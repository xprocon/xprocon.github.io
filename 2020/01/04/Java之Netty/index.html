<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="description" content="è¿™é‡Œæ˜¯ @Proconæ™®å…‰ çš„ä¸ªäººåšå®¢ï¼Œä¸ä½ ä¸€èµ·å‘ç°æ›´å¤§çš„ä¸–ç•Œ">
    <meta name="keywords" content="æ™®å…‰, Proconæ™®å…‰, åšå®¢, ä¸ªäººç½‘ç«™, äº’è”ç½‘, Java , åç«¯">
    <meta name="theme-color" content="#000000">

    <!-- Open Graph -->
    <meta property="og:title"
        content="Netty - Procon's Tech Life Blog">
    
    <meta property="og:type" content="article">
    <meta property="og:description" content="ä¸€. NIO åŸºç¡€
">
    
    <meta property="article:published_time" content=" 2020-01-04T12:00:00Z">
    
    
    <meta property="article:author" content="Procon">
    
    
    <meta property="article:tag" content="Java">
    
    <meta property="article:tag" content="netty">
    
    
    <meta property="og:image" content="https://blog.procon.cchttps://procon-note.oss-cn-guangzhou.aliyuncs.com/typora/avatar_m.jpg">
    <meta property="og:url" content="https://blog.procon.cc/2020/01/04/Java%E4%B9%8BNetty/">
    <meta property="og:site_name" content="Procon's Tech Life Blog">

    <title>Netty - Procon's Tech Life Blog</title>

    <!-- Web App Manifest -->
    <link rel="manifest" href="/pwa/manifest.json">

    <!-- Favicon -->
    <link rel="shortcut icon" href="/img/favicon.ico">

    <!-- Canonical URL -->
    <link rel="canonical" href="https://blog.procon.cc/2020/01/04/Java%E4%B9%8BNetty/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href=" /css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href=" /css/hux-blog.min.css">

    <!-- Custom Fonts -->
    <!-- <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet"
        type="text/css">


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>

    <!-- Google AdSense -->
    <script data-ad-client="ca-pub-6487568398225121" async
        src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->

<nav class="navbar navbar-default navbar-custom navbar-fixed-top invert">
    
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/">Procon's Tech Life Blog</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div id="huxblog_navbar">
                <div class="navbar-collapse">
                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="/">Home</a>
                        </li>
                        
                        
                        
                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                        
                        
                        <li>
                            <a href="/archive/">Archive</a>
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <li class="search-icon">
                            <a href="javascript:void(0)">
                                <i class="fa fa-search"></i>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <script>
        // Drop Bootstarp low-performance Navbar
        // Use customize navbar with high-quality material design animation
        // in high-perf jank-free CSS3 implementation
        var $body = document.body;
        var $toggle = document.querySelector('.navbar-toggle');
        var $navbar = document.querySelector('#huxblog_navbar');
        var $collapse = document.querySelector('.navbar-collapse');

        var __HuxNav__ = {
            close: function () {
                $navbar.className = " ";
                // wait until animation end.
                setTimeout(function () {
                    // prevent frequently toggle
                    if ($navbar.className.indexOf('in') < 0) {
                        $collapse.style.height = "0px"
                    }
                }, 400)
            },
            open: function () {
                $collapse.style.height = "auto"
                $navbar.className += " in";
            }
        }

        // Bind Event
        $toggle.addEventListener('click', function (e) {
            if ($navbar.className.indexOf('in') > 0) {
                __HuxNav__.close()
            } else {
                __HuxNav__.open()
            }
        })

        /**
         * Since Fastclick is used to delegate 'touchstart' globally
         * to hack 300ms delay in iOS by performing a fake 'click',
         * Using 'e.stopPropagation' to stop 'touchstart' event from 
         * $toggle/$collapse will break global delegation.
         * 
         * Instead, we use a 'e.target' filter to prevent handler
         * added to document close HuxNav.  
         *
         * Also, we use 'click' instead of 'touchstart' as compromise
         */
        document.addEventListener('click', function (e) {
            if (e.target == $toggle) return;
            if (e.target.className == 'icon-bar') return;
            __HuxNav__.close();
        })
    </script>
    <!-- Search -->
<div class="search-page">
  <div class="search-icon-close-container">
    <span class="search-icon-close">
      <i class="fa fa-chevron-down"></i>
    </span>
  </div>
  <div class="search-main container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <form></form>
        <input type="text" id="search-input" placeholder="$ grep...">
        </form>
        <div id="search-results" class="mini-post-list"></div>
      </div>
    </div>
  </div>
</div>

    <!-- Image to hack wechat -->
<!-- <img src="/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="/https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora/post-bg-alibaba.jpg" width="0" height="0"> -->

<!-- Post Header -->



<style type="text/css">
    header.intro-header{
        position: relative;
        background-image: url('/https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora/post-bg-alibaba.jpg');
        background: ;
    }

    
</style>




<header class="intro-header style-text" >

    <div class="header-mask"></div>
    
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/archive/?tag=Java" title="Java">Java</a>
                        
                        <a class="tag" href="/archive/?tag=netty" title="netty">netty</a>
                        
                    </div>
                    <h1>Netty</h1>
                    
                    <h2 class="subheading">nettyå­¦ä¹ </h2>
                    <span class="meta">Posted by Procon on January 4, 2020</span>
                </div>
            </div>
        </div>
    </div>
</header>







<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <!-- Multi-Lingual -->
                

				<h1 id="ä¸€-nio-åŸºç¡€">ä¸€. NIO åŸºç¡€</h1>

<p>non-blocking io éé˜»å¡ IO</p>

<h2 id="1-ä¸‰å¤§ç»„ä»¶">1. ä¸‰å¤§ç»„ä»¶</h2>

<h3 id="11-channel--buffer">1.1 Channel &amp; Buffer</h3>

<p>channel æœ‰ä¸€ç‚¹ç±»ä¼¼äº streamï¼Œå®ƒå°±æ˜¯è¯»å†™æ•°æ®çš„<strong>åŒå‘é€šé“</strong>ï¼Œå¯ä»¥ä» channel å°†æ•°æ®è¯»å…¥ bufferï¼Œä¹Ÿå¯ä»¥å°† buffer çš„æ•°æ®å†™å…¥ channelï¼Œè€Œä¹‹å‰çš„ stream è¦ä¹ˆæ˜¯è¾“å…¥ï¼Œè¦ä¹ˆæ˜¯è¾“å‡ºï¼Œchannel æ¯” stream æ›´ä¸ºåº•å±‚</p>

<pre><code class="language-mermaid">graph LR
channel --&gt; buffer
buffer --&gt; channel
</code></pre>

<p>å¸¸è§çš„ Channel æœ‰</p>

<ul>
  <li>FileChannel</li>
  <li>DatagramChannel</li>
  <li>SocketChannel</li>
  <li>ServerSocketChannel</li>
</ul>

<p>buffer åˆ™ç”¨æ¥ç¼“å†²è¯»å†™æ•°æ®ï¼Œå¸¸è§çš„ buffer æœ‰</p>

<ul>
  <li>ByteBuffer
    <ul>
      <li>MappedByteBuffer</li>
      <li>DirectByteBuffer</li>
      <li>HeapByteBuffer</li>
    </ul>
  </li>
  <li>ShortBuffer</li>
  <li>IntBuffer</li>
  <li>LongBuffer</li>
  <li>FloatBuffer</li>
  <li>DoubleBuffer</li>
  <li>CharBuffer</li>
</ul>

<h3 id="12-selector">1.2 Selector</h3>

<p>selector å•ä»å­—é¢æ„æ€ä¸å¥½ç†è§£ï¼Œéœ€è¦ç»“åˆæœåŠ¡å™¨çš„è®¾è®¡æ¼”åŒ–æ¥ç†è§£å®ƒçš„ç”¨é€”</p>

<h4 id="å¤šçº¿ç¨‹ç‰ˆè®¾è®¡">å¤šçº¿ç¨‹ç‰ˆè®¾è®¡</h4>

<pre><code class="language-mermaid">graph TD
subgraph å¤šçº¿ç¨‹ç‰ˆ
t1(thread) --&gt; s1(socket1)
t2(thread) --&gt; s2(socket2)
t3(thread) --&gt; s3(socket3)
end
</code></pre>

<h4 id="ï¸-å¤šçº¿ç¨‹ç‰ˆç¼ºç‚¹">âš ï¸ å¤šçº¿ç¨‹ç‰ˆç¼ºç‚¹</h4>

<ul>
  <li>å†…å­˜å ç”¨é«˜</li>
  <li>çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æˆæœ¬é«˜</li>
  <li>åªé€‚åˆè¿æ¥æ•°å°‘çš„åœºæ™¯</li>
</ul>

<h4 id="çº¿ç¨‹æ± ç‰ˆè®¾è®¡">çº¿ç¨‹æ± ç‰ˆè®¾è®¡</h4>

<pre><code class="language-mermaid">graph TD
subgraph çº¿ç¨‹æ± ç‰ˆ
t4(thread) --&gt; s4(socket1)
t5(thread) --&gt; s5(socket2)
t4(thread) -.-&gt; s6(socket3)
t5(thread) -.-&gt; s7(socket4)
end
</code></pre>

<h4 id="ï¸-çº¿ç¨‹æ± ç‰ˆç¼ºç‚¹">âš ï¸ çº¿ç¨‹æ± ç‰ˆç¼ºç‚¹</h4>

<ul>
  <li>é˜»å¡æ¨¡å¼ä¸‹ï¼Œçº¿ç¨‹ä»…èƒ½å¤„ç†ä¸€ä¸ª socket è¿æ¥</li>
  <li>ä»…é€‚åˆçŸ­è¿æ¥åœºæ™¯</li>
</ul>

<h4 id="selector-ç‰ˆè®¾è®¡">selector ç‰ˆè®¾è®¡</h4>

<p>selector çš„ä½œç”¨å°±æ˜¯é…åˆä¸€ä¸ªçº¿ç¨‹æ¥ç®¡ç†å¤šä¸ª channelï¼Œè·å–è¿™äº› channel ä¸Šå‘ç”Ÿçš„äº‹ä»¶ï¼Œè¿™äº› channel å·¥ä½œåœ¨éé˜»å¡æ¨¡å¼ä¸‹ï¼Œä¸ä¼šè®©çº¿ç¨‹åŠæ­»åœ¨ä¸€ä¸ª channel ä¸Šã€‚é€‚åˆè¿æ¥æ•°ç‰¹åˆ«å¤šï¼Œä½†æµé‡ä½çš„åœºæ™¯ï¼ˆlow trafficï¼‰</p>

<pre><code class="language-mermaid">graph TD
subgraph selector ç‰ˆ
thread --&gt; selector
selector --&gt; c1(channel)
selector --&gt; c2(channel)
selector --&gt; c3(channel)
end
</code></pre>

<p>è°ƒç”¨ selector çš„ select() ä¼šé˜»å¡ç›´åˆ° channel å‘ç”Ÿäº†è¯»å†™å°±ç»ªäº‹ä»¶ï¼Œè¿™äº›äº‹ä»¶å‘ç”Ÿï¼Œselect æ–¹æ³•å°±ä¼šè¿”å›è¿™äº›äº‹ä»¶äº¤ç»™ thread æ¥å¤„ç†</p>

<h2 id="2-bytebuffer">2. ByteBuffer</h2>

<p>æœ‰ä¸€æ™®é€šæ–‡æœ¬æ–‡ä»¶ data.txtï¼Œå†…å®¹ä¸º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>1234567890abcd
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä½¿ç”¨ FileChannel æ¥è¯»å–æ–‡ä»¶å†…å®¹</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre><span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ChannelDemo1</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">(</span><span class="nc">RandomAccessFile</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RandomAccessFile</span><span class="o">(</span><span class="s">"helloword/data.txt"</span><span class="o">,</span> <span class="s">"rw"</span><span class="o">))</span> <span class="o">{</span>
            <span class="nc">FileChannel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="na">getChannel</span><span class="o">();</span>
            <span class="nc">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
            <span class="k">do</span> <span class="o">{</span>
                <span class="c1">// å‘ buffer å†™å…¥</span>
                <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"è¯»åˆ°å­—èŠ‚æ•°ï¼š{}"</span><span class="o">,</span> <span class="n">len</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">len</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="c1">// åˆ‡æ¢ buffer è¯»æ¨¡å¼</span>
                <span class="n">buffer</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
                <span class="k">while</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">hasRemaining</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"{}"</span><span class="o">,</span> <span class="o">(</span><span class="kt">char</span><span class="o">)</span><span class="n">buffer</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
                <span class="o">}</span>
                <span class="c1">// åˆ‡æ¢ buffer å†™æ¨¡å¼</span>
                <span class="n">buffer</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre>10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - è¯»åˆ°å­—èŠ‚æ•°ï¼š10
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 1
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 2
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 3
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 4
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 5
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 6
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 7
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 8
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 9
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 0
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - è¯»åˆ°å­—èŠ‚æ•°ï¼š4
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - a
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - b
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - c
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - d
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - è¯»åˆ°å­—èŠ‚æ•°ï¼š-1
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="21--bytebuffer-æ­£ç¡®ä½¿ç”¨å§¿åŠ¿">2.1  ByteBuffer æ­£ç¡®ä½¿ç”¨å§¿åŠ¿</h3>

<ol>
  <li>å‘ buffer å†™å…¥æ•°æ®ï¼Œä¾‹å¦‚è°ƒç”¨ channel.read(buffer)</li>
  <li>è°ƒç”¨ flip() åˆ‡æ¢è‡³<strong>è¯»æ¨¡å¼</strong></li>
  <li>ä» buffer è¯»å–æ•°æ®ï¼Œä¾‹å¦‚è°ƒç”¨ buffer.get()</li>
  <li>è°ƒç”¨ clear() æˆ– compact() åˆ‡æ¢è‡³<strong>å†™æ¨¡å¼</strong></li>
  <li>é‡å¤ 1~4 æ­¥éª¤</li>
</ol>

<h3 id="22-bytebuffer-ç»“æ„">2.2 ByteBuffer ç»“æ„</h3>

<p>ByteBuffer æœ‰ä»¥ä¸‹é‡è¦å±æ€§</p>

<ul>
  <li>capacity</li>
  <li>position</li>
  <li>limit</li>
</ul>

<p>ä¸€å¼€å§‹</p>

<p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0021.png" alt="" /></p>

<p>å†™æ¨¡å¼ä¸‹ï¼Œposition æ˜¯å†™å…¥ä½ç½®ï¼Œlimit ç­‰äºå®¹é‡ï¼Œä¸‹å›¾è¡¨ç¤ºå†™å…¥äº† 4 ä¸ªå­—èŠ‚åçš„çŠ¶æ€</p>

<p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0018.png" alt="" /></p>

<p>flip åŠ¨ä½œå‘ç”Ÿåï¼Œposition åˆ‡æ¢ä¸ºè¯»å–ä½ç½®ï¼Œlimit åˆ‡æ¢ä¸ºè¯»å–é™åˆ¶</p>

<p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0019.png" alt="" /></p>

<p>è¯»å– 4 ä¸ªå­—èŠ‚åï¼ŒçŠ¶æ€</p>

<p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0020.png" alt="" /></p>

<p>clear åŠ¨ä½œå‘ç”Ÿåï¼ŒçŠ¶æ€</p>

<p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0021.png" alt="" /></p>

<p>compact æ–¹æ³•ï¼Œæ˜¯æŠŠæœªè¯»å®Œçš„éƒ¨åˆ†å‘å‰å‹ç¼©ï¼Œç„¶ååˆ‡æ¢è‡³å†™æ¨¡å¼</p>

<p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0022.png" alt="" /></p>

<h4 id="-è°ƒè¯•å·¥å…·ç±»">ğŸ’¡ è°ƒè¯•å·¥å…·ç±»</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ByteBufferUtil</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">char</span><span class="o">[]</span> <span class="no">BYTE2CHAR</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">char</span><span class="o">[</span><span class="mi">256</span><span class="o">];</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">char</span><span class="o">[]</span> <span class="no">HEXDUMP_TABLE</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">char</span><span class="o">[</span><span class="mi">256</span> <span class="o">*</span> <span class="mi">4</span><span class="o">];</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span><span class="o">[]</span> <span class="no">HEXPADDING</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">[</span><span class="mi">16</span><span class="o">];</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span><span class="o">[]</span> <span class="no">HEXDUMP_ROWPREFIXES</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">[</span><span class="mi">65536</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">4</span><span class="o">];</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span><span class="o">[]</span> <span class="no">BYTE2HEX</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">[</span><span class="mi">256</span><span class="o">];</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span><span class="o">[]</span> <span class="no">BYTEPADDING</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">[</span><span class="mi">16</span><span class="o">];</span>

    <span class="kd">static</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="kt">char</span><span class="o">[]</span> <span class="no">DIGITS</span> <span class="o">=</span> <span class="s">"0123456789abcdef"</span><span class="o">.</span><span class="na">toCharArray</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="no">HEXDUMP_TABLE</span><span class="o">[</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="no">DIGITS</span><span class="o">[</span><span class="n">i</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">4</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="o">];</span>
            <span class="no">HEXDUMP_TABLE</span><span class="o">[(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="no">DIGITS</span><span class="o">[</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="o">];</span>
        <span class="o">}</span>

        <span class="kt">int</span> <span class="n">i</span><span class="o">;</span>

        <span class="c1">// Generate the lookup table for hex dump paddings</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="no">HEXPADDING</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">padding</span> <span class="o">=</span> <span class="no">HEXPADDING</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="n">i</span><span class="o">;</span>
            <span class="nc">StringBuilder</span> <span class="n">buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">(</span><span class="n">padding</span> <span class="o">*</span> <span class="mi">3</span><span class="o">);</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">padding</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">buf</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"   "</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="no">HEXPADDING</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="c1">// Generate the lookup table for the start-offset header in each row (up to 64KiB).</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="no">HEXDUMP_ROWPREFIXES</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="nc">StringBuilder</span> <span class="n">buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">(</span><span class="mi">12</span><span class="o">);</span>
            <span class="n">buf</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="no">NEWLINE</span><span class="o">);</span>
            <span class="n">buf</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="nc">Long</span><span class="o">.</span><span class="na">toHexString</span><span class="o">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="no">L</span> <span class="o">|</span> <span class="mh">0x100000000</span><span class="no">L</span><span class="o">));</span>
            <span class="n">buf</span><span class="o">.</span><span class="na">setCharAt</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">-</span> <span class="mi">9</span><span class="o">,</span> <span class="sc">'|'</span><span class="o">);</span>
            <span class="n">buf</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">'|'</span><span class="o">);</span>
            <span class="no">HEXDUMP_ROWPREFIXES</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="c1">// Generate the lookup table for byte-to-hex-dump conversion</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="no">BYTE2HEX</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="no">BYTE2HEX</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="sc">' '</span> <span class="o">+</span> <span class="nc">StringUtil</span><span class="o">.</span><span class="na">byteToHexStringPadded</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">// Generate the lookup table for byte dump paddings</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="no">BYTEPADDING</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">padding</span> <span class="o">=</span> <span class="no">BYTEPADDING</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="n">i</span><span class="o">;</span>
            <span class="nc">StringBuilder</span> <span class="n">buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">(</span><span class="n">padding</span><span class="o">);</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">padding</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">buf</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">' '</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="no">BYTEPADDING</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="c1">// Generate the lookup table for byte-to-char conversion</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="no">BYTE2CHAR</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&lt;=</span> <span class="mh">0x1f</span> <span class="o">||</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mh">0x7f</span><span class="o">)</span> <span class="o">{</span>
                <span class="no">BYTE2CHAR</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="sc">'.'</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="no">BYTE2CHAR</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="o">(</span><span class="kt">char</span><span class="o">)</span> <span class="n">i</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * æ‰“å°æ‰€æœ‰å†…å®¹
     * @param buffer
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">debugAll</span><span class="o">(</span><span class="nc">ByteBuffer</span> <span class="n">buffer</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">oldlimit</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="na">limit</span><span class="o">();</span>
        <span class="n">buffer</span><span class="o">.</span><span class="na">limit</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">capacity</span><span class="o">());</span>
        <span class="nc">StringBuilder</span> <span class="n">origin</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">(</span><span class="mi">256</span><span class="o">);</span>
        <span class="n">appendPrettyHexDump</span><span class="o">(</span><span class="n">origin</span><span class="o">,</span> <span class="n">buffer</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">buffer</span><span class="o">.</span><span class="na">capacity</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"+--------+-------------------- all ------------------------+----------------+"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"position: [%d], limit: [%d]\n"</span><span class="o">,</span> <span class="n">buffer</span><span class="o">.</span><span class="na">position</span><span class="o">(),</span> <span class="n">oldlimit</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">origin</span><span class="o">);</span>
        <span class="n">buffer</span><span class="o">.</span><span class="na">limit</span><span class="o">(</span><span class="n">oldlimit</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * æ‰“å°å¯è¯»å–å†…å®¹
     * @param buffer
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">debugRead</span><span class="o">(</span><span class="nc">ByteBuffer</span> <span class="n">buffer</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">StringBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">(</span><span class="mi">256</span><span class="o">);</span>
        <span class="n">appendPrettyHexDump</span><span class="o">(</span><span class="n">builder</span><span class="o">,</span> <span class="n">buffer</span><span class="o">,</span> <span class="n">buffer</span><span class="o">.</span><span class="na">position</span><span class="o">(),</span> <span class="n">buffer</span><span class="o">.</span><span class="na">limit</span><span class="o">()</span> <span class="o">-</span> <span class="n">buffer</span><span class="o">.</span><span class="na">position</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"+--------+-------------------- read -----------------------+----------------+"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"position: [%d], limit: [%d]\n"</span><span class="o">,</span> <span class="n">buffer</span><span class="o">.</span><span class="na">position</span><span class="o">(),</span> <span class="n">buffer</span><span class="o">.</span><span class="na">limit</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">builder</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">appendPrettyHexDump</span><span class="o">(</span><span class="nc">StringBuilder</span> <span class="n">dump</span><span class="o">,</span> <span class="nc">ByteBuffer</span> <span class="n">buf</span><span class="o">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="o">,</span> <span class="kt">int</span> <span class="n">length</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">isOutOfBounds</span><span class="o">(</span><span class="n">offset</span><span class="o">,</span> <span class="n">length</span><span class="o">,</span> <span class="n">buf</span><span class="o">.</span><span class="na">capacity</span><span class="o">()))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IndexOutOfBoundsException</span><span class="o">(</span>
                    <span class="s">"expected: "</span> <span class="o">+</span> <span class="s">"0 &lt;= offset("</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">+</span> <span class="s">") &lt;= offset + length("</span> <span class="o">+</span> <span class="n">length</span>
                            <span class="o">+</span> <span class="s">") &lt;= "</span> <span class="o">+</span> <span class="s">"buf.capacity("</span> <span class="o">+</span> <span class="n">buf</span><span class="o">.</span><span class="na">capacity</span><span class="o">()</span> <span class="o">+</span> <span class="sc">')'</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">dump</span><span class="o">.</span><span class="na">append</span><span class="o">(</span>
                <span class="s">"         +-------------------------------------------------+"</span> <span class="o">+</span>
                        <span class="no">NEWLINE</span> <span class="o">+</span> <span class="s">"         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |"</span> <span class="o">+</span>
                        <span class="no">NEWLINE</span> <span class="o">+</span> <span class="s">"+--------+-------------------------------------------------+----------------+"</span><span class="o">);</span>

        <span class="kd">final</span> <span class="kt">int</span> <span class="n">startIndex</span> <span class="o">=</span> <span class="n">offset</span><span class="o">;</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">fullRows</span> <span class="o">=</span> <span class="n">length</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">4</span><span class="o">;</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">remainder</span> <span class="o">=</span> <span class="n">length</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="o">;</span>

        <span class="c1">// Dump the rows which have 16 bytes.</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">row</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">fullRows</span><span class="o">;</span> <span class="n">row</span><span class="o">++)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">rowStartIndex</span> <span class="o">=</span> <span class="o">(</span><span class="n">row</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="o">)</span> <span class="o">+</span> <span class="n">startIndex</span><span class="o">;</span>

            <span class="c1">// Per-row prefix.</span>
            <span class="n">appendHexDumpRowPrefix</span><span class="o">(</span><span class="n">dump</span><span class="o">,</span> <span class="n">row</span><span class="o">,</span> <span class="n">rowStartIndex</span><span class="o">);</span>

            <span class="c1">// Hex dump</span>
            <span class="kt">int</span> <span class="n">rowEndIndex</span> <span class="o">=</span> <span class="n">rowStartIndex</span> <span class="o">+</span> <span class="mi">16</span><span class="o">;</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">rowStartIndex</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">rowEndIndex</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">dump</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="no">BYTE2HEX</span><span class="o">[</span><span class="n">getUnsignedByte</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="n">j</span><span class="o">)]);</span>
            <span class="o">}</span>
            <span class="n">dump</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">" |"</span><span class="o">);</span>

            <span class="c1">// ASCII dump</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">rowStartIndex</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">rowEndIndex</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">dump</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="no">BYTE2CHAR</span><span class="o">[</span><span class="n">getUnsignedByte</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="n">j</span><span class="o">)]);</span>
            <span class="o">}</span>
            <span class="n">dump</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">'|'</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">// Dump the last row which has less than 16 bytes.</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">remainder</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">rowStartIndex</span> <span class="o">=</span> <span class="o">(</span><span class="n">fullRows</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="o">)</span> <span class="o">+</span> <span class="n">startIndex</span><span class="o">;</span>
            <span class="n">appendHexDumpRowPrefix</span><span class="o">(</span><span class="n">dump</span><span class="o">,</span> <span class="n">fullRows</span><span class="o">,</span> <span class="n">rowStartIndex</span><span class="o">);</span>

            <span class="c1">// Hex dump</span>
            <span class="kt">int</span> <span class="n">rowEndIndex</span> <span class="o">=</span> <span class="n">rowStartIndex</span> <span class="o">+</span> <span class="n">remainder</span><span class="o">;</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">rowStartIndex</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">rowEndIndex</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">dump</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="no">BYTE2HEX</span><span class="o">[</span><span class="n">getUnsignedByte</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="n">j</span><span class="o">)]);</span>
            <span class="o">}</span>
            <span class="n">dump</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="no">HEXPADDING</span><span class="o">[</span><span class="n">remainder</span><span class="o">]);</span>
            <span class="n">dump</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">" |"</span><span class="o">);</span>

            <span class="c1">// Ascii dump</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">rowStartIndex</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">rowEndIndex</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">dump</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="no">BYTE2CHAR</span><span class="o">[</span><span class="n">getUnsignedByte</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="n">j</span><span class="o">)]);</span>
            <span class="o">}</span>
            <span class="n">dump</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="no">BYTEPADDING</span><span class="o">[</span><span class="n">remainder</span><span class="o">]);</span>
            <span class="n">dump</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">'|'</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">dump</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="no">NEWLINE</span> <span class="o">+</span>
                <span class="s">"+--------+-------------------------------------------------+----------------+"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">appendHexDumpRowPrefix</span><span class="o">(</span><span class="nc">StringBuilder</span> <span class="n">dump</span><span class="o">,</span> <span class="kt">int</span> <span class="n">row</span><span class="o">,</span> <span class="kt">int</span> <span class="n">rowStartIndex</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">row</span> <span class="o">&lt;</span> <span class="no">HEXDUMP_ROWPREFIXES</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">dump</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="no">HEXDUMP_ROWPREFIXES</span><span class="o">[</span><span class="n">row</span><span class="o">]);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">dump</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="no">NEWLINE</span><span class="o">);</span>
            <span class="n">dump</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="nc">Long</span><span class="o">.</span><span class="na">toHexString</span><span class="o">(</span><span class="n">rowStartIndex</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="no">L</span> <span class="o">|</span> <span class="mh">0x100000000</span><span class="no">L</span><span class="o">));</span>
            <span class="n">dump</span><span class="o">.</span><span class="na">setCharAt</span><span class="o">(</span><span class="n">dump</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">-</span> <span class="mi">9</span><span class="o">,</span> <span class="sc">'|'</span><span class="o">);</span>
            <span class="n">dump</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">'|'</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">short</span> <span class="nf">getUnsignedByte</span><span class="o">(</span><span class="nc">ByteBuffer</span> <span class="n">buffer</span><span class="o">,</span> <span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="kt">short</span><span class="o">)</span> <span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">index</span><span class="o">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="23-bytebuffer-å¸¸è§æ–¹æ³•">2.3 ByteBuffer å¸¸è§æ–¹æ³•</h3>

<h4 id="åˆ†é…ç©ºé—´">åˆ†é…ç©ºé—´</h4>

<p>å¯ä»¥ä½¿ç”¨ allocate æ–¹æ³•ä¸º ByteBuffer åˆ†é…ç©ºé—´ï¼Œå…¶å®ƒ buffer ç±»ä¹Ÿæœ‰è¯¥æ–¹æ³•</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nc">Bytebuffer</span> <span class="n">buf</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">16</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="å‘-buffer-å†™å…¥æ•°æ®">å‘ buffer å†™å…¥æ•°æ®</h4>

<p>æœ‰ä¸¤ç§åŠæ³•</p>

<ul>
  <li>è°ƒç”¨ channel çš„ read æ–¹æ³•</li>
  <li>è°ƒç”¨ buffer è‡ªå·±çš„ put æ–¹æ³•</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kt">int</span> <span class="n">readBytes</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buf</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å’Œ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">buf</span><span class="o">.</span><span class="na">put</span><span class="o">((</span><span class="kt">byte</span><span class="o">)</span><span class="mi">127</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="ä»-buffer-è¯»å–æ•°æ®">ä» buffer è¯»å–æ•°æ®</h4>

<p>åŒæ ·æœ‰ä¸¤ç§åŠæ³•</p>

<ul>
  <li>è°ƒç”¨ channel çš„ write æ–¹æ³•</li>
  <li>è°ƒç”¨ buffer è‡ªå·±çš„ get æ–¹æ³•</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kt">int</span> <span class="n">writeBytes</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buf</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å’Œ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kt">byte</span> <span class="n">b</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>get æ–¹æ³•ä¼šè®© position è¯»æŒ‡é’ˆå‘åèµ°ï¼Œå¦‚æœæƒ³é‡å¤è¯»å–æ•°æ®</p>

<ul>
  <li>å¯ä»¥è°ƒç”¨ rewind æ–¹æ³•å°† position é‡æ–°ç½®ä¸º 0</li>
  <li>æˆ–è€…è°ƒç”¨ get(int i) æ–¹æ³•è·å–ç´¢å¼• i çš„å†…å®¹ï¼Œå®ƒä¸ä¼šç§»åŠ¨è¯»æŒ‡é’ˆ</li>
</ul>

<h4 id="mark-å’Œ-reset">mark å’Œ reset</h4>

<p>mark æ˜¯åœ¨è¯»å–æ—¶ï¼Œåšä¸€ä¸ªæ ‡è®°ï¼Œå³ä½¿ position æ”¹å˜ï¼Œåªè¦è°ƒç”¨ reset å°±èƒ½å›åˆ° mark çš„ä½ç½®</p>

<blockquote>
  <p><strong>æ³¨æ„</strong></p>

  <p>rewind å’Œ flip éƒ½ä¼šæ¸…é™¤ mark ä½ç½®</p>
</blockquote>

<h4 id="å­—ç¬¦ä¸²ä¸-bytebuffer-äº’è½¬">å­—ç¬¦ä¸²ä¸ ByteBuffer äº’è½¬</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="nc">ByteBuffer</span> <span class="n">buffer1</span> <span class="o">=</span> <span class="nc">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="s">"ä½ å¥½"</span><span class="o">);</span>
<span class="nc">ByteBuffer</span> <span class="n">buffer2</span> <span class="o">=</span> <span class="nc">Charset</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"utf-8"</span><span class="o">).</span><span class="na">encode</span><span class="o">(</span><span class="s">"ä½ å¥½"</span><span class="o">);</span>

<span class="n">debug</span><span class="o">(</span><span class="n">buffer1</span><span class="o">);</span>
<span class="n">debug</span><span class="o">(</span><span class="n">buffer2</span><span class="o">);</span>

<span class="nc">CharBuffer</span> <span class="n">buffer3</span> <span class="o">=</span> <span class="nc">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">.</span><span class="na">decode</span><span class="o">(</span><span class="n">buffer1</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buffer3</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buffer3</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre>         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| e4 bd a0 e5 a5 bd                               |......          |
+--------+-------------------------------------------------+----------------+
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| e4 bd a0 e5 a5 bd                               |......          |
+--------+-------------------------------------------------+----------------+
class java.nio.HeapCharBuffer
ä½ å¥½
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="ï¸-buffer-çš„çº¿ç¨‹å®‰å…¨">âš ï¸ Buffer çš„çº¿ç¨‹å®‰å…¨</h4>

<blockquote>
  <p>Buffer æ˜¯<strong>éçº¿ç¨‹å®‰å…¨çš„</strong></p>
</blockquote>

<h3 id="24-scattering-reads">2.4 Scattering Reads</h3>

<p>åˆ†æ•£è¯»å–ï¼Œæœ‰ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ 3parts.txt</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>onetwothree
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä½¿ç”¨å¦‚ä¸‹æ–¹å¼è¯»å–ï¼Œå¯ä»¥å°†æ•°æ®å¡«å……è‡³å¤šä¸ª buffer</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="k">try</span> <span class="o">(</span><span class="nc">RandomAccessFile</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RandomAccessFile</span><span class="o">(</span><span class="s">"helloword/3parts.txt"</span><span class="o">,</span> <span class="s">"rw"</span><span class="o">))</span> <span class="o">{</span>
    <span class="nc">FileChannel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="na">getChannel</span><span class="o">();</span>
    <span class="nc">ByteBuffer</span> <span class="n">a</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>
    <span class="nc">ByteBuffer</span> <span class="n">b</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>
    <span class="nc">ByteBuffer</span> <span class="n">c</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
    <span class="n">channel</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="k">new</span> <span class="nc">ByteBuffer</span><span class="o">[]{</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">c</span><span class="o">});</span>
    <span class="n">a</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
    <span class="n">b</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
    <span class="n">c</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
    <span class="n">debug</span><span class="o">(</span><span class="n">a</span><span class="o">);</span>
    <span class="n">debug</span><span class="o">(</span><span class="n">b</span><span class="o">);</span>
    <span class="n">debug</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç»“æœ</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre>         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 6f 6e 65                                        |one             |
+--------+-------------------------------------------------+----------------+
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 74 77 6f                                        |two             |
+--------+-------------------------------------------------+----------------+
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 74 68 72 65 65                                  |three           |
+--------+-------------------------------------------------+----------------+
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="25-gathering-writes">2.5 Gathering Writes</h3>

<p>ä½¿ç”¨å¦‚ä¸‹æ–¹å¼å†™å…¥ï¼Œå¯ä»¥å°†å¤šä¸ª buffer çš„æ•°æ®å¡«å……è‡³ channel</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="k">try</span> <span class="o">(</span><span class="nc">RandomAccessFile</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RandomAccessFile</span><span class="o">(</span><span class="s">"helloword/3parts.txt"</span><span class="o">,</span> <span class="s">"rw"</span><span class="o">))</span> <span class="o">{</span>
    <span class="nc">FileChannel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="na">getChannel</span><span class="o">();</span>
    <span class="nc">ByteBuffer</span> <span class="n">d</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">4</span><span class="o">);</span>
    <span class="nc">ByteBuffer</span> <span class="n">e</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">4</span><span class="o">);</span>
    <span class="n">channel</span><span class="o">.</span><span class="na">position</span><span class="o">(</span><span class="mi">11</span><span class="o">);</span>

    <span class="n">d</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="k">new</span> <span class="kt">byte</span><span class="o">[]{</span><span class="sc">'f'</span><span class="o">,</span> <span class="sc">'o'</span><span class="o">,</span> <span class="sc">'u'</span><span class="o">,</span> <span class="sc">'r'</span><span class="o">});</span>
    <span class="n">e</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="k">new</span> <span class="kt">byte</span><span class="o">[]{</span><span class="sc">'f'</span><span class="o">,</span> <span class="sc">'i'</span><span class="o">,</span> <span class="sc">'v'</span><span class="o">,</span> <span class="sc">'e'</span><span class="o">});</span>
    <span class="n">d</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
    <span class="n">e</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
    <span class="n">debug</span><span class="o">(</span><span class="n">d</span><span class="o">);</span>
    <span class="n">debug</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="n">channel</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="k">new</span> <span class="nc">ByteBuffer</span><span class="o">[]{</span><span class="n">d</span><span class="o">,</span> <span class="n">e</span><span class="o">});</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 66 6f 75 72                                     |four            |
+--------+-------------------------------------------------+----------------+
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 66 69 76 65                                     |five            |
+--------+-------------------------------------------------+----------------+
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ–‡ä»¶å†…å®¹</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>onetwothreefourfive
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="26-ç»ƒä¹ ">2.6 ç»ƒä¹ </h3>

<p>ç½‘ç»œä¸Šæœ‰å¤šæ¡æ•°æ®å‘é€ç»™æœåŠ¡ç«¯ï¼Œæ•°æ®ä¹‹é—´ä½¿ç”¨ \n è¿›è¡Œåˆ†éš”
ä½†ç”±äºæŸç§åŸå› è¿™äº›æ•°æ®åœ¨æ¥æ”¶æ—¶ï¼Œè¢«è¿›è¡Œäº†é‡æ–°ç»„åˆï¼Œä¾‹å¦‚åŸå§‹æ•°æ®æœ‰3æ¡ä¸º</p>

<ul>
  <li>Hello,world\n</li>
  <li>Iâ€™m zhangsan\n</li>
  <li>How are you?\n</li>
</ul>

<p>å˜æˆäº†ä¸‹é¢çš„ä¸¤ä¸ª byteBuffer (é»åŒ…ï¼ŒåŠåŒ…)</p>

<ul>
  <li>Hello,world\nIâ€™m zhangsan\nHo</li>
  <li>w are you?\n</li>
</ul>

<p>ç°åœ¨è¦æ±‚ä½ ç¼–å†™ç¨‹åºï¼Œå°†é”™ä¹±çš„æ•°æ®æ¢å¤æˆåŸå§‹çš„æŒ‰ \n åˆ†éš”çš„æ•°æ®</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">ByteBuffer</span> <span class="n">source</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">32</span><span class="o">);</span>
    <span class="c1">//                     11            24</span>
    <span class="n">source</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"Hello,world\nI'm zhangsan\nHo"</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
    <span class="n">split</span><span class="o">(</span><span class="n">source</span><span class="o">);</span>

    <span class="n">source</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"w are you?\nhaha!\n"</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
    <span class="n">split</span><span class="o">(</span><span class="n">source</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">split</span><span class="o">(</span><span class="nc">ByteBuffer</span> <span class="n">source</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">source</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
    <span class="kt">int</span> <span class="n">oldLimit</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="na">limit</span><span class="o">();</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">oldLimit</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">source</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">)</span> <span class="o">==</span> <span class="sc">'\n'</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
            <span class="nc">ByteBuffer</span> <span class="n">target</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">source</span><span class="o">.</span><span class="na">position</span><span class="o">());</span>
            <span class="c1">// 0 ~ limit</span>
            <span class="n">source</span><span class="o">.</span><span class="na">limit</span><span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
            <span class="n">target</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">source</span><span class="o">);</span> <span class="c1">// ä»source è¯»ï¼Œå‘ target å†™</span>
            <span class="n">debugAll</span><span class="o">(</span><span class="n">target</span><span class="o">);</span>
            <span class="n">source</span><span class="o">.</span><span class="na">limit</span><span class="o">(</span><span class="n">oldLimit</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">source</span><span class="o">.</span><span class="na">compact</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="3-æ–‡ä»¶ç¼–ç¨‹">3. æ–‡ä»¶ç¼–ç¨‹</h2>

<h3 id="31-filechannel">3.1 FileChannel</h3>

<h4 id="ï¸-filechannel-å·¥ä½œæ¨¡å¼">âš ï¸ FileChannel å·¥ä½œæ¨¡å¼</h4>

<blockquote>
  <p>FileChannel åªèƒ½å·¥ä½œåœ¨é˜»å¡æ¨¡å¼ä¸‹</p>
</blockquote>

<h4 id="è·å–">è·å–</h4>

<p>ä¸èƒ½ç›´æ¥æ‰“å¼€ FileChannelï¼Œå¿…é¡»é€šè¿‡ FileInputStreamã€FileOutputStream æˆ–è€… RandomAccessFile æ¥è·å– FileChannelï¼Œå®ƒä»¬éƒ½æœ‰ getChannel æ–¹æ³•</p>

<ul>
  <li>é€šè¿‡ FileInputStream è·å–çš„ channel åªèƒ½è¯»</li>
  <li>é€šè¿‡ FileOutputStream è·å–çš„ channel åªèƒ½å†™</li>
  <li>é€šè¿‡ RandomAccessFile æ˜¯å¦èƒ½è¯»å†™æ ¹æ®æ„é€  RandomAccessFile æ—¶çš„è¯»å†™æ¨¡å¼å†³å®š</li>
</ul>

<h4 id="è¯»å–">è¯»å–</h4>

<p>ä¼šä» channel è¯»å–æ•°æ®å¡«å…… ByteBufferï¼Œè¿”å›å€¼è¡¨ç¤ºè¯»åˆ°äº†å¤šå°‘å­—èŠ‚ï¼Œ-1 è¡¨ç¤ºåˆ°è¾¾äº†æ–‡ä»¶çš„æœ«å°¾</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kt">int</span> <span class="n">readBytes</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="å†™å…¥">å†™å…¥</h4>

<p>å†™å…¥çš„æ­£ç¡®å§¿åŠ¿å¦‚ä¸‹ï¼Œ SocketChannel</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="nc">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="o">...;</span>
<span class="n">buffer</span><span class="o">.</span><span class="na">put</span><span class="o">(...);</span> <span class="c1">// å­˜å…¥æ•°æ®</span>
<span class="n">buffer</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>   <span class="c1">// åˆ‡æ¢è¯»æ¨¡å¼</span>

<span class="k">while</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">hasRemaining</span><span class="o">())</span> <span class="o">{</span>
    <span class="n">channel</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åœ¨ while ä¸­è°ƒç”¨ channel.write æ˜¯å› ä¸º write æ–¹æ³•å¹¶ä¸èƒ½ä¿è¯ä¸€æ¬¡å°† buffer ä¸­çš„å†…å®¹å…¨éƒ¨å†™å…¥ channel</p>

<h4 id="å…³é—­">å…³é—­</h4>

<p>channel å¿…é¡»å…³é—­ï¼Œä¸è¿‡è°ƒç”¨äº† FileInputStreamã€FileOutputStream æˆ–è€… RandomAccessFile çš„ close æ–¹æ³•ä¼šé—´æ¥åœ°è°ƒç”¨ channel çš„ close æ–¹æ³•</p>

<h4 id="ä½ç½®">ä½ç½®</h4>

<p>è·å–å½“å‰ä½ç½®</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kt">long</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="na">position</span><span class="o">();</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è®¾ç½®å½“å‰ä½ç½®</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="kt">long</span> <span class="n">newPos</span> <span class="o">=</span> <span class="o">...;</span>
<span class="n">channel</span><span class="o">.</span><span class="na">position</span><span class="o">(</span><span class="n">newPos</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è®¾ç½®å½“å‰ä½ç½®æ—¶ï¼Œå¦‚æœè®¾ç½®ä¸ºæ–‡ä»¶çš„æœ«å°¾</p>

<ul>
  <li>è¿™æ—¶è¯»å–ä¼šè¿”å› -1</li>
  <li>è¿™æ—¶å†™å…¥ï¼Œä¼šè¿½åŠ å†…å®¹ï¼Œä½†è¦æ³¨æ„å¦‚æœ position è¶…è¿‡äº†æ–‡ä»¶æœ«å°¾ï¼Œå†å†™å…¥æ—¶åœ¨æ–°å†…å®¹å’ŒåŸæœ«å°¾ä¹‹é—´ä¼šæœ‰ç©ºæ´ï¼ˆ00ï¼‰</li>
</ul>

<h4 id="å¤§å°">å¤§å°</h4>

<p>ä½¿ç”¨ size æ–¹æ³•è·å–æ–‡ä»¶çš„å¤§å°</p>

<h4 id="å¼ºåˆ¶å†™å…¥">å¼ºåˆ¶å†™å…¥</h4>

<p>æ“ä½œç³»ç»Ÿå‡ºäºæ€§èƒ½çš„è€ƒè™‘ï¼Œä¼šå°†æ•°æ®ç¼“å­˜ï¼Œä¸æ˜¯ç«‹åˆ»å†™å…¥ç£ç›˜ã€‚å¯ä»¥è°ƒç”¨ force(true)  æ–¹æ³•å°†æ–‡ä»¶å†…å®¹å’Œå…ƒæ•°æ®ï¼ˆæ–‡ä»¶çš„æƒé™ç­‰ä¿¡æ¯ï¼‰ç«‹åˆ»å†™å…¥ç£ç›˜</p>

<h3 id="32-ä¸¤ä¸ª-channel-ä¼ è¾“æ•°æ®">3.2 ä¸¤ä¸ª Channel ä¼ è¾“æ•°æ®</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="nc">String</span> <span class="no">FROM</span> <span class="o">=</span> <span class="s">"helloword/data.txt"</span><span class="o">;</span>
<span class="nc">String</span> <span class="no">TO</span> <span class="o">=</span> <span class="s">"helloword/to.txt"</span><span class="o">;</span>
<span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
<span class="k">try</span> <span class="o">(</span><span class="nc">FileChannel</span> <span class="n">from</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="no">FROM</span><span class="o">).</span><span class="na">getChannel</span><span class="o">();</span>
     <span class="nc">FileChannel</span> <span class="n">to</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileOutputStream</span><span class="o">(</span><span class="no">TO</span><span class="o">).</span><span class="na">getChannel</span><span class="o">();</span>
    <span class="o">)</span> <span class="o">{</span>
    <span class="n">from</span><span class="o">.</span><span class="na">transferTo</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">from</span><span class="o">.</span><span class="na">size</span><span class="o">(),</span> <span class="n">to</span><span class="o">);</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
<span class="o">}</span>
<span class="kt">long</span> <span class="n">end</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"transferTo ç”¨æ—¶ï¼š"</span> <span class="o">+</span> <span class="o">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="o">)</span> <span class="o">/</span> <span class="mf">1000_000.0</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>transferTo ç”¨æ—¶ï¼š8.2011
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¶…è¿‡ 2g å¤§å°çš„æ–‡ä»¶ä¼ è¾“</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestFileChannelTransferTo</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">(</span>
                <span class="nc">FileChannel</span> <span class="n">from</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="s">"data.txt"</span><span class="o">).</span><span class="na">getChannel</span><span class="o">();</span>
                <span class="nc">FileChannel</span> <span class="n">to</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileOutputStream</span><span class="o">(</span><span class="s">"to.txt"</span><span class="o">).</span><span class="na">getChannel</span><span class="o">();</span>
        <span class="o">)</span> <span class="o">{</span>
            <span class="c1">// æ•ˆç‡é«˜ï¼Œåº•å±‚ä¼šåˆ©ç”¨æ“ä½œç³»ç»Ÿçš„é›¶æ‹·è´è¿›è¡Œä¼˜åŒ–</span>
            <span class="kt">long</span> <span class="n">size</span> <span class="o">=</span> <span class="n">from</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
            <span class="c1">// left å˜é‡ä»£è¡¨è¿˜å‰©ä½™å¤šå°‘å­—èŠ‚</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">long</span> <span class="n">left</span> <span class="o">=</span> <span class="n">size</span><span class="o">;</span> <span class="n">left</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"position:"</span> <span class="o">+</span> <span class="o">(</span><span class="n">size</span> <span class="o">-</span> <span class="n">left</span><span class="o">)</span> <span class="o">+</span> <span class="s">" left:"</span> <span class="o">+</span> <span class="n">left</span><span class="o">);</span>
                <span class="n">left</span> <span class="o">-=</span> <span class="n">from</span><span class="o">.</span><span class="na">transferTo</span><span class="o">((</span><span class="n">size</span> <span class="o">-</span> <span class="n">left</span><span class="o">),</span> <span class="n">left</span><span class="o">,</span> <span class="n">to</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å®é™…ä¼ è¾“ä¸€ä¸ªè¶…å¤§æ–‡ä»¶</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>position:0 left:7769948160
position:2147483647 left:5622464513
position:4294967294 left:3474980866
position:6442450941 left:1327497219
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="33-path">3.3 Path</h3>

<p>jdk7 å¼•å…¥äº† Path å’Œ Paths ç±»</p>

<ul>
  <li>Path ç”¨æ¥è¡¨ç¤ºæ–‡ä»¶è·¯å¾„</li>
  <li>Paths æ˜¯å·¥å…·ç±»ï¼Œç”¨æ¥è·å– Path å®ä¾‹</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="nc">Path</span> <span class="n">source</span> <span class="o">=</span> <span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"1.txt"</span><span class="o">);</span> <span class="c1">// ç›¸å¯¹è·¯å¾„ ä½¿ç”¨ user.dir ç¯å¢ƒå˜é‡æ¥å®šä½ 1.txt</span>

<span class="nc">Path</span> <span class="n">source</span> <span class="o">=</span> <span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"d:\\1.txt"</span><span class="o">);</span> <span class="c1">// ç»å¯¹è·¯å¾„ ä»£è¡¨äº†  d:\1.txt</span>

<span class="nc">Path</span> <span class="n">source</span> <span class="o">=</span> <span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"d:/1.txt"</span><span class="o">);</span> <span class="c1">// ç»å¯¹è·¯å¾„ åŒæ ·ä»£è¡¨äº†  d:\1.txt</span>

<span class="nc">Path</span> <span class="n">projects</span> <span class="o">=</span> <span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"d:\\data"</span><span class="o">,</span> <span class="s">"projects"</span><span class="o">);</span> <span class="c1">// ä»£è¡¨äº†  d:\data\projects</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">.</code> ä»£è¡¨äº†å½“å‰è·¯å¾„</li>
  <li><code class="language-plaintext highlighter-rouge">..</code> ä»£è¡¨äº†ä¸Šä¸€çº§è·¯å¾„</li>
</ul>

<p>ä¾‹å¦‚ç›®å½•ç»“æ„å¦‚ä¸‹</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>d:
	|- data
		|- projects
			|- a
			|- b
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä»£ç </p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nc">Path</span> <span class="n">path</span> <span class="o">=</span> <span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"d:\\data\\projects\\a\\..\\b"</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">path</span><span class="o">.</span><span class="na">normalize</span><span class="o">());</span> <span class="c1">// æ­£å¸¸åŒ–è·¯å¾„</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä¼šè¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>d:\data\projects\a\..\b
d:\data\projects\b
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="34-files">3.4 Files</h3>

<p>æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nc">Path</span> <span class="n">path</span> <span class="o">=</span> <span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"helloword/data.txt"</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Files</span><span class="o">.</span><span class="na">exists</span><span class="o">(</span><span class="n">path</span><span class="o">));</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åˆ›å»ºä¸€çº§ç›®å½•</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nc">Path</span> <span class="n">path</span> <span class="o">=</span> <span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"helloword/d1"</span><span class="o">);</span>
<span class="nc">Files</span><span class="o">.</span><span class="na">createDirectory</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>å¦‚æœç›®å½•å·²å­˜åœ¨ï¼Œä¼šæŠ›å¼‚å¸¸ FileAlreadyExistsException</li>
  <li>ä¸èƒ½ä¸€æ¬¡åˆ›å»ºå¤šçº§ç›®å½•ï¼Œå¦åˆ™ä¼šæŠ›å¼‚å¸¸ NoSuchFileException</li>
</ul>

<p>åˆ›å»ºå¤šçº§ç›®å½•ç”¨</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nc">Path</span> <span class="n">path</span> <span class="o">=</span> <span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"helloword/d1/d2"</span><span class="o">);</span>
<span class="nc">Files</span><span class="o">.</span><span class="na">createDirectories</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ‹·è´æ–‡ä»¶</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nc">Path</span> <span class="n">source</span> <span class="o">=</span> <span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"helloword/data.txt"</span><span class="o">);</span>
<span class="nc">Path</span> <span class="n">target</span> <span class="o">=</span> <span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"helloword/target.txt"</span><span class="o">);</span>

<span class="nc">Files</span><span class="o">.</span><span class="na">copy</span><span class="o">(</span><span class="n">source</span><span class="o">,</span> <span class="n">target</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>å¦‚æœæ–‡ä»¶å·²å­˜åœ¨ï¼Œä¼šæŠ›å¼‚å¸¸ FileAlreadyExistsException</li>
</ul>

<p>å¦‚æœå¸Œæœ›ç”¨ source è¦†ç›–æ‰ targetï¼Œéœ€è¦ç”¨ StandardCopyOption æ¥æ§åˆ¶</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nc">Files</span><span class="o">.</span><span class="na">copy</span><span class="o">(</span><span class="n">source</span><span class="o">,</span> <span class="n">target</span><span class="o">,</span> <span class="nc">StandardCopyOption</span><span class="o">.</span><span class="na">REPLACE_EXISTING</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç§»åŠ¨æ–‡ä»¶</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nc">Path</span> <span class="n">source</span> <span class="o">=</span> <span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"helloword/data.txt"</span><span class="o">);</span>
<span class="nc">Path</span> <span class="n">target</span> <span class="o">=</span> <span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"helloword/data.txt"</span><span class="o">);</span>

<span class="nc">Files</span><span class="o">.</span><span class="na">move</span><span class="o">(</span><span class="n">source</span><span class="o">,</span> <span class="n">target</span><span class="o">,</span> <span class="nc">StandardCopyOption</span><span class="o">.</span><span class="na">ATOMIC_MOVE</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>StandardCopyOption.ATOMIC_MOVE ä¿è¯æ–‡ä»¶ç§»åŠ¨çš„åŸå­æ€§</li>
</ul>

<p>åˆ é™¤æ–‡ä»¶</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nc">Path</span> <span class="n">target</span> <span class="o">=</span> <span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"helloword/target.txt"</span><span class="o">);</span>

<span class="nc">Files</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">target</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œä¼šæŠ›å¼‚å¸¸ NoSuchFileException</li>
</ul>

<p>åˆ é™¤ç›®å½•</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nc">Path</span> <span class="n">target</span> <span class="o">=</span> <span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"helloword/d1"</span><span class="o">);</span>

<span class="nc">Files</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">target</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>å¦‚æœç›®å½•è¿˜æœ‰å†…å®¹ï¼Œä¼šæŠ›å¼‚å¸¸ DirectoryNotEmptyException</li>
</ul>

<p>éå†ç›®å½•æ–‡ä»¶</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="nc">Path</span> <span class="n">path</span> <span class="o">=</span> <span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"C:\\Program Files\\Java\\jdk1.8.0_91"</span><span class="o">);</span>
    <span class="nc">AtomicInteger</span> <span class="n">dirCount</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicInteger</span><span class="o">();</span>
    <span class="nc">AtomicInteger</span> <span class="n">fileCount</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicInteger</span><span class="o">();</span>
    <span class="nc">Files</span><span class="o">.</span><span class="na">walkFileTree</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="k">new</span> <span class="nc">SimpleFileVisitor</span><span class="o">&lt;</span><span class="nc">Path</span><span class="o">&gt;(){</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">FileVisitResult</span> <span class="nf">preVisitDirectory</span><span class="o">(</span><span class="nc">Path</span> <span class="n">dir</span><span class="o">,</span> <span class="nc">BasicFileAttributes</span> <span class="n">attrs</span><span class="o">)</span> 
            <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">dir</span><span class="o">);</span>
            <span class="n">dirCount</span><span class="o">.</span><span class="na">incrementAndGet</span><span class="o">();</span>
            <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">preVisitDirectory</span><span class="o">(</span><span class="n">dir</span><span class="o">,</span> <span class="n">attrs</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">FileVisitResult</span> <span class="nf">visitFile</span><span class="o">(</span><span class="nc">Path</span> <span class="n">file</span><span class="o">,</span> <span class="nc">BasicFileAttributes</span> <span class="n">attrs</span><span class="o">)</span> 
            <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">file</span><span class="o">);</span>
            <span class="n">fileCount</span><span class="o">.</span><span class="na">incrementAndGet</span><span class="o">();</span>
            <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">visitFile</span><span class="o">(</span><span class="n">file</span><span class="o">,</span> <span class="n">attrs</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">});</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">dirCount</span><span class="o">);</span> <span class="c1">// 133</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">fileCount</span><span class="o">);</span> <span class="c1">// 1479</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç»Ÿè®¡ jar çš„æ•°ç›®</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="nc">Path</span> <span class="n">path</span> <span class="o">=</span> <span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"C:\\Program Files\\Java\\jdk1.8.0_91"</span><span class="o">);</span>
<span class="nc">AtomicInteger</span> <span class="n">fileCount</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicInteger</span><span class="o">();</span>
<span class="nc">Files</span><span class="o">.</span><span class="na">walkFileTree</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="k">new</span> <span class="nc">SimpleFileVisitor</span><span class="o">&lt;</span><span class="nc">Path</span><span class="o">&gt;(){</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">FileVisitResult</span> <span class="nf">visitFile</span><span class="o">(</span><span class="nc">Path</span> <span class="n">file</span><span class="o">,</span> <span class="nc">BasicFileAttributes</span> <span class="n">attrs</span><span class="o">)</span> 
        <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">toFile</span><span class="o">().</span><span class="na">getName</span><span class="o">().</span><span class="na">endsWith</span><span class="o">(</span><span class="s">".jar"</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">fileCount</span><span class="o">.</span><span class="na">incrementAndGet</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">visitFile</span><span class="o">(</span><span class="n">file</span><span class="o">,</span> <span class="n">attrs</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">});</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">fileCount</span><span class="o">);</span> <span class="c1">// 724</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åˆ é™¤å¤šçº§ç›®å½•</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="nc">Path</span> <span class="n">path</span> <span class="o">=</span> <span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"d:\\a"</span><span class="o">);</span>
<span class="nc">Files</span><span class="o">.</span><span class="na">walkFileTree</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="k">new</span> <span class="nc">SimpleFileVisitor</span><span class="o">&lt;</span><span class="nc">Path</span><span class="o">&gt;(){</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">FileVisitResult</span> <span class="nf">visitFile</span><span class="o">(</span><span class="nc">Path</span> <span class="n">file</span><span class="o">,</span> <span class="nc">BasicFileAttributes</span> <span class="n">attrs</span><span class="o">)</span> 
        <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">Files</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">file</span><span class="o">);</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">visitFile</span><span class="o">(</span><span class="n">file</span><span class="o">,</span> <span class="n">attrs</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">FileVisitResult</span> <span class="nf">postVisitDirectory</span><span class="o">(</span><span class="nc">Path</span> <span class="n">dir</span><span class="o">,</span> <span class="nc">IOException</span> <span class="n">exc</span><span class="o">)</span> 
        <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">Files</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">dir</span><span class="o">);</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">postVisitDirectory</span><span class="o">(</span><span class="n">dir</span><span class="o">,</span> <span class="n">exc</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">});</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="ï¸-åˆ é™¤å¾ˆå±é™©">âš ï¸ åˆ é™¤å¾ˆå±é™©</h4>

<blockquote>
  <p>åˆ é™¤æ˜¯å±é™©æ“ä½œï¼Œç¡®ä¿è¦é€’å½’åˆ é™¤çš„æ–‡ä»¶å¤¹æ²¡æœ‰é‡è¦å†…å®¹</p>
</blockquote>

<p>æ‹·è´å¤šçº§ç›®å½•</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
<span class="nc">String</span> <span class="n">source</span> <span class="o">=</span> <span class="s">"D:\\Snipaste-1.16.2-x64"</span><span class="o">;</span>
<span class="nc">String</span> <span class="n">target</span> <span class="o">=</span> <span class="s">"D:\\Snipaste-1.16.2-x64aaa"</span><span class="o">;</span>

<span class="nc">Files</span><span class="o">.</span><span class="na">walk</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">source</span><span class="o">)).</span><span class="na">forEach</span><span class="o">(</span><span class="n">path</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">targetName</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="na">toString</span><span class="o">().</span><span class="na">replace</span><span class="o">(</span><span class="n">source</span><span class="o">,</span> <span class="n">target</span><span class="o">);</span>
        <span class="c1">// æ˜¯ç›®å½•</span>
        <span class="k">if</span> <span class="o">(</span><span class="nc">Files</span><span class="o">.</span><span class="na">isDirectory</span><span class="o">(</span><span class="n">path</span><span class="o">))</span> <span class="o">{</span>
            <span class="nc">Files</span><span class="o">.</span><span class="na">createDirectory</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">targetName</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="c1">// æ˜¯æ™®é€šæ–‡ä»¶</span>
        <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="nc">Files</span><span class="o">.</span><span class="na">isRegularFile</span><span class="o">(</span><span class="n">path</span><span class="o">))</span> <span class="o">{</span>
            <span class="nc">Files</span><span class="o">.</span><span class="na">copy</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">targetName</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">});</span>
<span class="kt">long</span> <span class="n">end</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="4-ç½‘ç»œç¼–ç¨‹">4. ç½‘ç»œç¼–ç¨‹</h2>

<h3 id="41-éé˜»å¡-vs-é˜»å¡">4.1 éé˜»å¡ vs é˜»å¡</h3>

<h4 id="é˜»å¡">é˜»å¡</h4>

<ul>
  <li>é˜»å¡æ¨¡å¼ä¸‹ï¼Œç›¸å…³æ–¹æ³•éƒ½ä¼šå¯¼è‡´çº¿ç¨‹æš‚åœ
    <ul>
      <li>ServerSocketChannel.accept ä¼šåœ¨æ²¡æœ‰è¿æ¥å»ºç«‹æ—¶è®©çº¿ç¨‹æš‚åœ</li>
      <li>SocketChannel.read ä¼šåœ¨æ²¡æœ‰æ•°æ®å¯è¯»æ—¶è®©çº¿ç¨‹æš‚åœ</li>
      <li>é˜»å¡çš„è¡¨ç°å…¶å®å°±æ˜¯çº¿ç¨‹æš‚åœäº†ï¼Œæš‚åœæœŸé—´ä¸ä¼šå ç”¨ cpuï¼Œä½†çº¿ç¨‹ç›¸å½“äºé—²ç½®</li>
    </ul>
  </li>
  <li>å•çº¿ç¨‹ä¸‹ï¼Œé˜»å¡æ–¹æ³•ä¹‹é—´ç›¸äº’å½±å“ï¼Œå‡ ä¹ä¸èƒ½æ­£å¸¸å·¥ä½œï¼Œéœ€è¦å¤šçº¿ç¨‹æ”¯æŒ</li>
  <li>ä½†å¤šçº¿ç¨‹ä¸‹ï¼Œæœ‰æ–°çš„é—®é¢˜ï¼Œä½“ç°åœ¨ä»¥ä¸‹æ–¹é¢
    <ul>
      <li>32 ä½ jvm ä¸€ä¸ªçº¿ç¨‹ 320kï¼Œ64 ä½ jvm ä¸€ä¸ªçº¿ç¨‹ 1024kï¼Œå¦‚æœè¿æ¥æ•°è¿‡å¤šï¼Œå¿…ç„¶å¯¼è‡´ OOMï¼Œå¹¶ä¸”çº¿ç¨‹å¤ªå¤šï¼Œåè€Œä¼šå› ä¸ºé¢‘ç¹ä¸Šä¸‹æ–‡åˆ‡æ¢å¯¼è‡´æ€§èƒ½é™ä½</li>
      <li>å¯ä»¥é‡‡ç”¨çº¿ç¨‹æ± æŠ€æœ¯æ¥å‡å°‘çº¿ç¨‹æ•°å’Œçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä½†æ²»æ ‡ä¸æ²»æœ¬ï¼Œå¦‚æœæœ‰å¾ˆå¤šè¿æ¥å»ºç«‹ï¼Œä½†é•¿æ—¶é—´ inactiveï¼Œä¼šé˜»å¡çº¿ç¨‹æ± ä¸­æ‰€æœ‰çº¿ç¨‹ï¼Œå› æ­¤ä¸é€‚åˆé•¿è¿æ¥ï¼Œåªé€‚åˆçŸ­è¿æ¥</li>
    </ul>
  </li>
</ul>

<p>æœåŠ¡å™¨ç«¯</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre><span class="c1">// ä½¿ç”¨ nio æ¥ç†è§£é˜»å¡æ¨¡å¼, å•çº¿ç¨‹</span>
<span class="c1">// 0. ByteBuffer</span>
<span class="nc">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">16</span><span class="o">);</span>
<span class="c1">// 1. åˆ›å»ºäº†æœåŠ¡å™¨</span>
<span class="nc">ServerSocketChannel</span> <span class="n">ssc</span> <span class="o">=</span> <span class="nc">ServerSocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>

<span class="c1">// 2. ç»‘å®šç›‘å¬ç«¯å£</span>
<span class="n">ssc</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="mi">8080</span><span class="o">));</span>

<span class="c1">// 3. è¿æ¥é›†åˆ</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">SocketChannel</span><span class="o">&gt;</span> <span class="n">channels</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
<span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// 4. accept å»ºç«‹ä¸å®¢æˆ·ç«¯è¿æ¥ï¼Œ SocketChannel ç”¨æ¥ä¸å®¢æˆ·ç«¯ä¹‹é—´é€šä¿¡</span>
    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"connecting..."</span><span class="o">);</span>
    <span class="nc">SocketChannel</span> <span class="n">sc</span> <span class="o">=</span> <span class="n">ssc</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span> <span class="c1">// é˜»å¡æ–¹æ³•ï¼Œçº¿ç¨‹åœæ­¢è¿è¡Œ</span>
    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"connected... {}"</span><span class="o">,</span> <span class="n">sc</span><span class="o">);</span>
    <span class="n">channels</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">sc</span><span class="o">);</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">SocketChannel</span> <span class="n">channel</span> <span class="o">:</span> <span class="n">channels</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 5. æ¥æ”¶å®¢æˆ·ç«¯å‘é€çš„æ•°æ®</span>
        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"before read... {}"</span><span class="o">,</span> <span class="n">channel</span><span class="o">);</span>
        <span class="n">channel</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span> <span class="c1">// é˜»å¡æ–¹æ³•ï¼Œçº¿ç¨‹åœæ­¢è¿è¡Œ</span>
        <span class="n">buffer</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
        <span class="n">debugRead</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
        <span class="n">buffer</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"after read...{}"</span><span class="o">,</span> <span class="n">channel</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å®¢æˆ·ç«¯</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nc">SocketChannel</span> <span class="n">sc</span> <span class="o">=</span> <span class="nc">SocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
<span class="n">sc</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="mi">8080</span><span class="o">));</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"waiting..."</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="éé˜»å¡">éé˜»å¡</h4>

<ul>
  <li>éé˜»å¡æ¨¡å¼ä¸‹ï¼Œç›¸å…³æ–¹æ³•éƒ½ä¼šä¸ä¼šè®©çº¿ç¨‹æš‚åœ
    <ul>
      <li>åœ¨ ServerSocketChannel.accept åœ¨æ²¡æœ‰è¿æ¥å»ºç«‹æ—¶ï¼Œä¼šè¿”å› nullï¼Œç»§ç»­è¿è¡Œ</li>
      <li>SocketChannel.read åœ¨æ²¡æœ‰æ•°æ®å¯è¯»æ—¶ï¼Œä¼šè¿”å› 0ï¼Œä½†çº¿ç¨‹ä¸å¿…é˜»å¡ï¼Œå¯ä»¥å»æ‰§è¡Œå…¶å®ƒ SocketChannel çš„ read æˆ–æ˜¯å»æ‰§è¡Œ ServerSocketChannel.accept</li>
      <li>å†™æ•°æ®æ—¶ï¼Œçº¿ç¨‹åªæ˜¯ç­‰å¾…æ•°æ®å†™å…¥ Channel å³å¯ï¼Œæ— éœ€ç­‰ Channel é€šè¿‡ç½‘ç»œæŠŠæ•°æ®å‘é€å‡ºå»</li>
    </ul>
  </li>
  <li>ä½†éé˜»å¡æ¨¡å¼ä¸‹ï¼Œå³ä½¿æ²¡æœ‰è¿æ¥å»ºç«‹ï¼Œå’Œå¯è¯»æ•°æ®ï¼Œçº¿ç¨‹ä»ç„¶åœ¨ä¸æ–­è¿è¡Œï¼Œç™½ç™½æµªè´¹äº† cpu</li>
  <li>æ•°æ®å¤åˆ¶è¿‡ç¨‹ä¸­ï¼Œçº¿ç¨‹å®é™…è¿˜æ˜¯é˜»å¡çš„ï¼ˆAIO æ”¹è¿›çš„åœ°æ–¹ï¼‰</li>
</ul>

<p>æœåŠ¡å™¨ç«¯ï¼Œå®¢æˆ·ç«¯ä»£ç ä¸å˜</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre><span class="c1">// ä½¿ç”¨ nio æ¥ç†è§£éé˜»å¡æ¨¡å¼, å•çº¿ç¨‹</span>
<span class="c1">// 0. ByteBuffer</span>
<span class="nc">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">16</span><span class="o">);</span>
<span class="c1">// 1. åˆ›å»ºäº†æœåŠ¡å™¨</span>
<span class="nc">ServerSocketChannel</span> <span class="n">ssc</span> <span class="o">=</span> <span class="nc">ServerSocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
<span class="n">ssc</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span> <span class="c1">// éé˜»å¡æ¨¡å¼</span>
<span class="c1">// 2. ç»‘å®šç›‘å¬ç«¯å£</span>
<span class="n">ssc</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="mi">8080</span><span class="o">));</span>
<span class="c1">// 3. è¿æ¥é›†åˆ</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">SocketChannel</span><span class="o">&gt;</span> <span class="n">channels</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
<span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// 4. accept å»ºç«‹ä¸å®¢æˆ·ç«¯è¿æ¥ï¼Œ SocketChannel ç”¨æ¥ä¸å®¢æˆ·ç«¯ä¹‹é—´é€šä¿¡</span>
    <span class="nc">SocketChannel</span> <span class="n">sc</span> <span class="o">=</span> <span class="n">ssc</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span> <span class="c1">// éé˜»å¡ï¼Œçº¿ç¨‹è¿˜ä¼šç»§ç»­è¿è¡Œï¼Œå¦‚æœæ²¡æœ‰è¿æ¥å»ºç«‹ï¼Œä½†scæ˜¯null</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">sc</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"connected... {}"</span><span class="o">,</span> <span class="n">sc</span><span class="o">);</span>
        <span class="n">sc</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span> <span class="c1">// éé˜»å¡æ¨¡å¼</span>
        <span class="n">channels</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">sc</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">SocketChannel</span> <span class="n">channel</span> <span class="o">:</span> <span class="n">channels</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 5. æ¥æ”¶å®¢æˆ·ç«¯å‘é€çš„æ•°æ®</span>
        <span class="kt">int</span> <span class="n">read</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span><span class="c1">// éé˜»å¡ï¼Œçº¿ç¨‹ä»ç„¶ä¼šç»§ç»­è¿è¡Œï¼Œå¦‚æœæ²¡æœ‰è¯»åˆ°æ•°æ®ï¼Œread è¿”å› 0</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">read</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">buffer</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
            <span class="n">debugRead</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
            <span class="n">buffer</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"after read...{}"</span><span class="o">,</span> <span class="n">channel</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="å¤šè·¯å¤ç”¨">å¤šè·¯å¤ç”¨</h4>

<p>å•çº¿ç¨‹å¯ä»¥é…åˆ Selector å®Œæˆå¯¹å¤šä¸ª Channel å¯è¯»å†™äº‹ä»¶çš„ç›‘æ§ï¼Œè¿™ç§°ä¹‹ä¸ºå¤šè·¯å¤ç”¨</p>

<ul>
  <li>å¤šè·¯å¤ç”¨ä»…é’ˆå¯¹ç½‘ç»œ IOã€æ™®é€šæ–‡ä»¶ IO æ²¡æ³•åˆ©ç”¨å¤šè·¯å¤ç”¨</li>
  <li>å¦‚æœä¸ç”¨ Selector çš„éé˜»å¡æ¨¡å¼ï¼Œçº¿ç¨‹å¤§éƒ¨åˆ†æ—¶é—´éƒ½åœ¨åšæ— ç”¨åŠŸï¼Œè€Œ Selector èƒ½å¤Ÿä¿è¯
    <ul>
      <li>æœ‰å¯è¿æ¥äº‹ä»¶æ—¶æ‰å»è¿æ¥</li>
      <li>æœ‰å¯è¯»äº‹ä»¶æ‰å»è¯»å–</li>
      <li>æœ‰å¯å†™äº‹ä»¶æ‰å»å†™å…¥
        <ul>
          <li>é™äºç½‘ç»œä¼ è¾“èƒ½åŠ›ï¼ŒChannel æœªå¿…æ—¶æ—¶å¯å†™ï¼Œä¸€æ—¦ Channel å¯å†™ï¼Œä¼šè§¦å‘ Selector çš„å¯å†™äº‹ä»¶</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h3 id="42-selector">4.2 Selector</h3>

<pre><code class="language-mermaid">graph TD
subgraph selector ç‰ˆ
thread --&gt; selector
selector --&gt; c1(channel)
selector --&gt; c2(channel)
selector --&gt; c3(channel)
end
</code></pre>

<p>å¥½å¤„</p>

<ul>
  <li>ä¸€ä¸ªçº¿ç¨‹é…åˆ selector å°±å¯ä»¥ç›‘æ§å¤šä¸ª channel çš„äº‹ä»¶ï¼Œäº‹ä»¶å‘ç”Ÿçº¿ç¨‹æ‰å»å¤„ç†ã€‚é¿å…éé˜»å¡æ¨¡å¼ä¸‹æ‰€åšæ— ç”¨åŠŸ</li>
  <li>è®©è¿™ä¸ªçº¿ç¨‹èƒ½å¤Ÿè¢«å……åˆ†åˆ©ç”¨</li>
  <li>èŠ‚çº¦äº†çº¿ç¨‹çš„æ•°é‡</li>
  <li>å‡å°‘äº†çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢</li>
</ul>

<h4 id="åˆ›å»º">åˆ›å»º</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nc">Selector</span> <span class="n">selector</span> <span class="o">=</span> <span class="nc">Selector</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="ç»‘å®š-channel-äº‹ä»¶">ç»‘å®š Channel äº‹ä»¶</h4>

<p>ä¹Ÿç§°ä¹‹ä¸ºæ³¨å†Œäº‹ä»¶ï¼Œç»‘å®šçš„äº‹ä»¶ selector æ‰ä¼šå…³å¿ƒ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">channel</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
<span class="nc">SelectionKey</span> <span class="n">key</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">selector</span><span class="o">,</span> <span class="n">ç»‘å®šäº‹ä»¶</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>channel å¿…é¡»å·¥ä½œåœ¨éé˜»å¡æ¨¡å¼</li>
  <li>FileChannel æ²¡æœ‰éé˜»å¡æ¨¡å¼ï¼Œå› æ­¤ä¸èƒ½é…åˆ selector ä¸€èµ·ä½¿ç”¨</li>
  <li>ç»‘å®šçš„äº‹ä»¶ç±»å‹å¯ä»¥æœ‰
    <ul>
      <li>connect - å®¢æˆ·ç«¯è¿æ¥æˆåŠŸæ—¶è§¦å‘</li>
      <li>accept - æœåŠ¡å™¨ç«¯æˆåŠŸæ¥å—è¿æ¥æ—¶è§¦å‘</li>
      <li>read - æ•°æ®å¯è¯»å…¥æ—¶è§¦å‘ï¼Œæœ‰å› ä¸ºæ¥æ”¶èƒ½åŠ›å¼±ï¼Œæ•°æ®æš‚ä¸èƒ½è¯»å…¥çš„æƒ…å†µ</li>
      <li>write - æ•°æ®å¯å†™å‡ºæ—¶è§¦å‘ï¼Œæœ‰å› ä¸ºå‘é€èƒ½åŠ›å¼±ï¼Œæ•°æ®æš‚ä¸èƒ½å†™å‡ºçš„æƒ…å†µ</li>
    </ul>
  </li>
</ul>

<h4 id="ç›‘å¬-channel-äº‹ä»¶">ç›‘å¬ Channel äº‹ä»¶</h4>

<p>å¯ä»¥é€šè¿‡ä¸‹é¢ä¸‰ç§æ–¹æ³•æ¥ç›‘å¬æ˜¯å¦æœ‰äº‹ä»¶å‘ç”Ÿï¼Œæ–¹æ³•çš„è¿”å›å€¼ä»£è¡¨æœ‰å¤šå°‘ channel å‘ç”Ÿäº†äº‹ä»¶</p>

<p>æ–¹æ³•1ï¼Œé˜»å¡ç›´åˆ°ç»‘å®šäº‹ä»¶å‘ç”Ÿ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="na">select</span><span class="o">();</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ–¹æ³•2ï¼Œé˜»å¡ç›´åˆ°ç»‘å®šäº‹ä»¶å‘ç”Ÿï¼Œæˆ–æ˜¯è¶…æ—¶ï¼ˆæ—¶é—´å•ä½ä¸º msï¼‰</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="kt">long</span> <span class="n">timeout</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ–¹æ³•3ï¼Œä¸ä¼šé˜»å¡ï¼Œä¹Ÿå°±æ˜¯ä¸ç®¡æœ‰æ²¡æœ‰äº‹ä»¶ï¼Œç«‹åˆ»è¿”å›ï¼Œè‡ªå·±æ ¹æ®è¿”å›å€¼æ£€æŸ¥æ˜¯å¦æœ‰äº‹ä»¶</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="na">selectNow</span><span class="o">();</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="-select-ä½•æ—¶ä¸é˜»å¡">ğŸ’¡ select ä½•æ—¶ä¸é˜»å¡</h4>

<blockquote>
  <ul>
    <li>äº‹ä»¶å‘ç”Ÿæ—¶
      <ul>
        <li>å®¢æˆ·ç«¯å‘èµ·è¿æ¥è¯·æ±‚ï¼Œä¼šè§¦å‘ accept äº‹ä»¶</li>
        <li>å®¢æˆ·ç«¯å‘é€æ•°æ®è¿‡æ¥ï¼Œå®¢æˆ·ç«¯æ­£å¸¸ã€å¼‚å¸¸å…³é—­æ—¶ï¼Œéƒ½ä¼šè§¦å‘ read äº‹ä»¶ï¼Œå¦å¤–å¦‚æœå‘é€çš„æ•°æ®å¤§äº buffer ç¼“å†²åŒºï¼Œä¼šè§¦å‘å¤šæ¬¡è¯»å–äº‹ä»¶</li>
        <li>channel å¯å†™ï¼Œä¼šè§¦å‘ write äº‹ä»¶</li>
        <li>åœ¨ linux ä¸‹ nio bug å‘ç”Ÿæ—¶</li>
      </ul>
    </li>
    <li>è°ƒç”¨ selector.wakeup()</li>
    <li>è°ƒç”¨ selector.close()</li>
    <li>selector æ‰€åœ¨çº¿ç¨‹ interrupt</li>
  </ul>
</blockquote>

<h3 id="43-å¤„ç†-accept-äº‹ä»¶">4.3 å¤„ç† accept äº‹ä»¶</h3>

<p>å®¢æˆ·ç«¯ä»£ç ä¸º</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Client</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">(</span><span class="nc">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Socket</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="mi">8080</span><span class="o">))</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">socket</span><span class="o">);</span>
            <span class="n">socket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="s">"world"</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">in</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æœåŠ¡å™¨ç«¯ä»£ç ä¸º</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre></td><td class="rouge-code"><pre><span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ChannelDemo6</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">(</span><span class="nc">ServerSocketChannel</span> <span class="n">channel</span> <span class="o">=</span> <span class="nc">ServerSocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">channel</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="mi">8080</span><span class="o">));</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">channel</span><span class="o">);</span>
            <span class="nc">Selector</span> <span class="n">selector</span> <span class="o">=</span> <span class="nc">Selector</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
            <span class="n">channel</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
            <span class="n">channel</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">selector</span><span class="o">,</span> <span class="nc">SelectionKey</span><span class="o">.</span><span class="na">OP_ACCEPT</span><span class="o">);</span>

            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="na">select</span><span class="o">();</span>
<span class="c1">//                int count = selector.selectNow();</span>
                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"select count: {}"</span><span class="o">,</span> <span class="n">count</span><span class="o">);</span>
<span class="c1">//                if(count &lt;= 0) {</span>
<span class="c1">//                    continue;</span>
<span class="c1">//                }</span>

                <span class="c1">// è·å–æ‰€æœ‰äº‹ä»¶</span>
                <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">SelectionKey</span><span class="o">&gt;</span> <span class="n">keys</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="na">selectedKeys</span><span class="o">();</span>

                <span class="c1">// éå†æ‰€æœ‰äº‹ä»¶ï¼Œé€ä¸€å¤„ç†</span>
                <span class="nc">Iterator</span><span class="o">&lt;</span><span class="nc">SelectionKey</span><span class="o">&gt;</span> <span class="n">iter</span> <span class="o">=</span> <span class="n">keys</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>
                <span class="k">while</span> <span class="o">(</span><span class="n">iter</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
                    <span class="nc">SelectionKey</span> <span class="n">key</span> <span class="o">=</span> <span class="n">iter</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
                    <span class="c1">// åˆ¤æ–­äº‹ä»¶ç±»å‹</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">isAcceptable</span><span class="o">())</span> <span class="o">{</span>
                        <span class="nc">ServerSocketChannel</span> <span class="n">c</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ServerSocketChannel</span><span class="o">)</span> <span class="n">key</span><span class="o">.</span><span class="na">channel</span><span class="o">();</span>
                        <span class="c1">// å¿…é¡»å¤„ç†</span>
                        <span class="nc">SocketChannel</span> <span class="n">sc</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>
                        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"{}"</span><span class="o">,</span> <span class="n">sc</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="c1">// å¤„ç†å®Œæ¯•ï¼Œå¿…é¡»å°†äº‹ä»¶ç§»é™¤</span>
                    <span class="n">iter</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="-äº‹ä»¶å‘ç”Ÿåèƒ½å¦ä¸å¤„ç†">ğŸ’¡ äº‹ä»¶å‘ç”Ÿåèƒ½å¦ä¸å¤„ç†</h4>

<blockquote>
  <p>äº‹ä»¶å‘ç”Ÿåï¼Œè¦ä¹ˆå¤„ç†ï¼Œè¦ä¹ˆå–æ¶ˆï¼ˆcancelï¼‰ï¼Œä¸èƒ½ä»€ä¹ˆéƒ½ä¸åšï¼Œå¦åˆ™ä¸‹æ¬¡è¯¥äº‹ä»¶ä»ä¼šè§¦å‘ï¼Œè¿™æ˜¯å› ä¸º nio åº•å±‚ä½¿ç”¨çš„æ˜¯æ°´å¹³è§¦å‘</p>
</blockquote>

<h3 id="44-å¤„ç†-read-äº‹ä»¶">4.4 å¤„ç† read äº‹ä»¶</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
</pre></td><td class="rouge-code"><pre><span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ChannelDemo6</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">(</span><span class="nc">ServerSocketChannel</span> <span class="n">channel</span> <span class="o">=</span> <span class="nc">ServerSocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">channel</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="mi">8080</span><span class="o">));</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">channel</span><span class="o">);</span>
            <span class="nc">Selector</span> <span class="n">selector</span> <span class="o">=</span> <span class="nc">Selector</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
            <span class="n">channel</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
            <span class="n">channel</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">selector</span><span class="o">,</span> <span class="nc">SelectionKey</span><span class="o">.</span><span class="na">OP_ACCEPT</span><span class="o">);</span>

            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="na">select</span><span class="o">();</span>
<span class="c1">//                int count = selector.selectNow();</span>
                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"select count: {}"</span><span class="o">,</span> <span class="n">count</span><span class="o">);</span>
<span class="c1">//                if(count &lt;= 0) {</span>
<span class="c1">//                    continue;</span>
<span class="c1">//                }</span>

                <span class="c1">// è·å–æ‰€æœ‰äº‹ä»¶</span>
                <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">SelectionKey</span><span class="o">&gt;</span> <span class="n">keys</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="na">selectedKeys</span><span class="o">();</span>

                <span class="c1">// éå†æ‰€æœ‰äº‹ä»¶ï¼Œé€ä¸€å¤„ç†</span>
                <span class="nc">Iterator</span><span class="o">&lt;</span><span class="nc">SelectionKey</span><span class="o">&gt;</span> <span class="n">iter</span> <span class="o">=</span> <span class="n">keys</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>
                <span class="k">while</span> <span class="o">(</span><span class="n">iter</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
                    <span class="nc">SelectionKey</span> <span class="n">key</span> <span class="o">=</span> <span class="n">iter</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
                    <span class="c1">// åˆ¤æ–­äº‹ä»¶ç±»å‹</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">isAcceptable</span><span class="o">())</span> <span class="o">{</span>
                        <span class="nc">ServerSocketChannel</span> <span class="n">c</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ServerSocketChannel</span><span class="o">)</span> <span class="n">key</span><span class="o">.</span><span class="na">channel</span><span class="o">();</span>
                        <span class="c1">// å¿…é¡»å¤„ç†</span>
                        <span class="nc">SocketChannel</span> <span class="n">sc</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>
                        <span class="n">sc</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
                        <span class="n">sc</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">selector</span><span class="o">,</span> <span class="nc">SelectionKey</span><span class="o">.</span><span class="na">OP_READ</span><span class="o">);</span>
                        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"è¿æ¥å·²å»ºç«‹: {}"</span><span class="o">,</span> <span class="n">sc</span><span class="o">);</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">isReadable</span><span class="o">())</span> <span class="o">{</span>
                        <span class="nc">SocketChannel</span> <span class="n">sc</span> <span class="o">=</span> <span class="o">(</span><span class="nc">SocketChannel</span><span class="o">)</span> <span class="n">key</span><span class="o">.</span><span class="na">channel</span><span class="o">();</span>
                        <span class="nc">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">128</span><span class="o">);</span>
                        <span class="kt">int</span> <span class="n">read</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
                        <span class="k">if</span><span class="o">(</span><span class="n">read</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">key</span><span class="o">.</span><span class="na">cancel</span><span class="o">();</span>
                            <span class="n">sc</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                            <span class="n">buffer</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
                            <span class="n">debug</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                    <span class="c1">// å¤„ç†å®Œæ¯•ï¼Œå¿…é¡»å°†äº‹ä»¶ç§»é™¤</span>
                    <span class="n">iter</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¼€å¯ä¸¤ä¸ªå®¢æˆ·ç«¯ï¼Œä¿®æ”¹ä¸€ä¸‹å‘é€æ–‡å­—ï¼Œè¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre>sun.nio.ch.ServerSocketChannelImpl[/0:0:0:0:0:0:0:0:8080]
21:16:39 [DEBUG] [main] c.i.n.ChannelDemo6 - select count: 1
21:16:39 [DEBUG] [main] c.i.n.ChannelDemo6 - è¿æ¥å·²å»ºç«‹: java.nio.channels.SocketChannel[connected local=/127.0.0.1:8080 remote=/127.0.0.1:60367]
21:16:39 [DEBUG] [main] c.i.n.ChannelDemo6 - select count: 1
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 68 65 6c 6c 6f                                  |hello           |
+--------+-------------------------------------------------+----------------+
21:16:59 [DEBUG] [main] c.i.n.ChannelDemo6 - select count: 1
21:16:59 [DEBUG] [main] c.i.n.ChannelDemo6 - è¿æ¥å·²å»ºç«‹: java.nio.channels.SocketChannel[connected local=/127.0.0.1:8080 remote=/127.0.0.1:60378]
21:16:59 [DEBUG] [main] c.i.n.ChannelDemo6 - select count: 1
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 77 6f 72 6c 64                                  |world           |
+--------+-------------------------------------------------+----------------+
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="-ä¸ºä½•è¦-iterremove">ğŸ’¡ ä¸ºä½•è¦ iter.remove()</h4>

<blockquote>
  <p>å› ä¸º select åœ¨äº‹ä»¶å‘ç”Ÿåï¼Œå°±ä¼šå°†ç›¸å…³çš„ key æ”¾å…¥ selectedKeys é›†åˆï¼Œä½†ä¸ä¼šåœ¨å¤„ç†å®Œåä» selectedKeys é›†åˆä¸­ç§»é™¤ï¼Œéœ€è¦æˆ‘ä»¬è‡ªå·±ç¼–ç åˆ é™¤ã€‚ä¾‹å¦‚</p>

  <ul>
    <li>ç¬¬ä¸€æ¬¡è§¦å‘äº† ssckey ä¸Šçš„ accept äº‹ä»¶ï¼Œæ²¡æœ‰ç§»é™¤ ssckey</li>
    <li>ç¬¬äºŒæ¬¡è§¦å‘äº† sckey ä¸Šçš„ read äº‹ä»¶ï¼Œä½†è¿™æ—¶ selectedKeys ä¸­è¿˜æœ‰ä¸Šæ¬¡çš„ ssckey ï¼Œåœ¨å¤„ç†æ—¶å› ä¸ºæ²¡æœ‰çœŸæ­£çš„ serverSocket è¿ä¸Šäº†ï¼Œå°±ä¼šå¯¼è‡´ç©ºæŒ‡é’ˆå¼‚å¸¸</li>
  </ul>
</blockquote>

<h4 id="-cancel-çš„ä½œç”¨">ğŸ’¡ cancel çš„ä½œç”¨</h4>

<blockquote>
  <p>cancel ä¼šå–æ¶ˆæ³¨å†Œåœ¨ selector ä¸Šçš„ channelï¼Œå¹¶ä» keys é›†åˆä¸­åˆ é™¤ key åç»­ä¸ä¼šå†ç›‘å¬äº‹ä»¶</p>
</blockquote>

<h4 id="ï¸--ä¸å¤„ç†è¾¹ç•Œçš„é—®é¢˜">âš ï¸  ä¸å¤„ç†è¾¹ç•Œçš„é—®é¢˜</h4>

<p>ä»¥å‰æœ‰åŒå­¦å†™è¿‡è¿™æ ·çš„ä»£ç ï¼Œæ€è€ƒæ³¨é‡Šä¸­ä¸¤ä¸ªé—®é¢˜ï¼Œä»¥ bio ä¸ºä¾‹ï¼Œå…¶å® nio é“ç†æ˜¯ä¸€æ ·çš„</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Server</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">ServerSocket</span> <span class="n">ss</span><span class="o">=</span><span class="k">new</span> <span class="nc">ServerSocket</span><span class="o">(</span><span class="mi">9000</span><span class="o">);</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Socket</span> <span class="n">s</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>
            <span class="nc">InputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">();</span>
            <span class="c1">// è¿™é‡Œè¿™ä¹ˆå†™ï¼Œæœ‰æ²¡æœ‰é—®é¢˜</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">arr</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">4</span><span class="o">];</span>
            <span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">read</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">arr</span><span class="o">);</span>
                <span class="c1">// è¿™é‡Œè¿™ä¹ˆå†™ï¼Œæœ‰æ²¡æœ‰é—®é¢˜</span>
                <span class="k">if</span><span class="o">(</span><span class="n">read</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">arr</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">read</span><span class="o">));</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å®¢æˆ·ç«¯</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Client</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">Socket</span> <span class="n">max</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Socket</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="mi">9000</span><span class="o">);</span>
        <span class="nc">OutputStream</span> <span class="n">out</span> <span class="o">=</span> <span class="n">max</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">();</span>
        <span class="n">out</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"hello"</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
        <span class="n">out</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"world"</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
        <span class="n">out</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"ä½ å¥½"</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
        <span class="n">max</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>hell
owor
ldï¿½
ï¿½å¥½

</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä¸ºä»€ä¹ˆï¼Ÿ</p>

<h4 id="å¤„ç†æ¶ˆæ¯çš„è¾¹ç•Œ">å¤„ç†æ¶ˆæ¯çš„è¾¹ç•Œ</h4>

<p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0023.png" alt="" /></p>

<ul>
  <li>ä¸€ç§æ€è·¯æ˜¯å›ºå®šæ¶ˆæ¯é•¿åº¦ï¼Œæ•°æ®åŒ…å¤§å°ä¸€æ ·ï¼ŒæœåŠ¡å™¨æŒ‰é¢„å®šé•¿åº¦è¯»å–ï¼Œç¼ºç‚¹æ˜¯æµªè´¹å¸¦å®½</li>
  <li>å¦ä¸€ç§æ€è·¯æ˜¯æŒ‰åˆ†éš”ç¬¦æ‹†åˆ†ï¼Œç¼ºç‚¹æ˜¯æ•ˆç‡ä½</li>
  <li>TLV æ ¼å¼ï¼Œå³ Type ç±»å‹ã€Length é•¿åº¦ã€Value æ•°æ®ï¼Œç±»å‹å’Œé•¿åº¦å·²çŸ¥çš„æƒ…å†µä¸‹ï¼Œå°±å¯ä»¥æ–¹ä¾¿è·å–æ¶ˆæ¯å¤§å°ï¼Œåˆ†é…åˆé€‚çš„ bufferï¼Œç¼ºç‚¹æ˜¯ buffer éœ€è¦æå‰åˆ†é…ï¼Œå¦‚æœå†…å®¹è¿‡å¤§ï¼Œåˆ™å½±å“ server ååé‡
    <ul>
      <li>Http 1.1 æ˜¯ TLV æ ¼å¼</li>
      <li>Http 2.0 æ˜¯ LTV æ ¼å¼</li>
    </ul>
  </li>
</ul>

<pre><code class="language-mermaid">sequenceDiagram 
participant c1 as å®¢æˆ·ç«¯1
participant s as æœåŠ¡å™¨
participant b1 as ByteBuffer1
participant b2 as ByteBuffer2
c1 -&gt;&gt; s: å‘é€ 01234567890abcdef3333\r
s -&gt;&gt; b1: ç¬¬ä¸€æ¬¡ read å­˜å…¥ 01234567890abcdef
s -&gt;&gt; b2: æ‰©å®¹
b1 -&gt;&gt; b2: æ‹·è´ 01234567890abcdef
s -&gt;&gt; b2: ç¬¬äºŒæ¬¡ read å­˜å…¥ 3333\r
b2 -&gt;&gt; b2: 01234567890abcdef3333\r
</code></pre>

<p>æœåŠ¡å™¨ç«¯</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">split</span><span class="o">(</span><span class="nc">ByteBuffer</span> <span class="n">source</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">source</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">source</span><span class="o">.</span><span class="na">limit</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="c1">// æ‰¾åˆ°ä¸€æ¡å®Œæ•´æ¶ˆæ¯</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">source</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">)</span> <span class="o">==</span> <span class="sc">'\n'</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">source</span><span class="o">.</span><span class="na">position</span><span class="o">();</span>
            <span class="c1">// æŠŠè¿™æ¡å®Œæ•´æ¶ˆæ¯å­˜å…¥æ–°çš„ ByteBuffer</span>
            <span class="nc">ByteBuffer</span> <span class="n">target</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">length</span><span class="o">);</span>
            <span class="c1">// ä» source è¯»ï¼Œå‘ target å†™</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">length</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">target</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">source</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
            <span class="o">}</span>
            <span class="n">debugAll</span><span class="o">(</span><span class="n">target</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">source</span><span class="o">.</span><span class="na">compact</span><span class="o">();</span> <span class="c1">// 0123456789abcdef  position 16 limit 16</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="c1">// 1. åˆ›å»º selector, ç®¡ç†å¤šä¸ª channel</span>
    <span class="nc">Selector</span> <span class="n">selector</span> <span class="o">=</span> <span class="nc">Selector</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
    <span class="nc">ServerSocketChannel</span> <span class="n">ssc</span> <span class="o">=</span> <span class="nc">ServerSocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
    <span class="n">ssc</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
    <span class="c1">// 2. å»ºç«‹ selector å’Œ channel çš„è”ç³»ï¼ˆæ³¨å†Œï¼‰</span>
    <span class="c1">// SelectionKey å°±æ˜¯å°†æ¥äº‹ä»¶å‘ç”Ÿåï¼Œé€šè¿‡å®ƒå¯ä»¥çŸ¥é“äº‹ä»¶å’Œå“ªä¸ªchannelçš„äº‹ä»¶</span>
    <span class="nc">SelectionKey</span> <span class="n">sscKey</span> <span class="o">=</span> <span class="n">ssc</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">selector</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
    <span class="c1">// key åªå…³æ³¨ accept äº‹ä»¶</span>
    <span class="n">sscKey</span><span class="o">.</span><span class="na">interestOps</span><span class="o">(</span><span class="nc">SelectionKey</span><span class="o">.</span><span class="na">OP_ACCEPT</span><span class="o">);</span>
    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"sscKey:{}"</span><span class="o">,</span> <span class="n">sscKey</span><span class="o">);</span>
    <span class="n">ssc</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="mi">8080</span><span class="o">));</span>
    <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 3. select æ–¹æ³•, æ²¡æœ‰äº‹ä»¶å‘ç”Ÿï¼Œçº¿ç¨‹é˜»å¡ï¼Œæœ‰äº‹ä»¶ï¼Œçº¿ç¨‹æ‰ä¼šæ¢å¤è¿è¡Œ</span>
        <span class="c1">// select åœ¨äº‹ä»¶æœªå¤„ç†æ—¶ï¼Œå®ƒä¸ä¼šé˜»å¡, äº‹ä»¶å‘ç”Ÿåè¦ä¹ˆå¤„ç†ï¼Œè¦ä¹ˆå–æ¶ˆï¼Œä¸èƒ½ç½®ä¹‹ä¸ç†</span>
        <span class="n">selector</span><span class="o">.</span><span class="na">select</span><span class="o">();</span>
        <span class="c1">// 4. å¤„ç†äº‹ä»¶, selectedKeys å†…éƒ¨åŒ…å«äº†æ‰€æœ‰å‘ç”Ÿçš„äº‹ä»¶</span>
        <span class="nc">Iterator</span><span class="o">&lt;</span><span class="nc">SelectionKey</span><span class="o">&gt;</span> <span class="n">iter</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="na">selectedKeys</span><span class="o">().</span><span class="na">iterator</span><span class="o">();</span> <span class="c1">// accept, read</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">iter</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">SelectionKey</span> <span class="n">key</span> <span class="o">=</span> <span class="n">iter</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
            <span class="c1">// å¤„ç†key æ—¶ï¼Œè¦ä» selectedKeys é›†åˆä¸­åˆ é™¤ï¼Œå¦åˆ™ä¸‹æ¬¡å¤„ç†å°±ä¼šæœ‰é—®é¢˜</span>
            <span class="n">iter</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"key: {}"</span><span class="o">,</span> <span class="n">key</span><span class="o">);</span>
            <span class="c1">// 5. åŒºåˆ†äº‹ä»¶ç±»å‹</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">isAcceptable</span><span class="o">())</span> <span class="o">{</span> <span class="c1">// å¦‚æœæ˜¯ accept</span>
                <span class="nc">ServerSocketChannel</span> <span class="n">channel</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ServerSocketChannel</span><span class="o">)</span> <span class="n">key</span><span class="o">.</span><span class="na">channel</span><span class="o">();</span>
                <span class="nc">SocketChannel</span> <span class="n">sc</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>
                <span class="n">sc</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
                <span class="nc">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">16</span><span class="o">);</span> <span class="c1">// attachment</span>
                <span class="c1">// å°†ä¸€ä¸ª byteBuffer ä½œä¸ºé™„ä»¶å…³è”åˆ° selectionKey ä¸Š</span>
                <span class="nc">SelectionKey</span> <span class="n">scKey</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">selector</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">buffer</span><span class="o">);</span>
                <span class="n">scKey</span><span class="o">.</span><span class="na">interestOps</span><span class="o">(</span><span class="nc">SelectionKey</span><span class="o">.</span><span class="na">OP_READ</span><span class="o">);</span>
                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"{}"</span><span class="o">,</span> <span class="n">sc</span><span class="o">);</span>
                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"scKey:{}"</span><span class="o">,</span> <span class="n">scKey</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">isReadable</span><span class="o">())</span> <span class="o">{</span> <span class="c1">// å¦‚æœæ˜¯ read</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">SocketChannel</span> <span class="n">channel</span> <span class="o">=</span> <span class="o">(</span><span class="nc">SocketChannel</span><span class="o">)</span> <span class="n">key</span><span class="o">.</span><span class="na">channel</span><span class="o">();</span> <span class="c1">// æ‹¿åˆ°è§¦å‘äº‹ä»¶çš„channel</span>
                    <span class="c1">// è·å– selectionKey ä¸Šå…³è”çš„é™„ä»¶</span>
                    <span class="nc">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ByteBuffer</span><span class="o">)</span> <span class="n">key</span><span class="o">.</span><span class="na">attachment</span><span class="o">();</span>
                    <span class="kt">int</span> <span class="n">read</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span> <span class="c1">// å¦‚æœæ˜¯æ­£å¸¸æ–­å¼€ï¼Œread çš„æ–¹æ³•çš„è¿”å›å€¼æ˜¯ -1</span>
                    <span class="k">if</span><span class="o">(</span><span class="n">read</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">key</span><span class="o">.</span><span class="na">cancel</span><span class="o">();</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="n">split</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
                        <span class="c1">// éœ€è¦æ‰©å®¹</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">position</span><span class="o">()</span> <span class="o">==</span> <span class="n">buffer</span><span class="o">.</span><span class="na">limit</span><span class="o">())</span> <span class="o">{</span>
                            <span class="nc">ByteBuffer</span> <span class="n">newBuffer</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">capacity</span><span class="o">()</span> <span class="o">*</span> <span class="mi">2</span><span class="o">);</span>
                            <span class="n">buffer</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
                            <span class="n">newBuffer</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span> <span class="c1">// 0123456789abcdef3333\n</span>
                            <span class="n">key</span><span class="o">.</span><span class="na">attach</span><span class="o">(</span><span class="n">newBuffer</span><span class="o">);</span>
                        <span class="o">}</span>
                    <span class="o">}</span>

                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                    <span class="n">key</span><span class="o">.</span><span class="na">cancel</span><span class="o">();</span>  <span class="c1">// å› ä¸ºå®¢æˆ·ç«¯æ–­å¼€äº†,å› æ­¤éœ€è¦å°† key å–æ¶ˆï¼ˆä» selector çš„ keys é›†åˆä¸­çœŸæ­£åˆ é™¤ keyï¼‰</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å®¢æˆ·ç«¯</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="nc">SocketChannel</span> <span class="n">sc</span> <span class="o">=</span> <span class="nc">SocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
<span class="n">sc</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="mi">8080</span><span class="o">));</span>
<span class="nc">SocketAddress</span> <span class="n">address</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="na">getLocalAddress</span><span class="o">();</span>
<span class="c1">// sc.write(Charset.defaultCharset().encode("hello\nworld\n"));</span>
<span class="n">sc</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="nc">Charset</span><span class="o">.</span><span class="na">defaultCharset</span><span class="o">().</span><span class="na">encode</span><span class="o">(</span><span class="s">"0123\n456789abcdef"</span><span class="o">));</span>
<span class="n">sc</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="nc">Charset</span><span class="o">.</span><span class="na">defaultCharset</span><span class="o">().</span><span class="na">encode</span><span class="o">(</span><span class="s">"0123456789abcdef3333\n"</span><span class="o">));</span>
<span class="nc">System</span><span class="o">.</span><span class="na">in</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="bytebuffer-å¤§å°åˆ†é…">ByteBuffer å¤§å°åˆ†é…</h4>

<ul>
  <li>æ¯ä¸ª channel éƒ½éœ€è¦è®°å½•å¯èƒ½è¢«åˆ‡åˆ†çš„æ¶ˆæ¯ï¼Œå› ä¸º ByteBuffer ä¸èƒ½è¢«å¤šä¸ª channel å…±åŒä½¿ç”¨ï¼Œå› æ­¤éœ€è¦ä¸ºæ¯ä¸ª channel ç»´æŠ¤ä¸€ä¸ªç‹¬ç«‹çš„ ByteBuffer</li>
  <li>ByteBuffer ä¸èƒ½å¤ªå¤§ï¼Œæ¯”å¦‚ä¸€ä¸ª ByteBuffer 1Mb çš„è¯ï¼Œè¦æ”¯æŒç™¾ä¸‡è¿æ¥å°±è¦ 1Tb å†…å­˜ï¼Œå› æ­¤éœ€è¦è®¾è®¡å¤§å°å¯å˜çš„ ByteBuffer
    <ul>
      <li>ä¸€ç§æ€è·¯æ˜¯é¦–å…ˆåˆ†é…ä¸€ä¸ªè¾ƒå°çš„ bufferï¼Œä¾‹å¦‚ 4kï¼Œå¦‚æœå‘ç°æ•°æ®ä¸å¤Ÿï¼Œå†åˆ†é… 8k çš„ bufferï¼Œå°† 4k buffer å†…å®¹æ‹·è´è‡³ 8k bufferï¼Œä¼˜ç‚¹æ˜¯æ¶ˆæ¯è¿ç»­å®¹æ˜“å¤„ç†ï¼Œç¼ºç‚¹æ˜¯æ•°æ®æ‹·è´è€—è´¹æ€§èƒ½ï¼Œå‚è€ƒå®ç° <a href="http://tutorials.jenkov.com/java-performance/resizable-array.html">http://tutorials.jenkov.com/java-performance/resizable-array.html</a></li>
      <li>å¦ä¸€ç§æ€è·¯æ˜¯ç”¨å¤šä¸ªæ•°ç»„ç»„æˆ bufferï¼Œä¸€ä¸ªæ•°ç»„ä¸å¤Ÿï¼ŒæŠŠå¤šå‡ºæ¥çš„å†…å®¹å†™å…¥æ–°çš„æ•°ç»„ï¼Œä¸å‰é¢çš„åŒºåˆ«æ˜¯æ¶ˆæ¯å­˜å‚¨ä¸è¿ç»­è§£æå¤æ‚ï¼Œä¼˜ç‚¹æ˜¯é¿å…äº†æ‹·è´å¼•èµ·çš„æ€§èƒ½æŸè€—</li>
    </ul>
  </li>
</ul>

<h3 id="45-å¤„ç†-write-äº‹ä»¶">4.5 å¤„ç† write äº‹ä»¶</h3>

<h4 id="ä¸€æ¬¡æ— æ³•å†™å®Œä¾‹å­">ä¸€æ¬¡æ— æ³•å†™å®Œä¾‹å­</h4>

<ul>
  <li>éé˜»å¡æ¨¡å¼ä¸‹ï¼Œæ— æ³•ä¿è¯æŠŠ buffer ä¸­æ‰€æœ‰æ•°æ®éƒ½å†™å…¥ channelï¼Œå› æ­¤éœ€è¦è¿½è¸ª write æ–¹æ³•çš„è¿”å›å€¼ï¼ˆä»£è¡¨å®é™…å†™å…¥å­—èŠ‚æ•°ï¼‰</li>
  <li>ç”¨ selector ç›‘å¬æ‰€æœ‰ channel çš„å¯å†™äº‹ä»¶ï¼Œæ¯ä¸ª channel éƒ½éœ€è¦ä¸€ä¸ª key æ¥è·Ÿè¸ª bufferï¼Œä½†è¿™æ ·åˆä¼šå¯¼è‡´å ç”¨å†…å­˜è¿‡å¤šï¼Œå°±æœ‰ä¸¤é˜¶æ®µç­–ç•¥
    <ul>
      <li>å½“æ¶ˆæ¯å¤„ç†å™¨ç¬¬ä¸€æ¬¡å†™å…¥æ¶ˆæ¯æ—¶ï¼Œæ‰å°† channel æ³¨å†Œåˆ° selector ä¸Š</li>
      <li>selector æ£€æŸ¥ channel ä¸Šçš„å¯å†™äº‹ä»¶ï¼Œå¦‚æœæ‰€æœ‰çš„æ•°æ®å†™å®Œäº†ï¼Œå°±å–æ¶ˆ channel çš„æ³¨å†Œ</li>
      <li>å¦‚æœä¸å–æ¶ˆï¼Œä¼šæ¯æ¬¡å¯å†™å‡ä¼šè§¦å‘ write äº‹ä»¶</li>
    </ul>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">WriteServer</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">ServerSocketChannel</span> <span class="n">ssc</span> <span class="o">=</span> <span class="nc">ServerSocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
        <span class="n">ssc</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
        <span class="n">ssc</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="mi">8080</span><span class="o">));</span>

        <span class="nc">Selector</span> <span class="n">selector</span> <span class="o">=</span> <span class="nc">Selector</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
        <span class="n">ssc</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">selector</span><span class="o">,</span> <span class="nc">SelectionKey</span><span class="o">.</span><span class="na">OP_ACCEPT</span><span class="o">);</span>

        <span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">selector</span><span class="o">.</span><span class="na">select</span><span class="o">();</span>

            <span class="nc">Iterator</span><span class="o">&lt;</span><span class="nc">SelectionKey</span><span class="o">&gt;</span> <span class="n">iter</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="na">selectedKeys</span><span class="o">().</span><span class="na">iterator</span><span class="o">();</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">iter</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
                <span class="nc">SelectionKey</span> <span class="n">key</span> <span class="o">=</span> <span class="n">iter</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
                <span class="n">iter</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">isAcceptable</span><span class="o">())</span> <span class="o">{</span>
                    <span class="nc">SocketChannel</span> <span class="n">sc</span> <span class="o">=</span> <span class="n">ssc</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>
                    <span class="n">sc</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
                    <span class="nc">SelectionKey</span> <span class="n">sckey</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">selector</span><span class="o">,</span> <span class="nc">SelectionKey</span><span class="o">.</span><span class="na">OP_READ</span><span class="o">);</span>
                    <span class="c1">// 1. å‘å®¢æˆ·ç«¯å‘é€å†…å®¹</span>
                    <span class="nc">StringBuilder</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">();</span>
                    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3000000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                        <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"a"</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="nc">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nc">Charset</span><span class="o">.</span><span class="na">defaultCharset</span><span class="o">().</span><span class="na">encode</span><span class="o">(</span><span class="n">sb</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
                    <span class="kt">int</span> <span class="n">write</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
                    <span class="c1">// 3. write è¡¨ç¤ºå®é™…å†™äº†å¤šå°‘å­—èŠ‚</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å®é™…å†™å…¥å­—èŠ‚:"</span> <span class="o">+</span> <span class="n">write</span><span class="o">);</span>
                    <span class="c1">// 4. å¦‚æœæœ‰å‰©ä½™æœªè¯»å­—èŠ‚ï¼Œæ‰éœ€è¦å…³æ³¨å†™äº‹ä»¶</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">hasRemaining</span><span class="o">())</span> <span class="o">{</span>
                        <span class="c1">// read 1  write 4</span>
                        <span class="c1">// åœ¨åŸæœ‰å…³æ³¨äº‹ä»¶çš„åŸºç¡€ä¸Šï¼Œå¤šå…³æ³¨ å†™äº‹ä»¶</span>
                        <span class="n">sckey</span><span class="o">.</span><span class="na">interestOps</span><span class="o">(</span><span class="n">sckey</span><span class="o">.</span><span class="na">interestOps</span><span class="o">()</span> <span class="o">+</span> <span class="nc">SelectionKey</span><span class="o">.</span><span class="na">OP_WRITE</span><span class="o">);</span>
                        <span class="c1">// æŠŠ buffer ä½œä¸ºé™„ä»¶åŠ å…¥ sckey</span>
                        <span class="n">sckey</span><span class="o">.</span><span class="na">attach</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">isWritable</span><span class="o">())</span> <span class="o">{</span>
                    <span class="nc">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ByteBuffer</span><span class="o">)</span> <span class="n">key</span><span class="o">.</span><span class="na">attachment</span><span class="o">();</span>
                    <span class="nc">SocketChannel</span> <span class="n">sc</span> <span class="o">=</span> <span class="o">(</span><span class="nc">SocketChannel</span><span class="o">)</span> <span class="n">key</span><span class="o">.</span><span class="na">channel</span><span class="o">();</span>
                    <span class="kt">int</span> <span class="n">write</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å®é™…å†™å…¥å­—èŠ‚:"</span> <span class="o">+</span> <span class="n">write</span><span class="o">);</span>
                    <span class="k">if</span> <span class="o">(!</span><span class="n">buffer</span><span class="o">.</span><span class="na">hasRemaining</span><span class="o">())</span> <span class="o">{</span> <span class="c1">// å†™å®Œäº†</span>
                        <span class="n">key</span><span class="o">.</span><span class="na">interestOps</span><span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">interestOps</span><span class="o">()</span> <span class="o">-</span> <span class="nc">SelectionKey</span><span class="o">.</span><span class="na">OP_WRITE</span><span class="o">);</span>
                        <span class="n">key</span><span class="o">.</span><span class="na">attach</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å®¢æˆ·ç«¯</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">WriteClient</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">Selector</span> <span class="n">selector</span> <span class="o">=</span> <span class="nc">Selector</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
        <span class="nc">SocketChannel</span> <span class="n">sc</span> <span class="o">=</span> <span class="nc">SocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
        <span class="n">sc</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
        <span class="n">sc</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">selector</span><span class="o">,</span> <span class="nc">SelectionKey</span><span class="o">.</span><span class="na">OP_CONNECT</span> <span class="o">|</span> <span class="nc">SelectionKey</span><span class="o">.</span><span class="na">OP_READ</span><span class="o">);</span>
        <span class="n">sc</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="mi">8080</span><span class="o">));</span>
        <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">selector</span><span class="o">.</span><span class="na">select</span><span class="o">();</span>
            <span class="nc">Iterator</span><span class="o">&lt;</span><span class="nc">SelectionKey</span><span class="o">&gt;</span> <span class="n">iter</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="na">selectedKeys</span><span class="o">().</span><span class="na">iterator</span><span class="o">();</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">iter</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
                <span class="nc">SelectionKey</span> <span class="n">key</span> <span class="o">=</span> <span class="n">iter</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
                <span class="n">iter</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">isConnectable</span><span class="o">())</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">sc</span><span class="o">.</span><span class="na">finishConnect</span><span class="o">());</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">isReadable</span><span class="o">())</span> <span class="o">{</span>
                    <span class="nc">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="o">);</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="n">sc</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
                    <span class="n">buffer</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">count</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="-write-ä¸ºä½•è¦å–æ¶ˆ">ğŸ’¡ write ä¸ºä½•è¦å–æ¶ˆ</h4>

<p>åªè¦å‘ channel å‘é€æ•°æ®æ—¶ï¼Œsocket ç¼“å†²å¯å†™ï¼Œè¿™ä¸ªäº‹ä»¶ä¼šé¢‘ç¹è§¦å‘ï¼Œå› æ­¤åº”å½“åªåœ¨ socket ç¼“å†²åŒºå†™ä¸ä¸‹æ—¶å†å…³æ³¨å¯å†™äº‹ä»¶ï¼Œæ•°æ®å†™å®Œä¹‹åå†å–æ¶ˆå…³æ³¨</p>

<h3 id="46-æ›´è¿›ä¸€æ­¥">4.6 æ›´è¿›ä¸€æ­¥</h3>

<h4 id="-åˆ©ç”¨å¤šçº¿ç¨‹ä¼˜åŒ–">ğŸ’¡ åˆ©ç”¨å¤šçº¿ç¨‹ä¼˜åŒ–</h4>

<blockquote>
  <p>ç°åœ¨éƒ½æ˜¯å¤šæ ¸ cpuï¼Œè®¾è®¡æ—¶è¦å……åˆ†è€ƒè™‘åˆ«è®© cpu çš„åŠ›é‡è¢«ç™½ç™½æµªè´¹</p>
</blockquote>

<p>å‰é¢çš„ä»£ç åªæœ‰ä¸€ä¸ªé€‰æ‹©å™¨ï¼Œæ²¡æœ‰å……åˆ†åˆ©ç”¨å¤šæ ¸ cpuï¼Œå¦‚ä½•æ”¹è¿›å‘¢ï¼Ÿ</p>

<p>åˆ†ä¸¤ç»„é€‰æ‹©å™¨</p>

<ul>
  <li>å•çº¿ç¨‹é…ä¸€ä¸ªé€‰æ‹©å™¨ï¼Œä¸“é—¨å¤„ç† accept äº‹ä»¶</li>
  <li>åˆ›å»º cpu æ ¸å¿ƒæ•°çš„çº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹é…ä¸€ä¸ªé€‰æ‹©å™¨ï¼Œè½®æµå¤„ç† read äº‹ä»¶</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ChannelDemo7</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="k">new</span> <span class="nf">BossEventLoop</span><span class="o">().</span><span class="na">register</span><span class="o">();</span>
    <span class="o">}</span>


    <span class="nd">@Slf4j</span>
    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">BossEventLoop</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="nc">Selector</span> <span class="n">boss</span><span class="o">;</span>
        <span class="kd">private</span> <span class="nc">WorkerEventLoop</span><span class="o">[]</span> <span class="n">workers</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">boolean</span> <span class="n">start</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="nc">AtomicInteger</span> <span class="n">index</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicInteger</span><span class="o">();</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">register</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">start</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">ServerSocketChannel</span> <span class="n">ssc</span> <span class="o">=</span> <span class="nc">ServerSocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
                <span class="n">ssc</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="mi">8080</span><span class="o">));</span>
                <span class="n">ssc</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
                <span class="n">boss</span> <span class="o">=</span> <span class="nc">Selector</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
                <span class="nc">SelectionKey</span> <span class="n">ssckey</span> <span class="o">=</span> <span class="n">ssc</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">boss</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
                <span class="n">ssckey</span><span class="o">.</span><span class="na">interestOps</span><span class="o">(</span><span class="nc">SelectionKey</span><span class="o">.</span><span class="na">OP_ACCEPT</span><span class="o">);</span>
                <span class="n">workers</span> <span class="o">=</span> <span class="n">initEventLoops</span><span class="o">();</span>
                <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="s">"boss"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"boss start..."</span><span class="o">);</span>
                <span class="n">start</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="nc">WorkerEventLoop</span><span class="o">[]</span> <span class="nf">initEventLoops</span><span class="o">()</span> <span class="o">{</span>
<span class="c1">//        EventLoop[] eventLoops = new EventLoop[Runtime.getRuntime().availableProcessors()];</span>
            <span class="nc">WorkerEventLoop</span><span class="o">[]</span> <span class="n">workerEventLoops</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">WorkerEventLoop</span><span class="o">[</span><span class="mi">2</span><span class="o">];</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">workerEventLoops</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">workerEventLoops</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">WorkerEventLoop</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="n">workerEventLoops</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">boss</span><span class="o">.</span><span class="na">select</span><span class="o">();</span>
                    <span class="nc">Iterator</span><span class="o">&lt;</span><span class="nc">SelectionKey</span><span class="o">&gt;</span> <span class="n">iter</span> <span class="o">=</span> <span class="n">boss</span><span class="o">.</span><span class="na">selectedKeys</span><span class="o">().</span><span class="na">iterator</span><span class="o">();</span>
                    <span class="k">while</span> <span class="o">(</span><span class="n">iter</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
                        <span class="nc">SelectionKey</span> <span class="n">key</span> <span class="o">=</span> <span class="n">iter</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
                        <span class="n">iter</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">isAcceptable</span><span class="o">())</span> <span class="o">{</span>
                            <span class="nc">ServerSocketChannel</span> <span class="n">c</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ServerSocketChannel</span><span class="o">)</span> <span class="n">key</span><span class="o">.</span><span class="na">channel</span><span class="o">();</span>
                            <span class="nc">SocketChannel</span> <span class="n">sc</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>
                            <span class="n">sc</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
                            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"{} connected"</span><span class="o">,</span> <span class="n">sc</span><span class="o">.</span><span class="na">getRemoteAddress</span><span class="o">());</span>
                            <span class="n">workers</span><span class="o">[</span><span class="n">index</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">()</span> <span class="o">%</span> <span class="n">workers</span><span class="o">.</span><span class="na">length</span><span class="o">].</span><span class="na">register</span><span class="o">(</span><span class="n">sc</span><span class="o">);</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Slf4j</span>
    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">WorkerEventLoop</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="nc">Selector</span> <span class="n">worker</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">boolean</span> <span class="n">start</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">index</span><span class="o">;</span>

        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ConcurrentLinkedQueue</span><span class="o">&lt;</span><span class="nc">Runnable</span><span class="o">&gt;</span> <span class="n">tasks</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConcurrentLinkedQueue</span><span class="o">&lt;&gt;();</span>

        <span class="kd">public</span> <span class="nf">WorkerEventLoop</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">index</span> <span class="o">=</span> <span class="n">index</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">register</span><span class="o">(</span><span class="nc">SocketChannel</span> <span class="n">sc</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">start</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">worker</span> <span class="o">=</span> <span class="nc">Selector</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
                <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="s">"worker-"</span> <span class="o">+</span> <span class="n">index</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
                <span class="n">start</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">tasks</span><span class="o">.</span><span class="na">add</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">SelectionKey</span> <span class="n">sckey</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">worker</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
                    <span class="n">sckey</span><span class="o">.</span><span class="na">interestOps</span><span class="o">(</span><span class="nc">SelectionKey</span><span class="o">.</span><span class="na">OP_READ</span><span class="o">);</span>
                    <span class="n">worker</span><span class="o">.</span><span class="na">selectNow</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">});</span>
            <span class="n">worker</span><span class="o">.</span><span class="na">wakeup</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">worker</span><span class="o">.</span><span class="na">select</span><span class="o">();</span>
                    <span class="nc">Runnable</span> <span class="n">task</span> <span class="o">=</span> <span class="n">tasks</span><span class="o">.</span><span class="na">poll</span><span class="o">();</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">task</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">task</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
                    <span class="o">}</span>
                    <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">SelectionKey</span><span class="o">&gt;</span> <span class="n">keys</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="na">selectedKeys</span><span class="o">();</span>
                    <span class="nc">Iterator</span><span class="o">&lt;</span><span class="nc">SelectionKey</span><span class="o">&gt;</span> <span class="n">iter</span> <span class="o">=</span> <span class="n">keys</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>
                    <span class="k">while</span> <span class="o">(</span><span class="n">iter</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
                        <span class="nc">SelectionKey</span> <span class="n">key</span> <span class="o">=</span> <span class="n">iter</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">isReadable</span><span class="o">())</span> <span class="o">{</span>
                            <span class="nc">SocketChannel</span> <span class="n">sc</span> <span class="o">=</span> <span class="o">(</span><span class="nc">SocketChannel</span><span class="o">)</span> <span class="n">key</span><span class="o">.</span><span class="na">channel</span><span class="o">();</span>
                            <span class="nc">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">128</span><span class="o">);</span>
                            <span class="k">try</span> <span class="o">{</span>
                                <span class="kt">int</span> <span class="n">read</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
                                <span class="k">if</span> <span class="o">(</span><span class="n">read</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                                    <span class="n">key</span><span class="o">.</span><span class="na">cancel</span><span class="o">();</span>
                                    <span class="n">sc</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                                    <span class="n">buffer</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
                                    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"{} message:"</span><span class="o">,</span> <span class="n">sc</span><span class="o">.</span><span class="na">getRemoteAddress</span><span class="o">());</span>
                                    <span class="n">debugAll</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
                                <span class="o">}</span>
                            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                                <span class="n">key</span><span class="o">.</span><span class="na">cancel</span><span class="o">();</span>
                                <span class="n">sc</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                            <span class="o">}</span>
                        <span class="o">}</span>
                        <span class="n">iter</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="-å¦‚ä½•æ‹¿åˆ°-cpu-ä¸ªæ•°">ğŸ’¡ å¦‚ä½•æ‹¿åˆ° cpu ä¸ªæ•°</h4>

<blockquote>
  <ul>
    <li>Runtime.getRuntime().availableProcessors() å¦‚æœå·¥ä½œåœ¨ docker å®¹å™¨ä¸‹ï¼Œå› ä¸ºå®¹å™¨ä¸æ˜¯ç‰©ç†éš”ç¦»çš„ï¼Œä¼šæ‹¿åˆ°ç‰©ç† cpu ä¸ªæ•°ï¼Œè€Œä¸æ˜¯å®¹å™¨ç”³è¯·æ—¶çš„ä¸ªæ•°</li>
    <li>è¿™ä¸ªé—®é¢˜ç›´åˆ° jdk 10 æ‰ä¿®å¤ï¼Œä½¿ç”¨ jvm å‚æ•° UseContainerSupport é…ç½®ï¼Œ é»˜è®¤å¼€å¯</li>
  </ul>
</blockquote>

<h3 id="47-udp">4.7 UDP</h3>

<ul>
  <li>UDP æ˜¯æ— è¿æ¥çš„ï¼Œclient å‘é€æ•°æ®ä¸ä¼šç®¡ server æ˜¯å¦å¼€å¯</li>
  <li>server è¿™è¾¹çš„ receive æ–¹æ³•ä¼šå°†æ¥æ”¶åˆ°çš„æ•°æ®å­˜å…¥ byte bufferï¼Œä½†å¦‚æœæ•°æ®æŠ¥æ–‡è¶…è¿‡ buffer å¤§å°ï¼Œå¤šå‡ºæ¥çš„æ•°æ®ä¼šè¢«é»˜é»˜æŠ›å¼ƒ</li>
</ul>

<p>é¦–å…ˆå¯åŠ¨æœåŠ¡å™¨ç«¯</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UdpServer</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">(</span><span class="nc">DatagramChannel</span> <span class="n">channel</span> <span class="o">=</span> <span class="nc">DatagramChannel</span><span class="o">.</span><span class="na">open</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">channel</span><span class="o">.</span><span class="na">socket</span><span class="o">().</span><span class="na">bind</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="mi">9999</span><span class="o">));</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"waiting..."</span><span class="o">);</span>
            <span class="nc">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">32</span><span class="o">);</span>
            <span class="n">channel</span><span class="o">.</span><span class="na">receive</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
            <span class="n">buffer</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
            <span class="n">debug</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>waiting...
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¿è¡Œå®¢æˆ·ç«¯</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UdpClient</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">(</span><span class="nc">DatagramChannel</span> <span class="n">channel</span> <span class="o">=</span> <span class="nc">DatagramChannel</span><span class="o">.</span><span class="na">open</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nc">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="s">"hello"</span><span class="o">);</span>
            <span class="nc">InetSocketAddress</span> <span class="n">address</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="mi">9999</span><span class="o">);</span>
            <span class="n">channel</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="n">address</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ¥ä¸‹æ¥æœåŠ¡å™¨ç«¯è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 68 65 6c 6c 6f                                  |hello           |
+--------+-------------------------------------------------+----------------+
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="5-nio-vs-bio">5. NIO vs BIO</h2>

<h3 id="51-stream-vs-channel">5.1 stream vs channel</h3>

<ul>
  <li>stream ä¸ä¼šè‡ªåŠ¨ç¼“å†²æ•°æ®ï¼Œchannel ä¼šåˆ©ç”¨ç³»ç»Ÿæä¾›çš„å‘é€ç¼“å†²åŒºã€æ¥æ”¶ç¼“å†²åŒºï¼ˆæ›´ä¸ºåº•å±‚ï¼‰</li>
  <li>stream ä»…æ”¯æŒé˜»å¡ APIï¼Œchannel åŒæ—¶æ”¯æŒé˜»å¡ã€éé˜»å¡ APIï¼Œç½‘ç»œ channel å¯é…åˆ selector å®ç°å¤šè·¯å¤ç”¨</li>
  <li>äºŒè€…å‡ä¸ºå…¨åŒå·¥ï¼Œå³è¯»å†™å¯ä»¥åŒæ—¶è¿›è¡Œ</li>
</ul>

<h3 id="52-io-æ¨¡å‹">5.2 IO æ¨¡å‹</h3>

<p>åŒæ­¥é˜»å¡ã€åŒæ­¥éé˜»å¡ã€åŒæ­¥å¤šè·¯å¤ç”¨ã€å¼‚æ­¥é˜»å¡ï¼ˆæ²¡æœ‰æ­¤æƒ…å†µï¼‰ã€å¼‚æ­¥éé˜»å¡</p>

<ul>
  <li>åŒæ­¥ï¼šçº¿ç¨‹è‡ªå·±å»è·å–ç»“æœï¼ˆä¸€ä¸ªçº¿ç¨‹ï¼‰</li>
  <li>å¼‚æ­¥ï¼šçº¿ç¨‹è‡ªå·±ä¸å»è·å–ç»“æœï¼Œè€Œæ˜¯ç”±å…¶å®ƒçº¿ç¨‹é€ç»“æœï¼ˆè‡³å°‘ä¸¤ä¸ªçº¿ç¨‹ï¼‰</li>
</ul>

<p>å½“è°ƒç”¨ä¸€æ¬¡ channel.read æˆ– stream.read åï¼Œä¼šåˆ‡æ¢è‡³æ“ä½œç³»ç»Ÿå†…æ ¸æ€æ¥å®ŒæˆçœŸæ­£æ•°æ®è¯»å–ï¼Œè€Œè¯»å–åˆåˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œåˆ†åˆ«ä¸ºï¼š</p>

<ul>
  <li>ç­‰å¾…æ•°æ®é˜¶æ®µ</li>
  <li>å¤åˆ¶æ•°æ®é˜¶æ®µ</li>
</ul>

<p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0033.png" alt="" /></p>

<ul>
  <li>
    <p>é˜»å¡ IO</p>

    <p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0039.png" alt="" /></p>
  </li>
  <li>
    <p>éé˜»å¡  IO</p>

    <p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0035.png" alt="" /></p>
  </li>
  <li>
    <p>å¤šè·¯å¤ç”¨</p>

    <p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0038.png" alt="" /></p>
  </li>
  <li>
    <p>ä¿¡å·é©±åŠ¨</p>
  </li>
  <li>
    <p>å¼‚æ­¥ IO</p>

    <p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0037.png" alt="" /></p>
  </li>
  <li>
    <p>é˜»å¡ IO vs å¤šè·¯å¤ç”¨</p>

    <p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0034.png" alt="" /></p>

    <p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0036.png" alt="" /></p>
  </li>
</ul>

<h4 id="-å‚è€ƒ">ğŸ”– å‚è€ƒ</h4>

<p>UNIX ç½‘ç»œç¼–ç¨‹ - å· I</p>

<h3 id="53-é›¶æ‹·è´">5.3 é›¶æ‹·è´</h3>

<h4 id="ä¼ ç»Ÿ-io-é—®é¢˜">ä¼ ç»Ÿ IO é—®é¢˜</h4>

<p>ä¼ ç»Ÿçš„ IO å°†ä¸€ä¸ªæ–‡ä»¶é€šè¿‡ socket å†™å‡º</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="nc">File</span> <span class="n">f</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="s">"helloword/data.txt"</span><span class="o">);</span>
<span class="nc">RandomAccessFile</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RandomAccessFile</span><span class="o">(</span><span class="n">file</span><span class="o">,</span> <span class="s">"r"</span><span class="o">);</span>

<span class="kt">byte</span><span class="o">[]</span> <span class="n">buf</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[(</span><span class="kt">int</span><span class="o">)</span><span class="n">f</span><span class="o">.</span><span class="na">length</span><span class="o">()];</span>
<span class="n">file</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buf</span><span class="o">);</span>

<span class="nc">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="o">...;</span>
<span class="n">socket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="n">buf</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å†…éƒ¨å·¥ä½œæµç¨‹æ˜¯è¿™æ ·çš„ï¼š</p>

<p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0024.png" alt="" /></p>

<ol>
  <li>
    <p>java æœ¬èº«å¹¶ä¸å…·å¤‡ IO è¯»å†™èƒ½åŠ›ï¼Œå› æ­¤ read æ–¹æ³•è°ƒç”¨åï¼Œè¦ä» java ç¨‹åºçš„<strong>ç”¨æˆ·æ€</strong>åˆ‡æ¢è‡³<strong>å†…æ ¸æ€</strong>ï¼Œå»è°ƒç”¨æ“ä½œç³»ç»Ÿï¼ˆKernelï¼‰çš„è¯»èƒ½åŠ›ï¼Œå°†æ•°æ®è¯»å…¥<strong>å†…æ ¸ç¼“å†²åŒº</strong>ã€‚è¿™æœŸé—´ç”¨æˆ·çº¿ç¨‹é˜»å¡ï¼Œæ“ä½œç³»ç»Ÿä½¿ç”¨ DMAï¼ˆDirect Memory Accessï¼‰æ¥å®ç°æ–‡ä»¶è¯»ï¼Œå…¶é—´ä¹Ÿä¸ä¼šä½¿ç”¨ cpu</p>

    <blockquote>
      <p>DMA ä¹Ÿå¯ä»¥ç†è§£ä¸ºç¡¬ä»¶å•å…ƒï¼Œç”¨æ¥è§£æ”¾ cpu å®Œæˆæ–‡ä»¶ IO</p>
    </blockquote>
  </li>
  <li>
    <p>ä»<strong>å†…æ ¸æ€</strong>åˆ‡æ¢å›<strong>ç”¨æˆ·æ€</strong>ï¼Œå°†æ•°æ®ä»<strong>å†…æ ¸ç¼“å†²åŒº</strong>è¯»å…¥<strong>ç”¨æˆ·ç¼“å†²åŒº</strong>ï¼ˆå³ byte[] bufï¼‰ï¼Œè¿™æœŸé—´ cpu ä¼šå‚ä¸æ‹·è´ï¼Œæ— æ³•åˆ©ç”¨ DMA</p>
  </li>
  <li>
    <p>è°ƒç”¨ write æ–¹æ³•ï¼Œè¿™æ—¶å°†æ•°æ®ä»<strong>ç”¨æˆ·ç¼“å†²åŒº</strong>ï¼ˆbyte[] bufï¼‰å†™å…¥ <strong>socket ç¼“å†²åŒº</strong>ï¼Œcpu ä¼šå‚ä¸æ‹·è´</p>
  </li>
  <li>
    <p>æ¥ä¸‹æ¥è¦å‘ç½‘å¡å†™æ•°æ®ï¼Œè¿™é¡¹èƒ½åŠ› java åˆä¸å…·å¤‡ï¼Œå› æ­¤åˆå¾—ä»<strong>ç”¨æˆ·æ€</strong>åˆ‡æ¢è‡³<strong>å†…æ ¸æ€</strong>ï¼Œè°ƒç”¨æ“ä½œç³»ç»Ÿçš„å†™èƒ½åŠ›ï¼Œä½¿ç”¨ DMA å°† <strong>socket ç¼“å†²åŒº</strong>çš„æ•°æ®å†™å…¥ç½‘å¡ï¼Œä¸ä¼šä½¿ç”¨ cpu</p>
  </li>
</ol>

<p>å¯ä»¥çœ‹åˆ°ä¸­é—´ç¯èŠ‚è¾ƒå¤šï¼Œjava çš„ IO å®é™…ä¸æ˜¯ç‰©ç†è®¾å¤‡çº§åˆ«çš„è¯»å†™ï¼Œè€Œæ˜¯ç¼“å­˜çš„å¤åˆ¶ï¼Œåº•å±‚çš„çœŸæ­£è¯»å†™æ˜¯æ“ä½œç³»ç»Ÿæ¥å®Œæˆçš„</p>

<ul>
  <li>ç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„åˆ‡æ¢å‘ç”Ÿäº† 3 æ¬¡ï¼Œè¿™ä¸ªæ“ä½œæ¯”è¾ƒé‡é‡çº§</li>
  <li>æ•°æ®æ‹·è´äº†å…± 4 æ¬¡</li>
</ul>

<h4 id="nio-ä¼˜åŒ–">NIO ä¼˜åŒ–</h4>

<p>é€šè¿‡ DirectByteBuf</p>

<ul>
  <li>ByteBuffer.allocate(10)  HeapByteBuffer ä½¿ç”¨çš„è¿˜æ˜¯ java å†…å­˜</li>
  <li>ByteBuffer.allocateDirect(10)  DirectByteBuffer ä½¿ç”¨çš„æ˜¯æ“ä½œç³»ç»Ÿå†…å­˜</li>
</ul>

<p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0025.png" alt="" /></p>

<p>å¤§éƒ¨åˆ†æ­¥éª¤ä¸ä¼˜åŒ–å‰ç›¸åŒï¼Œä¸å†èµ˜è¿°ã€‚å”¯æœ‰ä¸€ç‚¹ï¼šjava å¯ä»¥ä½¿ç”¨ DirectByteBuf å°†å †å¤–å†…å­˜æ˜ å°„åˆ° jvm å†…å­˜ä¸­æ¥ç›´æ¥è®¿é—®ä½¿ç”¨</p>

<ul>
  <li>è¿™å—å†…å­˜ä¸å— jvm åƒåœ¾å›æ”¶çš„å½±å“ï¼Œå› æ­¤å†…å­˜åœ°å€å›ºå®šï¼Œæœ‰åŠ©äº IO è¯»å†™</li>
  <li>java ä¸­çš„ DirectByteBuf å¯¹è±¡ä»…ç»´æŠ¤äº†æ­¤å†…å­˜çš„è™šå¼•ç”¨ï¼Œå†…å­˜å›æ”¶åˆ†æˆä¸¤æ­¥
    <ul>
      <li>DirectByteBuf å¯¹è±¡è¢«åƒåœ¾å›æ”¶ï¼Œå°†è™šå¼•ç”¨åŠ å…¥å¼•ç”¨é˜Ÿåˆ—</li>
      <li>é€šè¿‡ä¸“é—¨çº¿ç¨‹è®¿é—®å¼•ç”¨é˜Ÿåˆ—ï¼Œæ ¹æ®è™šå¼•ç”¨é‡Šæ”¾å †å¤–å†…å­˜</li>
    </ul>
  </li>
  <li>å‡å°‘äº†ä¸€æ¬¡æ•°æ®æ‹·è´ï¼Œç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„åˆ‡æ¢æ¬¡æ•°æ²¡æœ‰å‡å°‘</li>
</ul>

<p>è¿›ä¸€æ­¥ä¼˜åŒ–ï¼ˆåº•å±‚é‡‡ç”¨äº† linux 2.1 åæä¾›çš„ sendFile æ–¹æ³•ï¼‰ï¼Œjava ä¸­å¯¹åº”ç€ä¸¤ä¸ª channel è°ƒç”¨ transferTo/transferFrom æ–¹æ³•æ‹·è´æ•°æ®</p>

<p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0026.png" alt="" /></p>

<ol>
  <li>java è°ƒç”¨ transferTo æ–¹æ³•åï¼Œè¦ä» java ç¨‹åºçš„<strong>ç”¨æˆ·æ€</strong>åˆ‡æ¢è‡³<strong>å†…æ ¸æ€</strong>ï¼Œä½¿ç”¨ DMAå°†æ•°æ®è¯»å…¥<strong>å†…æ ¸ç¼“å†²åŒº</strong>ï¼Œä¸ä¼šä½¿ç”¨ cpu</li>
  <li>æ•°æ®ä»<strong>å†…æ ¸ç¼“å†²åŒº</strong>ä¼ è¾“åˆ° <strong>socket ç¼“å†²åŒº</strong>ï¼Œcpu ä¼šå‚ä¸æ‹·è´</li>
  <li>æœ€åä½¿ç”¨ DMA å°† <strong>socket ç¼“å†²åŒº</strong>çš„æ•°æ®å†™å…¥ç½‘å¡ï¼Œä¸ä¼šä½¿ç”¨ cpu</li>
</ol>

<p>å¯ä»¥çœ‹åˆ°</p>

<ul>
  <li>åªå‘ç”Ÿäº†ä¸€æ¬¡ç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„åˆ‡æ¢</li>
  <li>æ•°æ®æ‹·è´äº† 3 æ¬¡</li>
</ul>

<p>è¿›ä¸€æ­¥ä¼˜åŒ–ï¼ˆlinux 2.4ï¼‰</p>

<p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0027.png" alt="" /></p>

<ol>
  <li>java è°ƒç”¨ transferTo æ–¹æ³•åï¼Œè¦ä» java ç¨‹åºçš„<strong>ç”¨æˆ·æ€</strong>åˆ‡æ¢è‡³<strong>å†…æ ¸æ€</strong>ï¼Œä½¿ç”¨ DMAå°†æ•°æ®è¯»å…¥<strong>å†…æ ¸ç¼“å†²åŒº</strong>ï¼Œä¸ä¼šä½¿ç”¨ cpu</li>
  <li>åªä¼šå°†ä¸€äº› offset å’Œ length ä¿¡æ¯æ‹·å…¥ <strong>socket ç¼“å†²åŒº</strong>ï¼Œå‡ ä¹æ— æ¶ˆè€—</li>
  <li>ä½¿ç”¨ DMA å°† <strong>å†…æ ¸ç¼“å†²åŒº</strong>çš„æ•°æ®å†™å…¥ç½‘å¡ï¼Œä¸ä¼šä½¿ç”¨ cpu</li>
</ol>

<p>æ•´ä¸ªè¿‡ç¨‹ä»…åªå‘ç”Ÿäº†ä¸€æ¬¡ç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„åˆ‡æ¢ï¼Œæ•°æ®æ‹·è´äº† 2 æ¬¡ã€‚æ‰€è°“çš„ã€é›¶æ‹·è´ã€‘ï¼Œå¹¶ä¸æ˜¯çœŸæ­£æ— æ‹·è´ï¼Œè€Œæ˜¯åœ¨ä¸ä¼šæ‹·è´é‡å¤æ•°æ®åˆ° jvm å†…å­˜ä¸­ï¼Œé›¶æ‹·è´çš„ä¼˜ç‚¹æœ‰</p>

<ul>
  <li>æ›´å°‘çš„ç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„åˆ‡æ¢</li>
  <li>ä¸åˆ©ç”¨ cpu è®¡ç®—ï¼Œå‡å°‘ cpu ç¼“å­˜ä¼ªå…±äº«</li>
  <li>é›¶æ‹·è´é€‚åˆå°æ–‡ä»¶ä¼ è¾“</li>
</ul>

<h3 id="53-aio">5.3 AIO</h3>

<p>AIO ç”¨æ¥è§£å†³æ•°æ®å¤åˆ¶é˜¶æ®µçš„é˜»å¡é—®é¢˜</p>

<ul>
  <li>åŒæ­¥æ„å‘³ç€ï¼Œåœ¨è¿›è¡Œè¯»å†™æ“ä½œæ—¶ï¼Œçº¿ç¨‹éœ€è¦ç­‰å¾…ç»“æœï¼Œè¿˜æ˜¯ç›¸å½“äºé—²ç½®</li>
  <li>å¼‚æ­¥æ„å‘³ç€ï¼Œåœ¨è¿›è¡Œè¯»å†™æ“ä½œæ—¶ï¼Œçº¿ç¨‹ä¸å¿…ç­‰å¾…ç»“æœï¼Œè€Œæ˜¯å°†æ¥ç”±æ“ä½œç³»ç»Ÿæ¥é€šè¿‡å›è°ƒæ–¹å¼ç”±å¦å¤–çš„çº¿ç¨‹æ¥è·å¾—ç»“æœ</li>
</ul>

<blockquote>
  <p>å¼‚æ­¥æ¨¡å‹éœ€è¦åº•å±‚æ“ä½œç³»ç»Ÿï¼ˆKernelï¼‰æä¾›æ”¯æŒ</p>

  <ul>
    <li>Windows ç³»ç»Ÿé€šè¿‡ IOCP å®ç°äº†çœŸæ­£çš„å¼‚æ­¥ IO</li>
    <li>Linux ç³»ç»Ÿå¼‚æ­¥ IO åœ¨ 2.6 ç‰ˆæœ¬å¼•å…¥ï¼Œä½†å…¶åº•å±‚å®ç°è¿˜æ˜¯ç”¨å¤šè·¯å¤ç”¨æ¨¡æ‹Ÿäº†å¼‚æ­¥ IOï¼Œæ€§èƒ½æ²¡æœ‰ä¼˜åŠ¿</li>
  </ul>
</blockquote>

<h4 id="æ–‡ä»¶-aio">æ–‡ä»¶ AIO</h4>

<p>å…ˆæ¥çœ‹çœ‹ AsynchronousFileChannel</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre><span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AioDemo1</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="k">try</span><span class="o">{</span>
            <span class="nc">AsynchronousFileChannel</span> <span class="n">s</span> <span class="o">=</span> 
                <span class="nc">AsynchronousFileChannel</span><span class="o">.</span><span class="na">open</span><span class="o">(</span>
                	<span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"1.txt"</span><span class="o">),</span> <span class="nc">StandardOpenOption</span><span class="o">.</span><span class="na">READ</span><span class="o">);</span>
            <span class="nc">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"begin..."</span><span class="o">);</span>
            <span class="n">s</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="k">new</span> <span class="nc">CompletionHandler</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">ByteBuffer</span><span class="o">&gt;()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">completed</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">result</span><span class="o">,</span> <span class="nc">ByteBuffer</span> <span class="n">attachment</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"read completed...{}"</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
                    <span class="n">buffer</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
                    <span class="n">debug</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
                <span class="o">}</span>

                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">failed</span><span class="o">(</span><span class="nc">Throwable</span> <span class="n">exc</span><span class="o">,</span> <span class="nc">ByteBuffer</span> <span class="n">attachment</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"read failed..."</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">});</span>

        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"do other things..."</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">in</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>13:44:56 [DEBUG] [main] c.i.aio.AioDemo1 - begin...
13:44:56 [DEBUG] [main] c.i.aio.AioDemo1 - do other things...
13:44:56 [DEBUG] [Thread-5] c.i.aio.AioDemo1 - read completed...2
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 61 0d                                           |a.              |
+--------+-------------------------------------------------+----------------+
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¯ä»¥çœ‹åˆ°</p>

<ul>
  <li>å“åº”æ–‡ä»¶è¯»å–æˆåŠŸçš„æ˜¯å¦ä¸€ä¸ªçº¿ç¨‹ Thread-5</li>
  <li>ä¸»çº¿ç¨‹å¹¶æ²¡æœ‰ IO æ“ä½œé˜»å¡</li>
</ul>

<h4 id="-å®ˆæŠ¤çº¿ç¨‹">ğŸ’¡ å®ˆæŠ¤çº¿ç¨‹</h4>

<p>é»˜è®¤æ–‡ä»¶ AIO ä½¿ç”¨çš„çº¿ç¨‹éƒ½æ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼Œæ‰€ä»¥æœ€åè¦æ‰§è¡Œ <code class="language-plaintext highlighter-rouge">System.in.read()</code> ä»¥é¿å…å®ˆæŠ¤çº¿ç¨‹æ„å¤–ç»“æŸ</p>

<h4 id="ç½‘ç»œ-aio">ç½‘ç»œ AIO</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AioServer</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">AsynchronousServerSocketChannel</span> <span class="n">ssc</span> <span class="o">=</span> <span class="nc">AsynchronousServerSocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
        <span class="n">ssc</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="mi">8080</span><span class="o">));</span>
        <span class="n">ssc</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="k">new</span> <span class="nc">AcceptHandler</span><span class="o">(</span><span class="n">ssc</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">in</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">closeChannel</span><span class="o">(</span><span class="nc">AsynchronousSocketChannel</span> <span class="n">sc</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"[%s] %s close\n"</span><span class="o">,</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">(),</span> <span class="n">sc</span><span class="o">.</span><span class="na">getRemoteAddress</span><span class="o">());</span>
            <span class="n">sc</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ReadHandler</span> <span class="kd">implements</span> <span class="nc">CompletionHandler</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">ByteBuffer</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">AsynchronousSocketChannel</span> <span class="n">sc</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">ReadHandler</span><span class="o">(</span><span class="nc">AsynchronousSocketChannel</span> <span class="n">sc</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">sc</span> <span class="o">=</span> <span class="n">sc</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">completed</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">result</span><span class="o">,</span> <span class="nc">ByteBuffer</span> <span class="n">attachment</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">closeChannel</span><span class="o">(</span><span class="n">sc</span><span class="o">);</span>
                    <span class="k">return</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"[%s] %s read\n"</span><span class="o">,</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">(),</span> <span class="n">sc</span><span class="o">.</span><span class="na">getRemoteAddress</span><span class="o">());</span>
                <span class="n">attachment</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Charset</span><span class="o">.</span><span class="na">defaultCharset</span><span class="o">().</span><span class="na">decode</span><span class="o">(</span><span class="n">attachment</span><span class="o">));</span>
                <span class="n">attachment</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
                <span class="c1">// å¤„ç†å®Œç¬¬ä¸€ä¸ª read æ—¶ï¼Œéœ€è¦å†æ¬¡è°ƒç”¨ read æ–¹æ³•æ¥å¤„ç†ä¸‹ä¸€ä¸ª read äº‹ä»¶</span>
                <span class="n">sc</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">attachment</span><span class="o">,</span> <span class="n">attachment</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">failed</span><span class="o">(</span><span class="nc">Throwable</span> <span class="n">exc</span><span class="o">,</span> <span class="nc">ByteBuffer</span> <span class="n">attachment</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">closeChannel</span><span class="o">(</span><span class="n">sc</span><span class="o">);</span>
            <span class="n">exc</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">WriteHandler</span> <span class="kd">implements</span> <span class="nc">CompletionHandler</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">ByteBuffer</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">AsynchronousSocketChannel</span> <span class="n">sc</span><span class="o">;</span>

        <span class="kd">private</span> <span class="nf">WriteHandler</span><span class="o">(</span><span class="nc">AsynchronousSocketChannel</span> <span class="n">sc</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">sc</span> <span class="o">=</span> <span class="n">sc</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">completed</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">result</span><span class="o">,</span> <span class="nc">ByteBuffer</span> <span class="n">attachment</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// å¦‚æœä½œä¸ºé™„ä»¶çš„ buffer è¿˜æœ‰å†…å®¹ï¼Œéœ€è¦å†æ¬¡ write å†™å‡ºå‰©ä½™å†…å®¹</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">attachment</span><span class="o">.</span><span class="na">hasRemaining</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">sc</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">attachment</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">failed</span><span class="o">(</span><span class="nc">Throwable</span> <span class="n">exc</span><span class="o">,</span> <span class="nc">ByteBuffer</span> <span class="n">attachment</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">exc</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="n">closeChannel</span><span class="o">(</span><span class="n">sc</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">AcceptHandler</span> <span class="kd">implements</span> <span class="nc">CompletionHandler</span><span class="o">&lt;</span><span class="nc">AsynchronousSocketChannel</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">AsynchronousServerSocketChannel</span> <span class="n">ssc</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">AcceptHandler</span><span class="o">(</span><span class="nc">AsynchronousServerSocketChannel</span> <span class="n">ssc</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">ssc</span> <span class="o">=</span> <span class="n">ssc</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">completed</span><span class="o">(</span><span class="nc">AsynchronousSocketChannel</span> <span class="n">sc</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">attachment</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"[%s] %s connected\n"</span><span class="o">,</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">(),</span> <span class="n">sc</span><span class="o">.</span><span class="na">getRemoteAddress</span><span class="o">());</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="nc">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">16</span><span class="o">);</span>
            <span class="c1">// è¯»äº‹ä»¶ç”± ReadHandler å¤„ç†</span>
            <span class="n">sc</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="n">buffer</span><span class="o">,</span> <span class="k">new</span> <span class="nc">ReadHandler</span><span class="o">(</span><span class="n">sc</span><span class="o">));</span>
            <span class="c1">// å†™äº‹ä»¶ç”± WriteHandler å¤„ç†</span>
            <span class="n">sc</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="nc">Charset</span><span class="o">.</span><span class="na">defaultCharset</span><span class="o">().</span><span class="na">encode</span><span class="o">(</span><span class="s">"server hello!"</span><span class="o">),</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">16</span><span class="o">),</span> <span class="k">new</span> <span class="nc">WriteHandler</span><span class="o">(</span><span class="n">sc</span><span class="o">));</span>
            <span class="c1">// å¤„ç†å®Œç¬¬ä¸€ä¸ª accpet æ—¶ï¼Œéœ€è¦å†æ¬¡è°ƒç”¨ accept æ–¹æ³•æ¥å¤„ç†ä¸‹ä¸€ä¸ª accept äº‹ä»¶</span>
            <span class="n">ssc</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">failed</span><span class="o">(</span><span class="nc">Throwable</span> <span class="n">exc</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">attachment</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">exc</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h1 id="äºŒ-netty-å…¥é—¨">äºŒ. Netty å…¥é—¨</h1>

<h2 id="1-æ¦‚è¿°">1. æ¦‚è¿°</h2>

<h3 id="11-netty-æ˜¯ä»€ä¹ˆ">1.1 Netty æ˜¯ä»€ä¹ˆï¼Ÿ</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>Netty is an asynchronous event-driven network application framework
for rapid development of maintainable high performance protocol servers &amp; clients.
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Netty æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„ã€åŸºäºäº‹ä»¶é©±åŠ¨çš„ç½‘ç»œåº”ç”¨æ¡†æ¶ï¼Œç”¨äºå¿«é€Ÿå¼€å‘å¯ç»´æŠ¤ã€é«˜æ€§èƒ½çš„ç½‘ç»œæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯</p>

<h3 id="12-netty-çš„ä½œè€…">1.2 Netty çš„ä½œè€…</h3>

<p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0005.png" alt="" /></p>

<p>ä»–è¿˜æ˜¯å¦ä¸€ä¸ªè‘—åç½‘ç»œåº”ç”¨æ¡†æ¶ Mina çš„é‡è¦è´¡çŒ®è€…</p>

<h3 id="13-netty-çš„åœ°ä½">1.3 Netty çš„åœ°ä½</h3>

<p>Netty åœ¨ Java ç½‘ç»œåº”ç”¨æ¡†æ¶ä¸­çš„åœ°ä½å°±å¥½æ¯”ï¼šSpring æ¡†æ¶åœ¨ JavaEE å¼€å‘ä¸­çš„åœ°ä½</p>

<p>ä»¥ä¸‹çš„æ¡†æ¶éƒ½ä½¿ç”¨äº† Nettyï¼Œå› ä¸ºå®ƒä»¬æœ‰ç½‘ç»œé€šä¿¡éœ€æ±‚ï¼</p>

<ul>
  <li>Cassandra - nosql æ•°æ®åº“</li>
  <li>Spark - å¤§æ•°æ®åˆ†å¸ƒå¼è®¡ç®—æ¡†æ¶</li>
  <li>Hadoop - å¤§æ•°æ®åˆ†å¸ƒå¼å­˜å‚¨æ¡†æ¶</li>
  <li>RocketMQ - ali å¼€æºçš„æ¶ˆæ¯é˜Ÿåˆ—</li>
  <li>ElasticSearch - æœç´¢å¼•æ“</li>
  <li>gRPC - rpc æ¡†æ¶</li>
  <li>Dubbo - rpc æ¡†æ¶</li>
  <li>Spring 5.x - flux api å®Œå…¨æŠ›å¼ƒäº† tomcat ï¼Œä½¿ç”¨ netty ä½œä¸ºæœåŠ¡å™¨ç«¯</li>
  <li>Zookeeper - åˆ†å¸ƒå¼åè°ƒæ¡†æ¶</li>
</ul>

<h3 id="14-netty-çš„ä¼˜åŠ¿">1.4 Netty çš„ä¼˜åŠ¿</h3>

<ul>
  <li>Netty vs NIOï¼Œå·¥ä½œé‡å¤§ï¼Œbug å¤š
    <ul>
      <li>éœ€è¦è‡ªå·±æ„å»ºåè®®</li>
      <li>è§£å†³ TCP ä¼ è¾“é—®é¢˜ï¼Œå¦‚ç²˜åŒ…ã€åŠåŒ…</li>
      <li>epoll ç©ºè½®è¯¢å¯¼è‡´ CPU 100%</li>
      <li>å¯¹ API è¿›è¡Œå¢å¼ºï¼Œä½¿ä¹‹æ›´æ˜“ç”¨ï¼Œå¦‚ FastThreadLocal =&gt; ThreadLocalï¼ŒByteBuf =&gt; ByteBuffer</li>
    </ul>
  </li>
  <li>Netty vs å…¶å®ƒç½‘ç»œåº”ç”¨æ¡†æ¶
    <ul>
      <li>Mina ç”± apache ç»´æŠ¤ï¼Œå°†æ¥ 3.x ç‰ˆæœ¬å¯èƒ½ä¼šæœ‰è¾ƒå¤§é‡æ„ï¼Œç ´å API å‘ä¸‹å…¼å®¹æ€§ï¼ŒNetty çš„å¼€å‘è¿­ä»£æ›´è¿…é€Ÿï¼ŒAPI æ›´ç®€æ´ã€æ–‡æ¡£æ›´ä¼˜ç§€</li>
      <li>ä¹…ç»è€ƒéªŒï¼Œ16å¹´ï¼ŒNetty ç‰ˆæœ¬
        <ul>
          <li>2.x 2004</li>
          <li>3.x 2008</li>
          <li>4.x 2013</li>
          <li>5.x å·²åºŸå¼ƒï¼ˆæ²¡æœ‰æ˜æ˜¾çš„æ€§èƒ½æå‡ï¼Œç»´æŠ¤æˆæœ¬é«˜ï¼‰</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h2 id="2-hello-world">2. Hello World</h2>

<h3 id="21-ç›®æ ‡">2.1 ç›®æ ‡</h3>

<p>å¼€å‘ä¸€ä¸ªç®€å•çš„æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯</p>

<ul>
  <li>å®¢æˆ·ç«¯å‘æœåŠ¡å™¨ç«¯å‘é€ hello, world</li>
  <li>æœåŠ¡å™¨ä»…æ¥æ”¶ï¼Œä¸è¿”å›</li>
</ul>

<p>åŠ å…¥ä¾èµ–</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>io.netty<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>netty-all<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>4.1.39.Final<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="22-æœåŠ¡å™¨ç«¯">2.2 æœåŠ¡å™¨ç«¯</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="k">new</span> <span class="nc">ServerBootstrap</span><span class="o">()</span>
    <span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">())</span> <span class="c1">// 1</span>
    <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="c1">// 2</span>
    <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">NioSocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span> <span class="c1">// 3</span>
        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">NioSocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">StringDecoder</span><span class="o">());</span> <span class="c1">// 5</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">SimpleChannelInboundHandler</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;()</span> <span class="o">{</span> <span class="c1">// 6</span>
                <span class="nd">@Override</span>
                <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">channelRead0</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">String</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">});</span>
        <span class="o">}</span>
    <span class="o">})</span>
    <span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="mi">8080</span><span class="o">);</span> <span class="c1">// 4</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä»£ç è§£è¯»</p>

<ul>
  <li>
    <p>1 å¤„ï¼Œåˆ›å»º NioEventLoopGroupï¼Œå¯ä»¥ç®€å•ç†è§£ä¸º <code class="language-plaintext highlighter-rouge">çº¿ç¨‹æ±  + Selector</code> åé¢ä¼šè¯¦ç»†å±•å¼€</p>
  </li>
  <li>
    <p>2 å¤„ï¼Œé€‰æ‹©æœåŠ¡ Scoket å®ç°ç±»ï¼Œå…¶ä¸­ NioServerSocketChannel è¡¨ç¤ºåŸºäº NIO çš„æœåŠ¡å™¨ç«¯å®ç°ï¼Œå…¶å®ƒå®ç°è¿˜æœ‰</p>

    <p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0006.png" alt="" /></p>
  </li>
  <li>
    <p>3 å¤„ï¼Œä¸ºå•¥æ–¹æ³•å« childHandlerï¼Œæ˜¯æ¥ä¸‹æ¥æ·»åŠ çš„å¤„ç†å™¨éƒ½æ˜¯ç»™ SocketChannel ç”¨çš„ï¼Œè€Œä¸æ˜¯ç»™ ServerSocketChannelã€‚ChannelInitializer å¤„ç†å™¨ï¼ˆä»…æ‰§è¡Œä¸€æ¬¡ï¼‰ï¼Œå®ƒçš„ä½œç”¨æ˜¯å¾…å®¢æˆ·ç«¯ SocketChannel å»ºç«‹è¿æ¥åï¼Œæ‰§è¡Œ initChannel ä»¥ä¾¿æ·»åŠ æ›´å¤šçš„å¤„ç†å™¨</p>
  </li>
  <li>
    <p>4 å¤„ï¼ŒServerSocketChannel ç»‘å®šçš„ç›‘å¬ç«¯å£</p>
  </li>
  <li>
    <p>5 å¤„ï¼ŒSocketChannel çš„å¤„ç†å™¨ï¼Œè§£ç  ByteBuf =&gt; String</p>
  </li>
  <li>
    <p>6 å¤„ï¼ŒSocketChannel çš„ä¸šåŠ¡å¤„ç†å™¨ï¼Œä½¿ç”¨ä¸Šä¸€ä¸ªå¤„ç†å™¨çš„å¤„ç†ç»“æœ</p>
  </li>
</ul>

<h3 id="23-å®¢æˆ·ç«¯">2.3 å®¢æˆ·ç«¯</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="k">new</span> <span class="nc">Bootstrap</span><span class="o">()</span>
    <span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">())</span> <span class="c1">// 1</span>
    <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="c1">// 2</span>
    <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">Channel</span><span class="o">&gt;()</span> <span class="o">{</span> <span class="c1">// 3</span>
        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">Channel</span> <span class="n">ch</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">StringEncoder</span><span class="o">());</span> <span class="c1">// 8</span>
        <span class="o">}</span>
    <span class="o">})</span>
    <span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="s">"127.0.0.1"</span><span class="o">,</span> <span class="mi">8080</span><span class="o">)</span> <span class="c1">// 4</span>
    <span class="o">.</span><span class="na">sync</span><span class="o">()</span> <span class="c1">// 5</span>
    <span class="o">.</span><span class="na">channel</span><span class="o">()</span> <span class="c1">// 6</span>
    <span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">()</span> <span class="o">+</span> <span class="s">": hello world!"</span><span class="o">);</span> <span class="c1">// 7</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä»£ç è§£è¯»</p>

<ul>
  <li>
    <p>1 å¤„ï¼Œåˆ›å»º NioEventLoopGroupï¼ŒåŒ Server</p>
  </li>
  <li>
    <p>2 å¤„ï¼Œé€‰æ‹©å®¢æˆ· Socket å®ç°ç±»ï¼ŒNioSocketChannel è¡¨ç¤ºåŸºäº NIO çš„å®¢æˆ·ç«¯å®ç°ï¼Œå…¶å®ƒå®ç°è¿˜æœ‰</p>

    <p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0007.png" alt="" /></p>
  </li>
  <li>
    <p>3 å¤„ï¼Œæ·»åŠ  SocketChannel çš„å¤„ç†å™¨ï¼ŒChannelInitializer å¤„ç†å™¨ï¼ˆä»…æ‰§è¡Œä¸€æ¬¡ï¼‰ï¼Œå®ƒçš„ä½œç”¨æ˜¯å¾…å®¢æˆ·ç«¯ SocketChannel å»ºç«‹è¿æ¥åï¼Œæ‰§è¡Œ initChannel ä»¥ä¾¿æ·»åŠ æ›´å¤šçš„å¤„ç†å™¨</p>
  </li>
  <li>
    <p>4 å¤„ï¼ŒæŒ‡å®šè¦è¿æ¥çš„æœåŠ¡å™¨å’Œç«¯å£</p>
  </li>
  <li>
    <p>5 å¤„ï¼ŒNetty ä¸­å¾ˆå¤šæ–¹æ³•éƒ½æ˜¯å¼‚æ­¥çš„ï¼Œå¦‚ connectï¼Œè¿™æ—¶éœ€è¦ä½¿ç”¨ sync æ–¹æ³•ç­‰å¾… connect å»ºç«‹è¿æ¥å®Œæ¯•</p>
  </li>
  <li>
    <p>6 å¤„ï¼Œè·å– channel å¯¹è±¡ï¼Œå®ƒå³ä¸ºé€šé“æŠ½è±¡ï¼Œå¯ä»¥è¿›è¡Œæ•°æ®è¯»å†™æ“ä½œ</p>
  </li>
  <li>
    <p>7 å¤„ï¼Œå†™å…¥æ¶ˆæ¯å¹¶æ¸…ç©ºç¼“å†²åŒº</p>
  </li>
  <li>
    <p>8 å¤„ï¼Œæ¶ˆæ¯ä¼šç»è¿‡é€šé“ handler å¤„ç†ï¼Œè¿™é‡Œæ˜¯å°† String =&gt; ByteBuf å‘å‡º</p>
  </li>
  <li>
    <p>æ•°æ®ç»è¿‡ç½‘ç»œä¼ è¾“ï¼Œåˆ°è¾¾æœåŠ¡å™¨ç«¯ï¼ŒæœåŠ¡å™¨ç«¯ 5 å’Œ 6 å¤„çš„ handler å…ˆåè¢«è§¦å‘ï¼Œèµ°å®Œä¸€ä¸ªæµç¨‹</p>
  </li>
</ul>

<h3 id="24-æµç¨‹æ¢³ç†">2.4 æµç¨‹æ¢³ç†</h3>

<p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0040.png" alt="" /></p>

<h4 id="-æç¤º">ğŸ’¡ æç¤º</h4>

<blockquote>
  <p>ä¸€å¼€å§‹éœ€è¦æ ‘ç«‹æ­£ç¡®çš„è§‚å¿µ</p>

  <ul>
    <li>æŠŠ channel ç†è§£ä¸ºæ•°æ®çš„é€šé“</li>
    <li>æŠŠ msg ç†è§£ä¸ºæµåŠ¨çš„æ•°æ®ï¼Œæœ€å¼€å§‹è¾“å…¥æ˜¯ ByteBufï¼Œä½†ç»è¿‡ pipeline çš„åŠ å·¥ï¼Œä¼šå˜æˆå…¶å®ƒç±»å‹å¯¹è±¡ï¼Œæœ€åè¾“å‡ºåˆå˜æˆ ByteBuf</li>
    <li>æŠŠ handler ç†è§£ä¸ºæ•°æ®çš„å¤„ç†å·¥åº
      <ul>
        <li>å·¥åºæœ‰å¤šé“ï¼Œåˆåœ¨ä¸€èµ·å°±æ˜¯ pipelineï¼Œpipeline è´Ÿè´£å‘å¸ƒäº‹ä»¶ï¼ˆè¯»ã€è¯»å–å®Œæˆâ€¦ï¼‰ä¼ æ’­ç»™æ¯ä¸ª handlerï¼Œ handler å¯¹è‡ªå·±æ„Ÿå…´è¶£çš„äº‹ä»¶è¿›è¡Œå¤„ç†ï¼ˆé‡å†™äº†ç›¸åº”äº‹ä»¶å¤„ç†æ–¹æ³•ï¼‰</li>
        <li>handler åˆ† Inbound å’Œ Outbound ä¸¤ç±»</li>
      </ul>
    </li>
    <li>æŠŠ eventLoop ç†è§£ä¸ºå¤„ç†æ•°æ®çš„å·¥äºº
      <ul>
        <li>å·¥äººå¯ä»¥ç®¡ç†å¤šä¸ª channel çš„ io æ“ä½œï¼Œå¹¶ä¸”ä¸€æ—¦å·¥äººè´Ÿè´£äº†æŸä¸ª channelï¼Œå°±è¦è´Ÿè´£åˆ°åº•ï¼ˆç»‘å®šï¼‰</li>
        <li>å·¥äººæ—¢å¯ä»¥æ‰§è¡Œ io æ“ä½œï¼Œä¹Ÿå¯ä»¥è¿›è¡Œä»»åŠ¡å¤„ç†ï¼Œæ¯ä½å·¥äººæœ‰ä»»åŠ¡é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—é‡Œå¯ä»¥å †æ”¾å¤šä¸ª channel çš„å¾…å¤„ç†ä»»åŠ¡ï¼Œä»»åŠ¡åˆ†ä¸ºæ™®é€šä»»åŠ¡ã€å®šæ—¶ä»»åŠ¡</li>
        <li>å·¥äººæŒ‰ç…§ pipeline é¡ºåºï¼Œä¾æ¬¡æŒ‰ç…§ handler çš„è§„åˆ’ï¼ˆä»£ç ï¼‰å¤„ç†æ•°æ®ï¼Œå¯ä»¥ä¸ºæ¯é“å·¥åºæŒ‡å®šä¸åŒçš„å·¥äºº</li>
      </ul>
    </li>
  </ul>
</blockquote>

<h2 id="3-ç»„ä»¶">3. ç»„ä»¶</h2>

<h3 id="31-eventloop">3.1 EventLoop</h3>

<p>äº‹ä»¶å¾ªç¯å¯¹è±¡</p>

<p>EventLoop æœ¬è´¨æ˜¯ä¸€ä¸ªå•çº¿ç¨‹æ‰§è¡Œå™¨ï¼ˆåŒæ—¶ç»´æŠ¤äº†ä¸€ä¸ª Selectorï¼‰ï¼Œé‡Œé¢æœ‰ run æ–¹æ³•å¤„ç† Channel ä¸Šæºæºä¸æ–­çš„ io äº‹ä»¶ã€‚</p>

<p>å®ƒçš„ç»§æ‰¿å…³ç³»æ¯”è¾ƒå¤æ‚</p>

<ul>
  <li>ä¸€æ¡çº¿æ˜¯ç»§æ‰¿è‡ª j.u.c.ScheduledExecutorService å› æ­¤åŒ…å«äº†çº¿ç¨‹æ± ä¸­æ‰€æœ‰çš„æ–¹æ³•</li>
  <li>å¦ä¸€æ¡çº¿æ˜¯ç»§æ‰¿è‡ª netty è‡ªå·±çš„ OrderedEventExecutorï¼Œ
    <ul>
      <li>æä¾›äº† boolean inEventLoop(Thread thread) æ–¹æ³•åˆ¤æ–­ä¸€ä¸ªçº¿ç¨‹æ˜¯å¦å±äºæ­¤ EventLoop</li>
      <li>æä¾›äº† parent æ–¹æ³•æ¥çœ‹çœ‹è‡ªå·±å±äºå“ªä¸ª EventLoopGroup</li>
    </ul>
  </li>
</ul>

<p>äº‹ä»¶å¾ªç¯ç»„</p>

<p>EventLoopGroup æ˜¯ä¸€ç»„ EventLoopï¼ŒChannel ä¸€èˆ¬ä¼šè°ƒç”¨ EventLoopGroup çš„ register æ–¹æ³•æ¥ç»‘å®šå…¶ä¸­ä¸€ä¸ª EventLoopï¼Œåç»­è¿™ä¸ª Channel ä¸Šçš„ io äº‹ä»¶éƒ½ç”±æ­¤ EventLoop æ¥å¤„ç†ï¼ˆä¿è¯äº† io äº‹ä»¶å¤„ç†æ—¶çš„çº¿ç¨‹å®‰å…¨ï¼‰</p>

<ul>
  <li>ç»§æ‰¿è‡ª netty è‡ªå·±çš„ EventExecutorGroup
    <ul>
      <li>å®ç°äº† Iterable æ¥å£æä¾›éå† EventLoop çš„èƒ½åŠ›</li>
      <li>å¦æœ‰ next æ–¹æ³•è·å–é›†åˆä¸­ä¸‹ä¸€ä¸ª EventLoop</li>
    </ul>
  </li>
</ul>

<p>ä»¥ä¸€ä¸ªç®€å•çš„å®ç°ä¸ºä¾‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="c1">// å†…éƒ¨åˆ›å»ºäº†ä¸¤ä¸ª EventLoop, æ¯ä¸ª EventLoop ç»´æŠ¤ä¸€ä¸ªçº¿ç¨‹</span>
<span class="nc">DefaultEventLoopGroup</span> <span class="n">group</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultEventLoopGroup</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">group</span><span class="o">.</span><span class="na">next</span><span class="o">());</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">group</span><span class="o">.</span><span class="na">next</span><span class="o">());</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">group</span><span class="o">.</span><span class="na">next</span><span class="o">());</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>io.netty.channel.DefaultEventLoop@60f82f98
io.netty.channel.DefaultEventLoop@35f983a6
io.netty.channel.DefaultEventLoop@60f82f98
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä¹Ÿå¯ä»¥ä½¿ç”¨ for å¾ªç¯</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nc">DefaultEventLoopGroup</span> <span class="n">group</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultEventLoopGroup</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
<span class="k">for</span> <span class="o">(</span><span class="nc">EventExecutor</span> <span class="n">eventLoop</span> <span class="o">:</span> <span class="n">group</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">eventLoop</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>io.netty.channel.DefaultEventLoop@60f82f98
io.netty.channel.DefaultEventLoop@35f983a6
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="-ä¼˜é›…å…³é—­">ğŸ’¡ ä¼˜é›…å…³é—­</h4>

<p>ä¼˜é›…å…³é—­ <code class="language-plaintext highlighter-rouge">shutdownGracefully</code> æ–¹æ³•ã€‚è¯¥æ–¹æ³•ä¼šé¦–å…ˆåˆ‡æ¢ <code class="language-plaintext highlighter-rouge">EventLoopGroup</code> åˆ°å…³é—­çŠ¶æ€ä»è€Œæ‹’ç»æ–°çš„ä»»åŠ¡çš„åŠ å…¥ï¼Œç„¶ååœ¨ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡éƒ½å¤„ç†å®Œæˆåï¼Œåœæ­¢çº¿ç¨‹çš„è¿è¡Œã€‚ä»è€Œç¡®ä¿æ•´ä½“åº”ç”¨æ˜¯åœ¨æ­£å¸¸æœ‰åºçš„çŠ¶æ€ä¸‹é€€å‡ºçš„</p>

<h4 id="æ¼”ç¤º-nioeventloop-å¤„ç†-io-äº‹ä»¶">æ¼”ç¤º NioEventLoop å¤„ç† io äº‹ä»¶</h4>

<p>æœåŠ¡å™¨ç«¯ä¸¤ä¸ª nio worker å·¥äºº</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="k">new</span> <span class="nc">ServerBootstrap</span><span class="o">()</span>
    <span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">(</span><span class="mi">1</span><span class="o">),</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">(</span><span class="mi">2</span><span class="o">))</span>
    <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">NioSocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">NioSocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInboundHandlerAdapter</span><span class="o">()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">ByteBuf</span> <span class="n">byteBuf</span> <span class="o">=</span> <span class="n">msg</span> <span class="k">instanceof</span> <span class="nc">ByteBuf</span> <span class="o">?</span> <span class="o">((</span><span class="nc">ByteBuf</span><span class="o">)</span> <span class="n">msg</span><span class="o">)</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">byteBuf</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="kt">byte</span><span class="o">[]</span> <span class="n">buf</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">16</span><span class="o">];</span>
                        <span class="nc">ByteBuf</span> <span class="n">len</span> <span class="o">=</span> <span class="n">byteBuf</span><span class="o">.</span><span class="na">readBytes</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">byteBuf</span><span class="o">.</span><span class="na">readableBytes</span><span class="o">());</span>
                        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">buf</span><span class="o">));</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">});</span>
        <span class="o">}</span>
    <span class="o">}).</span><span class="na">bind</span><span class="o">(</span><span class="mi">8080</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å®¢æˆ·ç«¯ï¼Œå¯åŠ¨ä¸‰æ¬¡ï¼Œåˆ†åˆ«ä¿®æ”¹å‘é€å­—ç¬¦ä¸²ä¸º zhangsanï¼ˆç¬¬ä¸€æ¬¡ï¼‰ï¼Œlisiï¼ˆç¬¬äºŒæ¬¡ï¼‰ï¼Œwangwuï¼ˆç¬¬ä¸‰æ¬¡ï¼‰</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
    <span class="nc">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Bootstrap</span><span class="o">()</span>
            <span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">(</span><span class="mi">1</span><span class="o">))</span>
            <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">NioSocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">NioSocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"init..."</span><span class="o">);</span>
                    <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">LoggingHandler</span><span class="o">(</span><span class="nc">LogLevel</span><span class="o">.</span><span class="na">DEBUG</span><span class="o">));</span>
                <span class="o">}</span>
            <span class="o">})</span>
            <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">connect</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="mi">8080</span><span class="o">)</span>
            <span class="o">.</span><span class="na">sync</span><span class="o">()</span>
            <span class="o">.</span><span class="na">channel</span><span class="o">();</span>

    <span class="n">channel</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="nc">ByteBufAllocator</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">.</span><span class="na">buffer</span><span class="o">().</span><span class="na">writeBytes</span><span class="o">(</span><span class="s">"wangwu"</span><span class="o">.</span><span class="na">getBytes</span><span class="o">()));</span>
    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">2000</span><span class="o">);</span>
    <span class="n">channel</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="nc">ByteBufAllocator</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">.</span><span class="na">buffer</span><span class="o">().</span><span class="na">writeBytes</span><span class="o">(</span><span class="s">"wangwu"</span><span class="o">.</span><span class="na">getBytes</span><span class="o">()));</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æœ€åè¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>22:03:34 [DEBUG] [nioEventLoopGroup-3-1] c.i.o.EventLoopTest - zhangsan       
22:03:36 [DEBUG] [nioEventLoopGroup-3-1] c.i.o.EventLoopTest - zhangsan       
22:05:36 [DEBUG] [nioEventLoopGroup-3-2] c.i.o.EventLoopTest - lisi           
22:05:38 [DEBUG] [nioEventLoopGroup-3-2] c.i.o.EventLoopTest - lisi           
22:06:09 [DEBUG] [nioEventLoopGroup-3-1] c.i.o.EventLoopTest - wangwu        
22:06:11 [DEBUG] [nioEventLoopGroup-3-1] c.i.o.EventLoopTest - wangwu         
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªå·¥äººè½®æµå¤„ç† channelï¼Œä½†å·¥äººä¸ channel ä¹‹é—´è¿›è¡Œäº†ç»‘å®š</p>

<p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0042.png" alt="" /></p>

<p>å†å¢åŠ ä¸¤ä¸ªé nio å·¥äºº</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="nc">DefaultEventLoopGroup</span> <span class="n">normalWorkers</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultEventLoopGroup</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
<span class="k">new</span> <span class="nf">ServerBootstrap</span><span class="o">()</span>
    <span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">(</span><span class="mi">1</span><span class="o">),</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">(</span><span class="mi">2</span><span class="o">))</span>
    <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">NioSocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">NioSocketChannel</span> <span class="n">ch</span><span class="o">)</span>  <span class="o">{</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">LoggingHandler</span><span class="o">(</span><span class="nc">LogLevel</span><span class="o">.</span><span class="na">DEBUG</span><span class="o">));</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="n">normalWorkers</span><span class="o">,</span><span class="s">"myhandler"</span><span class="o">,</span>
              <span class="k">new</span> <span class="nf">ChannelInboundHandlerAdapter</span><span class="o">()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">ByteBuf</span> <span class="n">byteBuf</span> <span class="o">=</span> <span class="n">msg</span> <span class="k">instanceof</span> <span class="nc">ByteBuf</span> <span class="o">?</span> <span class="o">((</span><span class="nc">ByteBuf</span><span class="o">)</span> <span class="n">msg</span><span class="o">)</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">byteBuf</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="kt">byte</span><span class="o">[]</span> <span class="n">buf</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">16</span><span class="o">];</span>
                        <span class="nc">ByteBuf</span> <span class="n">len</span> <span class="o">=</span> <span class="n">byteBuf</span><span class="o">.</span><span class="na">readBytes</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">byteBuf</span><span class="o">.</span><span class="na">readableBytes</span><span class="o">());</span>
                        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">buf</span><span class="o">));</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">});</span>
        <span class="o">}</span>
    <span class="o">}).</span><span class="na">bind</span><span class="o">(</span><span class="mi">8080</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å®¢æˆ·ç«¯ä»£ç ä¸å˜ï¼Œå¯åŠ¨ä¸‰æ¬¡ï¼Œåˆ†åˆ«ä¿®æ”¹å‘é€å­—ç¬¦ä¸²ä¸º zhangsanï¼ˆç¬¬ä¸€æ¬¡ï¼‰ï¼Œlisiï¼ˆç¬¬äºŒæ¬¡ï¼‰ï¼Œwangwuï¼ˆç¬¬ä¸‰æ¬¡ï¼‰</p>

<p>è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
</pre></td><td class="rouge-code"><pre>22:19:48 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x251562d5, L:/127.0.0.1:8080 - R:/127.0.0.1:52588] REGISTERED
22:19:48 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x251562d5, L:/127.0.0.1:8080 - R:/127.0.0.1:52588] ACTIVE
22:19:48 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x251562d5, L:/127.0.0.1:8080 - R:/127.0.0.1:52588] READ: 8B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 7a 68 61 6e 67 73 61 6e                         |zhangsan        |
+--------+-------------------------------------------------+----------------+
22:19:48 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x251562d5, L:/127.0.0.1:8080 - R:/127.0.0.1:52588] READ COMPLETE
22:19:48 [DEBUG] [defaultEventLoopGroup-2-1] c.i.o.EventLoopTest - zhangsan        
22:19:50 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x251562d5, L:/127.0.0.1:8080 - R:/127.0.0.1:52588] READ: 8B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 7a 68 61 6e 67 73 61 6e                         |zhangsan        |
+--------+-------------------------------------------------+----------------+
22:19:50 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x251562d5, L:/127.0.0.1:8080 - R:/127.0.0.1:52588] READ COMPLETE
22:19:50 [DEBUG] [defaultEventLoopGroup-2-1] c.i.o.EventLoopTest - zhangsan        
22:20:24 [DEBUG] [nioEventLoopGroup-4-2] i.n.h.l.LoggingHandler - [id: 0x94b2a840, L:/127.0.0.1:8080 - R:/127.0.0.1:52612] REGISTERED
22:20:24 [DEBUG] [nioEventLoopGroup-4-2] i.n.h.l.LoggingHandler - [id: 0x94b2a840, L:/127.0.0.1:8080 - R:/127.0.0.1:52612] ACTIVE
22:20:25 [DEBUG] [nioEventLoopGroup-4-2] i.n.h.l.LoggingHandler - [id: 0x94b2a840, L:/127.0.0.1:8080 - R:/127.0.0.1:52612] READ: 4B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 6c 69 73 69                                     |lisi            |
+--------+-------------------------------------------------+----------------+
22:20:25 [DEBUG] [nioEventLoopGroup-4-2] i.n.h.l.LoggingHandler - [id: 0x94b2a840, L:/127.0.0.1:8080 - R:/127.0.0.1:52612] READ COMPLETE
22:20:25 [DEBUG] [defaultEventLoopGroup-2-2] c.i.o.EventLoopTest - lisi            
22:20:27 [DEBUG] [nioEventLoopGroup-4-2] i.n.h.l.LoggingHandler - [id: 0x94b2a840, L:/127.0.0.1:8080 - R:/127.0.0.1:52612] READ: 4B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 6c 69 73 69                                     |lisi            |
+--------+-------------------------------------------------+----------------+
22:20:27 [DEBUG] [nioEventLoopGroup-4-2] i.n.h.l.LoggingHandler - [id: 0x94b2a840, L:/127.0.0.1:8080 - R:/127.0.0.1:52612] READ COMPLETE
22:20:27 [DEBUG] [defaultEventLoopGroup-2-2] c.i.o.EventLoopTest - lisi            
22:20:38 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x79a26af9, L:/127.0.0.1:8080 - R:/127.0.0.1:52625] REGISTERED
22:20:38 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x79a26af9, L:/127.0.0.1:8080 - R:/127.0.0.1:52625] ACTIVE
22:20:38 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x79a26af9, L:/127.0.0.1:8080 - R:/127.0.0.1:52625] READ: 6B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 77 61 6e 67 77 75                               |wangwu          |
+--------+-------------------------------------------------+----------------+
22:20:38 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x79a26af9, L:/127.0.0.1:8080 - R:/127.0.0.1:52625] READ COMPLETE
22:20:38 [DEBUG] [defaultEventLoopGroup-2-1] c.i.o.EventLoopTest - wangwu          
22:20:40 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x79a26af9, L:/127.0.0.1:8080 - R:/127.0.0.1:52625] READ: 6B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 77 61 6e 67 77 75                               |wangwu          |
+--------+-------------------------------------------------+----------------+
22:20:40 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x79a26af9, L:/127.0.0.1:8080 - R:/127.0.0.1:52625] READ COMPLETE
22:20:40 [DEBUG] [defaultEventLoopGroup-2-1] c.i.o.EventLoopTest - wangwu          
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¯ä»¥çœ‹åˆ°ï¼Œnio å·¥äººå’Œ é nio å·¥äººä¹Ÿåˆ†åˆ«ç»‘å®šäº† channelï¼ˆLoggingHandler ç”± nio å·¥äººæ‰§è¡Œï¼Œè€Œæˆ‘ä»¬è‡ªå·±çš„ handler ç”±é nio å·¥äººæ‰§è¡Œï¼‰</p>

<p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0041.png" alt="" /></p>

<h4 id="-handler-æ‰§è¡Œä¸­å¦‚ä½•æ¢äºº">ğŸ’¡ handler æ‰§è¡Œä¸­å¦‚ä½•æ¢äººï¼Ÿ</h4>

<p>å…³é”®ä»£ç  <code class="language-plaintext highlighter-rouge">io.netty.channel.AbstractChannelHandlerContext#invokeChannelRead()</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="kd">static</span> <span class="kt">void</span> <span class="nf">invokeChannelRead</span><span class="o">(</span><span class="kd">final</span> <span class="nc">AbstractChannelHandlerContext</span> <span class="n">next</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="nc">Object</span> <span class="n">m</span> <span class="o">=</span> <span class="n">next</span><span class="o">.</span><span class="na">pipeline</span><span class="o">.</span><span class="na">touch</span><span class="o">(</span><span class="nc">ObjectUtil</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="s">"msg"</span><span class="o">),</span> <span class="n">next</span><span class="o">);</span>
    <span class="c1">// ä¸‹ä¸€ä¸ª handler çš„äº‹ä»¶å¾ªç¯æ˜¯å¦ä¸å½“å‰çš„äº‹ä»¶å¾ªç¯æ˜¯åŒä¸€ä¸ªçº¿ç¨‹</span>
    <span class="nc">EventExecutor</span> <span class="n">executor</span> <span class="o">=</span> <span class="n">next</span><span class="o">.</span><span class="na">executor</span><span class="o">();</span>
    
    <span class="c1">// æ˜¯ï¼Œç›´æ¥è°ƒç”¨</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">executor</span><span class="o">.</span><span class="na">inEventLoop</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">next</span><span class="o">.</span><span class="na">invokeChannelRead</span><span class="o">(</span><span class="n">m</span><span class="o">);</span>
    <span class="o">}</span> 
    <span class="c1">// ä¸æ˜¯ï¼Œå°†è¦æ‰§è¡Œçš„ä»£ç ä½œä¸ºä»»åŠ¡æäº¤ç»™ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªç¯å¤„ç†ï¼ˆæ¢äººï¼‰</span>
    <span class="k">else</span> <span class="o">{</span>
        <span class="n">executor</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="n">next</span><span class="o">.</span><span class="na">invokeChannelRead</span><span class="o">(</span><span class="n">m</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>å¦‚æœä¸¤ä¸ª handler ç»‘å®šçš„æ˜¯åŒä¸€ä¸ªçº¿ç¨‹ï¼Œé‚£ä¹ˆå°±ç›´æ¥è°ƒç”¨</li>
  <li>å¦åˆ™ï¼ŒæŠŠè¦è°ƒç”¨çš„ä»£ç å°è£…ä¸ºä¸€ä¸ªä»»åŠ¡å¯¹è±¡ï¼Œç”±ä¸‹ä¸€ä¸ª handler çš„çº¿ç¨‹æ¥è°ƒç”¨</li>
</ul>

<h4 id="æ¼”ç¤º-nioeventloop-å¤„ç†æ™®é€šä»»åŠ¡">æ¼”ç¤º NioEventLoop å¤„ç†æ™®é€šä»»åŠ¡</h4>

<p>NioEventLoop é™¤äº†å¯ä»¥å¤„ç† io äº‹ä»¶ï¼ŒåŒæ ·å¯ä»¥å‘å®ƒæäº¤æ™®é€šä»»åŠ¡</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="nc">NioEventLoopGroup</span> <span class="n">nioWorkers</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>

<span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"server start..."</span><span class="o">);</span>
<span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">2000</span><span class="o">);</span>
<span class="n">nioWorkers</span><span class="o">.</span><span class="na">execute</span><span class="o">(()-&gt;{</span>
    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"normal task..."</span><span class="o">);</span>
<span class="o">});</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>22:30:36 [DEBUG] [main] c.i.o.EventLoopTest2 - server start...
22:30:38 [DEBUG] [nioEventLoopGroup-2-1] c.i.o.EventLoopTest2 - normal task...
</pre></td></tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>å¯ä»¥ç”¨æ¥æ‰§è¡Œè€—æ—¶è¾ƒé•¿çš„ä»»åŠ¡</p>
</blockquote>

<h4 id="æ¼”ç¤º-nioeventloop-å¤„ç†å®šæ—¶ä»»åŠ¡">æ¼”ç¤º NioEventLoop å¤„ç†å®šæ—¶ä»»åŠ¡</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="nc">NioEventLoopGroup</span> <span class="n">nioWorkers</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>

<span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"server start..."</span><span class="o">);</span>
<span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">2000</span><span class="o">);</span>
<span class="n">nioWorkers</span><span class="o">.</span><span class="na">scheduleAtFixedRate</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"running..."</span><span class="o">);</span>
<span class="o">},</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>22:35:15 [DEBUG] [main] c.i.o.EventLoopTest2 - server start...
22:35:17 [DEBUG] [nioEventLoopGroup-2-1] c.i.o.EventLoopTest2 - running...
22:35:18 [DEBUG] [nioEventLoopGroup-2-1] c.i.o.EventLoopTest2 - running...
22:35:19 [DEBUG] [nioEventLoopGroup-2-1] c.i.o.EventLoopTest2 - running...
22:35:20 [DEBUG] [nioEventLoopGroup-2-1] c.i.o.EventLoopTest2 - running...
...
</pre></td></tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>å¯ä»¥ç”¨æ¥æ‰§è¡Œå®šæ—¶ä»»åŠ¡</p>
</blockquote>

<h3 id="32-channel">3.2 Channel</h3>

<p>channel çš„ä¸»è¦ä½œç”¨</p>

<ul>
  <li>close() å¯ä»¥ç”¨æ¥å…³é—­ channel</li>
  <li>closeFuture() ç”¨æ¥å¤„ç† channel çš„å…³é—­
    <ul>
      <li>sync æ–¹æ³•ä½œç”¨æ˜¯åŒæ­¥ç­‰å¾… channel å…³é—­</li>
      <li>è€Œ addListener æ–¹æ³•æ˜¯å¼‚æ­¥ç­‰å¾… channel å…³é—­</li>
    </ul>
  </li>
  <li>pipeline() æ–¹æ³•æ·»åŠ å¤„ç†å™¨</li>
  <li>write() æ–¹æ³•å°†æ•°æ®å†™å…¥</li>
  <li>writeAndFlush() æ–¹æ³•å°†æ•°æ®å†™å…¥å¹¶åˆ·å‡º</li>
</ul>

<h4 id="channelfuture">ChannelFuture</h4>

<p>è¿™æ—¶åˆšæ‰çš„å®¢æˆ·ç«¯ä»£ç </p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="k">new</span> <span class="nc">Bootstrap</span><span class="o">()</span>
    <span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">())</span>
    <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">Channel</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">Channel</span> <span class="n">ch</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">StringEncoder</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">})</span>
    <span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="s">"127.0.0.1"</span><span class="o">,</span> <span class="mi">8080</span><span class="o">)</span>
    <span class="o">.</span><span class="na">sync</span><span class="o">()</span>
    <span class="o">.</span><span class="na">channel</span><span class="o">()</span>
    <span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">()</span> <span class="o">+</span> <span class="s">": hello world!"</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç°åœ¨æŠŠå®ƒæ‹†å¼€æ¥çœ‹</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="nc">ChannelFuture</span> <span class="n">channelFuture</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Bootstrap</span><span class="o">()</span>
    <span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">())</span>
    <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">Channel</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">Channel</span> <span class="n">ch</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">StringEncoder</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">})</span>
    <span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="s">"127.0.0.1"</span><span class="o">,</span> <span class="mi">8080</span><span class="o">);</span> <span class="c1">// 1</span>

<span class="n">channelFuture</span><span class="o">.</span><span class="na">sync</span><span class="o">().</span><span class="na">channel</span><span class="o">().</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">()</span> <span class="o">+</span> <span class="s">": hello world!"</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>1 å¤„è¿”å›çš„æ˜¯ ChannelFuture å¯¹è±¡ï¼Œå®ƒçš„ä½œç”¨æ˜¯åˆ©ç”¨ channel() æ–¹æ³•æ¥è·å– Channel å¯¹è±¡</li>
</ul>

<p><strong>æ³¨æ„</strong> connect æ–¹æ³•æ˜¯å¼‚æ­¥çš„ï¼Œæ„å‘³ç€ä¸ç­‰è¿æ¥å»ºç«‹ï¼Œæ–¹æ³•æ‰§è¡Œå°±è¿”å›äº†ã€‚å› æ­¤ channelFuture å¯¹è±¡ä¸­ä¸èƒ½ã€ç«‹åˆ»ã€‘è·å¾—åˆ°æ­£ç¡®çš„ Channel å¯¹è±¡</p>

<p>å®éªŒå¦‚ä¸‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="nc">ChannelFuture</span> <span class="n">channelFuture</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Bootstrap</span><span class="o">()</span>
    <span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">())</span>
    <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">Channel</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">Channel</span> <span class="n">ch</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">StringEncoder</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">})</span>
    <span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="s">"127.0.0.1"</span><span class="o">,</span> <span class="mi">8080</span><span class="o">);</span>

<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">channelFuture</span><span class="o">.</span><span class="na">channel</span><span class="o">());</span> <span class="c1">// 1</span>
<span class="n">channelFuture</span><span class="o">.</span><span class="na">sync</span><span class="o">();</span> <span class="c1">// 2</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">channelFuture</span><span class="o">.</span><span class="na">channel</span><span class="o">());</span> <span class="c1">// 3</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>æ‰§è¡Œåˆ° 1 æ—¶ï¼Œè¿æ¥æœªå»ºç«‹ï¼Œæ‰“å° <code class="language-plaintext highlighter-rouge">[id: 0x2e1884dd]</code></li>
  <li>æ‰§è¡Œåˆ° 2 æ—¶ï¼Œsync æ–¹æ³•æ˜¯åŒæ­¥ç­‰å¾…è¿æ¥å»ºç«‹å®Œæˆ</li>
  <li>æ‰§è¡Œåˆ° 3 æ—¶ï¼Œè¿æ¥è‚¯å®šå»ºç«‹äº†ï¼Œæ‰“å° <code class="language-plaintext highlighter-rouge">[id: 0x2e1884dd, L:/127.0.0.1:57191 - R:/127.0.0.1:8080]</code></li>
</ul>

<p>é™¤äº†ç”¨ sync æ–¹æ³•å¯ä»¥è®©å¼‚æ­¥æ“ä½œåŒæ­¥ä»¥å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨å›è°ƒçš„æ–¹å¼ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="nc">ChannelFuture</span> <span class="n">channelFuture</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Bootstrap</span><span class="o">()</span>
    <span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">())</span>
    <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">Channel</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">Channel</span> <span class="n">ch</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">StringEncoder</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">})</span>
    <span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="s">"127.0.0.1"</span><span class="o">,</span> <span class="mi">8080</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">channelFuture</span><span class="o">.</span><span class="na">channel</span><span class="o">());</span> <span class="c1">// 1</span>
<span class="n">channelFuture</span><span class="o">.</span><span class="na">addListener</span><span class="o">((</span><span class="nc">ChannelFutureListener</span><span class="o">)</span> <span class="n">future</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">future</span><span class="o">.</span><span class="na">channel</span><span class="o">());</span> <span class="c1">// 2</span>
<span class="o">});</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>æ‰§è¡Œåˆ° 1 æ—¶ï¼Œè¿æ¥æœªå»ºç«‹ï¼Œæ‰“å° <code class="language-plaintext highlighter-rouge">[id: 0x749124ba]</code></li>
  <li>ChannelFutureListener ä¼šåœ¨è¿æ¥å»ºç«‹æ—¶è¢«è°ƒç”¨ï¼ˆå…¶ä¸­ operationComplete æ–¹æ³•ï¼‰ï¼Œå› æ­¤æ‰§è¡Œåˆ° 2 æ—¶ï¼Œè¿æ¥è‚¯å®šå»ºç«‹äº†ï¼Œæ‰“å° <code class="language-plaintext highlighter-rouge">[id: 0x749124ba, L:/127.0.0.1:57351 - R:/127.0.0.1:8080]</code></li>
</ul>

<h4 id="closefuture">CloseFuture</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre></td><td class="rouge-code"><pre><span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CloseFutureClient</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">NioEventLoopGroup</span> <span class="n">group</span> <span class="k">new</span> <span class="nf">NioEventLoopGroup</span><span class="o">();</span>
        <span class="nc">ChannelFuture</span> <span class="n">channelFuture</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Bootstrap</span><span class="o">()</span>
                <span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">group</span><span class="o">)</span>
                <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">NioSocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
                    <span class="nd">@Override</span> <span class="c1">// åœ¨è¿æ¥å»ºç«‹åè¢«è°ƒç”¨</span>
                    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">NioSocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                        <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">LoggingHandler</span><span class="o">(</span><span class="nc">LogLevel</span><span class="o">.</span><span class="na">DEBUG</span><span class="o">));</span>
                        <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">StringEncoder</span><span class="o">());</span>
                    <span class="o">}</span>
                <span class="o">})</span>
                <span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="mi">8080</span><span class="o">));</span>
        <span class="nc">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">channelFuture</span><span class="o">.</span><span class="na">sync</span><span class="o">().</span><span class="na">channel</span><span class="o">();</span>
        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"{}"</span><span class="o">,</span> <span class="n">channel</span><span class="o">);</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()-&gt;{</span>
            <span class="nc">Scanner</span> <span class="n">scanner</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Scanner</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">in</span><span class="o">);</span>
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">String</span> <span class="n">line</span> <span class="o">=</span> <span class="n">scanner</span><span class="o">.</span><span class="na">nextLine</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="s">"q"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">line</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">channel</span><span class="o">.</span><span class="na">close</span><span class="o">();</span> <span class="c1">// close å¼‚æ­¥æ“ä½œ 1s ä¹‹å</span>
<span class="c1">//                    log.debug("å¤„ç†å…³é—­ä¹‹åçš„æ“ä½œ"); // ä¸èƒ½åœ¨è¿™é‡Œå–„å</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="n">channel</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">line</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">},</span> <span class="s">"input"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>

        <span class="c1">// è·å– CloseFuture å¯¹è±¡ï¼Œ 1) åŒæ­¥å¤„ç†å…³é—­ï¼Œ 2) å¼‚æ­¥å¤„ç†å…³é—­</span>
        <span class="nc">ChannelFuture</span> <span class="n">closeFuture</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="na">closeFuture</span><span class="o">();</span>
        <span class="cm">/*log.debug("waiting close...");
        closeFuture.sync();
        log.debug("å¤„ç†å…³é—­ä¹‹åçš„æ“ä½œ");*/</span>
        <span class="n">closeFuture</span><span class="o">.</span><span class="na">addListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelFutureListener</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">operationComplete</span><span class="o">(</span><span class="nc">ChannelFuture</span> <span class="n">future</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"å¤„ç†å…³é—­ä¹‹åçš„æ“ä½œ"</span><span class="o">);</span>
                <span class="n">group</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="-å¼‚æ­¥æå‡çš„æ˜¯ä»€ä¹ˆ">ğŸ’¡ å¼‚æ­¥æå‡çš„æ˜¯ä»€ä¹ˆ</h4>

<ul>
  <li>
    <p>æœ‰äº›åŒå­¦çœ‹åˆ°è¿™é‡Œä¼šæœ‰ç–‘é—®ï¼šä¸ºä»€ä¹ˆä¸åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­å»æ‰§è¡Œå»ºç«‹è¿æ¥ã€å»æ‰§è¡Œå…³é—­ channelï¼Œé‚£æ ·ä¸æ˜¯ä¹Ÿå¯ä»¥å—ï¼Ÿéè¦ç”¨è¿™ä¹ˆå¤æ‚çš„å¼‚æ­¥æ–¹å¼ï¼šæ¯”å¦‚ä¸€ä¸ªçº¿ç¨‹å‘èµ·å»ºç«‹è¿æ¥ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å»çœŸæ­£å»ºç«‹è¿æ¥</p>
  </li>
  <li>
    <p>è¿˜æœ‰åŒå­¦ä¼šç¬¼ç»Ÿåœ°å›ç­”ï¼Œå› ä¸º netty å¼‚æ­¥æ–¹å¼ç”¨äº†å¤šçº¿ç¨‹ã€å¤šçº¿ç¨‹å°±æ•ˆç‡é«˜ã€‚å…¶å®è¿™äº›è®¤è¯†éƒ½æ¯”è¾ƒç‰‡é¢ï¼Œå¤šçº¿ç¨‹å’Œå¼‚æ­¥æ‰€æå‡çš„æ•ˆç‡å¹¶ä¸æ˜¯æ‰€è®¤ä¸ºçš„</p>
  </li>
</ul>

<p>æ€è€ƒä¸‹é¢çš„åœºæ™¯ï¼Œ4 ä¸ªåŒ»ç”Ÿç»™äººçœ‹ç—…ï¼Œæ¯ä¸ªç—…äººèŠ±è´¹ 20 åˆ†é’Ÿï¼Œè€Œä¸”åŒ»ç”Ÿçœ‹ç—…çš„è¿‡ç¨‹ä¸­æ˜¯ä»¥ç—…äººä¸ºå•ä½çš„ï¼Œä¸€ä¸ªç—…äººçœ‹å®Œäº†ï¼Œæ‰èƒ½çœ‹ä¸‹ä¸€ä¸ªç—…äººã€‚å‡è®¾ç—…äººæºæºä¸æ–­åœ°æ¥ï¼Œå¯ä»¥è®¡ç®—ä¸€ä¸‹ 4 ä¸ªåŒ»ç”Ÿä¸€å¤©å·¥ä½œ 8 å°æ—¶ï¼Œå¤„ç†çš„ç—…äººæ€»æ•°æ˜¯ï¼š<code class="language-plaintext highlighter-rouge">4 * 8 * 3 = 96</code></p>

<p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0044.png" alt="" /></p>

<p>ç»ç ”ç©¶å‘ç°ï¼Œçœ‹ç—…å¯ä»¥ç»†åˆ†ä¸ºå››ä¸ªæ­¥éª¤ï¼Œç»æ‹†åˆ†åæ¯ä¸ªæ­¥éª¤éœ€è¦ 5 åˆ†é’Ÿï¼Œå¦‚ä¸‹</p>

<p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0048.png" alt="" /></p>

<p>å› æ­¤å¯ä»¥åšå¦‚ä¸‹ä¼˜åŒ–ï¼Œåªæœ‰ä¸€å¼€å§‹ï¼ŒåŒ»ç”Ÿ 2ã€3ã€4 åˆ†åˆ«è¦ç­‰å¾… 5ã€10ã€15 åˆ†é’Ÿæ‰èƒ½æ‰§è¡Œå·¥ä½œï¼Œä½†åªè¦åç»­ç—…äººæºæºä¸æ–­åœ°æ¥ï¼Œä»–ä»¬å°±èƒ½å¤Ÿæ»¡è´Ÿè·å·¥ä½œï¼Œå¹¶ä¸”å¤„ç†ç—…äººçš„èƒ½åŠ›æé«˜åˆ°äº† <code class="language-plaintext highlighter-rouge">4 * 8 * 12</code> æ•ˆç‡å‡ ä¹æ˜¯åŸæ¥çš„å››å€</p>

<p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0047.png" alt="" /></p>

<p>è¦ç‚¹</p>

<ul>
  <li>å•çº¿ç¨‹æ²¡æ³•å¼‚æ­¥æé«˜æ•ˆç‡ï¼Œå¿…é¡»é…åˆå¤šçº¿ç¨‹ã€å¤šæ ¸ cpu æ‰èƒ½å‘æŒ¥å¼‚æ­¥çš„ä¼˜åŠ¿</li>
  <li>å¼‚æ­¥å¹¶æ²¡æœ‰ç¼©çŸ­å“åº”æ—¶é—´ï¼Œåè€Œæœ‰æ‰€å¢åŠ </li>
  <li>åˆç†è¿›è¡Œä»»åŠ¡æ‹†åˆ†ï¼Œä¹Ÿæ˜¯åˆ©ç”¨å¼‚æ­¥çš„å…³é”®</li>
</ul>

<h3 id="33-future--promise">3.3 Future &amp; Promise</h3>

<p>åœ¨å¼‚æ­¥å¤„ç†æ—¶ï¼Œç»å¸¸ç”¨åˆ°è¿™ä¸¤ä¸ªæ¥å£</p>

<p>é¦–å…ˆè¦è¯´æ˜ netty ä¸­çš„ Future ä¸ jdk ä¸­çš„ Future åŒåï¼Œä½†æ˜¯æ˜¯ä¸¤ä¸ªæ¥å£ï¼Œnetty çš„ Future ç»§æ‰¿è‡ª jdk çš„ Futureï¼Œè€Œ Promise åˆå¯¹ netty Future è¿›è¡Œäº†æ‰©å±•</p>

<ul>
  <li>jdk Future åªèƒ½åŒæ­¥ç­‰å¾…ä»»åŠ¡ç»“æŸï¼ˆæˆ–æˆåŠŸã€æˆ–å¤±è´¥ï¼‰æ‰èƒ½å¾—åˆ°ç»“æœ</li>
  <li>netty Future å¯ä»¥åŒæ­¥ç­‰å¾…ä»»åŠ¡ç»“æŸå¾—åˆ°ç»“æœï¼Œä¹Ÿå¯ä»¥å¼‚æ­¥æ–¹å¼å¾—åˆ°ç»“æœï¼Œä½†éƒ½æ˜¯è¦ç­‰ä»»åŠ¡ç»“æŸ</li>
  <li>netty Promise ä¸ä»…æœ‰ netty Future çš„åŠŸèƒ½ï¼Œè€Œä¸”è„±ç¦»äº†ä»»åŠ¡ç‹¬ç«‹å­˜åœ¨ï¼Œåªä½œä¸ºä¸¤ä¸ªçº¿ç¨‹é—´ä¼ é€’ç»“æœçš„å®¹å™¨</li>
</ul>

<table>
  <thead>
    <tr>
      <th>åŠŸèƒ½/åç§°</th>
      <th>jdk Future</th>
      <th>netty Future</th>
      <th>Promise</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>cancel</td>
      <td>å–æ¶ˆä»»åŠ¡</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <td>isCanceled</td>
      <td>ä»»åŠ¡æ˜¯å¦å–æ¶ˆ</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <td>isDone</td>
      <td>ä»»åŠ¡æ˜¯å¦å®Œæˆï¼Œä¸èƒ½åŒºåˆ†æˆåŠŸå¤±è´¥</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <td>get</td>
      <td>è·å–ä»»åŠ¡ç»“æœï¼Œé˜»å¡ç­‰å¾…</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <td>getNow</td>
      <td>-</td>
      <td>è·å–ä»»åŠ¡ç»“æœï¼Œéé˜»å¡ï¼Œè¿˜æœªäº§ç”Ÿç»“æœæ—¶è¿”å› null</td>
      <td>-</td>
    </tr>
    <tr>
      <td>await</td>
      <td>-</td>
      <td>ç­‰å¾…ä»»åŠ¡ç»“æŸï¼Œå¦‚æœä»»åŠ¡å¤±è´¥ï¼Œä¸ä¼šæŠ›å¼‚å¸¸ï¼Œè€Œæ˜¯é€šè¿‡ isSuccess åˆ¤æ–­</td>
      <td>-</td>
    </tr>
    <tr>
      <td>sync</td>
      <td>-</td>
      <td>ç­‰å¾…ä»»åŠ¡ç»“æŸï¼Œå¦‚æœä»»åŠ¡å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸</td>
      <td>-</td>
    </tr>
    <tr>
      <td>isSuccess</td>
      <td>-</td>
      <td>åˆ¤æ–­ä»»åŠ¡æ˜¯å¦æˆåŠŸ</td>
      <td>-</td>
    </tr>
    <tr>
      <td>cause</td>
      <td>-</td>
      <td>è·å–å¤±è´¥ä¿¡æ¯ï¼Œéé˜»å¡ï¼Œå¦‚æœæ²¡æœ‰å¤±è´¥ï¼Œè¿”å›null</td>
      <td>-</td>
    </tr>
    <tr>
      <td>addLinstener</td>
      <td>-</td>
      <td>æ·»åŠ å›è°ƒï¼Œå¼‚æ­¥æ¥æ”¶ç»“æœ</td>
      <td>-</td>
    </tr>
    <tr>
      <td>setSuccess</td>
      <td>-</td>
      <td>-</td>
      <td>è®¾ç½®æˆåŠŸç»“æœ</td>
    </tr>
    <tr>
      <td>setFailure</td>
      <td>-</td>
      <td>-</td>
      <td>è®¾ç½®å¤±è´¥ç»“æœ</td>
    </tr>
  </tbody>
</table>

<h4 id="ä¾‹1">ä¾‹1</h4>

<p>åŒæ­¥å¤„ç†ä»»åŠ¡æˆåŠŸ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="nc">DefaultEventLoop</span> <span class="n">eventExecutors</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultEventLoop</span><span class="o">();</span>
<span class="nc">DefaultPromise</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">promise</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultPromise</span><span class="o">&lt;&gt;(</span><span class="n">eventExecutors</span><span class="o">);</span>

<span class="n">eventExecutors</span><span class="o">.</span><span class="na">execute</span><span class="o">(()-&gt;{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"set success, {}"</span><span class="o">,</span><span class="mi">10</span><span class="o">);</span>
    <span class="n">promise</span><span class="o">.</span><span class="na">setSuccess</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
<span class="o">});</span>

<span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"start..."</span><span class="o">);</span>
<span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"{}"</span><span class="o">,</span><span class="n">promise</span><span class="o">.</span><span class="na">getNow</span><span class="o">());</span> <span class="c1">// è¿˜æ²¡æœ‰ç»“æœ</span>
<span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"{}"</span><span class="o">,</span><span class="n">promise</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>11:51:53 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - start...
11:51:53 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - null
11:51:54 [DEBUG] [defaultEventLoop-1-1] c.i.o.DefaultPromiseTest2 - set success, 10
11:51:54 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - 10
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="ä¾‹2">ä¾‹2</h4>

<p>å¼‚æ­¥å¤„ç†ä»»åŠ¡æˆåŠŸ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="nc">DefaultEventLoop</span> <span class="n">eventExecutors</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultEventLoop</span><span class="o">();</span>
<span class="nc">DefaultPromise</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">promise</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultPromise</span><span class="o">&lt;&gt;(</span><span class="n">eventExecutors</span><span class="o">);</span>

<span class="c1">// è®¾ç½®å›è°ƒï¼Œå¼‚æ­¥æ¥æ”¶ç»“æœ</span>
<span class="n">promise</span><span class="o">.</span><span class="na">addListener</span><span class="o">(</span><span class="n">future</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="c1">// è¿™é‡Œçš„ future å°±æ˜¯ä¸Šé¢çš„ promise</span>
    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"{}"</span><span class="o">,</span><span class="n">future</span><span class="o">.</span><span class="na">getNow</span><span class="o">());</span>
<span class="o">});</span>

<span class="c1">// ç­‰å¾… 1000 åè®¾ç½®æˆåŠŸç»“æœ</span>
<span class="n">eventExecutors</span><span class="o">.</span><span class="na">execute</span><span class="o">(()-&gt;{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"set success, {}"</span><span class="o">,</span><span class="mi">10</span><span class="o">);</span>
    <span class="n">promise</span><span class="o">.</span><span class="na">setSuccess</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
<span class="o">});</span>

<span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"start..."</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>11:49:30 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - start...
11:49:31 [DEBUG] [defaultEventLoop-1-1] c.i.o.DefaultPromiseTest2 - set success, 10
11:49:31 [DEBUG] [defaultEventLoop-1-1] c.i.o.DefaultPromiseTest2 - 10
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="ä¾‹3">ä¾‹3</h4>

<p>åŒæ­¥å¤„ç†ä»»åŠ¡å¤±è´¥ - sync &amp; get</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="nc">DefaultEventLoop</span> <span class="n">eventExecutors</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultEventLoop</span><span class="o">();</span>
        <span class="nc">DefaultPromise</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">promise</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultPromise</span><span class="o">&lt;&gt;(</span><span class="n">eventExecutors</span><span class="o">);</span>

        <span class="n">eventExecutors</span><span class="o">.</span><span class="na">execute</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="nc">RuntimeException</span> <span class="n">e</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RuntimeException</span><span class="o">(</span><span class="s">"error..."</span><span class="o">);</span>
            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"set failure, {}"</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
            <span class="n">promise</span><span class="o">.</span><span class="na">setFailure</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">});</span>

        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"start..."</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"{}"</span><span class="o">,</span> <span class="n">promise</span><span class="o">.</span><span class="na">getNow</span><span class="o">());</span>
        <span class="n">promise</span><span class="o">.</span><span class="na">get</span><span class="o">();</span> <span class="c1">// sync() ä¹Ÿä¼šå‡ºç°å¼‚å¸¸ï¼Œåªæ˜¯ get ä¼šå†ç”¨ ExecutionException åŒ…ä¸€å±‚å¼‚å¸¸</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre>12:11:07 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - start...
12:11:07 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - null
12:11:08 [DEBUG] [defaultEventLoop-1-1] c.i.o.DefaultPromiseTest2 - set failure, java.lang.RuntimeException: error...
Exception in thread "main" java.util.concurrent.ExecutionException: java.lang.RuntimeException: error...
	at io.netty.util.concurrent.AbstractFuture.get(AbstractFuture.java:41)
	at com.itcast.oio.DefaultPromiseTest2.main(DefaultPromiseTest2.java:34)
Caused by: java.lang.RuntimeException: error...
	at com.itcast.oio.DefaultPromiseTest2.lambda$main$0(DefaultPromiseTest2.java:27)
	at io.netty.channel.DefaultEventLoop.run(DefaultEventLoop.java:54)
	at io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:918)
	at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)
	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
	at java.lang.Thread.run(Thread.java:745)
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="ä¾‹4">ä¾‹4</h4>

<p>åŒæ­¥å¤„ç†ä»»åŠ¡å¤±è´¥ - await</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="nc">DefaultEventLoop</span> <span class="n">eventExecutors</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultEventLoop</span><span class="o">();</span>
<span class="nc">DefaultPromise</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">promise</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultPromise</span><span class="o">&lt;&gt;(</span><span class="n">eventExecutors</span><span class="o">);</span>

<span class="n">eventExecutors</span><span class="o">.</span><span class="na">execute</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="nc">RuntimeException</span> <span class="n">e</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RuntimeException</span><span class="o">(</span><span class="s">"error..."</span><span class="o">);</span>
    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"set failure, {}"</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
    <span class="n">promise</span><span class="o">.</span><span class="na">setFailure</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
<span class="o">});</span>

<span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"start..."</span><span class="o">);</span>
<span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"{}"</span><span class="o">,</span> <span class="n">promise</span><span class="o">.</span><span class="na">getNow</span><span class="o">());</span>
<span class="n">promise</span><span class="o">.</span><span class="na">await</span><span class="o">();</span> <span class="c1">// ä¸ sync å’Œ get åŒºåˆ«åœ¨äºï¼Œä¸ä¼šæŠ›å¼‚å¸¸</span>
<span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"result {}"</span><span class="o">,</span> <span class="o">(</span><span class="n">promise</span><span class="o">.</span><span class="na">isSuccess</span><span class="o">()</span> <span class="o">?</span> <span class="n">promise</span><span class="o">.</span><span class="na">getNow</span><span class="o">()</span> <span class="o">:</span> <span class="n">promise</span><span class="o">.</span><span class="na">cause</span><span class="o">()).</span><span class="na">toString</span><span class="o">());</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>12:18:53 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - start...
12:18:53 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - null
12:18:54 [DEBUG] [defaultEventLoop-1-1] c.i.o.DefaultPromiseTest2 - set failure, java.lang.RuntimeException: error...
12:18:54 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - result java.lang.RuntimeException: error...
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="ä¾‹5">ä¾‹5</h4>

<p>å¼‚æ­¥å¤„ç†ä»»åŠ¡å¤±è´¥</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="nc">DefaultEventLoop</span> <span class="n">eventExecutors</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultEventLoop</span><span class="o">();</span>
<span class="nc">DefaultPromise</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">promise</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultPromise</span><span class="o">&lt;&gt;(</span><span class="n">eventExecutors</span><span class="o">);</span>

<span class="n">promise</span><span class="o">.</span><span class="na">addListener</span><span class="o">(</span><span class="n">future</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"result {}"</span><span class="o">,</span> <span class="o">(</span><span class="n">promise</span><span class="o">.</span><span class="na">isSuccess</span><span class="o">()</span> <span class="o">?</span> <span class="n">promise</span><span class="o">.</span><span class="na">getNow</span><span class="o">()</span> <span class="o">:</span> <span class="n">promise</span><span class="o">.</span><span class="na">cause</span><span class="o">()).</span><span class="na">toString</span><span class="o">());</span>
<span class="o">});</span>

<span class="n">eventExecutors</span><span class="o">.</span><span class="na">execute</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="nc">RuntimeException</span> <span class="n">e</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RuntimeException</span><span class="o">(</span><span class="s">"error..."</span><span class="o">);</span>
    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"set failure, {}"</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
    <span class="n">promise</span><span class="o">.</span><span class="na">setFailure</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
<span class="o">});</span>

<span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"start..."</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>12:04:57 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - start...
12:04:58 [DEBUG] [defaultEventLoop-1-1] c.i.o.DefaultPromiseTest2 - set failure, java.lang.RuntimeException: error...
12:04:58 [DEBUG] [defaultEventLoop-1-1] c.i.o.DefaultPromiseTest2 - result java.lang.RuntimeException: error...
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="ä¾‹6">ä¾‹6</h4>

<p>await æ­»é”æ£€æŸ¥</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="nc">DefaultEventLoop</span> <span class="n">eventExecutors</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultEventLoop</span><span class="o">();</span>
<span class="nc">DefaultPromise</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">promise</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultPromise</span><span class="o">&lt;&gt;(</span><span class="n">eventExecutors</span><span class="o">);</span>

<span class="n">eventExecutors</span><span class="o">.</span><span class="na">submit</span><span class="o">(()-&gt;{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"1"</span><span class="o">);</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">promise</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
        <span class="c1">// æ³¨æ„ä¸èƒ½ä»…æ•è· InterruptedException å¼‚å¸¸</span>
        <span class="c1">// å¦åˆ™ æ­»é”æ£€æŸ¥æŠ›å‡ºçš„ BlockingOperationException ä¼šç»§ç»­å‘ä¸Šä¼ æ’­</span>
        <span class="c1">// è€Œæäº¤çš„ä»»åŠ¡ä¼šè¢«åŒ…è£…ä¸º PromiseTaskï¼Œå®ƒçš„ run æ–¹æ³•ä¸­ä¼š catch æ‰€æœ‰å¼‚å¸¸ç„¶åè®¾ç½®ä¸º Promise çš„å¤±è´¥ç»“æœè€Œä¸ä¼šæŠ›å‡º</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span> 
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"2"</span><span class="o">);</span>
<span class="o">});</span>
<span class="n">eventExecutors</span><span class="o">.</span><span class="na">submit</span><span class="o">(()-&gt;{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"3"</span><span class="o">);</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">promise</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"4"</span><span class="o">);</span>
<span class="o">});</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre>1
2
3
4
io.netty.util.concurrent.BlockingOperationException: DefaultPromise@47499c2a(incomplete)
	at io.netty.util.concurrent.DefaultPromise.checkDeadLock(DefaultPromise.java:384)
	at io.netty.util.concurrent.DefaultPromise.await(DefaultPromise.java:212)
	at com.itcast.oio.DefaultPromiseTest.lambda$main$0(DefaultPromiseTest.java:27)
	at io.netty.util.concurrent.PromiseTask$RunnableAdapter.call(PromiseTask.java:38)
	at io.netty.util.concurrent.PromiseTask.run(PromiseTask.java:73)
	at io.netty.channel.DefaultEventLoop.run(DefaultEventLoop.java:54)
	at io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:918)
	at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)
	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
	at java.lang.Thread.run(Thread.java:745)
io.netty.util.concurrent.BlockingOperationException: DefaultPromise@47499c2a(incomplete)
	at io.netty.util.concurrent.DefaultPromise.checkDeadLock(DefaultPromise.java:384)
	at io.netty.util.concurrent.DefaultPromise.await(DefaultPromise.java:212)
	at com.itcast.oio.DefaultPromiseTest.lambda$main$1(DefaultPromiseTest.java:36)
	at io.netty.util.concurrent.PromiseTask$RunnableAdapter.call(PromiseTask.java:38)
	at io.netty.util.concurrent.PromiseTask.run(PromiseTask.java:73)
	at io.netty.channel.DefaultEventLoop.run(DefaultEventLoop.java:54)
	at io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:918)
	at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)
	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
	at java.lang.Thread.run(Thread.java:745)

</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="34-handler--pipeline">3.4 Handler &amp; Pipeline</h3>

<p>ChannelHandler ç”¨æ¥å¤„ç† Channel ä¸Šçš„å„ç§äº‹ä»¶ï¼Œåˆ†ä¸ºå…¥ç«™ã€å‡ºç«™ä¸¤ç§ã€‚æ‰€æœ‰ ChannelHandler è¢«è¿æˆä¸€ä¸²ï¼Œå°±æ˜¯ Pipeline</p>

<ul>
  <li>å…¥ç«™å¤„ç†å™¨é€šå¸¸æ˜¯ ChannelInboundHandlerAdapter çš„å­ç±»ï¼Œä¸»è¦ç”¨æ¥è¯»å–å®¢æˆ·ç«¯æ•°æ®ï¼Œå†™å›ç»“æœ</li>
  <li>å‡ºç«™å¤„ç†å™¨é€šå¸¸æ˜¯ ChannelOutboundHandlerAdapter çš„å­ç±»ï¼Œä¸»è¦å¯¹å†™å›ç»“æœè¿›è¡ŒåŠ å·¥</li>
</ul>

<p>æ‰“ä¸ªæ¯”å–»ï¼Œæ¯ä¸ª Channel æ˜¯ä¸€ä¸ªäº§å“çš„åŠ å·¥è½¦é—´ï¼ŒPipeline æ˜¯è½¦é—´ä¸­çš„æµæ°´çº¿ï¼ŒChannelHandler å°±æ˜¯æµæ°´çº¿ä¸Šçš„å„é“å·¥åºï¼Œè€Œåé¢è¦è®²çš„ ByteBuf æ˜¯åŸææ–™ï¼Œç»è¿‡å¾ˆå¤šå·¥åºçš„åŠ å·¥ï¼šå…ˆç»è¿‡ä¸€é“é“å…¥ç«™å·¥åºï¼Œå†ç»è¿‡ä¸€é“é“å‡ºç«™å·¥åºæœ€ç»ˆå˜æˆäº§å“</p>

<p>å…ˆææ¸…æ¥šé¡ºåºï¼ŒæœåŠ¡ç«¯</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
</pre></td><td class="rouge-code"><pre><span class="k">new</span> <span class="nc">ServerBootstrap</span><span class="o">()</span>
    <span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">())</span>
    <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">NioSocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">NioSocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInboundHandlerAdapter</span><span class="o">(){</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                    <span class="n">ctx</span><span class="o">.</span><span class="na">fireChannelRead</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span> <span class="c1">// 1</span>
                <span class="o">}</span>
            <span class="o">});</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInboundHandlerAdapter</span><span class="o">(){</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
                    <span class="n">ctx</span><span class="o">.</span><span class="na">fireChannelRead</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span> <span class="c1">// 2</span>
                <span class="o">}</span>
            <span class="o">});</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInboundHandlerAdapter</span><span class="o">(){</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>
                    <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span> <span class="c1">// 3</span>
                <span class="o">}</span>
            <span class="o">});</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelOutboundHandlerAdapter</span><span class="o">(){</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">msg</span><span class="o">,</span> 
                                  <span class="nc">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="mi">4</span><span class="o">);</span>
                    <span class="n">ctx</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span> <span class="c1">// 4</span>
                <span class="o">}</span>
            <span class="o">});</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelOutboundHandlerAdapter</span><span class="o">(){</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">msg</span><span class="o">,</span> 
                                  <span class="nc">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
                    <span class="n">ctx</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span> <span class="c1">// 5</span>
                <span class="o">}</span>
            <span class="o">});</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelOutboundHandlerAdapter</span><span class="o">(){</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">msg</span><span class="o">,</span> 
                                  <span class="nc">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="mi">6</span><span class="o">);</span>
                    <span class="n">ctx</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span> <span class="c1">// 6</span>
                <span class="o">}</span>
            <span class="o">});</span>
        <span class="o">}</span>
    <span class="o">})</span>
    <span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="mi">8080</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å®¢æˆ·ç«¯</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="k">new</span> <span class="nc">Bootstrap</span><span class="o">()</span>
    <span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">())</span>
    <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">Channel</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">Channel</span> <span class="n">ch</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">StringEncoder</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">})</span>
    <span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="s">"127.0.0.1"</span><span class="o">,</span> <span class="mi">8080</span><span class="o">)</span>
    <span class="o">.</span><span class="na">addListener</span><span class="o">((</span><span class="nc">ChannelFutureListener</span><span class="o">)</span> <span class="n">future</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="n">future</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="s">"hello,world"</span><span class="o">);</span>
    <span class="o">});</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æœåŠ¡å™¨ç«¯æ‰“å°ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>1
2
3
6
5
4
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¯ä»¥çœ‹åˆ°ï¼ŒChannelInboundHandlerAdapter æ˜¯æŒ‰ç…§ addLast çš„é¡ºåºæ‰§è¡Œçš„ï¼Œè€Œ ChannelOutboundHandlerAdapter æ˜¯æŒ‰ç…§ addLast çš„é€†åºæ‰§è¡Œçš„ã€‚ChannelPipeline çš„å®ç°æ˜¯ä¸€ä¸ª ChannelHandlerContextï¼ˆåŒ…è£…äº† ChannelHandlerï¼‰ ç»„æˆçš„åŒå‘é“¾è¡¨</p>

<p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0008.png" alt="" /></p>

<ul>
  <li>å…¥ç«™å¤„ç†å™¨ä¸­ï¼Œctx.fireChannelRead(msg) æ˜¯ <strong>è°ƒç”¨ä¸‹ä¸€ä¸ªå…¥ç«™å¤„ç†å™¨</strong>
    <ul>
      <li>å¦‚æœæ³¨é‡Šæ‰ 1 å¤„ä»£ç ï¼Œåˆ™ä»…ä¼šæ‰“å° 1</li>
      <li>å¦‚æœæ³¨é‡Šæ‰ 2 å¤„ä»£ç ï¼Œåˆ™ä»…ä¼šæ‰“å° 1 2</li>
    </ul>
  </li>
  <li>3 å¤„çš„ ctx.channel().write(msg) ä¼š <strong>ä»å°¾éƒ¨å¼€å§‹è§¦å‘</strong> åç»­å‡ºç«™å¤„ç†å™¨çš„æ‰§è¡Œ
    <ul>
      <li>å¦‚æœæ³¨é‡Šæ‰ 3 å¤„ä»£ç ï¼Œåˆ™ä»…ä¼šæ‰“å° 1 2 3</li>
    </ul>
  </li>
  <li>ç±»ä¼¼çš„ï¼Œå‡ºç«™å¤„ç†å™¨ä¸­ï¼Œctx.write(msg, promise) çš„è°ƒç”¨ä¹Ÿä¼š <strong>è§¦å‘ä¸Šä¸€ä¸ªå‡ºç«™å¤„ç†å™¨</strong>
    <ul>
      <li>å¦‚æœæ³¨é‡Šæ‰ 6 å¤„ä»£ç ï¼Œåˆ™ä»…ä¼šæ‰“å° 1 2 3 6</li>
    </ul>
  </li>
  <li>ctx.channel().write(msg) vs ctx.write(msg)
    <ul>
      <li>éƒ½æ˜¯è§¦å‘å‡ºç«™å¤„ç†å™¨çš„æ‰§è¡Œ</li>
      <li>ctx.channel().write(msg) ä»å°¾éƒ¨å¼€å§‹æŸ¥æ‰¾å‡ºç«™å¤„ç†å™¨</li>
      <li>ctx.write(msg) æ˜¯ä»å½“å‰èŠ‚ç‚¹æ‰¾ä¸Šä¸€ä¸ªå‡ºç«™å¤„ç†å™¨</li>
      <li>3 å¤„çš„ ctx.channel().write(msg) å¦‚æœæ”¹ä¸º ctx.write(msg) ä»…ä¼šæ‰“å° 1 2 3ï¼Œå› ä¸ºèŠ‚ç‚¹3 ä¹‹å‰æ²¡æœ‰å…¶å®ƒå‡ºç«™å¤„ç†å™¨äº†</li>
      <li>6 å¤„çš„ ctx.write(msg, promise) å¦‚æœæ”¹ä¸º ctx.channel().write(msg) ä¼šæ‰“å° 1 2 3 6 6 6â€¦ å› ä¸º ctx.channel().write() æ˜¯ä»å°¾éƒ¨å¼€å§‹æŸ¥æ‰¾ï¼Œç»“æœåˆæ˜¯èŠ‚ç‚¹6 è‡ªå·±</li>
    </ul>
  </li>
</ul>

<p>å›¾1 - æœåŠ¡ç«¯ pipeline è§¦å‘çš„åŸå§‹æµç¨‹ï¼Œå›¾ä¸­æ•°å­—ä»£è¡¨äº†å¤„ç†æ­¥éª¤çš„å…ˆåæ¬¡åº</p>

<p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0009.png" alt="" /></p>

<h3 id="35-bytebuf">3.5 ByteBuf</h3>

<p>æ˜¯å¯¹å­—èŠ‚æ•°æ®çš„å°è£…</p>

<h4 id="1åˆ›å»º">1ï¼‰åˆ›å»º</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nc">ByteBuf</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nc">ByteBufAllocator</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">.</span><span class="na">buffer</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
<span class="n">log</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä¸Šé¢ä»£ç åˆ›å»ºäº†ä¸€ä¸ªé»˜è®¤çš„ ByteBufï¼ˆæ± åŒ–åŸºäºç›´æ¥å†…å­˜çš„ ByteBufï¼‰ï¼Œåˆå§‹å®¹é‡æ˜¯ 10</p>

<p>è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>read index:0 write index:0 capacity:10
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å…¶ä¸­ log æ–¹æ³•å‚è€ƒå¦‚ä¸‹</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">log</span><span class="o">(</span><span class="nc">ByteBuf</span> <span class="n">buffer</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="na">readableBytes</span><span class="o">();</span>
    <span class="kt">int</span> <span class="n">rows</span> <span class="o">=</span> <span class="n">length</span> <span class="o">/</span> <span class="mi">16</span> <span class="o">+</span> <span class="o">(</span><span class="n">length</span> <span class="o">%</span> <span class="mi">15</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="o">)</span> <span class="o">+</span> <span class="mi">4</span><span class="o">;</span>
    <span class="nc">StringBuilder</span> <span class="n">buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">(</span><span class="n">rows</span> <span class="o">*</span> <span class="mi">80</span> <span class="o">*</span> <span class="mi">2</span><span class="o">)</span>
        <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"read index:"</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">readerIndex</span><span class="o">())</span>
        <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">" write index:"</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">writerIndex</span><span class="o">())</span>
        <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">" capacity:"</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">capacity</span><span class="o">())</span>
        <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="no">NEWLINE</span><span class="o">);</span>
    <span class="n">appendPrettyHexDump</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="n">buffer</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="2ç›´æ¥å†…å­˜-vs-å †å†…å­˜">2ï¼‰ç›´æ¥å†…å­˜ vs å †å†…å­˜</h4>

<p>å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„ä»£ç æ¥åˆ›å»ºæ± åŒ–åŸºäºå †çš„ ByteBuf</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nc">ByteBuf</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nc">ByteBufAllocator</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">.</span><span class="na">heapBuffer</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„ä»£ç æ¥åˆ›å»ºæ± åŒ–åŸºäºç›´æ¥å†…å­˜çš„ ByteBuf</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nc">ByteBuf</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nc">ByteBufAllocator</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">.</span><span class="na">directBuffer</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>ç›´æ¥å†…å­˜åˆ›å»ºå’Œé”€æ¯çš„ä»£ä»·æ˜‚è´µï¼Œä½†è¯»å†™æ€§èƒ½é«˜ï¼ˆå°‘ä¸€æ¬¡å†…å­˜å¤åˆ¶ï¼‰ï¼Œé€‚åˆé…åˆæ± åŒ–åŠŸèƒ½ä¸€èµ·ç”¨</li>
  <li>ç›´æ¥å†…å­˜å¯¹ GC å‹åŠ›å°ï¼Œå› ä¸ºè¿™éƒ¨åˆ†å†…å­˜ä¸å— JVM åƒåœ¾å›æ”¶çš„ç®¡ç†ï¼Œä½†ä¹Ÿè¦æ³¨æ„åŠæ—¶ä¸»åŠ¨é‡Šæ”¾</li>
</ul>

<h4 id="3æ± åŒ–-vs-éæ± åŒ–">3ï¼‰æ± åŒ– vs éæ± åŒ–</h4>

<p>æ± åŒ–çš„æœ€å¤§æ„ä¹‰åœ¨äºå¯ä»¥é‡ç”¨ ByteBufï¼Œä¼˜ç‚¹æœ‰</p>

<ul>
  <li>æ²¡æœ‰æ± åŒ–ï¼Œåˆ™æ¯æ¬¡éƒ½å¾—åˆ›å»ºæ–°çš„ ByteBuf å®ä¾‹ï¼Œè¿™ä¸ªæ“ä½œå¯¹ç›´æ¥å†…å­˜ä»£ä»·æ˜‚è´µï¼Œå°±ç®—æ˜¯å †å†…å­˜ï¼Œä¹Ÿä¼šå¢åŠ  GC å‹åŠ›</li>
  <li>æœ‰äº†æ± åŒ–ï¼Œåˆ™å¯ä»¥é‡ç”¨æ± ä¸­ ByteBuf å®ä¾‹ï¼Œå¹¶ä¸”é‡‡ç”¨äº†ä¸ jemalloc ç±»ä¼¼çš„å†…å­˜åˆ†é…ç®—æ³•æå‡åˆ†é…æ•ˆç‡</li>
  <li>é«˜å¹¶å‘æ—¶ï¼Œæ± åŒ–åŠŸèƒ½æ›´èŠ‚çº¦å†…å­˜ï¼Œå‡å°‘å†…å­˜æº¢å‡ºçš„å¯èƒ½</li>
</ul>

<p>æ± åŒ–åŠŸèƒ½æ˜¯å¦å¼€å¯ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢çš„ç³»ç»Ÿç¯å¢ƒå˜é‡æ¥è®¾ç½®</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="o">-</span><span class="nc">Dio</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">allocator</span><span class="o">.</span><span class="na">type</span><span class="o">={</span><span class="n">unpooled</span><span class="o">|</span><span class="n">pooled</span><span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>4.1 ä»¥åï¼Œé Android å¹³å°é»˜è®¤å¯ç”¨æ± åŒ–å®ç°ï¼ŒAndroid å¹³å°å¯ç”¨éæ± åŒ–å®ç°</li>
  <li>4.1 ä¹‹å‰ï¼Œæ± åŒ–åŠŸèƒ½è¿˜ä¸æˆç†Ÿï¼Œé»˜è®¤æ˜¯éæ± åŒ–å®ç°</li>
</ul>

<h4 id="4ç»„æˆ">4ï¼‰ç»„æˆ</h4>

<p>ByteBuf ç”±å››éƒ¨åˆ†ç»„æˆ</p>

<p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0010.png" alt="" /></p>

<p>æœ€å¼€å§‹è¯»å†™æŒ‡é’ˆéƒ½åœ¨ 0 ä½ç½®</p>

<h4 id="5å†™å…¥">5ï¼‰å†™å…¥</h4>

<p>æ–¹æ³•åˆ—è¡¨ï¼Œçœç•¥ä¸€äº›ä¸é‡è¦çš„æ–¹æ³•</p>

<table>
  <thead>
    <tr>
      <th>æ–¹æ³•ç­¾å</th>
      <th>å«ä¹‰</th>
      <th>å¤‡æ³¨</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>writeBoolean(boolean value)</td>
      <td>å†™å…¥ boolean å€¼</td>
      <td>ç”¨ä¸€å­—èŠ‚ 01|00 ä»£è¡¨ true|false</td>
    </tr>
    <tr>
      <td>writeByte(int value)</td>
      <td>å†™å…¥ byte å€¼</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>writeShort(int value)</td>
      <td>å†™å…¥ short å€¼</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>writeInt(int value)</td>
      <td>å†™å…¥ int å€¼</td>
      <td>Big Endianï¼Œå³ 0x250ï¼Œå†™å…¥å 00 00 02 50</td>
    </tr>
    <tr>
      <td>writeIntLE(int value)</td>
      <td>å†™å…¥ int å€¼</td>
      <td>Little Endianï¼Œå³ 0x250ï¼Œå†™å…¥å 50 02 00 00</td>
    </tr>
    <tr>
      <td>writeLong(long value)</td>
      <td>å†™å…¥ long å€¼</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>writeChar(int value)</td>
      <td>å†™å…¥ char å€¼</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>writeFloat(float value)</td>
      <td>å†™å…¥ float å€¼</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>writeDouble(double value)</td>
      <td>å†™å…¥ double å€¼</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>writeBytes(ByteBuf src)</td>
      <td>å†™å…¥ netty çš„ ByteBuf</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>writeBytes(byte[] src)</td>
      <td>å†™å…¥ byte[]</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>writeBytes(ByteBuffer src)</td>
      <td>å†™å…¥ nio çš„ ByteBuffer</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>int writeCharSequence(CharSequence sequence, Charset charset)</td>
      <td>å†™å…¥å­—ç¬¦ä¸²</td>
      <td>Â </td>
    </tr>
  </tbody>
</table>

<blockquote>
  <p>æ³¨æ„</p>

  <ul>
    <li>è¿™äº›æ–¹æ³•çš„æœªæŒ‡æ˜è¿”å›å€¼çš„ï¼Œå…¶è¿”å›å€¼éƒ½æ˜¯ ByteBufï¼Œæ„å‘³ç€å¯ä»¥é“¾å¼è°ƒç”¨</li>
    <li>ç½‘ç»œä¼ è¾“ï¼Œé»˜è®¤ä¹ æƒ¯æ˜¯ Big Endian</li>
  </ul>
</blockquote>

<p>å…ˆå†™å…¥ 4 ä¸ªå­—èŠ‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">buffer</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="k">new</span> <span class="kt">byte</span><span class="o">[]{</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">});</span>
<span class="n">log</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç»“æœæ˜¯</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>read index:0 write index:4 capacity:10
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 01 02 03 04                                     |....            |
+--------+-------------------------------------------------+----------------+
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å†å†™å…¥ä¸€ä¸ª int æ•´æ•°ï¼Œä¹Ÿæ˜¯ 4 ä¸ªå­—èŠ‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">buffer</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
<span class="n">log</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç»“æœæ˜¯</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>read index:0 write index:8 capacity:10
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 01 02 03 04 00 00 00 05                         |........        |
+--------+-------------------------------------------------+----------------+
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¿˜æœ‰ä¸€ç±»æ–¹æ³•æ˜¯ set å¼€å¤´çš„ä¸€ç³»åˆ—æ–¹æ³•ï¼Œä¹Ÿå¯ä»¥å†™å…¥æ•°æ®ï¼Œä½†ä¸ä¼šæ”¹å˜å†™æŒ‡é’ˆä½ç½®</p>

<h4 id="6æ‰©å®¹">6ï¼‰æ‰©å®¹</h4>

<p>å†å†™å…¥ä¸€ä¸ª int æ•´æ•°æ—¶ï¼Œå®¹é‡ä¸å¤Ÿäº†ï¼ˆåˆå§‹å®¹é‡æ˜¯ 10ï¼‰ï¼Œè¿™æ—¶ä¼šå¼•å‘æ‰©å®¹</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">buffer</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="mi">6</span><span class="o">);</span>
<span class="n">log</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ‰©å®¹è§„åˆ™æ˜¯</p>

<ul>
  <li>å¦‚ä½•å†™å…¥åæ•°æ®å¤§å°æœªè¶…è¿‡ 512ï¼Œåˆ™é€‰æ‹©ä¸‹ä¸€ä¸ª 16 çš„æ•´æ•°å€ï¼Œä¾‹å¦‚å†™å…¥åå¤§å°ä¸º 12 ï¼Œåˆ™æ‰©å®¹å capacity æ˜¯ 16</li>
  <li>å¦‚æœå†™å…¥åæ•°æ®å¤§å°è¶…è¿‡ 512ï¼Œåˆ™é€‰æ‹©ä¸‹ä¸€ä¸ª 2^nï¼Œä¾‹å¦‚å†™å…¥åå¤§å°ä¸º 513ï¼Œåˆ™æ‰©å®¹å capacity æ˜¯ 2^10=1024ï¼ˆ2^9=512 å·²ç»ä¸å¤Ÿäº†ï¼‰</li>
  <li>æ‰©å®¹ä¸èƒ½è¶…è¿‡ max capacity ä¼šæŠ¥é”™</li>
</ul>

<p>ç»“æœæ˜¯</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>read index:0 write index:12 capacity:16
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 01 02 03 04 00 00 00 05 00 00 00 06             |............    |
+--------+-------------------------------------------------+----------------+
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="7è¯»å–">7ï¼‰è¯»å–</h4>

<p>ä¾‹å¦‚è¯»äº† 4 æ¬¡ï¼Œæ¯æ¬¡ä¸€ä¸ªå­—èŠ‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">readByte</span><span class="o">());</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">readByte</span><span class="o">());</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">readByte</span><span class="o">());</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">readByte</span><span class="o">());</span>
<span class="n">log</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¯»è¿‡çš„å†…å®¹ï¼Œå°±å±äºåºŸå¼ƒéƒ¨åˆ†äº†ï¼Œå†è¯»åªèƒ½è¯»é‚£äº›å°šæœªè¯»å–çš„éƒ¨åˆ†</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>1
2
3
4
read index:4 write index:12 capacity:16
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 00 00 00 05 00 00 00 06                         |........        |
+--------+-------------------------------------------------+----------------+
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¦‚æœéœ€è¦é‡å¤è¯»å– int æ•´æ•° 5ï¼Œæ€ä¹ˆåŠï¼Ÿ</p>

<p>å¯ä»¥åœ¨ read å‰å…ˆåšä¸ªæ ‡è®° mark</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="n">buffer</span><span class="o">.</span><span class="na">markReaderIndex</span><span class="o">();</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">readInt</span><span class="o">());</span>
<span class="n">log</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç»“æœ</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>5
read index:8 write index:12 capacity:16
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 00 00 00 06                                     |....            |
+--------+-------------------------------------------------+----------------+
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¿™æ—¶è¦é‡å¤è¯»å–çš„è¯ï¼Œé‡ç½®åˆ°æ ‡è®°ä½ç½® reset</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">buffer</span><span class="o">.</span><span class="na">resetReaderIndex</span><span class="o">();</span>
<span class="n">log</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¿™æ—¶</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>read index:4 write index:12 capacity:16
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 00 00 00 05 00 00 00 06                         |........        |
+--------+-------------------------------------------------+----------------+
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¿˜æœ‰ç§åŠæ³•æ˜¯é‡‡ç”¨ get å¼€å¤´çš„ä¸€ç³»åˆ—æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•ä¸ä¼šæ”¹å˜ read index</p>

<h4 id="8retain--release">8ï¼‰retain &amp; release</h4>

<p>ç”±äº Netty ä¸­æœ‰å †å¤–å†…å­˜çš„ ByteBuf å®ç°ï¼Œå †å¤–å†…å­˜æœ€å¥½æ˜¯æ‰‹åŠ¨æ¥é‡Šæ”¾ï¼Œè€Œä¸æ˜¯ç­‰ GC åƒåœ¾å›æ”¶ã€‚</p>

<ul>
  <li>UnpooledHeapByteBuf ä½¿ç”¨çš„æ˜¯ JVM å†…å­˜ï¼Œåªéœ€ç­‰ GC å›æ”¶å†…å­˜å³å¯</li>
  <li>UnpooledDirectByteBuf ä½¿ç”¨çš„å°±æ˜¯ç›´æ¥å†…å­˜äº†ï¼Œéœ€è¦ç‰¹æ®Šçš„æ–¹æ³•æ¥å›æ”¶å†…å­˜</li>
  <li>PooledByteBuf å’Œå®ƒçš„å­ç±»ä½¿ç”¨äº†æ± åŒ–æœºåˆ¶ï¼Œéœ€è¦æ›´å¤æ‚çš„è§„åˆ™æ¥å›æ”¶å†…å­˜</li>
</ul>

<blockquote>
  <p>å›æ”¶å†…å­˜çš„æºç å®ç°ï¼Œè¯·å…³æ³¨ä¸‹é¢æ–¹æ³•çš„ä¸åŒå®ç°</p>

  <p><code class="language-plaintext highlighter-rouge">protected abstract void deallocate()</code></p>
</blockquote>

<p>Netty è¿™é‡Œé‡‡ç”¨äº†å¼•ç”¨è®¡æ•°æ³•æ¥æ§åˆ¶å›æ”¶å†…å­˜ï¼Œæ¯ä¸ª ByteBuf éƒ½å®ç°äº† ReferenceCounted æ¥å£</p>

<ul>
  <li>æ¯ä¸ª ByteBuf å¯¹è±¡çš„åˆå§‹è®¡æ•°ä¸º 1</li>
  <li>è°ƒç”¨ release æ–¹æ³•è®¡æ•°å‡ 1ï¼Œå¦‚æœè®¡æ•°ä¸º 0ï¼ŒByteBuf å†…å­˜è¢«å›æ”¶</li>
  <li>è°ƒç”¨ retain æ–¹æ³•è®¡æ•°åŠ  1ï¼Œè¡¨ç¤ºè°ƒç”¨è€…æ²¡ç”¨å®Œä¹‹å‰ï¼Œå…¶å®ƒ handler å³ä½¿è°ƒç”¨äº† release ä¹Ÿä¸ä¼šé€ æˆå›æ”¶</li>
  <li>å½“è®¡æ•°ä¸º 0 æ—¶ï¼Œåº•å±‚å†…å­˜ä¼šè¢«å›æ”¶ï¼Œè¿™æ—¶å³ä½¿ ByteBuf å¯¹è±¡è¿˜åœ¨ï¼Œå…¶å„ä¸ªæ–¹æ³•å‡æ— æ³•æ­£å¸¸ä½¿ç”¨</li>
</ul>

<p>è°æ¥è´Ÿè´£ release å‘¢ï¼Ÿ</p>

<p>ä¸æ˜¯æˆ‘ä»¬æƒ³è±¡çš„ï¼ˆä¸€èˆ¬æƒ…å†µä¸‹ï¼‰</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="nc">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="o">...</span>
<span class="k">try</span> <span class="o">{</span>
    <span class="o">...</span>
<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
    <span class="n">buf</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¯·æ€è€ƒï¼Œå› ä¸º pipeline çš„å­˜åœ¨ï¼Œä¸€èˆ¬éœ€è¦å°† ByteBuf ä¼ é€’ç»™ä¸‹ä¸€ä¸ª ChannelHandlerï¼Œå¦‚æœåœ¨ finally ä¸­ release äº†ï¼Œå°±å¤±å»äº†ä¼ é€’æ€§ï¼ˆå½“ç„¶ï¼Œå¦‚æœåœ¨è¿™ä¸ª ChannelHandler å†…è¿™ä¸ª ByteBuf å·²å®Œæˆäº†å®ƒçš„ä½¿å‘½ï¼Œé‚£ä¹ˆä¾¿æ— é¡»å†ä¼ é€’ï¼‰</p>

<p>åŸºæœ¬è§„åˆ™æ˜¯ï¼Œ<strong>è°æ˜¯æœ€åä½¿ç”¨è€…ï¼Œè°è´Ÿè´£ release</strong>ï¼Œè¯¦ç»†åˆ†æå¦‚ä¸‹</p>

<ul>
  <li>èµ·ç‚¹ï¼Œå¯¹äº NIO å®ç°æ¥è®²ï¼Œåœ¨ io.netty.channel.nio.AbstractNioByteChannel.NioByteUnsafe#read æ–¹æ³•ä¸­é¦–æ¬¡åˆ›å»º ByteBuf æ”¾å…¥ pipelineï¼ˆline 163 pipeline.fireChannelRead(byteBuf)ï¼‰</li>
  <li>å…¥ç«™ ByteBuf å¤„ç†åŸåˆ™
    <ul>
      <li>å¯¹åŸå§‹ ByteBuf ä¸åšå¤„ç†ï¼Œè°ƒç”¨ ctx.fireChannelRead(msg) å‘åä¼ é€’ï¼Œè¿™æ—¶æ— é¡» release</li>
      <li>å°†åŸå§‹ ByteBuf è½¬æ¢ä¸ºå…¶å®ƒç±»å‹çš„ Java å¯¹è±¡ï¼Œè¿™æ—¶ ByteBuf å°±æ²¡ç”¨äº†ï¼Œå¿…é¡» release</li>
      <li>å¦‚æœä¸è°ƒç”¨ ctx.fireChannelRead(msg) å‘åä¼ é€’ï¼Œé‚£ä¹ˆä¹Ÿå¿…é¡» release</li>
      <li>æ³¨æ„å„ç§å¼‚å¸¸ï¼Œå¦‚æœ ByteBuf æ²¡æœ‰æˆåŠŸä¼ é€’åˆ°ä¸‹ä¸€ä¸ª ChannelHandlerï¼Œå¿…é¡» release</li>
      <li>å‡è®¾æ¶ˆæ¯ä¸€ç›´å‘åä¼ ï¼Œé‚£ä¹ˆ TailContext ä¼šè´Ÿè´£é‡Šæ”¾æœªå¤„ç†æ¶ˆæ¯ï¼ˆåŸå§‹çš„ ByteBufï¼‰</li>
    </ul>
  </li>
  <li>å‡ºç«™ ByteBuf å¤„ç†åŸåˆ™
    <ul>
      <li>å‡ºç«™æ¶ˆæ¯æœ€ç»ˆéƒ½ä¼šè½¬ä¸º ByteBuf è¾“å‡ºï¼Œä¸€ç›´å‘å‰ä¼ ï¼Œç”± HeadContext flush å release</li>
    </ul>
  </li>
  <li>å¼‚å¸¸å¤„ç†åŸåˆ™
    <ul>
      <li>æœ‰æ—¶å€™ä¸æ¸…æ¥š ByteBuf è¢«å¼•ç”¨äº†å¤šå°‘æ¬¡ï¼Œä½†åˆå¿…é¡»å½»åº•é‡Šæ”¾ï¼Œå¯ä»¥å¾ªç¯è°ƒç”¨ release ç›´åˆ°è¿”å› true</li>
    </ul>
  </li>
</ul>

<p>TailContext é‡Šæ”¾æœªå¤„ç†æ¶ˆæ¯é€»è¾‘</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="c1">// io.netty.channel.DefaultChannelPipeline#onUnhandledInboundMessage(java.lang.Object)</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onUnhandledInboundMessage</span><span class="o">(</span><span class="nc">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span>
            <span class="s">"Discarded inbound message {} that reached at the tail of the pipeline. "</span> <span class="o">+</span>
            <span class="s">"Please check your pipeline configuration."</span><span class="o">,</span> <span class="n">msg</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="nc">ReferenceCountUtil</span><span class="o">.</span><span class="na">release</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å…·ä½“ä»£ç </p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="c1">// io.netty.util.ReferenceCountUtil#release(java.lang.Object)</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">release</span><span class="o">(</span><span class="nc">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="k">instanceof</span> <span class="nc">ReferenceCounted</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">((</span><span class="nc">ReferenceCounted</span><span class="o">)</span> <span class="n">msg</span><span class="o">).</span><span class="na">release</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="9slice">9ï¼‰slice</h4>

<p>ã€é›¶æ‹·è´ã€‘çš„ä½“ç°ä¹‹ä¸€ï¼Œå¯¹åŸå§‹ ByteBuf è¿›è¡Œåˆ‡ç‰‡æˆå¤šä¸ª ByteBufï¼Œåˆ‡ç‰‡åçš„ ByteBuf å¹¶æ²¡æœ‰å‘ç”Ÿå†…å­˜å¤åˆ¶ï¼Œè¿˜æ˜¯ä½¿ç”¨åŸå§‹ ByteBuf çš„å†…å­˜ï¼Œåˆ‡ç‰‡åçš„ ByteBuf ç»´æŠ¤ç‹¬ç«‹çš„ readï¼Œwrite æŒ‡é’ˆ</p>

<p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0011.png" alt="" /></p>

<p>ä¾‹ï¼ŒåŸå§‹ ByteBuf è¿›è¡Œä¸€äº›åˆå§‹æ“ä½œ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nc">ByteBuf</span> <span class="n">origin</span> <span class="o">=</span> <span class="nc">ByteBufAllocator</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">.</span><span class="na">buffer</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
<span class="n">origin</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="k">new</span> <span class="kt">byte</span><span class="o">[]{</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">});</span>
<span class="n">origin</span><span class="o">.</span><span class="na">readByte</span><span class="o">();</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">ByteBufUtil</span><span class="o">.</span><span class="na">prettyHexDump</span><span class="o">(</span><span class="n">origin</span><span class="o">));</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 02 03 04                                        |...             |
+--------+-------------------------------------------------+----------------+
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¿™æ—¶è°ƒç”¨ slice è¿›è¡Œåˆ‡ç‰‡ï¼Œæ— å‚ slice æ˜¯ä»åŸå§‹ ByteBuf çš„ read index åˆ° write index ä¹‹é—´çš„å†…å®¹è¿›è¡Œåˆ‡ç‰‡ï¼Œåˆ‡ç‰‡åçš„ max capacity è¢«å›ºå®šä¸ºè¿™ä¸ªåŒºé—´çš„å¤§å°ï¼Œå› æ­¤ä¸èƒ½è¿½åŠ  write</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nc">ByteBuf</span> <span class="n">slice</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="na">slice</span><span class="o">();</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">ByteBufUtil</span><span class="o">.</span><span class="na">prettyHexDump</span><span class="o">(</span><span class="n">slice</span><span class="o">));</span>
<span class="c1">// slice.writeByte(5); å¦‚æœæ‰§è¡Œï¼Œä¼šæŠ¥ IndexOutOfBoundsException å¼‚å¸¸</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 02 03 04                                        |...             |
+--------+-------------------------------------------------+----------------+
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¦‚æœåŸå§‹ ByteBuf å†æ¬¡è¯»æ“ä½œï¼ˆåˆè¯»äº†ä¸€ä¸ªå­—èŠ‚ï¼‰</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">origin</span><span class="o">.</span><span class="na">readByte</span><span class="o">();</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">ByteBufUtil</span><span class="o">.</span><span class="na">prettyHexDump</span><span class="o">(</span><span class="n">origin</span><span class="o">));</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 03 04                                           |..              |
+--------+-------------------------------------------------+----------------+
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¿™æ—¶çš„ slice ä¸å—å½±å“ï¼Œå› ä¸ºå®ƒæœ‰ç‹¬ç«‹çš„è¯»å†™æŒ‡é’ˆ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">ByteBufUtil</span><span class="o">.</span><span class="na">prettyHexDump</span><span class="o">(</span><span class="n">slice</span><span class="o">));</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 02 03 04                                        |...             |
+--------+-------------------------------------------------+----------------+
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¦‚æœ slice çš„å†…å®¹å‘ç”Ÿäº†æ›´æ”¹</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">slice</span><span class="o">.</span><span class="na">setByte</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mi">5</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">ByteBufUtil</span><span class="o">.</span><span class="na">prettyHexDump</span><span class="o">(</span><span class="n">slice</span><span class="o">));</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 02 03 05                                        |...             |
+--------+-------------------------------------------------+----------------+
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¿™æ—¶ï¼ŒåŸå§‹ ByteBuf ä¹Ÿä¼šå—å½±å“ï¼Œå› ä¸ºåº•å±‚éƒ½æ˜¯åŒä¸€å—å†…å­˜</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>System.out.println(ByteBufUtil.prettyHexDump(origin));
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 03 05                                           |..              |
+--------+-------------------------------------------------+----------------+
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="10duplicate">10ï¼‰duplicate</h4>

<p>ã€é›¶æ‹·è´ã€‘çš„ä½“ç°ä¹‹ä¸€ï¼Œå°±å¥½æ¯”æˆªå–äº†åŸå§‹ ByteBuf æ‰€æœ‰å†…å®¹ï¼Œå¹¶ä¸”æ²¡æœ‰ max capacity çš„é™åˆ¶ï¼Œä¹Ÿæ˜¯ä¸åŸå§‹ ByteBuf ä½¿ç”¨åŒä¸€å—åº•å±‚å†…å­˜ï¼Œåªæ˜¯è¯»å†™æŒ‡é’ˆæ˜¯ç‹¬ç«‹çš„</p>

<p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0012.png" alt="" /></p>

<h4 id="11copy">11ï¼‰copy</h4>

<p>ä¼šå°†åº•å±‚å†…å­˜æ•°æ®è¿›è¡Œæ·±æ‹·è´ï¼Œå› æ­¤æ— è®ºè¯»å†™ï¼Œéƒ½ä¸åŸå§‹ ByteBuf æ— å…³</p>

<h4 id="12compositebytebuf">12ï¼‰CompositeByteBuf</h4>

<p>ã€é›¶æ‹·è´ã€‘çš„ä½“ç°ä¹‹ä¸€ï¼Œå¯ä»¥å°†å¤šä¸ª ByteBuf åˆå¹¶ä¸ºä¸€ä¸ªé€»è¾‘ä¸Šçš„ ByteBufï¼Œé¿å…æ‹·è´</p>

<p>æœ‰ä¸¤ä¸ª ByteBuf å¦‚ä¸‹</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="nc">ByteBuf</span> <span class="n">buf1</span> <span class="o">=</span> <span class="nc">ByteBufAllocator</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">.</span><span class="na">buffer</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
<span class="n">buf1</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="k">new</span> <span class="kt">byte</span><span class="o">[]{</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="mi">5</span><span class="o">});</span>
<span class="nc">ByteBuf</span> <span class="n">buf2</span> <span class="o">=</span> <span class="nc">ByteBufAllocator</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">.</span><span class="na">buffer</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
<span class="n">buf2</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="k">new</span> <span class="kt">byte</span><span class="o">[]{</span><span class="mi">6</span><span class="o">,</span> <span class="mi">7</span><span class="o">,</span> <span class="mi">8</span><span class="o">,</span> <span class="mi">9</span><span class="o">,</span> <span class="mi">10</span><span class="o">});</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">ByteBufUtil</span><span class="o">.</span><span class="na">prettyHexDump</span><span class="o">(</span><span class="n">buf1</span><span class="o">));</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">ByteBufUtil</span><span class="o">.</span><span class="na">prettyHexDump</span><span class="o">(</span><span class="n">buf2</span><span class="o">));</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 01 02 03 04 05                                  |.....           |
+--------+-------------------------------------------------+----------------+
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 06 07 08 09 0a                                  |.....           |
+--------+-------------------------------------------------+----------------+
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç°åœ¨éœ€è¦ä¸€ä¸ªæ–°çš„ ByteBufï¼Œå†…å®¹æ¥è‡ªäºåˆšæ‰çš„ buf1 å’Œ buf2ï¼Œå¦‚ä½•å®ç°ï¼Ÿ</p>

<p>æ–¹æ³•1ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="nc">ByteBuf</span> <span class="n">buf3</span> <span class="o">=</span> <span class="nc">ByteBufAllocator</span><span class="o">.</span><span class="na">DEFAULT</span>
    <span class="o">.</span><span class="na">buffer</span><span class="o">(</span><span class="n">buf1</span><span class="o">.</span><span class="na">readableBytes</span><span class="o">()+</span><span class="n">buf2</span><span class="o">.</span><span class="na">readableBytes</span><span class="o">());</span>
<span class="n">buf3</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="n">buf1</span><span class="o">);</span>
<span class="n">buf3</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="n">buf2</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">ByteBufUtil</span><span class="o">.</span><span class="na">prettyHexDump</span><span class="o">(</span><span class="n">buf3</span><span class="o">));</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç»“æœ</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 01 02 03 04 05 06 07 08 09 0a                   |..........      |
+--------+-------------------------------------------------+----------------+
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¿™ç§æ–¹æ³•å¥½ä¸å¥½ï¼Ÿå›ç­”æ˜¯ä¸å¤ªå¥½ï¼Œå› ä¸ºè¿›è¡Œäº†æ•°æ®çš„å†…å­˜å¤åˆ¶æ“ä½œ</p>

<p>æ–¹æ³•2ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nc">CompositeByteBuf</span> <span class="n">buf3</span> <span class="o">=</span> <span class="nc">ByteBufAllocator</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">.</span><span class="na">compositeBuffer</span><span class="o">();</span>
<span class="c1">// true è¡¨ç¤ºå¢åŠ æ–°çš„ ByteBuf è‡ªåŠ¨é€’å¢ write index, å¦åˆ™ write index ä¼šå§‹ç»ˆä¸º 0</span>
<span class="n">buf3</span><span class="o">.</span><span class="na">addComponents</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span> <span class="n">buf1</span><span class="o">,</span> <span class="n">buf2</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç»“æœæ˜¯ä¸€æ ·çš„</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 01 02 03 04 05 06 07 08 09 0a                   |..........      |
+--------+-------------------------------------------------+----------------+
</pre></td></tr></tbody></table></code></pre></div></div>

<p>CompositeByteBuf æ˜¯ä¸€ä¸ªç»„åˆçš„ ByteBufï¼Œå®ƒå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ª Component æ•°ç»„ï¼Œæ¯ä¸ª Component ç®¡ç†ä¸€ä¸ª ByteBufï¼Œè®°å½•äº†è¿™ä¸ª ByteBuf ç›¸å¯¹äºæ•´ä½“åç§»é‡ç­‰ä¿¡æ¯ï¼Œä»£è¡¨ç€æ•´ä½“ä¸­æŸä¸€æ®µçš„æ•°æ®ã€‚</p>

<ul>
  <li>ä¼˜ç‚¹ï¼Œå¯¹å¤–æ˜¯ä¸€ä¸ªè™šæ‹Ÿè§†å›¾ï¼Œç»„åˆè¿™äº› ByteBuf ä¸ä¼šäº§ç”Ÿå†…å­˜å¤åˆ¶</li>
  <li>ç¼ºç‚¹ï¼Œå¤æ‚äº†å¾ˆå¤šï¼Œå¤šæ¬¡æ“ä½œä¼šå¸¦æ¥æ€§èƒ½çš„æŸè€—</li>
</ul>

<h4 id="13unpooled">13ï¼‰Unpooled</h4>

<p>Unpooled æ˜¯ä¸€ä¸ªå·¥å…·ç±»ï¼Œç±»å¦‚å…¶åï¼Œæä¾›äº†éæ± åŒ–çš„ ByteBuf åˆ›å»ºã€ç»„åˆã€å¤åˆ¶ç­‰æ“ä½œ</p>

<p>è¿™é‡Œä»…ä»‹ç»å…¶è·Ÿã€é›¶æ‹·è´ã€‘ç›¸å…³çš„ wrappedBuffer æ–¹æ³•ï¼Œå¯ä»¥ç”¨æ¥åŒ…è£… ByteBuf</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="nc">ByteBuf</span> <span class="n">buf1</span> <span class="o">=</span> <span class="nc">ByteBufAllocator</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">.</span><span class="na">buffer</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
<span class="n">buf1</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="k">new</span> <span class="kt">byte</span><span class="o">[]{</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="mi">5</span><span class="o">});</span>
<span class="nc">ByteBuf</span> <span class="n">buf2</span> <span class="o">=</span> <span class="nc">ByteBufAllocator</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">.</span><span class="na">buffer</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
<span class="n">buf2</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="k">new</span> <span class="kt">byte</span><span class="o">[]{</span><span class="mi">6</span><span class="o">,</span> <span class="mi">7</span><span class="o">,</span> <span class="mi">8</span><span class="o">,</span> <span class="mi">9</span><span class="o">,</span> <span class="mi">10</span><span class="o">});</span>

<span class="c1">// å½“åŒ…è£… ByteBuf ä¸ªæ•°è¶…è¿‡ä¸€ä¸ªæ—¶, åº•å±‚ä½¿ç”¨äº† CompositeByteBuf</span>
<span class="nc">ByteBuf</span> <span class="n">buf3</span> <span class="o">=</span> <span class="nc">Unpooled</span><span class="o">.</span><span class="na">wrappedBuffer</span><span class="o">(</span><span class="n">buf1</span><span class="o">,</span> <span class="n">buf2</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">ByteBufUtil</span><span class="o">.</span><span class="na">prettyHexDump</span><span class="o">(</span><span class="n">buf3</span><span class="o">));</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 01 02 03 04 05 06 07 08 09 0a                   |..........      |
+--------+-------------------------------------------------+----------------+
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä¹Ÿå¯ä»¥ç”¨æ¥åŒ…è£…æ™®é€šå­—èŠ‚æ•°ç»„ï¼Œåº•å±‚ä¹Ÿä¸ä¼šæœ‰æ‹·è´æ“ä½œ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nc">ByteBuf</span> <span class="n">buf4</span> <span class="o">=</span> <span class="nc">Unpooled</span><span class="o">.</span><span class="na">wrappedBuffer</span><span class="o">(</span><span class="k">new</span> <span class="kt">byte</span><span class="o">[]{</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">},</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[]{</span><span class="mi">4</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="mi">6</span><span class="o">});</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buf4</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">ByteBufUtil</span><span class="o">.</span><span class="na">prettyHexDump</span><span class="o">(</span><span class="n">buf4</span><span class="o">));</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>class io.netty.buffer.CompositeByteBuf
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 01 02 03 04 05 06                               |......          |
+--------+-------------------------------------------------+----------------+
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="-bytebuf-ä¼˜åŠ¿">ğŸ’¡ ByteBuf ä¼˜åŠ¿</h4>

<ul>
  <li>æ± åŒ– - å¯ä»¥é‡ç”¨æ± ä¸­ ByteBuf å®ä¾‹ï¼Œæ›´èŠ‚çº¦å†…å­˜ï¼Œå‡å°‘å†…å­˜æº¢å‡ºçš„å¯èƒ½</li>
  <li>è¯»å†™æŒ‡é’ˆåˆ†ç¦»ï¼Œä¸éœ€è¦åƒ ByteBuffer ä¸€æ ·åˆ‡æ¢è¯»å†™æ¨¡å¼</li>
  <li>å¯ä»¥è‡ªåŠ¨æ‰©å®¹</li>
  <li>æ”¯æŒé“¾å¼è°ƒç”¨ï¼Œä½¿ç”¨æ›´æµç•…</li>
  <li>å¾ˆå¤šåœ°æ–¹ä½“ç°é›¶æ‹·è´ï¼Œä¾‹å¦‚ sliceã€duplicateã€CompositeByteBuf</li>
</ul>

<h2 id="4-åŒå‘é€šä¿¡">4. åŒå‘é€šä¿¡</h2>

<h3 id="41-ç»ƒä¹ ">4.1 ç»ƒä¹ </h3>

<p>å®ç°ä¸€ä¸ª echo server</p>

<p>ç¼–å†™ server</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre><span class="k">new</span> <span class="nc">ServerBootstrap</span><span class="o">()</span>
    <span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">())</span>
    <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">NioSocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">NioSocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInboundHandlerAdapter</span><span class="o">(){</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">ByteBuf</span> <span class="n">buffer</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ByteBuf</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="nc">Charset</span><span class="o">.</span><span class="na">defaultCharset</span><span class="o">()));</span>

                    <span class="c1">// å»ºè®®ä½¿ç”¨ ctx.alloc() åˆ›å»º ByteBuf</span>
                    <span class="nc">ByteBuf</span> <span class="n">response</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">alloc</span><span class="o">().</span><span class="na">buffer</span><span class="o">();</span>
                    <span class="n">response</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
                    <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">response</span><span class="o">);</span>

                    <span class="c1">// æ€è€ƒï¼šéœ€è¦é‡Šæ”¾ buffer å—</span>
                    <span class="c1">// æ€è€ƒï¼šéœ€è¦é‡Šæ”¾ response å—</span>
                <span class="o">}</span>
            <span class="o">});</span>
        <span class="o">}</span>
    <span class="o">}).</span><span class="na">bind</span><span class="o">(</span><span class="mi">8080</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç¼–å†™ client</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="rouge-code"><pre><span class="nc">NioEventLoopGroup</span> <span class="n">group</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">();</span>
<span class="nc">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Bootstrap</span><span class="o">()</span>
    <span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">group</span><span class="o">)</span>
    <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">NioSocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">NioSocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">StringEncoder</span><span class="o">());</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInboundHandlerAdapter</span><span class="o">()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">ByteBuf</span> <span class="n">buffer</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ByteBuf</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="nc">Charset</span><span class="o">.</span><span class="na">defaultCharset</span><span class="o">()));</span>

                    <span class="c1">// æ€è€ƒï¼šéœ€è¦é‡Šæ”¾ buffer å—</span>
                <span class="o">}</span>
            <span class="o">});</span>
        <span class="o">}</span>
    <span class="o">}).</span><span class="na">connect</span><span class="o">(</span><span class="s">"127.0.0.1"</span><span class="o">,</span> <span class="mi">8080</span><span class="o">).</span><span class="na">sync</span><span class="o">().</span><span class="na">channel</span><span class="o">();</span>

<span class="n">channel</span><span class="o">.</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">addListener</span><span class="o">(</span><span class="n">future</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="n">group</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
<span class="o">});</span>

<span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="nc">Scanner</span> <span class="n">scanner</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Scanner</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">in</span><span class="o">);</span>
    <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">line</span> <span class="o">=</span> <span class="n">scanner</span><span class="o">.</span><span class="na">nextLine</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="s">"q"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">line</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">channel</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="k">break</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">channel</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">line</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}).</span><span class="na">start</span><span class="o">();</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="-è¯»å’Œå†™çš„è¯¯è§£">ğŸ’¡ è¯»å’Œå†™çš„è¯¯è§£</h3>

<p>æˆ‘æœ€åˆåœ¨è®¤è¯†ä¸Šæœ‰è¿™æ ·çš„è¯¯åŒºï¼Œè®¤ä¸ºåªæœ‰åœ¨ nettyï¼Œnio è¿™æ ·çš„å¤šè·¯å¤ç”¨ IO æ¨¡å‹æ—¶ï¼Œè¯»å†™æ‰ä¸ä¼šç›¸äº’é˜»å¡ï¼Œæ‰å¯ä»¥å®ç°é«˜æ•ˆçš„åŒå‘é€šä¿¡ï¼Œä½†å®é™…ä¸Šï¼ŒJava Socket æ˜¯å…¨åŒå·¥çš„ï¼šåœ¨ä»»æ„æ—¶åˆ»ï¼Œçº¿è·¯ä¸Šå­˜åœ¨<code class="language-plaintext highlighter-rouge">A åˆ° B</code> å’Œ <code class="language-plaintext highlighter-rouge">B åˆ° A</code> çš„åŒå‘ä¿¡å·ä¼ è¾“ã€‚å³ä½¿æ˜¯é˜»å¡ IOï¼Œè¯»å’Œå†™æ˜¯å¯ä»¥åŒæ—¶è¿›è¡Œçš„ï¼Œåªè¦åˆ†åˆ«é‡‡ç”¨è¯»çº¿ç¨‹å’Œå†™çº¿ç¨‹å³å¯ï¼Œè¯»ä¸ä¼šé˜»å¡å†™ã€å†™ä¹Ÿä¸ä¼šé˜»å¡è¯»</p>

<p>ä¾‹å¦‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestServer</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">ServerSocket</span> <span class="n">ss</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServerSocket</span><span class="o">(</span><span class="mi">8888</span><span class="o">);</span>
        <span class="nc">Socket</span> <span class="n">s</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>

        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">BufferedReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="nc">InputStreamReader</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">()));</span>
                <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">());</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}).</span><span class="na">start</span><span class="o">();</span>

        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">BufferedWriter</span> <span class="n">writer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedWriter</span><span class="o">(</span><span class="k">new</span> <span class="nc">OutputStreamWriter</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">()));</span>
                <span class="c1">// ä¾‹å¦‚åœ¨è¿™ä¸ªä½ç½®åŠ å…¥ thread çº§åˆ«æ–­ç‚¹ï¼Œå¯ä»¥å‘ç°å³ä½¿ä¸å†™å…¥æ•°æ®ï¼Œä¹Ÿä¸å¦¨ç¢å‰é¢çº¿ç¨‹è¯»å–å®¢æˆ·ç«¯æ•°æ®</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                    <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
                    <span class="n">writer</span><span class="o">.</span><span class="na">newLine</span><span class="o">();</span>
                    <span class="n">writer</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}).</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å®¢æˆ·ç«¯</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestClient</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">Socket</span> <span class="n">s</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Socket</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="mi">8888</span><span class="o">);</span>

        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">BufferedReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="nc">InputStreamReader</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">()));</span>
                <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">());</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}).</span><span class="na">start</span><span class="o">();</span>

        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">BufferedWriter</span> <span class="n">writer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedWriter</span><span class="o">(</span><span class="k">new</span> <span class="nc">OutputStreamWriter</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">()));</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                    <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
                    <span class="n">writer</span><span class="o">.</span><span class="na">newLine</span><span class="o">();</span>
                    <span class="n">writer</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}).</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h1 id="äºŒ-netty-å…¥é—¨-1">äºŒ. Netty å…¥é—¨</h1>

<h2 id="1-æ¦‚è¿°-1">1. æ¦‚è¿°</h2>

<h3 id="11-netty-æ˜¯ä»€ä¹ˆ-1">1.1 Netty æ˜¯ä»€ä¹ˆï¼Ÿ</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>Netty is an asynchronous event-driven network application framework
for rapid development of maintainable high performance protocol servers &amp; clients.
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Netty æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„ã€åŸºäºäº‹ä»¶é©±åŠ¨çš„ç½‘ç»œåº”ç”¨æ¡†æ¶ï¼Œç”¨äºå¿«é€Ÿå¼€å‘å¯ç»´æŠ¤ã€é«˜æ€§èƒ½çš„ç½‘ç»œæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯</p>

<h3 id="12-netty-çš„ä½œè€…-1">1.2 Netty çš„ä½œè€…</h3>

<p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0005.png" alt="" /></p>

<p>ä»–è¿˜æ˜¯å¦ä¸€ä¸ªè‘—åç½‘ç»œåº”ç”¨æ¡†æ¶ Mina çš„é‡è¦è´¡çŒ®è€…</p>

<h3 id="13-netty-çš„åœ°ä½-1">1.3 Netty çš„åœ°ä½</h3>

<p>Netty åœ¨ Java ç½‘ç»œåº”ç”¨æ¡†æ¶ä¸­çš„åœ°ä½å°±å¥½æ¯”ï¼šSpring æ¡†æ¶åœ¨ JavaEE å¼€å‘ä¸­çš„åœ°ä½</p>

<p>ä»¥ä¸‹çš„æ¡†æ¶éƒ½ä½¿ç”¨äº† Nettyï¼Œå› ä¸ºå®ƒä»¬æœ‰ç½‘ç»œé€šä¿¡éœ€æ±‚ï¼</p>

<ul>
  <li>Cassandra - nosql æ•°æ®åº“</li>
  <li>Spark - å¤§æ•°æ®åˆ†å¸ƒå¼è®¡ç®—æ¡†æ¶</li>
  <li>Hadoop - å¤§æ•°æ®åˆ†å¸ƒå¼å­˜å‚¨æ¡†æ¶</li>
  <li>RocketMQ - ali å¼€æºçš„æ¶ˆæ¯é˜Ÿåˆ—</li>
  <li>ElasticSearch - æœç´¢å¼•æ“</li>
  <li>gRPC - rpc æ¡†æ¶</li>
  <li>Dubbo - rpc æ¡†æ¶</li>
  <li>Spring 5.x - flux api å®Œå…¨æŠ›å¼ƒäº† tomcat ï¼Œä½¿ç”¨ netty ä½œä¸ºæœåŠ¡å™¨ç«¯</li>
  <li>Zookeeper - åˆ†å¸ƒå¼åè°ƒæ¡†æ¶</li>
</ul>

<h3 id="14-netty-çš„ä¼˜åŠ¿-1">1.4 Netty çš„ä¼˜åŠ¿</h3>

<ul>
  <li>Netty vs NIOï¼Œå·¥ä½œé‡å¤§ï¼Œbug å¤š
    <ul>
      <li>éœ€è¦è‡ªå·±æ„å»ºåè®®</li>
      <li>è§£å†³ TCP ä¼ è¾“é—®é¢˜ï¼Œå¦‚ç²˜åŒ…ã€åŠåŒ…</li>
      <li>epoll ç©ºè½®è¯¢å¯¼è‡´ CPU 100%</li>
      <li>å¯¹ API è¿›è¡Œå¢å¼ºï¼Œä½¿ä¹‹æ›´æ˜“ç”¨ï¼Œå¦‚ FastThreadLocal =&gt; ThreadLocalï¼ŒByteBuf =&gt; ByteBuffer</li>
    </ul>
  </li>
  <li>Netty vs å…¶å®ƒç½‘ç»œåº”ç”¨æ¡†æ¶
    <ul>
      <li>Mina ç”± apache ç»´æŠ¤ï¼Œå°†æ¥ 3.x ç‰ˆæœ¬å¯èƒ½ä¼šæœ‰è¾ƒå¤§é‡æ„ï¼Œç ´å API å‘ä¸‹å…¼å®¹æ€§ï¼ŒNetty çš„å¼€å‘è¿­ä»£æ›´è¿…é€Ÿï¼ŒAPI æ›´ç®€æ´ã€æ–‡æ¡£æ›´ä¼˜ç§€</li>
      <li>ä¹…ç»è€ƒéªŒï¼Œ16å¹´ï¼ŒNetty ç‰ˆæœ¬
        <ul>
          <li>2.x 2004</li>
          <li>3.x 2008</li>
          <li>4.x 2013</li>
          <li>5.x å·²åºŸå¼ƒï¼ˆæ²¡æœ‰æ˜æ˜¾çš„æ€§èƒ½æå‡ï¼Œç»´æŠ¤æˆæœ¬é«˜ï¼‰</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h2 id="2-hello-world-1">2. Hello World</h2>

<h3 id="21-ç›®æ ‡-1">2.1 ç›®æ ‡</h3>

<p>å¼€å‘ä¸€ä¸ªç®€å•çš„æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯</p>

<ul>
  <li>å®¢æˆ·ç«¯å‘æœåŠ¡å™¨ç«¯å‘é€ hello, world</li>
  <li>æœåŠ¡å™¨ä»…æ¥æ”¶ï¼Œä¸è¿”å›</li>
</ul>

<p>åŠ å…¥ä¾èµ–</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>io.netty<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>netty-all<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>4.1.39.Final<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="22-æœåŠ¡å™¨ç«¯-1">2.2 æœåŠ¡å™¨ç«¯</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="k">new</span> <span class="nc">ServerBootstrap</span><span class="o">()</span>
    <span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">())</span> <span class="c1">// 1</span>
    <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="c1">// 2</span>
    <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">NioSocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span> <span class="c1">// 3</span>
        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">NioSocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">StringDecoder</span><span class="o">());</span> <span class="c1">// 5</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">SimpleChannelInboundHandler</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;()</span> <span class="o">{</span> <span class="c1">// 6</span>
                <span class="nd">@Override</span>
                <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">channelRead0</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">String</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">});</span>
        <span class="o">}</span>
    <span class="o">})</span>
    <span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="mi">8080</span><span class="o">);</span> <span class="c1">// 4</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä»£ç è§£è¯»</p>

<ul>
  <li>
    <p>1 å¤„ï¼Œåˆ›å»º NioEventLoopGroupï¼Œå¯ä»¥ç®€å•ç†è§£ä¸º <code class="language-plaintext highlighter-rouge">çº¿ç¨‹æ±  + Selector</code> åé¢ä¼šè¯¦ç»†å±•å¼€</p>
  </li>
  <li>
    <p>2 å¤„ï¼Œé€‰æ‹©æœåŠ¡ Scoket å®ç°ç±»ï¼Œå…¶ä¸­ NioServerSocketChannel è¡¨ç¤ºåŸºäº NIO çš„æœåŠ¡å™¨ç«¯å®ç°ï¼Œå…¶å®ƒå®ç°è¿˜æœ‰</p>

    <p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0006.png" alt="" /></p>
  </li>
  <li>
    <p>3 å¤„ï¼Œä¸ºå•¥æ–¹æ³•å« childHandlerï¼Œæ˜¯æ¥ä¸‹æ¥æ·»åŠ çš„å¤„ç†å™¨éƒ½æ˜¯ç»™ SocketChannel ç”¨çš„ï¼Œè€Œä¸æ˜¯ç»™ ServerSocketChannelã€‚ChannelInitializer å¤„ç†å™¨ï¼ˆä»…æ‰§è¡Œä¸€æ¬¡ï¼‰ï¼Œå®ƒçš„ä½œç”¨æ˜¯å¾…å®¢æˆ·ç«¯ SocketChannel å»ºç«‹è¿æ¥åï¼Œæ‰§è¡Œ initChannel ä»¥ä¾¿æ·»åŠ æ›´å¤šçš„å¤„ç†å™¨</p>
  </li>
  <li>
    <p>4 å¤„ï¼ŒServerSocketChannel ç»‘å®šçš„ç›‘å¬ç«¯å£</p>
  </li>
  <li>
    <p>5 å¤„ï¼ŒSocketChannel çš„å¤„ç†å™¨ï¼Œè§£ç  ByteBuf =&gt; String</p>
  </li>
  <li>
    <p>6 å¤„ï¼ŒSocketChannel çš„ä¸šåŠ¡å¤„ç†å™¨ï¼Œä½¿ç”¨ä¸Šä¸€ä¸ªå¤„ç†å™¨çš„å¤„ç†ç»“æœ</p>
  </li>
</ul>

<h3 id="23-å®¢æˆ·ç«¯-1">2.3 å®¢æˆ·ç«¯</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="k">new</span> <span class="nc">Bootstrap</span><span class="o">()</span>
    <span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">())</span> <span class="c1">// 1</span>
    <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="c1">// 2</span>
    <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">Channel</span><span class="o">&gt;()</span> <span class="o">{</span> <span class="c1">// 3</span>
        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">Channel</span> <span class="n">ch</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">StringEncoder</span><span class="o">());</span> <span class="c1">// 8</span>
        <span class="o">}</span>
    <span class="o">})</span>
    <span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="s">"127.0.0.1"</span><span class="o">,</span> <span class="mi">8080</span><span class="o">)</span> <span class="c1">// 4</span>
    <span class="o">.</span><span class="na">sync</span><span class="o">()</span> <span class="c1">// 5</span>
    <span class="o">.</span><span class="na">channel</span><span class="o">()</span> <span class="c1">// 6</span>
    <span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">()</span> <span class="o">+</span> <span class="s">": hello world!"</span><span class="o">);</span> <span class="c1">// 7</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä»£ç è§£è¯»</p>

<ul>
  <li>
    <p>1 å¤„ï¼Œåˆ›å»º NioEventLoopGroupï¼ŒåŒ Server</p>
  </li>
  <li>
    <p>2 å¤„ï¼Œé€‰æ‹©å®¢æˆ· Socket å®ç°ç±»ï¼ŒNioSocketChannel è¡¨ç¤ºåŸºäº NIO çš„å®¢æˆ·ç«¯å®ç°ï¼Œå…¶å®ƒå®ç°è¿˜æœ‰</p>

    <p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0007.png" alt="" /></p>
  </li>
  <li>
    <p>3 å¤„ï¼Œæ·»åŠ  SocketChannel çš„å¤„ç†å™¨ï¼ŒChannelInitializer å¤„ç†å™¨ï¼ˆä»…æ‰§è¡Œä¸€æ¬¡ï¼‰ï¼Œå®ƒçš„ä½œç”¨æ˜¯å¾…å®¢æˆ·ç«¯ SocketChannel å»ºç«‹è¿æ¥åï¼Œæ‰§è¡Œ initChannel ä»¥ä¾¿æ·»åŠ æ›´å¤šçš„å¤„ç†å™¨</p>
  </li>
  <li>
    <p>4 å¤„ï¼ŒæŒ‡å®šè¦è¿æ¥çš„æœåŠ¡å™¨å’Œç«¯å£</p>
  </li>
  <li>
    <p>5 å¤„ï¼ŒNetty ä¸­å¾ˆå¤šæ–¹æ³•éƒ½æ˜¯å¼‚æ­¥çš„ï¼Œå¦‚ connectï¼Œè¿™æ—¶éœ€è¦ä½¿ç”¨ sync æ–¹æ³•ç­‰å¾… connect å»ºç«‹è¿æ¥å®Œæ¯•</p>
  </li>
  <li>
    <p>6 å¤„ï¼Œè·å– channel å¯¹è±¡ï¼Œå®ƒå³ä¸ºé€šé“æŠ½è±¡ï¼Œå¯ä»¥è¿›è¡Œæ•°æ®è¯»å†™æ“ä½œ</p>
  </li>
  <li>
    <p>7 å¤„ï¼Œå†™å…¥æ¶ˆæ¯å¹¶æ¸…ç©ºç¼“å†²åŒº</p>
  </li>
  <li>
    <p>8 å¤„ï¼Œæ¶ˆæ¯ä¼šç»è¿‡é€šé“ handler å¤„ç†ï¼Œè¿™é‡Œæ˜¯å°† String =&gt; ByteBuf å‘å‡º</p>
  </li>
  <li>
    <p>æ•°æ®ç»è¿‡ç½‘ç»œä¼ è¾“ï¼Œåˆ°è¾¾æœåŠ¡å™¨ç«¯ï¼ŒæœåŠ¡å™¨ç«¯ 5 å’Œ 6 å¤„çš„ handler å…ˆåè¢«è§¦å‘ï¼Œèµ°å®Œä¸€ä¸ªæµç¨‹</p>
  </li>
</ul>

<h3 id="24-æµç¨‹æ¢³ç†-1">2.4 æµç¨‹æ¢³ç†</h3>

<p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0040.png" alt="" /></p>

<h4 id="-æç¤º-1">ğŸ’¡ æç¤º</h4>

<blockquote>
  <p>ä¸€å¼€å§‹éœ€è¦æ ‘ç«‹æ­£ç¡®çš„è§‚å¿µ</p>

  <ul>
    <li>æŠŠ channel ç†è§£ä¸ºæ•°æ®çš„é€šé“</li>
    <li>æŠŠ msg ç†è§£ä¸ºæµåŠ¨çš„æ•°æ®ï¼Œæœ€å¼€å§‹è¾“å…¥æ˜¯ ByteBufï¼Œä½†ç»è¿‡ pipeline çš„åŠ å·¥ï¼Œä¼šå˜æˆå…¶å®ƒç±»å‹å¯¹è±¡ï¼Œæœ€åè¾“å‡ºåˆå˜æˆ ByteBuf</li>
    <li>æŠŠ handler ç†è§£ä¸ºæ•°æ®çš„å¤„ç†å·¥åº
      <ul>
        <li>å·¥åºæœ‰å¤šé“ï¼Œåˆåœ¨ä¸€èµ·å°±æ˜¯ pipelineï¼Œpipeline è´Ÿè´£å‘å¸ƒäº‹ä»¶ï¼ˆè¯»ã€è¯»å–å®Œæˆâ€¦ï¼‰ä¼ æ’­ç»™æ¯ä¸ª handlerï¼Œ handler å¯¹è‡ªå·±æ„Ÿå…´è¶£çš„äº‹ä»¶è¿›è¡Œå¤„ç†ï¼ˆé‡å†™äº†ç›¸åº”äº‹ä»¶å¤„ç†æ–¹æ³•ï¼‰</li>
        <li>handler åˆ† Inbound å’Œ Outbound ä¸¤ç±»</li>
      </ul>
    </li>
    <li>æŠŠ eventLoop ç†è§£ä¸ºå¤„ç†æ•°æ®çš„å·¥äºº
      <ul>
        <li>å·¥äººå¯ä»¥ç®¡ç†å¤šä¸ª channel çš„ io æ“ä½œï¼Œå¹¶ä¸”ä¸€æ—¦å·¥äººè´Ÿè´£äº†æŸä¸ª channelï¼Œå°±è¦è´Ÿè´£åˆ°åº•ï¼ˆç»‘å®šï¼‰</li>
        <li>å·¥äººæ—¢å¯ä»¥æ‰§è¡Œ io æ“ä½œï¼Œä¹Ÿå¯ä»¥è¿›è¡Œä»»åŠ¡å¤„ç†ï¼Œæ¯ä½å·¥äººæœ‰ä»»åŠ¡é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—é‡Œå¯ä»¥å †æ”¾å¤šä¸ª channel çš„å¾…å¤„ç†ä»»åŠ¡ï¼Œä»»åŠ¡åˆ†ä¸ºæ™®é€šä»»åŠ¡ã€å®šæ—¶ä»»åŠ¡</li>
        <li>å·¥äººæŒ‰ç…§ pipeline é¡ºåºï¼Œä¾æ¬¡æŒ‰ç…§ handler çš„è§„åˆ’ï¼ˆä»£ç ï¼‰å¤„ç†æ•°æ®ï¼Œå¯ä»¥ä¸ºæ¯é“å·¥åºæŒ‡å®šä¸åŒçš„å·¥äºº</li>
      </ul>
    </li>
  </ul>
</blockquote>

<h2 id="3-ç»„ä»¶-1">3. ç»„ä»¶</h2>

<h3 id="31-eventloop-1">3.1 EventLoop</h3>

<p>äº‹ä»¶å¾ªç¯å¯¹è±¡</p>

<p>EventLoop æœ¬è´¨æ˜¯ä¸€ä¸ªå•çº¿ç¨‹æ‰§è¡Œå™¨ï¼ˆåŒæ—¶ç»´æŠ¤äº†ä¸€ä¸ª Selectorï¼‰ï¼Œé‡Œé¢æœ‰ run æ–¹æ³•å¤„ç† Channel ä¸Šæºæºä¸æ–­çš„ io äº‹ä»¶ã€‚</p>

<p>å®ƒçš„ç»§æ‰¿å…³ç³»æ¯”è¾ƒå¤æ‚</p>

<ul>
  <li>ä¸€æ¡çº¿æ˜¯ç»§æ‰¿è‡ª j.u.c.ScheduledExecutorService å› æ­¤åŒ…å«äº†çº¿ç¨‹æ± ä¸­æ‰€æœ‰çš„æ–¹æ³•</li>
  <li>å¦ä¸€æ¡çº¿æ˜¯ç»§æ‰¿è‡ª netty è‡ªå·±çš„ OrderedEventExecutorï¼Œ
    <ul>
      <li>æä¾›äº† boolean inEventLoop(Thread thread) æ–¹æ³•åˆ¤æ–­ä¸€ä¸ªçº¿ç¨‹æ˜¯å¦å±äºæ­¤ EventLoop</li>
      <li>æä¾›äº† parent æ–¹æ³•æ¥çœ‹çœ‹è‡ªå·±å±äºå“ªä¸ª EventLoopGroup</li>
    </ul>
  </li>
</ul>

<p>äº‹ä»¶å¾ªç¯ç»„</p>

<p>EventLoopGroup æ˜¯ä¸€ç»„ EventLoopï¼ŒChannel ä¸€èˆ¬ä¼šè°ƒç”¨ EventLoopGroup çš„ register æ–¹æ³•æ¥ç»‘å®šå…¶ä¸­ä¸€ä¸ª EventLoopï¼Œåç»­è¿™ä¸ª Channel ä¸Šçš„ io äº‹ä»¶éƒ½ç”±æ­¤ EventLoop æ¥å¤„ç†ï¼ˆä¿è¯äº† io äº‹ä»¶å¤„ç†æ—¶çš„çº¿ç¨‹å®‰å…¨ï¼‰</p>

<ul>
  <li>ç»§æ‰¿è‡ª netty è‡ªå·±çš„ EventExecutorGroup
    <ul>
      <li>å®ç°äº† Iterable æ¥å£æä¾›éå† EventLoop çš„èƒ½åŠ›</li>
      <li>å¦æœ‰ next æ–¹æ³•è·å–é›†åˆä¸­ä¸‹ä¸€ä¸ª EventLoop</li>
    </ul>
  </li>
</ul>

<p>ä»¥ä¸€ä¸ªç®€å•çš„å®ç°ä¸ºä¾‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="c1">// å†…éƒ¨åˆ›å»ºäº†ä¸¤ä¸ª EventLoop, æ¯ä¸ª EventLoop ç»´æŠ¤ä¸€ä¸ªçº¿ç¨‹</span>
<span class="nc">DefaultEventLoopGroup</span> <span class="n">group</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultEventLoopGroup</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">group</span><span class="o">.</span><span class="na">next</span><span class="o">());</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">group</span><span class="o">.</span><span class="na">next</span><span class="o">());</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">group</span><span class="o">.</span><span class="na">next</span><span class="o">());</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>io.netty.channel.DefaultEventLoop@60f82f98
io.netty.channel.DefaultEventLoop@35f983a6
io.netty.channel.DefaultEventLoop@60f82f98
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä¹Ÿå¯ä»¥ä½¿ç”¨ for å¾ªç¯</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nc">DefaultEventLoopGroup</span> <span class="n">group</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultEventLoopGroup</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
<span class="k">for</span> <span class="o">(</span><span class="nc">EventExecutor</span> <span class="n">eventLoop</span> <span class="o">:</span> <span class="n">group</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">eventLoop</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>io.netty.channel.DefaultEventLoop@60f82f98
io.netty.channel.DefaultEventLoop@35f983a6
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="-ä¼˜é›…å…³é—­-1">ğŸ’¡ ä¼˜é›…å…³é—­</h4>

<p>ä¼˜é›…å…³é—­ <code class="language-plaintext highlighter-rouge">shutdownGracefully</code> æ–¹æ³•ã€‚è¯¥æ–¹æ³•ä¼šé¦–å…ˆåˆ‡æ¢ <code class="language-plaintext highlighter-rouge">EventLoopGroup</code> åˆ°å…³é—­çŠ¶æ€ä»è€Œæ‹’ç»æ–°çš„ä»»åŠ¡çš„åŠ å…¥ï¼Œç„¶ååœ¨ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡éƒ½å¤„ç†å®Œæˆåï¼Œåœæ­¢çº¿ç¨‹çš„è¿è¡Œã€‚ä»è€Œç¡®ä¿æ•´ä½“åº”ç”¨æ˜¯åœ¨æ­£å¸¸æœ‰åºçš„çŠ¶æ€ä¸‹é€€å‡ºçš„</p>

<h4 id="æ¼”ç¤º-nioeventloop-å¤„ç†-io-äº‹ä»¶-1">æ¼”ç¤º NioEventLoop å¤„ç† io äº‹ä»¶</h4>

<p>æœåŠ¡å™¨ç«¯ä¸¤ä¸ª nio worker å·¥äºº</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="k">new</span> <span class="nc">ServerBootstrap</span><span class="o">()</span>
    <span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">(</span><span class="mi">1</span><span class="o">),</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">(</span><span class="mi">2</span><span class="o">))</span>
    <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">NioSocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">NioSocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInboundHandlerAdapter</span><span class="o">()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">ByteBuf</span> <span class="n">byteBuf</span> <span class="o">=</span> <span class="n">msg</span> <span class="k">instanceof</span> <span class="nc">ByteBuf</span> <span class="o">?</span> <span class="o">((</span><span class="nc">ByteBuf</span><span class="o">)</span> <span class="n">msg</span><span class="o">)</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">byteBuf</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="kt">byte</span><span class="o">[]</span> <span class="n">buf</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">16</span><span class="o">];</span>
                        <span class="nc">ByteBuf</span> <span class="n">len</span> <span class="o">=</span> <span class="n">byteBuf</span><span class="o">.</span><span class="na">readBytes</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">byteBuf</span><span class="o">.</span><span class="na">readableBytes</span><span class="o">());</span>
                        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">buf</span><span class="o">));</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">});</span>
        <span class="o">}</span>
    <span class="o">}).</span><span class="na">bind</span><span class="o">(</span><span class="mi">8080</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å®¢æˆ·ç«¯ï¼Œå¯åŠ¨ä¸‰æ¬¡ï¼Œåˆ†åˆ«ä¿®æ”¹å‘é€å­—ç¬¦ä¸²ä¸º zhangsanï¼ˆç¬¬ä¸€æ¬¡ï¼‰ï¼Œlisiï¼ˆç¬¬äºŒæ¬¡ï¼‰ï¼Œwangwuï¼ˆç¬¬ä¸‰æ¬¡ï¼‰</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
    <span class="nc">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Bootstrap</span><span class="o">()</span>
            <span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">(</span><span class="mi">1</span><span class="o">))</span>
            <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">NioSocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">NioSocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"init..."</span><span class="o">);</span>
                    <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">LoggingHandler</span><span class="o">(</span><span class="nc">LogLevel</span><span class="o">.</span><span class="na">DEBUG</span><span class="o">));</span>
                <span class="o">}</span>
            <span class="o">})</span>
            <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">connect</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="mi">8080</span><span class="o">)</span>
            <span class="o">.</span><span class="na">sync</span><span class="o">()</span>
            <span class="o">.</span><span class="na">channel</span><span class="o">();</span>

    <span class="n">channel</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="nc">ByteBufAllocator</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">.</span><span class="na">buffer</span><span class="o">().</span><span class="na">writeBytes</span><span class="o">(</span><span class="s">"wangwu"</span><span class="o">.</span><span class="na">getBytes</span><span class="o">()));</span>
    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">2000</span><span class="o">);</span>
    <span class="n">channel</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="nc">ByteBufAllocator</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">.</span><span class="na">buffer</span><span class="o">().</span><span class="na">writeBytes</span><span class="o">(</span><span class="s">"wangwu"</span><span class="o">.</span><span class="na">getBytes</span><span class="o">()));</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æœ€åè¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>22:03:34 [DEBUG] [nioEventLoopGroup-3-1] c.i.o.EventLoopTest - zhangsan       
22:03:36 [DEBUG] [nioEventLoopGroup-3-1] c.i.o.EventLoopTest - zhangsan       
22:05:36 [DEBUG] [nioEventLoopGroup-3-2] c.i.o.EventLoopTest - lisi           
22:05:38 [DEBUG] [nioEventLoopGroup-3-2] c.i.o.EventLoopTest - lisi           
22:06:09 [DEBUG] [nioEventLoopGroup-3-1] c.i.o.EventLoopTest - wangwu        
22:06:11 [DEBUG] [nioEventLoopGroup-3-1] c.i.o.EventLoopTest - wangwu         
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªå·¥äººè½®æµå¤„ç† channelï¼Œä½†å·¥äººä¸ channel ä¹‹é—´è¿›è¡Œäº†ç»‘å®š</p>

<p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0042.png" alt="" /></p>

<p>å†å¢åŠ ä¸¤ä¸ªé nio å·¥äºº</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="nc">DefaultEventLoopGroup</span> <span class="n">normalWorkers</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultEventLoopGroup</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
<span class="k">new</span> <span class="nf">ServerBootstrap</span><span class="o">()</span>
    <span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">(</span><span class="mi">1</span><span class="o">),</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">(</span><span class="mi">2</span><span class="o">))</span>
    <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">NioSocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">NioSocketChannel</span> <span class="n">ch</span><span class="o">)</span>  <span class="o">{</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">LoggingHandler</span><span class="o">(</span><span class="nc">LogLevel</span><span class="o">.</span><span class="na">DEBUG</span><span class="o">));</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="n">normalWorkers</span><span class="o">,</span><span class="s">"myhandler"</span><span class="o">,</span>
              <span class="k">new</span> <span class="nf">ChannelInboundHandlerAdapter</span><span class="o">()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">ByteBuf</span> <span class="n">byteBuf</span> <span class="o">=</span> <span class="n">msg</span> <span class="k">instanceof</span> <span class="nc">ByteBuf</span> <span class="o">?</span> <span class="o">((</span><span class="nc">ByteBuf</span><span class="o">)</span> <span class="n">msg</span><span class="o">)</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">byteBuf</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="kt">byte</span><span class="o">[]</span> <span class="n">buf</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">16</span><span class="o">];</span>
                        <span class="nc">ByteBuf</span> <span class="n">len</span> <span class="o">=</span> <span class="n">byteBuf</span><span class="o">.</span><span class="na">readBytes</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">byteBuf</span><span class="o">.</span><span class="na">readableBytes</span><span class="o">());</span>
                        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">buf</span><span class="o">));</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">});</span>
        <span class="o">}</span>
    <span class="o">}).</span><span class="na">bind</span><span class="o">(</span><span class="mi">8080</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å®¢æˆ·ç«¯ä»£ç ä¸å˜ï¼Œå¯åŠ¨ä¸‰æ¬¡ï¼Œåˆ†åˆ«ä¿®æ”¹å‘é€å­—ç¬¦ä¸²ä¸º zhangsanï¼ˆç¬¬ä¸€æ¬¡ï¼‰ï¼Œlisiï¼ˆç¬¬äºŒæ¬¡ï¼‰ï¼Œwangwuï¼ˆç¬¬ä¸‰æ¬¡ï¼‰</p>

<p>è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
</pre></td><td class="rouge-code"><pre>22:19:48 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x251562d5, L:/127.0.0.1:8080 - R:/127.0.0.1:52588] REGISTERED
22:19:48 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x251562d5, L:/127.0.0.1:8080 - R:/127.0.0.1:52588] ACTIVE
22:19:48 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x251562d5, L:/127.0.0.1:8080 - R:/127.0.0.1:52588] READ: 8B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 7a 68 61 6e 67 73 61 6e                         |zhangsan        |
+--------+-------------------------------------------------+----------------+
22:19:48 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x251562d5, L:/127.0.0.1:8080 - R:/127.0.0.1:52588] READ COMPLETE
22:19:48 [DEBUG] [defaultEventLoopGroup-2-1] c.i.o.EventLoopTest - zhangsan        
22:19:50 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x251562d5, L:/127.0.0.1:8080 - R:/127.0.0.1:52588] READ: 8B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 7a 68 61 6e 67 73 61 6e                         |zhangsan        |
+--------+-------------------------------------------------+----------------+
22:19:50 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x251562d5, L:/127.0.0.1:8080 - R:/127.0.0.1:52588] READ COMPLETE
22:19:50 [DEBUG] [defaultEventLoopGroup-2-1] c.i.o.EventLoopTest - zhangsan        
22:20:24 [DEBUG] [nioEventLoopGroup-4-2] i.n.h.l.LoggingHandler - [id: 0x94b2a840, L:/127.0.0.1:8080 - R:/127.0.0.1:52612] REGISTERED
22:20:24 [DEBUG] [nioEventLoopGroup-4-2] i.n.h.l.LoggingHandler - [id: 0x94b2a840, L:/127.0.0.1:8080 - R:/127.0.0.1:52612] ACTIVE
22:20:25 [DEBUG] [nioEventLoopGroup-4-2] i.n.h.l.LoggingHandler - [id: 0x94b2a840, L:/127.0.0.1:8080 - R:/127.0.0.1:52612] READ: 4B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 6c 69 73 69                                     |lisi            |
+--------+-------------------------------------------------+----------------+
22:20:25 [DEBUG] [nioEventLoopGroup-4-2] i.n.h.l.LoggingHandler - [id: 0x94b2a840, L:/127.0.0.1:8080 - R:/127.0.0.1:52612] READ COMPLETE
22:20:25 [DEBUG] [defaultEventLoopGroup-2-2] c.i.o.EventLoopTest - lisi            
22:20:27 [DEBUG] [nioEventLoopGroup-4-2] i.n.h.l.LoggingHandler - [id: 0x94b2a840, L:/127.0.0.1:8080 - R:/127.0.0.1:52612] READ: 4B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 6c 69 73 69                                     |lisi            |
+--------+-------------------------------------------------+----------------+
22:20:27 [DEBUG] [nioEventLoopGroup-4-2] i.n.h.l.LoggingHandler - [id: 0x94b2a840, L:/127.0.0.1:8080 - R:/127.0.0.1:52612] READ COMPLETE
22:20:27 [DEBUG] [defaultEventLoopGroup-2-2] c.i.o.EventLoopTest - lisi            
22:20:38 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x79a26af9, L:/127.0.0.1:8080 - R:/127.0.0.1:52625] REGISTERED
22:20:38 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x79a26af9, L:/127.0.0.1:8080 - R:/127.0.0.1:52625] ACTIVE
22:20:38 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x79a26af9, L:/127.0.0.1:8080 - R:/127.0.0.1:52625] READ: 6B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 77 61 6e 67 77 75                               |wangwu          |
+--------+-------------------------------------------------+----------------+
22:20:38 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x79a26af9, L:/127.0.0.1:8080 - R:/127.0.0.1:52625] READ COMPLETE
22:20:38 [DEBUG] [defaultEventLoopGroup-2-1] c.i.o.EventLoopTest - wangwu          
22:20:40 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x79a26af9, L:/127.0.0.1:8080 - R:/127.0.0.1:52625] READ: 6B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 77 61 6e 67 77 75                               |wangwu          |
+--------+-------------------------------------------------+----------------+
22:20:40 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x79a26af9, L:/127.0.0.1:8080 - R:/127.0.0.1:52625] READ COMPLETE
22:20:40 [DEBUG] [defaultEventLoopGroup-2-1] c.i.o.EventLoopTest - wangwu          
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¯ä»¥çœ‹åˆ°ï¼Œnio å·¥äººå’Œ é nio å·¥äººä¹Ÿåˆ†åˆ«ç»‘å®šäº† channelï¼ˆLoggingHandler ç”± nio å·¥äººæ‰§è¡Œï¼Œè€Œæˆ‘ä»¬è‡ªå·±çš„ handler ç”±é nio å·¥äººæ‰§è¡Œï¼‰</p>

<p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0041.png" alt="" /></p>

<h4 id="-handler-æ‰§è¡Œä¸­å¦‚ä½•æ¢äºº-1">ğŸ’¡ handler æ‰§è¡Œä¸­å¦‚ä½•æ¢äººï¼Ÿ</h4>

<p>å…³é”®ä»£ç  <code class="language-plaintext highlighter-rouge">io.netty.channel.AbstractChannelHandlerContext#invokeChannelRead()</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="kd">static</span> <span class="kt">void</span> <span class="nf">invokeChannelRead</span><span class="o">(</span><span class="kd">final</span> <span class="nc">AbstractChannelHandlerContext</span> <span class="n">next</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="nc">Object</span> <span class="n">m</span> <span class="o">=</span> <span class="n">next</span><span class="o">.</span><span class="na">pipeline</span><span class="o">.</span><span class="na">touch</span><span class="o">(</span><span class="nc">ObjectUtil</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="s">"msg"</span><span class="o">),</span> <span class="n">next</span><span class="o">);</span>
    <span class="c1">// ä¸‹ä¸€ä¸ª handler çš„äº‹ä»¶å¾ªç¯æ˜¯å¦ä¸å½“å‰çš„äº‹ä»¶å¾ªç¯æ˜¯åŒä¸€ä¸ªçº¿ç¨‹</span>
    <span class="nc">EventExecutor</span> <span class="n">executor</span> <span class="o">=</span> <span class="n">next</span><span class="o">.</span><span class="na">executor</span><span class="o">();</span>
    
    <span class="c1">// æ˜¯ï¼Œç›´æ¥è°ƒç”¨</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">executor</span><span class="o">.</span><span class="na">inEventLoop</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">next</span><span class="o">.</span><span class="na">invokeChannelRead</span><span class="o">(</span><span class="n">m</span><span class="o">);</span>
    <span class="o">}</span> 
    <span class="c1">// ä¸æ˜¯ï¼Œå°†è¦æ‰§è¡Œçš„ä»£ç ä½œä¸ºä»»åŠ¡æäº¤ç»™ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªç¯å¤„ç†ï¼ˆæ¢äººï¼‰</span>
    <span class="k">else</span> <span class="o">{</span>
        <span class="n">executor</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="n">next</span><span class="o">.</span><span class="na">invokeChannelRead</span><span class="o">(</span><span class="n">m</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>å¦‚æœä¸¤ä¸ª handler ç»‘å®šçš„æ˜¯åŒä¸€ä¸ªçº¿ç¨‹ï¼Œé‚£ä¹ˆå°±ç›´æ¥è°ƒç”¨</li>
  <li>å¦åˆ™ï¼ŒæŠŠè¦è°ƒç”¨çš„ä»£ç å°è£…ä¸ºä¸€ä¸ªä»»åŠ¡å¯¹è±¡ï¼Œç”±ä¸‹ä¸€ä¸ª handler çš„çº¿ç¨‹æ¥è°ƒç”¨</li>
</ul>

<h4 id="æ¼”ç¤º-nioeventloop-å¤„ç†æ™®é€šä»»åŠ¡-1">æ¼”ç¤º NioEventLoop å¤„ç†æ™®é€šä»»åŠ¡</h4>

<p>NioEventLoop é™¤äº†å¯ä»¥å¤„ç† io äº‹ä»¶ï¼ŒåŒæ ·å¯ä»¥å‘å®ƒæäº¤æ™®é€šä»»åŠ¡</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="nc">NioEventLoopGroup</span> <span class="n">nioWorkers</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>

<span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"server start..."</span><span class="o">);</span>
<span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">2000</span><span class="o">);</span>
<span class="n">nioWorkers</span><span class="o">.</span><span class="na">execute</span><span class="o">(()-&gt;{</span>
    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"normal task..."</span><span class="o">);</span>
<span class="o">});</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>22:30:36 [DEBUG] [main] c.i.o.EventLoopTest2 - server start...
22:30:38 [DEBUG] [nioEventLoopGroup-2-1] c.i.o.EventLoopTest2 - normal task...
</pre></td></tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>å¯ä»¥ç”¨æ¥æ‰§è¡Œè€—æ—¶è¾ƒé•¿çš„ä»»åŠ¡</p>
</blockquote>

<h4 id="æ¼”ç¤º-nioeventloop-å¤„ç†å®šæ—¶ä»»åŠ¡-1">æ¼”ç¤º NioEventLoop å¤„ç†å®šæ—¶ä»»åŠ¡</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="nc">NioEventLoopGroup</span> <span class="n">nioWorkers</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>

<span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"server start..."</span><span class="o">);</span>
<span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">2000</span><span class="o">);</span>
<span class="n">nioWorkers</span><span class="o">.</span><span class="na">scheduleAtFixedRate</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"running..."</span><span class="o">);</span>
<span class="o">},</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>22:35:15 [DEBUG] [main] c.i.o.EventLoopTest2 - server start...
22:35:17 [DEBUG] [nioEventLoopGroup-2-1] c.i.o.EventLoopTest2 - running...
22:35:18 [DEBUG] [nioEventLoopGroup-2-1] c.i.o.EventLoopTest2 - running...
22:35:19 [DEBUG] [nioEventLoopGroup-2-1] c.i.o.EventLoopTest2 - running...
22:35:20 [DEBUG] [nioEventLoopGroup-2-1] c.i.o.EventLoopTest2 - running...
...
</pre></td></tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>å¯ä»¥ç”¨æ¥æ‰§è¡Œå®šæ—¶ä»»åŠ¡</p>
</blockquote>

<h3 id="32-channel-1">3.2 Channel</h3>

<p>channel çš„ä¸»è¦ä½œç”¨</p>

<ul>
  <li>close() å¯ä»¥ç”¨æ¥å…³é—­ channel</li>
  <li>closeFuture() ç”¨æ¥å¤„ç† channel çš„å…³é—­
    <ul>
      <li>sync æ–¹æ³•ä½œç”¨æ˜¯åŒæ­¥ç­‰å¾… channel å…³é—­</li>
      <li>è€Œ addListener æ–¹æ³•æ˜¯å¼‚æ­¥ç­‰å¾… channel å…³é—­</li>
    </ul>
  </li>
  <li>pipeline() æ–¹æ³•æ·»åŠ å¤„ç†å™¨</li>
  <li>write() æ–¹æ³•å°†æ•°æ®å†™å…¥</li>
  <li>writeAndFlush() æ–¹æ³•å°†æ•°æ®å†™å…¥å¹¶åˆ·å‡º</li>
</ul>

<h4 id="channelfuture-1">ChannelFuture</h4>

<p>è¿™æ—¶åˆšæ‰çš„å®¢æˆ·ç«¯ä»£ç </p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="k">new</span> <span class="nc">Bootstrap</span><span class="o">()</span>
    <span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">())</span>
    <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">Channel</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">Channel</span> <span class="n">ch</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">StringEncoder</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">})</span>
    <span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="s">"127.0.0.1"</span><span class="o">,</span> <span class="mi">8080</span><span class="o">)</span>
    <span class="o">.</span><span class="na">sync</span><span class="o">()</span>
    <span class="o">.</span><span class="na">channel</span><span class="o">()</span>
    <span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">()</span> <span class="o">+</span> <span class="s">": hello world!"</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç°åœ¨æŠŠå®ƒæ‹†å¼€æ¥çœ‹</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="nc">ChannelFuture</span> <span class="n">channelFuture</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Bootstrap</span><span class="o">()</span>
    <span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">())</span>
    <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">Channel</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">Channel</span> <span class="n">ch</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">StringEncoder</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">})</span>
    <span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="s">"127.0.0.1"</span><span class="o">,</span> <span class="mi">8080</span><span class="o">);</span> <span class="c1">// 1</span>

<span class="n">channelFuture</span><span class="o">.</span><span class="na">sync</span><span class="o">().</span><span class="na">channel</span><span class="o">().</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">()</span> <span class="o">+</span> <span class="s">": hello world!"</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>1 å¤„è¿”å›çš„æ˜¯ ChannelFuture å¯¹è±¡ï¼Œå®ƒçš„ä½œç”¨æ˜¯åˆ©ç”¨ channel() æ–¹æ³•æ¥è·å– Channel å¯¹è±¡</li>
</ul>

<p><strong>æ³¨æ„</strong> connect æ–¹æ³•æ˜¯å¼‚æ­¥çš„ï¼Œæ„å‘³ç€ä¸ç­‰è¿æ¥å»ºç«‹ï¼Œæ–¹æ³•æ‰§è¡Œå°±è¿”å›äº†ã€‚å› æ­¤ channelFuture å¯¹è±¡ä¸­ä¸èƒ½ã€ç«‹åˆ»ã€‘è·å¾—åˆ°æ­£ç¡®çš„ Channel å¯¹è±¡</p>

<p>å®éªŒå¦‚ä¸‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="nc">ChannelFuture</span> <span class="n">channelFuture</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Bootstrap</span><span class="o">()</span>
    <span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">())</span>
    <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">Channel</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">Channel</span> <span class="n">ch</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">StringEncoder</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">})</span>
    <span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="s">"127.0.0.1"</span><span class="o">,</span> <span class="mi">8080</span><span class="o">);</span>

<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">channelFuture</span><span class="o">.</span><span class="na">channel</span><span class="o">());</span> <span class="c1">// 1</span>
<span class="n">channelFuture</span><span class="o">.</span><span class="na">sync</span><span class="o">();</span> <span class="c1">// 2</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">channelFuture</span><span class="o">.</span><span class="na">channel</span><span class="o">());</span> <span class="c1">// 3</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>æ‰§è¡Œåˆ° 1 æ—¶ï¼Œè¿æ¥æœªå»ºç«‹ï¼Œæ‰“å° <code class="language-plaintext highlighter-rouge">[id: 0x2e1884dd]</code></li>
  <li>æ‰§è¡Œåˆ° 2 æ—¶ï¼Œsync æ–¹æ³•æ˜¯åŒæ­¥ç­‰å¾…è¿æ¥å»ºç«‹å®Œæˆ</li>
  <li>æ‰§è¡Œåˆ° 3 æ—¶ï¼Œè¿æ¥è‚¯å®šå»ºç«‹äº†ï¼Œæ‰“å° <code class="language-plaintext highlighter-rouge">[id: 0x2e1884dd, L:/127.0.0.1:57191 - R:/127.0.0.1:8080]</code></li>
</ul>

<p>é™¤äº†ç”¨ sync æ–¹æ³•å¯ä»¥è®©å¼‚æ­¥æ“ä½œåŒæ­¥ä»¥å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨å›è°ƒçš„æ–¹å¼ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="nc">ChannelFuture</span> <span class="n">channelFuture</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Bootstrap</span><span class="o">()</span>
    <span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">())</span>
    <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">Channel</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">Channel</span> <span class="n">ch</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">StringEncoder</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">})</span>
    <span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="s">"127.0.0.1"</span><span class="o">,</span> <span class="mi">8080</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">channelFuture</span><span class="o">.</span><span class="na">channel</span><span class="o">());</span> <span class="c1">// 1</span>
<span class="n">channelFuture</span><span class="o">.</span><span class="na">addListener</span><span class="o">((</span><span class="nc">ChannelFutureListener</span><span class="o">)</span> <span class="n">future</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">future</span><span class="o">.</span><span class="na">channel</span><span class="o">());</span> <span class="c1">// 2</span>
<span class="o">});</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>æ‰§è¡Œåˆ° 1 æ—¶ï¼Œè¿æ¥æœªå»ºç«‹ï¼Œæ‰“å° <code class="language-plaintext highlighter-rouge">[id: 0x749124ba]</code></li>
  <li>ChannelFutureListener ä¼šåœ¨è¿æ¥å»ºç«‹æ—¶è¢«è°ƒç”¨ï¼ˆå…¶ä¸­ operationComplete æ–¹æ³•ï¼‰ï¼Œå› æ­¤æ‰§è¡Œåˆ° 2 æ—¶ï¼Œè¿æ¥è‚¯å®šå»ºç«‹äº†ï¼Œæ‰“å° <code class="language-plaintext highlighter-rouge">[id: 0x749124ba, L:/127.0.0.1:57351 - R:/127.0.0.1:8080]</code></li>
</ul>

<h4 id="closefuture-1">CloseFuture</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre></td><td class="rouge-code"><pre><span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CloseFutureClient</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">NioEventLoopGroup</span> <span class="n">group</span> <span class="k">new</span> <span class="nf">NioEventLoopGroup</span><span class="o">();</span>
        <span class="nc">ChannelFuture</span> <span class="n">channelFuture</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Bootstrap</span><span class="o">()</span>
                <span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">group</span><span class="o">)</span>
                <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">NioSocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
                    <span class="nd">@Override</span> <span class="c1">// åœ¨è¿æ¥å»ºç«‹åè¢«è°ƒç”¨</span>
                    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">NioSocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                        <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">LoggingHandler</span><span class="o">(</span><span class="nc">LogLevel</span><span class="o">.</span><span class="na">DEBUG</span><span class="o">));</span>
                        <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">StringEncoder</span><span class="o">());</span>
                    <span class="o">}</span>
                <span class="o">})</span>
                <span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="mi">8080</span><span class="o">));</span>
        <span class="nc">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">channelFuture</span><span class="o">.</span><span class="na">sync</span><span class="o">().</span><span class="na">channel</span><span class="o">();</span>
        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"{}"</span><span class="o">,</span> <span class="n">channel</span><span class="o">);</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()-&gt;{</span>
            <span class="nc">Scanner</span> <span class="n">scanner</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Scanner</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">in</span><span class="o">);</span>
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">String</span> <span class="n">line</span> <span class="o">=</span> <span class="n">scanner</span><span class="o">.</span><span class="na">nextLine</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="s">"q"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">line</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">channel</span><span class="o">.</span><span class="na">close</span><span class="o">();</span> <span class="c1">// close å¼‚æ­¥æ“ä½œ 1s ä¹‹å</span>
<span class="c1">//                    log.debug("å¤„ç†å…³é—­ä¹‹åçš„æ“ä½œ"); // ä¸èƒ½åœ¨è¿™é‡Œå–„å</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="n">channel</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">line</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">},</span> <span class="s">"input"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>

        <span class="c1">// è·å– CloseFuture å¯¹è±¡ï¼Œ 1) åŒæ­¥å¤„ç†å…³é—­ï¼Œ 2) å¼‚æ­¥å¤„ç†å…³é—­</span>
        <span class="nc">ChannelFuture</span> <span class="n">closeFuture</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="na">closeFuture</span><span class="o">();</span>
        <span class="cm">/*log.debug("waiting close...");
        closeFuture.sync();
        log.debug("å¤„ç†å…³é—­ä¹‹åçš„æ“ä½œ");*/</span>
        <span class="n">closeFuture</span><span class="o">.</span><span class="na">addListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelFutureListener</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">operationComplete</span><span class="o">(</span><span class="nc">ChannelFuture</span> <span class="n">future</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"å¤„ç†å…³é—­ä¹‹åçš„æ“ä½œ"</span><span class="o">);</span>
                <span class="n">group</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="-å¼‚æ­¥æå‡çš„æ˜¯ä»€ä¹ˆ-1">ğŸ’¡ å¼‚æ­¥æå‡çš„æ˜¯ä»€ä¹ˆ</h4>

<ul>
  <li>
    <p>æœ‰äº›åŒå­¦çœ‹åˆ°è¿™é‡Œä¼šæœ‰ç–‘é—®ï¼šä¸ºä»€ä¹ˆä¸åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­å»æ‰§è¡Œå»ºç«‹è¿æ¥ã€å»æ‰§è¡Œå…³é—­ channelï¼Œé‚£æ ·ä¸æ˜¯ä¹Ÿå¯ä»¥å—ï¼Ÿéè¦ç”¨è¿™ä¹ˆå¤æ‚çš„å¼‚æ­¥æ–¹å¼ï¼šæ¯”å¦‚ä¸€ä¸ªçº¿ç¨‹å‘èµ·å»ºç«‹è¿æ¥ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å»çœŸæ­£å»ºç«‹è¿æ¥</p>
  </li>
  <li>
    <p>è¿˜æœ‰åŒå­¦ä¼šç¬¼ç»Ÿåœ°å›ç­”ï¼Œå› ä¸º netty å¼‚æ­¥æ–¹å¼ç”¨äº†å¤šçº¿ç¨‹ã€å¤šçº¿ç¨‹å°±æ•ˆç‡é«˜ã€‚å…¶å®è¿™äº›è®¤è¯†éƒ½æ¯”è¾ƒç‰‡é¢ï¼Œå¤šçº¿ç¨‹å’Œå¼‚æ­¥æ‰€æå‡çš„æ•ˆç‡å¹¶ä¸æ˜¯æ‰€è®¤ä¸ºçš„</p>
  </li>
</ul>

<p>æ€è€ƒä¸‹é¢çš„åœºæ™¯ï¼Œ4 ä¸ªåŒ»ç”Ÿç»™äººçœ‹ç—…ï¼Œæ¯ä¸ªç—…äººèŠ±è´¹ 20 åˆ†é’Ÿï¼Œè€Œä¸”åŒ»ç”Ÿçœ‹ç—…çš„è¿‡ç¨‹ä¸­æ˜¯ä»¥ç—…äººä¸ºå•ä½çš„ï¼Œä¸€ä¸ªç—…äººçœ‹å®Œäº†ï¼Œæ‰èƒ½çœ‹ä¸‹ä¸€ä¸ªç—…äººã€‚å‡è®¾ç—…äººæºæºä¸æ–­åœ°æ¥ï¼Œå¯ä»¥è®¡ç®—ä¸€ä¸‹ 4 ä¸ªåŒ»ç”Ÿä¸€å¤©å·¥ä½œ 8 å°æ—¶ï¼Œå¤„ç†çš„ç—…äººæ€»æ•°æ˜¯ï¼š<code class="language-plaintext highlighter-rouge">4 * 8 * 3 = 96</code></p>

<p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0044.png" alt="" /></p>

<p>ç»ç ”ç©¶å‘ç°ï¼Œçœ‹ç—…å¯ä»¥ç»†åˆ†ä¸ºå››ä¸ªæ­¥éª¤ï¼Œç»æ‹†åˆ†åæ¯ä¸ªæ­¥éª¤éœ€è¦ 5 åˆ†é’Ÿï¼Œå¦‚ä¸‹</p>

<p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0048.png" alt="" /></p>

<p>å› æ­¤å¯ä»¥åšå¦‚ä¸‹ä¼˜åŒ–ï¼Œåªæœ‰ä¸€å¼€å§‹ï¼ŒåŒ»ç”Ÿ 2ã€3ã€4 åˆ†åˆ«è¦ç­‰å¾… 5ã€10ã€15 åˆ†é’Ÿæ‰èƒ½æ‰§è¡Œå·¥ä½œï¼Œä½†åªè¦åç»­ç—…äººæºæºä¸æ–­åœ°æ¥ï¼Œä»–ä»¬å°±èƒ½å¤Ÿæ»¡è´Ÿè·å·¥ä½œï¼Œå¹¶ä¸”å¤„ç†ç—…äººçš„èƒ½åŠ›æé«˜åˆ°äº† <code class="language-plaintext highlighter-rouge">4 * 8 * 12</code> æ•ˆç‡å‡ ä¹æ˜¯åŸæ¥çš„å››å€</p>

<p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0047.png" alt="" /></p>

<p>è¦ç‚¹</p>

<ul>
  <li>å•çº¿ç¨‹æ²¡æ³•å¼‚æ­¥æé«˜æ•ˆç‡ï¼Œå¿…é¡»é…åˆå¤šçº¿ç¨‹ã€å¤šæ ¸ cpu æ‰èƒ½å‘æŒ¥å¼‚æ­¥çš„ä¼˜åŠ¿</li>
  <li>å¼‚æ­¥å¹¶æ²¡æœ‰ç¼©çŸ­å“åº”æ—¶é—´ï¼Œåè€Œæœ‰æ‰€å¢åŠ </li>
  <li>åˆç†è¿›è¡Œä»»åŠ¡æ‹†åˆ†ï¼Œä¹Ÿæ˜¯åˆ©ç”¨å¼‚æ­¥çš„å…³é”®</li>
</ul>

<h3 id="33-future--promise-1">3.3 Future &amp; Promise</h3>

<p>åœ¨å¼‚æ­¥å¤„ç†æ—¶ï¼Œç»å¸¸ç”¨åˆ°è¿™ä¸¤ä¸ªæ¥å£</p>

<p>é¦–å…ˆè¦è¯´æ˜ netty ä¸­çš„ Future ä¸ jdk ä¸­çš„ Future åŒåï¼Œä½†æ˜¯æ˜¯ä¸¤ä¸ªæ¥å£ï¼Œnetty çš„ Future ç»§æ‰¿è‡ª jdk çš„ Futureï¼Œè€Œ Promise åˆå¯¹ netty Future è¿›è¡Œäº†æ‰©å±•</p>

<ul>
  <li>jdk Future åªèƒ½åŒæ­¥ç­‰å¾…ä»»åŠ¡ç»“æŸï¼ˆæˆ–æˆåŠŸã€æˆ–å¤±è´¥ï¼‰æ‰èƒ½å¾—åˆ°ç»“æœ</li>
  <li>netty Future å¯ä»¥åŒæ­¥ç­‰å¾…ä»»åŠ¡ç»“æŸå¾—åˆ°ç»“æœï¼Œä¹Ÿå¯ä»¥å¼‚æ­¥æ–¹å¼å¾—åˆ°ç»“æœï¼Œä½†éƒ½æ˜¯è¦ç­‰ä»»åŠ¡ç»“æŸ</li>
  <li>netty Promise ä¸ä»…æœ‰ netty Future çš„åŠŸèƒ½ï¼Œè€Œä¸”è„±ç¦»äº†ä»»åŠ¡ç‹¬ç«‹å­˜åœ¨ï¼Œåªä½œä¸ºä¸¤ä¸ªçº¿ç¨‹é—´ä¼ é€’ç»“æœçš„å®¹å™¨</li>
</ul>

<table>
  <thead>
    <tr>
      <th>åŠŸèƒ½/åç§°</th>
      <th>jdk Future</th>
      <th>netty Future</th>
      <th>Promise</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>cancel</td>
      <td>å–æ¶ˆä»»åŠ¡</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <td>isCanceled</td>
      <td>ä»»åŠ¡æ˜¯å¦å–æ¶ˆ</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <td>isDone</td>
      <td>ä»»åŠ¡æ˜¯å¦å®Œæˆï¼Œä¸èƒ½åŒºåˆ†æˆåŠŸå¤±è´¥</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <td>get</td>
      <td>è·å–ä»»åŠ¡ç»“æœï¼Œé˜»å¡ç­‰å¾…</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <td>getNow</td>
      <td>-</td>
      <td>è·å–ä»»åŠ¡ç»“æœï¼Œéé˜»å¡ï¼Œè¿˜æœªäº§ç”Ÿç»“æœæ—¶è¿”å› null</td>
      <td>-</td>
    </tr>
    <tr>
      <td>await</td>
      <td>-</td>
      <td>ç­‰å¾…ä»»åŠ¡ç»“æŸï¼Œå¦‚æœä»»åŠ¡å¤±è´¥ï¼Œä¸ä¼šæŠ›å¼‚å¸¸ï¼Œè€Œæ˜¯é€šè¿‡ isSuccess åˆ¤æ–­</td>
      <td>-</td>
    </tr>
    <tr>
      <td>sync</td>
      <td>-</td>
      <td>ç­‰å¾…ä»»åŠ¡ç»“æŸï¼Œå¦‚æœä»»åŠ¡å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸</td>
      <td>-</td>
    </tr>
    <tr>
      <td>isSuccess</td>
      <td>-</td>
      <td>åˆ¤æ–­ä»»åŠ¡æ˜¯å¦æˆåŠŸ</td>
      <td>-</td>
    </tr>
    <tr>
      <td>cause</td>
      <td>-</td>
      <td>è·å–å¤±è´¥ä¿¡æ¯ï¼Œéé˜»å¡ï¼Œå¦‚æœæ²¡æœ‰å¤±è´¥ï¼Œè¿”å›null</td>
      <td>-</td>
    </tr>
    <tr>
      <td>addLinstener</td>
      <td>-</td>
      <td>æ·»åŠ å›è°ƒï¼Œå¼‚æ­¥æ¥æ”¶ç»“æœ</td>
      <td>-</td>
    </tr>
    <tr>
      <td>setSuccess</td>
      <td>-</td>
      <td>-</td>
      <td>è®¾ç½®æˆåŠŸç»“æœ</td>
    </tr>
    <tr>
      <td>setFailure</td>
      <td>-</td>
      <td>-</td>
      <td>è®¾ç½®å¤±è´¥ç»“æœ</td>
    </tr>
  </tbody>
</table>

<h4 id="ä¾‹1-1">ä¾‹1</h4>

<p>åŒæ­¥å¤„ç†ä»»åŠ¡æˆåŠŸ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="nc">DefaultEventLoop</span> <span class="n">eventExecutors</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultEventLoop</span><span class="o">();</span>
<span class="nc">DefaultPromise</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">promise</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultPromise</span><span class="o">&lt;&gt;(</span><span class="n">eventExecutors</span><span class="o">);</span>

<span class="n">eventExecutors</span><span class="o">.</span><span class="na">execute</span><span class="o">(()-&gt;{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"set success, {}"</span><span class="o">,</span><span class="mi">10</span><span class="o">);</span>
    <span class="n">promise</span><span class="o">.</span><span class="na">setSuccess</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
<span class="o">});</span>

<span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"start..."</span><span class="o">);</span>
<span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"{}"</span><span class="o">,</span><span class="n">promise</span><span class="o">.</span><span class="na">getNow</span><span class="o">());</span> <span class="c1">// è¿˜æ²¡æœ‰ç»“æœ</span>
<span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"{}"</span><span class="o">,</span><span class="n">promise</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>11:51:53 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - start...
11:51:53 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - null
11:51:54 [DEBUG] [defaultEventLoop-1-1] c.i.o.DefaultPromiseTest2 - set success, 10
11:51:54 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - 10
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="ä¾‹2-1">ä¾‹2</h4>

<p>å¼‚æ­¥å¤„ç†ä»»åŠ¡æˆåŠŸ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="nc">DefaultEventLoop</span> <span class="n">eventExecutors</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultEventLoop</span><span class="o">();</span>
<span class="nc">DefaultPromise</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">promise</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultPromise</span><span class="o">&lt;&gt;(</span><span class="n">eventExecutors</span><span class="o">);</span>

<span class="c1">// è®¾ç½®å›è°ƒï¼Œå¼‚æ­¥æ¥æ”¶ç»“æœ</span>
<span class="n">promise</span><span class="o">.</span><span class="na">addListener</span><span class="o">(</span><span class="n">future</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="c1">// è¿™é‡Œçš„ future å°±æ˜¯ä¸Šé¢çš„ promise</span>
    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"{}"</span><span class="o">,</span><span class="n">future</span><span class="o">.</span><span class="na">getNow</span><span class="o">());</span>
<span class="o">});</span>

<span class="c1">// ç­‰å¾… 1000 åè®¾ç½®æˆåŠŸç»“æœ</span>
<span class="n">eventExecutors</span><span class="o">.</span><span class="na">execute</span><span class="o">(()-&gt;{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"set success, {}"</span><span class="o">,</span><span class="mi">10</span><span class="o">);</span>
    <span class="n">promise</span><span class="o">.</span><span class="na">setSuccess</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
<span class="o">});</span>

<span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"start..."</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>11:49:30 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - start...
11:49:31 [DEBUG] [defaultEventLoop-1-1] c.i.o.DefaultPromiseTest2 - set success, 10
11:49:31 [DEBUG] [defaultEventLoop-1-1] c.i.o.DefaultPromiseTest2 - 10
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="ä¾‹3-1">ä¾‹3</h4>

<p>åŒæ­¥å¤„ç†ä»»åŠ¡å¤±è´¥ - sync &amp; get</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="nc">DefaultEventLoop</span> <span class="n">eventExecutors</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultEventLoop</span><span class="o">();</span>
        <span class="nc">DefaultPromise</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">promise</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultPromise</span><span class="o">&lt;&gt;(</span><span class="n">eventExecutors</span><span class="o">);</span>

        <span class="n">eventExecutors</span><span class="o">.</span><span class="na">execute</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="nc">RuntimeException</span> <span class="n">e</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RuntimeException</span><span class="o">(</span><span class="s">"error..."</span><span class="o">);</span>
            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"set failure, {}"</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
            <span class="n">promise</span><span class="o">.</span><span class="na">setFailure</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">});</span>

        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"start..."</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"{}"</span><span class="o">,</span> <span class="n">promise</span><span class="o">.</span><span class="na">getNow</span><span class="o">());</span>
        <span class="n">promise</span><span class="o">.</span><span class="na">get</span><span class="o">();</span> <span class="c1">// sync() ä¹Ÿä¼šå‡ºç°å¼‚å¸¸ï¼Œåªæ˜¯ get ä¼šå†ç”¨ ExecutionException åŒ…ä¸€å±‚å¼‚å¸¸</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre>12:11:07 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - start...
12:11:07 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - null
12:11:08 [DEBUG] [defaultEventLoop-1-1] c.i.o.DefaultPromiseTest2 - set failure, java.lang.RuntimeException: error...
Exception in thread "main" java.util.concurrent.ExecutionException: java.lang.RuntimeException: error...
	at io.netty.util.concurrent.AbstractFuture.get(AbstractFuture.java:41)
	at com.itcast.oio.DefaultPromiseTest2.main(DefaultPromiseTest2.java:34)
Caused by: java.lang.RuntimeException: error...
	at com.itcast.oio.DefaultPromiseTest2.lambda$main$0(DefaultPromiseTest2.java:27)
	at io.netty.channel.DefaultEventLoop.run(DefaultEventLoop.java:54)
	at io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:918)
	at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)
	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
	at java.lang.Thread.run(Thread.java:745)
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="ä¾‹4-1">ä¾‹4</h4>

<p>åŒæ­¥å¤„ç†ä»»åŠ¡å¤±è´¥ - await</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="nc">DefaultEventLoop</span> <span class="n">eventExecutors</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultEventLoop</span><span class="o">();</span>
<span class="nc">DefaultPromise</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">promise</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultPromise</span><span class="o">&lt;&gt;(</span><span class="n">eventExecutors</span><span class="o">);</span>

<span class="n">eventExecutors</span><span class="o">.</span><span class="na">execute</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="nc">RuntimeException</span> <span class="n">e</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RuntimeException</span><span class="o">(</span><span class="s">"error..."</span><span class="o">);</span>
    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"set failure, {}"</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
    <span class="n">promise</span><span class="o">.</span><span class="na">setFailure</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
<span class="o">});</span>

<span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"start..."</span><span class="o">);</span>
<span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"{}"</span><span class="o">,</span> <span class="n">promise</span><span class="o">.</span><span class="na">getNow</span><span class="o">());</span>
<span class="n">promise</span><span class="o">.</span><span class="na">await</span><span class="o">();</span> <span class="c1">// ä¸ sync å’Œ get åŒºåˆ«åœ¨äºï¼Œä¸ä¼šæŠ›å¼‚å¸¸</span>
<span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"result {}"</span><span class="o">,</span> <span class="o">(</span><span class="n">promise</span><span class="o">.</span><span class="na">isSuccess</span><span class="o">()</span> <span class="o">?</span> <span class="n">promise</span><span class="o">.</span><span class="na">getNow</span><span class="o">()</span> <span class="o">:</span> <span class="n">promise</span><span class="o">.</span><span class="na">cause</span><span class="o">()).</span><span class="na">toString</span><span class="o">());</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>12:18:53 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - start...
12:18:53 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - null
12:18:54 [DEBUG] [defaultEventLoop-1-1] c.i.o.DefaultPromiseTest2 - set failure, java.lang.RuntimeException: error...
12:18:54 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - result java.lang.RuntimeException: error...
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="ä¾‹5-1">ä¾‹5</h4>

<p>å¼‚æ­¥å¤„ç†ä»»åŠ¡å¤±è´¥</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="nc">DefaultEventLoop</span> <span class="n">eventExecutors</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultEventLoop</span><span class="o">();</span>
<span class="nc">DefaultPromise</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">promise</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultPromise</span><span class="o">&lt;&gt;(</span><span class="n">eventExecutors</span><span class="o">);</span>

<span class="n">promise</span><span class="o">.</span><span class="na">addListener</span><span class="o">(</span><span class="n">future</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"result {}"</span><span class="o">,</span> <span class="o">(</span><span class="n">promise</span><span class="o">.</span><span class="na">isSuccess</span><span class="o">()</span> <span class="o">?</span> <span class="n">promise</span><span class="o">.</span><span class="na">getNow</span><span class="o">()</span> <span class="o">:</span> <span class="n">promise</span><span class="o">.</span><span class="na">cause</span><span class="o">()).</span><span class="na">toString</span><span class="o">());</span>
<span class="o">});</span>

<span class="n">eventExecutors</span><span class="o">.</span><span class="na">execute</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="nc">RuntimeException</span> <span class="n">e</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RuntimeException</span><span class="o">(</span><span class="s">"error..."</span><span class="o">);</span>
    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"set failure, {}"</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
    <span class="n">promise</span><span class="o">.</span><span class="na">setFailure</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
<span class="o">});</span>

<span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"start..."</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>12:04:57 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - start...
12:04:58 [DEBUG] [defaultEventLoop-1-1] c.i.o.DefaultPromiseTest2 - set failure, java.lang.RuntimeException: error...
12:04:58 [DEBUG] [defaultEventLoop-1-1] c.i.o.DefaultPromiseTest2 - result java.lang.RuntimeException: error...
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="ä¾‹6-1">ä¾‹6</h4>

<p>await æ­»é”æ£€æŸ¥</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="nc">DefaultEventLoop</span> <span class="n">eventExecutors</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultEventLoop</span><span class="o">();</span>
<span class="nc">DefaultPromise</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">promise</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultPromise</span><span class="o">&lt;&gt;(</span><span class="n">eventExecutors</span><span class="o">);</span>

<span class="n">eventExecutors</span><span class="o">.</span><span class="na">submit</span><span class="o">(()-&gt;{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"1"</span><span class="o">);</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">promise</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
        <span class="c1">// æ³¨æ„ä¸èƒ½ä»…æ•è· InterruptedException å¼‚å¸¸</span>
        <span class="c1">// å¦åˆ™ æ­»é”æ£€æŸ¥æŠ›å‡ºçš„ BlockingOperationException ä¼šç»§ç»­å‘ä¸Šä¼ æ’­</span>
        <span class="c1">// è€Œæäº¤çš„ä»»åŠ¡ä¼šè¢«åŒ…è£…ä¸º PromiseTaskï¼Œå®ƒçš„ run æ–¹æ³•ä¸­ä¼š catch æ‰€æœ‰å¼‚å¸¸ç„¶åè®¾ç½®ä¸º Promise çš„å¤±è´¥ç»“æœè€Œä¸ä¼šæŠ›å‡º</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span> 
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"2"</span><span class="o">);</span>
<span class="o">});</span>
<span class="n">eventExecutors</span><span class="o">.</span><span class="na">submit</span><span class="o">(()-&gt;{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"3"</span><span class="o">);</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">promise</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"4"</span><span class="o">);</span>
<span class="o">});</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre>1
2
3
4
io.netty.util.concurrent.BlockingOperationException: DefaultPromise@47499c2a(incomplete)
	at io.netty.util.concurrent.DefaultPromise.checkDeadLock(DefaultPromise.java:384)
	at io.netty.util.concurrent.DefaultPromise.await(DefaultPromise.java:212)
	at com.itcast.oio.DefaultPromiseTest.lambda$main$0(DefaultPromiseTest.java:27)
	at io.netty.util.concurrent.PromiseTask$RunnableAdapter.call(PromiseTask.java:38)
	at io.netty.util.concurrent.PromiseTask.run(PromiseTask.java:73)
	at io.netty.channel.DefaultEventLoop.run(DefaultEventLoop.java:54)
	at io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:918)
	at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)
	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
	at java.lang.Thread.run(Thread.java:745)
io.netty.util.concurrent.BlockingOperationException: DefaultPromise@47499c2a(incomplete)
	at io.netty.util.concurrent.DefaultPromise.checkDeadLock(DefaultPromise.java:384)
	at io.netty.util.concurrent.DefaultPromise.await(DefaultPromise.java:212)
	at com.itcast.oio.DefaultPromiseTest.lambda$main$1(DefaultPromiseTest.java:36)
	at io.netty.util.concurrent.PromiseTask$RunnableAdapter.call(PromiseTask.java:38)
	at io.netty.util.concurrent.PromiseTask.run(PromiseTask.java:73)
	at io.netty.channel.DefaultEventLoop.run(DefaultEventLoop.java:54)
	at io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:918)
	at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)
	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
	at java.lang.Thread.run(Thread.java:745)

</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="34-handler--pipeline-1">3.4 Handler &amp; Pipeline</h3>

<p>ChannelHandler ç”¨æ¥å¤„ç† Channel ä¸Šçš„å„ç§äº‹ä»¶ï¼Œåˆ†ä¸ºå…¥ç«™ã€å‡ºç«™ä¸¤ç§ã€‚æ‰€æœ‰ ChannelHandler è¢«è¿æˆä¸€ä¸²ï¼Œå°±æ˜¯ Pipeline</p>

<ul>
  <li>å…¥ç«™å¤„ç†å™¨é€šå¸¸æ˜¯ ChannelInboundHandlerAdapter çš„å­ç±»ï¼Œä¸»è¦ç”¨æ¥è¯»å–å®¢æˆ·ç«¯æ•°æ®ï¼Œå†™å›ç»“æœ</li>
  <li>å‡ºç«™å¤„ç†å™¨é€šå¸¸æ˜¯ ChannelOutboundHandlerAdapter çš„å­ç±»ï¼Œä¸»è¦å¯¹å†™å›ç»“æœè¿›è¡ŒåŠ å·¥</li>
</ul>

<p>æ‰“ä¸ªæ¯”å–»ï¼Œæ¯ä¸ª Channel æ˜¯ä¸€ä¸ªäº§å“çš„åŠ å·¥è½¦é—´ï¼ŒPipeline æ˜¯è½¦é—´ä¸­çš„æµæ°´çº¿ï¼ŒChannelHandler å°±æ˜¯æµæ°´çº¿ä¸Šçš„å„é“å·¥åºï¼Œè€Œåé¢è¦è®²çš„ ByteBuf æ˜¯åŸææ–™ï¼Œç»è¿‡å¾ˆå¤šå·¥åºçš„åŠ å·¥ï¼šå…ˆç»è¿‡ä¸€é“é“å…¥ç«™å·¥åºï¼Œå†ç»è¿‡ä¸€é“é“å‡ºç«™å·¥åºæœ€ç»ˆå˜æˆäº§å“</p>

<p>å…ˆææ¸…æ¥šé¡ºåºï¼ŒæœåŠ¡ç«¯</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
</pre></td><td class="rouge-code"><pre><span class="k">new</span> <span class="nc">ServerBootstrap</span><span class="o">()</span>
    <span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">())</span>
    <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">NioSocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">NioSocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInboundHandlerAdapter</span><span class="o">(){</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                    <span class="n">ctx</span><span class="o">.</span><span class="na">fireChannelRead</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span> <span class="c1">// 1</span>
                <span class="o">}</span>
            <span class="o">});</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInboundHandlerAdapter</span><span class="o">(){</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
                    <span class="n">ctx</span><span class="o">.</span><span class="na">fireChannelRead</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span> <span class="c1">// 2</span>
                <span class="o">}</span>
            <span class="o">});</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInboundHandlerAdapter</span><span class="o">(){</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>
                    <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span> <span class="c1">// 3</span>
                <span class="o">}</span>
            <span class="o">});</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelOutboundHandlerAdapter</span><span class="o">(){</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">msg</span><span class="o">,</span> 
                                  <span class="nc">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="mi">4</span><span class="o">);</span>
                    <span class="n">ctx</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span> <span class="c1">// 4</span>
                <span class="o">}</span>
            <span class="o">});</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelOutboundHandlerAdapter</span><span class="o">(){</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">msg</span><span class="o">,</span> 
                                  <span class="nc">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
                    <span class="n">ctx</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span> <span class="c1">// 5</span>
                <span class="o">}</span>
            <span class="o">});</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelOutboundHandlerAdapter</span><span class="o">(){</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">msg</span><span class="o">,</span> 
                                  <span class="nc">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="mi">6</span><span class="o">);</span>
                    <span class="n">ctx</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span> <span class="c1">// 6</span>
                <span class="o">}</span>
            <span class="o">});</span>
        <span class="o">}</span>
    <span class="o">})</span>
    <span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="mi">8080</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å®¢æˆ·ç«¯</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="k">new</span> <span class="nc">Bootstrap</span><span class="o">()</span>
    <span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">())</span>
    <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">Channel</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">Channel</span> <span class="n">ch</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">StringEncoder</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">})</span>
    <span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="s">"127.0.0.1"</span><span class="o">,</span> <span class="mi">8080</span><span class="o">)</span>
    <span class="o">.</span><span class="na">addListener</span><span class="o">((</span><span class="nc">ChannelFutureListener</span><span class="o">)</span> <span class="n">future</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="n">future</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="s">"hello,world"</span><span class="o">);</span>
    <span class="o">});</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æœåŠ¡å™¨ç«¯æ‰“å°ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>1
2
3
6
5
4
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¯ä»¥çœ‹åˆ°ï¼ŒChannelInboundHandlerAdapter æ˜¯æŒ‰ç…§ addLast çš„é¡ºåºæ‰§è¡Œçš„ï¼Œè€Œ ChannelOutboundHandlerAdapter æ˜¯æŒ‰ç…§ addLast çš„é€†åºæ‰§è¡Œçš„ã€‚ChannelPipeline çš„å®ç°æ˜¯ä¸€ä¸ª ChannelHandlerContextï¼ˆåŒ…è£…äº† ChannelHandlerï¼‰ ç»„æˆçš„åŒå‘é“¾è¡¨</p>

<p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0008.png" alt="" /></p>

<ul>
  <li>å…¥ç«™å¤„ç†å™¨ä¸­ï¼Œctx.fireChannelRead(msg) æ˜¯ <strong>è°ƒç”¨ä¸‹ä¸€ä¸ªå…¥ç«™å¤„ç†å™¨</strong>
    <ul>
      <li>å¦‚æœæ³¨é‡Šæ‰ 1 å¤„ä»£ç ï¼Œåˆ™ä»…ä¼šæ‰“å° 1</li>
      <li>å¦‚æœæ³¨é‡Šæ‰ 2 å¤„ä»£ç ï¼Œåˆ™ä»…ä¼šæ‰“å° 1 2</li>
    </ul>
  </li>
  <li>3 å¤„çš„ ctx.channel().write(msg) ä¼š <strong>ä»å°¾éƒ¨å¼€å§‹è§¦å‘</strong> åç»­å‡ºç«™å¤„ç†å™¨çš„æ‰§è¡Œ
    <ul>
      <li>å¦‚æœæ³¨é‡Šæ‰ 3 å¤„ä»£ç ï¼Œåˆ™ä»…ä¼šæ‰“å° 1 2 3</li>
    </ul>
  </li>
  <li>ç±»ä¼¼çš„ï¼Œå‡ºç«™å¤„ç†å™¨ä¸­ï¼Œctx.write(msg, promise) çš„è°ƒç”¨ä¹Ÿä¼š <strong>è§¦å‘ä¸Šä¸€ä¸ªå‡ºç«™å¤„ç†å™¨</strong>
    <ul>
      <li>å¦‚æœæ³¨é‡Šæ‰ 6 å¤„ä»£ç ï¼Œåˆ™ä»…ä¼šæ‰“å° 1 2 3 6</li>
    </ul>
  </li>
  <li>ctx.channel().write(msg) vs ctx.write(msg)
    <ul>
      <li>éƒ½æ˜¯è§¦å‘å‡ºç«™å¤„ç†å™¨çš„æ‰§è¡Œ</li>
      <li>ctx.channel().write(msg) ä»å°¾éƒ¨å¼€å§‹æŸ¥æ‰¾å‡ºç«™å¤„ç†å™¨</li>
      <li>ctx.write(msg) æ˜¯ä»å½“å‰èŠ‚ç‚¹æ‰¾ä¸Šä¸€ä¸ªå‡ºç«™å¤„ç†å™¨</li>
      <li>3 å¤„çš„ ctx.channel().write(msg) å¦‚æœæ”¹ä¸º ctx.write(msg) ä»…ä¼šæ‰“å° 1 2 3ï¼Œå› ä¸ºèŠ‚ç‚¹3 ä¹‹å‰æ²¡æœ‰å…¶å®ƒå‡ºç«™å¤„ç†å™¨äº†</li>
      <li>6 å¤„çš„ ctx.write(msg, promise) å¦‚æœæ”¹ä¸º ctx.channel().write(msg) ä¼šæ‰“å° 1 2 3 6 6 6â€¦ å› ä¸º ctx.channel().write() æ˜¯ä»å°¾éƒ¨å¼€å§‹æŸ¥æ‰¾ï¼Œç»“æœåˆæ˜¯èŠ‚ç‚¹6 è‡ªå·±</li>
    </ul>
  </li>
</ul>

<p>å›¾1 - æœåŠ¡ç«¯ pipeline è§¦å‘çš„åŸå§‹æµç¨‹ï¼Œå›¾ä¸­æ•°å­—ä»£è¡¨äº†å¤„ç†æ­¥éª¤çš„å…ˆåæ¬¡åº</p>

<p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0009.png" alt="" /></p>

<h3 id="35-bytebuf-1">3.5 ByteBuf</h3>

<p>æ˜¯å¯¹å­—èŠ‚æ•°æ®çš„å°è£…</p>

<h4 id="1åˆ›å»º-1">1ï¼‰åˆ›å»º</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nc">ByteBuf</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nc">ByteBufAllocator</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">.</span><span class="na">buffer</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
<span class="n">log</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä¸Šé¢ä»£ç åˆ›å»ºäº†ä¸€ä¸ªé»˜è®¤çš„ ByteBufï¼ˆæ± åŒ–åŸºäºç›´æ¥å†…å­˜çš„ ByteBufï¼‰ï¼Œåˆå§‹å®¹é‡æ˜¯ 10</p>

<p>è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>read index:0 write index:0 capacity:10
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å…¶ä¸­ log æ–¹æ³•å‚è€ƒå¦‚ä¸‹</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">log</span><span class="o">(</span><span class="nc">ByteBuf</span> <span class="n">buffer</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="na">readableBytes</span><span class="o">();</span>
    <span class="kt">int</span> <span class="n">rows</span> <span class="o">=</span> <span class="n">length</span> <span class="o">/</span> <span class="mi">16</span> <span class="o">+</span> <span class="o">(</span><span class="n">length</span> <span class="o">%</span> <span class="mi">15</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="o">)</span> <span class="o">+</span> <span class="mi">4</span><span class="o">;</span>
    <span class="nc">StringBuilder</span> <span class="n">buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">(</span><span class="n">rows</span> <span class="o">*</span> <span class="mi">80</span> <span class="o">*</span> <span class="mi">2</span><span class="o">)</span>
        <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"read index:"</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">readerIndex</span><span class="o">())</span>
        <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">" write index:"</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">writerIndex</span><span class="o">())</span>
        <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">" capacity:"</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">capacity</span><span class="o">())</span>
        <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="no">NEWLINE</span><span class="o">);</span>
    <span class="n">appendPrettyHexDump</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="n">buffer</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="2ç›´æ¥å†…å­˜-vs-å †å†…å­˜-1">2ï¼‰ç›´æ¥å†…å­˜ vs å †å†…å­˜</h4>

<p>å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„ä»£ç æ¥åˆ›å»ºæ± åŒ–åŸºäºå †çš„ ByteBuf</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nc">ByteBuf</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nc">ByteBufAllocator</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">.</span><span class="na">heapBuffer</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„ä»£ç æ¥åˆ›å»ºæ± åŒ–åŸºäºç›´æ¥å†…å­˜çš„ ByteBuf</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nc">ByteBuf</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nc">ByteBufAllocator</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">.</span><span class="na">directBuffer</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>ç›´æ¥å†…å­˜åˆ›å»ºå’Œé”€æ¯çš„ä»£ä»·æ˜‚è´µï¼Œä½†è¯»å†™æ€§èƒ½é«˜ï¼ˆå°‘ä¸€æ¬¡å†…å­˜å¤åˆ¶ï¼‰ï¼Œé€‚åˆé…åˆæ± åŒ–åŠŸèƒ½ä¸€èµ·ç”¨</li>
  <li>ç›´æ¥å†…å­˜å¯¹ GC å‹åŠ›å°ï¼Œå› ä¸ºè¿™éƒ¨åˆ†å†…å­˜ä¸å— JVM åƒåœ¾å›æ”¶çš„ç®¡ç†ï¼Œä½†ä¹Ÿè¦æ³¨æ„åŠæ—¶ä¸»åŠ¨é‡Šæ”¾</li>
</ul>

<h4 id="3æ± åŒ–-vs-éæ± åŒ–-1">3ï¼‰æ± åŒ– vs éæ± åŒ–</h4>

<p>æ± åŒ–çš„æœ€å¤§æ„ä¹‰åœ¨äºå¯ä»¥é‡ç”¨ ByteBufï¼Œä¼˜ç‚¹æœ‰</p>

<ul>
  <li>æ²¡æœ‰æ± åŒ–ï¼Œåˆ™æ¯æ¬¡éƒ½å¾—åˆ›å»ºæ–°çš„ ByteBuf å®ä¾‹ï¼Œè¿™ä¸ªæ“ä½œå¯¹ç›´æ¥å†…å­˜ä»£ä»·æ˜‚è´µï¼Œå°±ç®—æ˜¯å †å†…å­˜ï¼Œä¹Ÿä¼šå¢åŠ  GC å‹åŠ›</li>
  <li>æœ‰äº†æ± åŒ–ï¼Œåˆ™å¯ä»¥é‡ç”¨æ± ä¸­ ByteBuf å®ä¾‹ï¼Œå¹¶ä¸”é‡‡ç”¨äº†ä¸ jemalloc ç±»ä¼¼çš„å†…å­˜åˆ†é…ç®—æ³•æå‡åˆ†é…æ•ˆç‡</li>
  <li>é«˜å¹¶å‘æ—¶ï¼Œæ± åŒ–åŠŸèƒ½æ›´èŠ‚çº¦å†…å­˜ï¼Œå‡å°‘å†…å­˜æº¢å‡ºçš„å¯èƒ½</li>
</ul>

<p>æ± åŒ–åŠŸèƒ½æ˜¯å¦å¼€å¯ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢çš„ç³»ç»Ÿç¯å¢ƒå˜é‡æ¥è®¾ç½®</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="o">-</span><span class="nc">Dio</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">allocator</span><span class="o">.</span><span class="na">type</span><span class="o">={</span><span class="n">unpooled</span><span class="o">|</span><span class="n">pooled</span><span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>4.1 ä»¥åï¼Œé Android å¹³å°é»˜è®¤å¯ç”¨æ± åŒ–å®ç°ï¼ŒAndroid å¹³å°å¯ç”¨éæ± åŒ–å®ç°</li>
  <li>4.1 ä¹‹å‰ï¼Œæ± åŒ–åŠŸèƒ½è¿˜ä¸æˆç†Ÿï¼Œé»˜è®¤æ˜¯éæ± åŒ–å®ç°</li>
</ul>

<h4 id="4ç»„æˆ-1">4ï¼‰ç»„æˆ</h4>

<p>ByteBuf ç”±å››éƒ¨åˆ†ç»„æˆ</p>

<p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0010.png" alt="" /></p>

<p>æœ€å¼€å§‹è¯»å†™æŒ‡é’ˆéƒ½åœ¨ 0 ä½ç½®</p>

<h4 id="5å†™å…¥-1">5ï¼‰å†™å…¥</h4>

<p>æ–¹æ³•åˆ—è¡¨ï¼Œçœç•¥ä¸€äº›ä¸é‡è¦çš„æ–¹æ³•</p>

<table>
  <thead>
    <tr>
      <th>æ–¹æ³•ç­¾å</th>
      <th>å«ä¹‰</th>
      <th>å¤‡æ³¨</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>writeBoolean(boolean value)</td>
      <td>å†™å…¥ boolean å€¼</td>
      <td>ç”¨ä¸€å­—èŠ‚ 01|00 ä»£è¡¨ true|false</td>
    </tr>
    <tr>
      <td>writeByte(int value)</td>
      <td>å†™å…¥ byte å€¼</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>writeShort(int value)</td>
      <td>å†™å…¥ short å€¼</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>writeInt(int value)</td>
      <td>å†™å…¥ int å€¼</td>
      <td>Big Endianï¼Œå³ 0x250ï¼Œå†™å…¥å 00 00 02 50</td>
    </tr>
    <tr>
      <td>writeIntLE(int value)</td>
      <td>å†™å…¥ int å€¼</td>
      <td>Little Endianï¼Œå³ 0x250ï¼Œå†™å…¥å 50 02 00 00</td>
    </tr>
    <tr>
      <td>writeLong(long value)</td>
      <td>å†™å…¥ long å€¼</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>writeChar(int value)</td>
      <td>å†™å…¥ char å€¼</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>writeFloat(float value)</td>
      <td>å†™å…¥ float å€¼</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>writeDouble(double value)</td>
      <td>å†™å…¥ double å€¼</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>writeBytes(ByteBuf src)</td>
      <td>å†™å…¥ netty çš„ ByteBuf</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>writeBytes(byte[] src)</td>
      <td>å†™å…¥ byte[]</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>writeBytes(ByteBuffer src)</td>
      <td>å†™å…¥ nio çš„ ByteBuffer</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>int writeCharSequence(CharSequence sequence, Charset charset)</td>
      <td>å†™å…¥å­—ç¬¦ä¸²</td>
      <td>Â </td>
    </tr>
  </tbody>
</table>

<blockquote>
  <p>æ³¨æ„</p>

  <ul>
    <li>è¿™äº›æ–¹æ³•çš„æœªæŒ‡æ˜è¿”å›å€¼çš„ï¼Œå…¶è¿”å›å€¼éƒ½æ˜¯ ByteBufï¼Œæ„å‘³ç€å¯ä»¥é“¾å¼è°ƒç”¨</li>
    <li>ç½‘ç»œä¼ è¾“ï¼Œé»˜è®¤ä¹ æƒ¯æ˜¯ Big Endian</li>
  </ul>
</blockquote>

<p>å…ˆå†™å…¥ 4 ä¸ªå­—èŠ‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">buffer</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="k">new</span> <span class="kt">byte</span><span class="o">[]{</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">});</span>
<span class="n">log</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç»“æœæ˜¯</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>read index:0 write index:4 capacity:10
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 01 02 03 04                                     |....            |
+--------+-------------------------------------------------+----------------+
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å†å†™å…¥ä¸€ä¸ª int æ•´æ•°ï¼Œä¹Ÿæ˜¯ 4 ä¸ªå­—èŠ‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">buffer</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
<span class="n">log</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç»“æœæ˜¯</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>read index:0 write index:8 capacity:10
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 01 02 03 04 00 00 00 05                         |........        |
+--------+-------------------------------------------------+----------------+
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¿˜æœ‰ä¸€ç±»æ–¹æ³•æ˜¯ set å¼€å¤´çš„ä¸€ç³»åˆ—æ–¹æ³•ï¼Œä¹Ÿå¯ä»¥å†™å…¥æ•°æ®ï¼Œä½†ä¸ä¼šæ”¹å˜å†™æŒ‡é’ˆä½ç½®</p>

<h4 id="6æ‰©å®¹-1">6ï¼‰æ‰©å®¹</h4>

<p>å†å†™å…¥ä¸€ä¸ª int æ•´æ•°æ—¶ï¼Œå®¹é‡ä¸å¤Ÿäº†ï¼ˆåˆå§‹å®¹é‡æ˜¯ 10ï¼‰ï¼Œè¿™æ—¶ä¼šå¼•å‘æ‰©å®¹</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">buffer</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="mi">6</span><span class="o">);</span>
<span class="n">log</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ‰©å®¹è§„åˆ™æ˜¯</p>

<ul>
  <li>å¦‚ä½•å†™å…¥åæ•°æ®å¤§å°æœªè¶…è¿‡ 512ï¼Œåˆ™é€‰æ‹©ä¸‹ä¸€ä¸ª 16 çš„æ•´æ•°å€ï¼Œä¾‹å¦‚å†™å…¥åå¤§å°ä¸º 12 ï¼Œåˆ™æ‰©å®¹å capacity æ˜¯ 16</li>
  <li>å¦‚æœå†™å…¥åæ•°æ®å¤§å°è¶…è¿‡ 512ï¼Œåˆ™é€‰æ‹©ä¸‹ä¸€ä¸ª 2^nï¼Œä¾‹å¦‚å†™å…¥åå¤§å°ä¸º 513ï¼Œåˆ™æ‰©å®¹å capacity æ˜¯ 2^10=1024ï¼ˆ2^9=512 å·²ç»ä¸å¤Ÿäº†ï¼‰</li>
  <li>æ‰©å®¹ä¸èƒ½è¶…è¿‡ max capacity ä¼šæŠ¥é”™</li>
</ul>

<p>ç»“æœæ˜¯</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>read index:0 write index:12 capacity:16
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 01 02 03 04 00 00 00 05 00 00 00 06             |............    |
+--------+-------------------------------------------------+----------------+
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="7è¯»å–-1">7ï¼‰è¯»å–</h4>

<p>ä¾‹å¦‚è¯»äº† 4 æ¬¡ï¼Œæ¯æ¬¡ä¸€ä¸ªå­—èŠ‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">readByte</span><span class="o">());</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">readByte</span><span class="o">());</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">readByte</span><span class="o">());</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">readByte</span><span class="o">());</span>
<span class="n">log</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¯»è¿‡çš„å†…å®¹ï¼Œå°±å±äºåºŸå¼ƒéƒ¨åˆ†äº†ï¼Œå†è¯»åªèƒ½è¯»é‚£äº›å°šæœªè¯»å–çš„éƒ¨åˆ†</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>1
2
3
4
read index:4 write index:12 capacity:16
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 00 00 00 05 00 00 00 06                         |........        |
+--------+-------------------------------------------------+----------------+
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¦‚æœéœ€è¦é‡å¤è¯»å– int æ•´æ•° 5ï¼Œæ€ä¹ˆåŠï¼Ÿ</p>

<p>å¯ä»¥åœ¨ read å‰å…ˆåšä¸ªæ ‡è®° mark</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="n">buffer</span><span class="o">.</span><span class="na">markReaderIndex</span><span class="o">();</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">readInt</span><span class="o">());</span>
<span class="n">log</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç»“æœ</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>5
read index:8 write index:12 capacity:16
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 00 00 00 06                                     |....            |
+--------+-------------------------------------------------+----------------+
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¿™æ—¶è¦é‡å¤è¯»å–çš„è¯ï¼Œé‡ç½®åˆ°æ ‡è®°ä½ç½® reset</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">buffer</span><span class="o">.</span><span class="na">resetReaderIndex</span><span class="o">();</span>
<span class="n">log</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¿™æ—¶</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>read index:4 write index:12 capacity:16
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 00 00 00 05 00 00 00 06                         |........        |
+--------+-------------------------------------------------+----------------+
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¿˜æœ‰ç§åŠæ³•æ˜¯é‡‡ç”¨ get å¼€å¤´çš„ä¸€ç³»åˆ—æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•ä¸ä¼šæ”¹å˜ read index</p>

<h4 id="8retain--release-1">8ï¼‰retain &amp; release</h4>

<p>ç”±äº Netty ä¸­æœ‰å †å¤–å†…å­˜çš„ ByteBuf å®ç°ï¼Œå †å¤–å†…å­˜æœ€å¥½æ˜¯æ‰‹åŠ¨æ¥é‡Šæ”¾ï¼Œè€Œä¸æ˜¯ç­‰ GC åƒåœ¾å›æ”¶ã€‚</p>

<ul>
  <li>UnpooledHeapByteBuf ä½¿ç”¨çš„æ˜¯ JVM å†…å­˜ï¼Œåªéœ€ç­‰ GC å›æ”¶å†…å­˜å³å¯</li>
  <li>UnpooledDirectByteBuf ä½¿ç”¨çš„å°±æ˜¯ç›´æ¥å†…å­˜äº†ï¼Œéœ€è¦ç‰¹æ®Šçš„æ–¹æ³•æ¥å›æ”¶å†…å­˜</li>
  <li>PooledByteBuf å’Œå®ƒçš„å­ç±»ä½¿ç”¨äº†æ± åŒ–æœºåˆ¶ï¼Œéœ€è¦æ›´å¤æ‚çš„è§„åˆ™æ¥å›æ”¶å†…å­˜</li>
</ul>

<blockquote>
  <p>å›æ”¶å†…å­˜çš„æºç å®ç°ï¼Œè¯·å…³æ³¨ä¸‹é¢æ–¹æ³•çš„ä¸åŒå®ç°</p>

  <p><code class="language-plaintext highlighter-rouge">protected abstract void deallocate()</code></p>
</blockquote>

<p>Netty è¿™é‡Œé‡‡ç”¨äº†å¼•ç”¨è®¡æ•°æ³•æ¥æ§åˆ¶å›æ”¶å†…å­˜ï¼Œæ¯ä¸ª ByteBuf éƒ½å®ç°äº† ReferenceCounted æ¥å£</p>

<ul>
  <li>æ¯ä¸ª ByteBuf å¯¹è±¡çš„åˆå§‹è®¡æ•°ä¸º 1</li>
  <li>è°ƒç”¨ release æ–¹æ³•è®¡æ•°å‡ 1ï¼Œå¦‚æœè®¡æ•°ä¸º 0ï¼ŒByteBuf å†…å­˜è¢«å›æ”¶</li>
  <li>è°ƒç”¨ retain æ–¹æ³•è®¡æ•°åŠ  1ï¼Œè¡¨ç¤ºè°ƒç”¨è€…æ²¡ç”¨å®Œä¹‹å‰ï¼Œå…¶å®ƒ handler å³ä½¿è°ƒç”¨äº† release ä¹Ÿä¸ä¼šé€ æˆå›æ”¶</li>
  <li>å½“è®¡æ•°ä¸º 0 æ—¶ï¼Œåº•å±‚å†…å­˜ä¼šè¢«å›æ”¶ï¼Œè¿™æ—¶å³ä½¿ ByteBuf å¯¹è±¡è¿˜åœ¨ï¼Œå…¶å„ä¸ªæ–¹æ³•å‡æ— æ³•æ­£å¸¸ä½¿ç”¨</li>
</ul>

<p>è°æ¥è´Ÿè´£ release å‘¢ï¼Ÿ</p>

<p>ä¸æ˜¯æˆ‘ä»¬æƒ³è±¡çš„ï¼ˆä¸€èˆ¬æƒ…å†µä¸‹ï¼‰</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="nc">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="o">...</span>
<span class="k">try</span> <span class="o">{</span>
    <span class="o">...</span>
<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
    <span class="n">buf</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¯·æ€è€ƒï¼Œå› ä¸º pipeline çš„å­˜åœ¨ï¼Œä¸€èˆ¬éœ€è¦å°† ByteBuf ä¼ é€’ç»™ä¸‹ä¸€ä¸ª ChannelHandlerï¼Œå¦‚æœåœ¨ finally ä¸­ release äº†ï¼Œå°±å¤±å»äº†ä¼ é€’æ€§ï¼ˆå½“ç„¶ï¼Œå¦‚æœåœ¨è¿™ä¸ª ChannelHandler å†…è¿™ä¸ª ByteBuf å·²å®Œæˆäº†å®ƒçš„ä½¿å‘½ï¼Œé‚£ä¹ˆä¾¿æ— é¡»å†ä¼ é€’ï¼‰</p>

<p>åŸºæœ¬è§„åˆ™æ˜¯ï¼Œ<strong>è°æ˜¯æœ€åä½¿ç”¨è€…ï¼Œè°è´Ÿè´£ release</strong>ï¼Œè¯¦ç»†åˆ†æå¦‚ä¸‹</p>

<ul>
  <li>èµ·ç‚¹ï¼Œå¯¹äº NIO å®ç°æ¥è®²ï¼Œåœ¨ io.netty.channel.nio.AbstractNioByteChannel.NioByteUnsafe#read æ–¹æ³•ä¸­é¦–æ¬¡åˆ›å»º ByteBuf æ”¾å…¥ pipelineï¼ˆline 163 pipeline.fireChannelRead(byteBuf)ï¼‰</li>
  <li>å…¥ç«™ ByteBuf å¤„ç†åŸåˆ™
    <ul>
      <li>å¯¹åŸå§‹ ByteBuf ä¸åšå¤„ç†ï¼Œè°ƒç”¨ ctx.fireChannelRead(msg) å‘åä¼ é€’ï¼Œè¿™æ—¶æ— é¡» release</li>
      <li>å°†åŸå§‹ ByteBuf è½¬æ¢ä¸ºå…¶å®ƒç±»å‹çš„ Java å¯¹è±¡ï¼Œè¿™æ—¶ ByteBuf å°±æ²¡ç”¨äº†ï¼Œå¿…é¡» release</li>
      <li>å¦‚æœä¸è°ƒç”¨ ctx.fireChannelRead(msg) å‘åä¼ é€’ï¼Œé‚£ä¹ˆä¹Ÿå¿…é¡» release</li>
      <li>æ³¨æ„å„ç§å¼‚å¸¸ï¼Œå¦‚æœ ByteBuf æ²¡æœ‰æˆåŠŸä¼ é€’åˆ°ä¸‹ä¸€ä¸ª ChannelHandlerï¼Œå¿…é¡» release</li>
      <li>å‡è®¾æ¶ˆæ¯ä¸€ç›´å‘åä¼ ï¼Œé‚£ä¹ˆ TailContext ä¼šè´Ÿè´£é‡Šæ”¾æœªå¤„ç†æ¶ˆæ¯ï¼ˆåŸå§‹çš„ ByteBufï¼‰</li>
    </ul>
  </li>
  <li>å‡ºç«™ ByteBuf å¤„ç†åŸåˆ™
    <ul>
      <li>å‡ºç«™æ¶ˆæ¯æœ€ç»ˆéƒ½ä¼šè½¬ä¸º ByteBuf è¾“å‡ºï¼Œä¸€ç›´å‘å‰ä¼ ï¼Œç”± HeadContext flush å release</li>
    </ul>
  </li>
  <li>å¼‚å¸¸å¤„ç†åŸåˆ™
    <ul>
      <li>æœ‰æ—¶å€™ä¸æ¸…æ¥š ByteBuf è¢«å¼•ç”¨äº†å¤šå°‘æ¬¡ï¼Œä½†åˆå¿…é¡»å½»åº•é‡Šæ”¾ï¼Œå¯ä»¥å¾ªç¯è°ƒç”¨ release ç›´åˆ°è¿”å› true</li>
    </ul>
  </li>
</ul>

<p>TailContext é‡Šæ”¾æœªå¤„ç†æ¶ˆæ¯é€»è¾‘</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="c1">// io.netty.channel.DefaultChannelPipeline#onUnhandledInboundMessage(java.lang.Object)</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onUnhandledInboundMessage</span><span class="o">(</span><span class="nc">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span>
            <span class="s">"Discarded inbound message {} that reached at the tail of the pipeline. "</span> <span class="o">+</span>
            <span class="s">"Please check your pipeline configuration."</span><span class="o">,</span> <span class="n">msg</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="nc">ReferenceCountUtil</span><span class="o">.</span><span class="na">release</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å…·ä½“ä»£ç </p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="c1">// io.netty.util.ReferenceCountUtil#release(java.lang.Object)</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">release</span><span class="o">(</span><span class="nc">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="k">instanceof</span> <span class="nc">ReferenceCounted</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">((</span><span class="nc">ReferenceCounted</span><span class="o">)</span> <span class="n">msg</span><span class="o">).</span><span class="na">release</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="9slice-1">9ï¼‰slice</h4>

<p>ã€é›¶æ‹·è´ã€‘çš„ä½“ç°ä¹‹ä¸€ï¼Œå¯¹åŸå§‹ ByteBuf è¿›è¡Œåˆ‡ç‰‡æˆå¤šä¸ª ByteBufï¼Œåˆ‡ç‰‡åçš„ ByteBuf å¹¶æ²¡æœ‰å‘ç”Ÿå†…å­˜å¤åˆ¶ï¼Œè¿˜æ˜¯ä½¿ç”¨åŸå§‹ ByteBuf çš„å†…å­˜ï¼Œåˆ‡ç‰‡åçš„ ByteBuf ç»´æŠ¤ç‹¬ç«‹çš„ readï¼Œwrite æŒ‡é’ˆ</p>

<p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0011.png" alt="" /></p>

<p>ä¾‹ï¼ŒåŸå§‹ ByteBuf è¿›è¡Œä¸€äº›åˆå§‹æ“ä½œ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nc">ByteBuf</span> <span class="n">origin</span> <span class="o">=</span> <span class="nc">ByteBufAllocator</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">.</span><span class="na">buffer</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
<span class="n">origin</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="k">new</span> <span class="kt">byte</span><span class="o">[]{</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">});</span>
<span class="n">origin</span><span class="o">.</span><span class="na">readByte</span><span class="o">();</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">ByteBufUtil</span><span class="o">.</span><span class="na">prettyHexDump</span><span class="o">(</span><span class="n">origin</span><span class="o">));</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 02 03 04                                        |...             |
+--------+-------------------------------------------------+----------------+
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¿™æ—¶è°ƒç”¨ slice è¿›è¡Œåˆ‡ç‰‡ï¼Œæ— å‚ slice æ˜¯ä»åŸå§‹ ByteBuf çš„ read index åˆ° write index ä¹‹é—´çš„å†…å®¹è¿›è¡Œåˆ‡ç‰‡ï¼Œåˆ‡ç‰‡åçš„ max capacity è¢«å›ºå®šä¸ºè¿™ä¸ªåŒºé—´çš„å¤§å°ï¼Œå› æ­¤ä¸èƒ½è¿½åŠ  write</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nc">ByteBuf</span> <span class="n">slice</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="na">slice</span><span class="o">();</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">ByteBufUtil</span><span class="o">.</span><span class="na">prettyHexDump</span><span class="o">(</span><span class="n">slice</span><span class="o">));</span>
<span class="c1">// slice.writeByte(5); å¦‚æœæ‰§è¡Œï¼Œä¼šæŠ¥ IndexOutOfBoundsException å¼‚å¸¸</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 02 03 04                                        |...             |
+--------+-------------------------------------------------+----------------+
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¦‚æœåŸå§‹ ByteBuf å†æ¬¡è¯»æ“ä½œï¼ˆåˆè¯»äº†ä¸€ä¸ªå­—èŠ‚ï¼‰</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">origin</span><span class="o">.</span><span class="na">readByte</span><span class="o">();</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">ByteBufUtil</span><span class="o">.</span><span class="na">prettyHexDump</span><span class="o">(</span><span class="n">origin</span><span class="o">));</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 03 04                                           |..              |
+--------+-------------------------------------------------+----------------+
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¿™æ—¶çš„ slice ä¸å—å½±å“ï¼Œå› ä¸ºå®ƒæœ‰ç‹¬ç«‹çš„è¯»å†™æŒ‡é’ˆ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">ByteBufUtil</span><span class="o">.</span><span class="na">prettyHexDump</span><span class="o">(</span><span class="n">slice</span><span class="o">));</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 02 03 04                                        |...             |
+--------+-------------------------------------------------+----------------+
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¦‚æœ slice çš„å†…å®¹å‘ç”Ÿäº†æ›´æ”¹</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">slice</span><span class="o">.</span><span class="na">setByte</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mi">5</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">ByteBufUtil</span><span class="o">.</span><span class="na">prettyHexDump</span><span class="o">(</span><span class="n">slice</span><span class="o">));</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 02 03 05                                        |...             |
+--------+-------------------------------------------------+----------------+
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¿™æ—¶ï¼ŒåŸå§‹ ByteBuf ä¹Ÿä¼šå—å½±å“ï¼Œå› ä¸ºåº•å±‚éƒ½æ˜¯åŒä¸€å—å†…å­˜</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>System.out.println(ByteBufUtil.prettyHexDump(origin));
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 03 05                                           |..              |
+--------+-------------------------------------------------+----------------+
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="10duplicate-1">10ï¼‰duplicate</h4>

<p>ã€é›¶æ‹·è´ã€‘çš„ä½“ç°ä¹‹ä¸€ï¼Œå°±å¥½æ¯”æˆªå–äº†åŸå§‹ ByteBuf æ‰€æœ‰å†…å®¹ï¼Œå¹¶ä¸”æ²¡æœ‰ max capacity çš„é™åˆ¶ï¼Œä¹Ÿæ˜¯ä¸åŸå§‹ ByteBuf ä½¿ç”¨åŒä¸€å—åº•å±‚å†…å­˜ï¼Œåªæ˜¯è¯»å†™æŒ‡é’ˆæ˜¯ç‹¬ç«‹çš„</p>

<p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0012.png" alt="" /></p>

<h4 id="11copy-1">11ï¼‰copy</h4>

<p>ä¼šå°†åº•å±‚å†…å­˜æ•°æ®è¿›è¡Œæ·±æ‹·è´ï¼Œå› æ­¤æ— è®ºè¯»å†™ï¼Œéƒ½ä¸åŸå§‹ ByteBuf æ— å…³</p>

<h4 id="12compositebytebuf-1">12ï¼‰CompositeByteBuf</h4>

<p>ã€é›¶æ‹·è´ã€‘çš„ä½“ç°ä¹‹ä¸€ï¼Œå¯ä»¥å°†å¤šä¸ª ByteBuf åˆå¹¶ä¸ºä¸€ä¸ªé€»è¾‘ä¸Šçš„ ByteBufï¼Œé¿å…æ‹·è´</p>

<p>æœ‰ä¸¤ä¸ª ByteBuf å¦‚ä¸‹</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="nc">ByteBuf</span> <span class="n">buf1</span> <span class="o">=</span> <span class="nc">ByteBufAllocator</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">.</span><span class="na">buffer</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
<span class="n">buf1</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="k">new</span> <span class="kt">byte</span><span class="o">[]{</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="mi">5</span><span class="o">});</span>
<span class="nc">ByteBuf</span> <span class="n">buf2</span> <span class="o">=</span> <span class="nc">ByteBufAllocator</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">.</span><span class="na">buffer</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
<span class="n">buf2</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="k">new</span> <span class="kt">byte</span><span class="o">[]{</span><span class="mi">6</span><span class="o">,</span> <span class="mi">7</span><span class="o">,</span> <span class="mi">8</span><span class="o">,</span> <span class="mi">9</span><span class="o">,</span> <span class="mi">10</span><span class="o">});</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">ByteBufUtil</span><span class="o">.</span><span class="na">prettyHexDump</span><span class="o">(</span><span class="n">buf1</span><span class="o">));</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">ByteBufUtil</span><span class="o">.</span><span class="na">prettyHexDump</span><span class="o">(</span><span class="n">buf2</span><span class="o">));</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 01 02 03 04 05                                  |.....           |
+--------+-------------------------------------------------+----------------+
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 06 07 08 09 0a                                  |.....           |
+--------+-------------------------------------------------+----------------+
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç°åœ¨éœ€è¦ä¸€ä¸ªæ–°çš„ ByteBufï¼Œå†…å®¹æ¥è‡ªäºåˆšæ‰çš„ buf1 å’Œ buf2ï¼Œå¦‚ä½•å®ç°ï¼Ÿ</p>

<p>æ–¹æ³•1ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="nc">ByteBuf</span> <span class="n">buf3</span> <span class="o">=</span> <span class="nc">ByteBufAllocator</span><span class="o">.</span><span class="na">DEFAULT</span>
    <span class="o">.</span><span class="na">buffer</span><span class="o">(</span><span class="n">buf1</span><span class="o">.</span><span class="na">readableBytes</span><span class="o">()+</span><span class="n">buf2</span><span class="o">.</span><span class="na">readableBytes</span><span class="o">());</span>
<span class="n">buf3</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="n">buf1</span><span class="o">);</span>
<span class="n">buf3</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="n">buf2</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">ByteBufUtil</span><span class="o">.</span><span class="na">prettyHexDump</span><span class="o">(</span><span class="n">buf3</span><span class="o">));</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç»“æœ</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 01 02 03 04 05 06 07 08 09 0a                   |..........      |
+--------+-------------------------------------------------+----------------+
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¿™ç§æ–¹æ³•å¥½ä¸å¥½ï¼Ÿå›ç­”æ˜¯ä¸å¤ªå¥½ï¼Œå› ä¸ºè¿›è¡Œäº†æ•°æ®çš„å†…å­˜å¤åˆ¶æ“ä½œ</p>

<p>æ–¹æ³•2ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nc">CompositeByteBuf</span> <span class="n">buf3</span> <span class="o">=</span> <span class="nc">ByteBufAllocator</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">.</span><span class="na">compositeBuffer</span><span class="o">();</span>
<span class="c1">// true è¡¨ç¤ºå¢åŠ æ–°çš„ ByteBuf è‡ªåŠ¨é€’å¢ write index, å¦åˆ™ write index ä¼šå§‹ç»ˆä¸º 0</span>
<span class="n">buf3</span><span class="o">.</span><span class="na">addComponents</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span> <span class="n">buf1</span><span class="o">,</span> <span class="n">buf2</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç»“æœæ˜¯ä¸€æ ·çš„</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 01 02 03 04 05 06 07 08 09 0a                   |..........      |
+--------+-------------------------------------------------+----------------+
</pre></td></tr></tbody></table></code></pre></div></div>

<p>CompositeByteBuf æ˜¯ä¸€ä¸ªç»„åˆçš„ ByteBufï¼Œå®ƒå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ª Component æ•°ç»„ï¼Œæ¯ä¸ª Component ç®¡ç†ä¸€ä¸ª ByteBufï¼Œè®°å½•äº†è¿™ä¸ª ByteBuf ç›¸å¯¹äºæ•´ä½“åç§»é‡ç­‰ä¿¡æ¯ï¼Œä»£è¡¨ç€æ•´ä½“ä¸­æŸä¸€æ®µçš„æ•°æ®ã€‚</p>

<ul>
  <li>ä¼˜ç‚¹ï¼Œå¯¹å¤–æ˜¯ä¸€ä¸ªè™šæ‹Ÿè§†å›¾ï¼Œç»„åˆè¿™äº› ByteBuf ä¸ä¼šäº§ç”Ÿå†…å­˜å¤åˆ¶</li>
  <li>ç¼ºç‚¹ï¼Œå¤æ‚äº†å¾ˆå¤šï¼Œå¤šæ¬¡æ“ä½œä¼šå¸¦æ¥æ€§èƒ½çš„æŸè€—</li>
</ul>

<h4 id="13unpooled-1">13ï¼‰Unpooled</h4>

<p>Unpooled æ˜¯ä¸€ä¸ªå·¥å…·ç±»ï¼Œç±»å¦‚å…¶åï¼Œæä¾›äº†éæ± åŒ–çš„ ByteBuf åˆ›å»ºã€ç»„åˆã€å¤åˆ¶ç­‰æ“ä½œ</p>

<p>è¿™é‡Œä»…ä»‹ç»å…¶è·Ÿã€é›¶æ‹·è´ã€‘ç›¸å…³çš„ wrappedBuffer æ–¹æ³•ï¼Œå¯ä»¥ç”¨æ¥åŒ…è£… ByteBuf</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="nc">ByteBuf</span> <span class="n">buf1</span> <span class="o">=</span> <span class="nc">ByteBufAllocator</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">.</span><span class="na">buffer</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
<span class="n">buf1</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="k">new</span> <span class="kt">byte</span><span class="o">[]{</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="mi">5</span><span class="o">});</span>
<span class="nc">ByteBuf</span> <span class="n">buf2</span> <span class="o">=</span> <span class="nc">ByteBufAllocator</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">.</span><span class="na">buffer</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
<span class="n">buf2</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="k">new</span> <span class="kt">byte</span><span class="o">[]{</span><span class="mi">6</span><span class="o">,</span> <span class="mi">7</span><span class="o">,</span> <span class="mi">8</span><span class="o">,</span> <span class="mi">9</span><span class="o">,</span> <span class="mi">10</span><span class="o">});</span>

<span class="c1">// å½“åŒ…è£… ByteBuf ä¸ªæ•°è¶…è¿‡ä¸€ä¸ªæ—¶, åº•å±‚ä½¿ç”¨äº† CompositeByteBuf</span>
<span class="nc">ByteBuf</span> <span class="n">buf3</span> <span class="o">=</span> <span class="nc">Unpooled</span><span class="o">.</span><span class="na">wrappedBuffer</span><span class="o">(</span><span class="n">buf1</span><span class="o">,</span> <span class="n">buf2</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">ByteBufUtil</span><span class="o">.</span><span class="na">prettyHexDump</span><span class="o">(</span><span class="n">buf3</span><span class="o">));</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 01 02 03 04 05 06 07 08 09 0a                   |..........      |
+--------+-------------------------------------------------+----------------+
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä¹Ÿå¯ä»¥ç”¨æ¥åŒ…è£…æ™®é€šå­—èŠ‚æ•°ç»„ï¼Œåº•å±‚ä¹Ÿä¸ä¼šæœ‰æ‹·è´æ“ä½œ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nc">ByteBuf</span> <span class="n">buf4</span> <span class="o">=</span> <span class="nc">Unpooled</span><span class="o">.</span><span class="na">wrappedBuffer</span><span class="o">(</span><span class="k">new</span> <span class="kt">byte</span><span class="o">[]{</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">},</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[]{</span><span class="mi">4</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="mi">6</span><span class="o">});</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buf4</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">ByteBufUtil</span><span class="o">.</span><span class="na">prettyHexDump</span><span class="o">(</span><span class="n">buf4</span><span class="o">));</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>class io.netty.buffer.CompositeByteBuf
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 01 02 03 04 05 06                               |......          |
+--------+-------------------------------------------------+----------------+
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="-bytebuf-ä¼˜åŠ¿-1">ğŸ’¡ ByteBuf ä¼˜åŠ¿</h4>

<ul>
  <li>æ± åŒ– - å¯ä»¥é‡ç”¨æ± ä¸­ ByteBuf å®ä¾‹ï¼Œæ›´èŠ‚çº¦å†…å­˜ï¼Œå‡å°‘å†…å­˜æº¢å‡ºçš„å¯èƒ½</li>
  <li>è¯»å†™æŒ‡é’ˆåˆ†ç¦»ï¼Œä¸éœ€è¦åƒ ByteBuffer ä¸€æ ·åˆ‡æ¢è¯»å†™æ¨¡å¼</li>
  <li>å¯ä»¥è‡ªåŠ¨æ‰©å®¹</li>
  <li>æ”¯æŒé“¾å¼è°ƒç”¨ï¼Œä½¿ç”¨æ›´æµç•…</li>
  <li>å¾ˆå¤šåœ°æ–¹ä½“ç°é›¶æ‹·è´ï¼Œä¾‹å¦‚ sliceã€duplicateã€CompositeByteBuf</li>
</ul>

<h2 id="4-åŒå‘é€šä¿¡-1">4. åŒå‘é€šä¿¡</h2>

<h3 id="41-ç»ƒä¹ -1">4.1 ç»ƒä¹ </h3>

<p>å®ç°ä¸€ä¸ª echo server</p>

<p>ç¼–å†™ server</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre><span class="k">new</span> <span class="nc">ServerBootstrap</span><span class="o">()</span>
    <span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">())</span>
    <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">NioSocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">NioSocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInboundHandlerAdapter</span><span class="o">(){</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">ByteBuf</span> <span class="n">buffer</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ByteBuf</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="nc">Charset</span><span class="o">.</span><span class="na">defaultCharset</span><span class="o">()));</span>

                    <span class="c1">// å»ºè®®ä½¿ç”¨ ctx.alloc() åˆ›å»º ByteBuf</span>
                    <span class="nc">ByteBuf</span> <span class="n">response</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">alloc</span><span class="o">().</span><span class="na">buffer</span><span class="o">();</span>
                    <span class="n">response</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
                    <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">response</span><span class="o">);</span>

                    <span class="c1">// æ€è€ƒï¼šéœ€è¦é‡Šæ”¾ buffer å—</span>
                    <span class="c1">// æ€è€ƒï¼šéœ€è¦é‡Šæ”¾ response å—</span>
                <span class="o">}</span>
            <span class="o">});</span>
        <span class="o">}</span>
    <span class="o">}).</span><span class="na">bind</span><span class="o">(</span><span class="mi">8080</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç¼–å†™ client</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="rouge-code"><pre><span class="nc">NioEventLoopGroup</span> <span class="n">group</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">();</span>
<span class="nc">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Bootstrap</span><span class="o">()</span>
    <span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">group</span><span class="o">)</span>
    <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">NioSocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">NioSocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">StringEncoder</span><span class="o">());</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInboundHandlerAdapter</span><span class="o">()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">ByteBuf</span> <span class="n">buffer</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ByteBuf</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="nc">Charset</span><span class="o">.</span><span class="na">defaultCharset</span><span class="o">()));</span>

                    <span class="c1">// æ€è€ƒï¼šéœ€è¦é‡Šæ”¾ buffer å—</span>
                <span class="o">}</span>
            <span class="o">});</span>
        <span class="o">}</span>
    <span class="o">}).</span><span class="na">connect</span><span class="o">(</span><span class="s">"127.0.0.1"</span><span class="o">,</span> <span class="mi">8080</span><span class="o">).</span><span class="na">sync</span><span class="o">().</span><span class="na">channel</span><span class="o">();</span>

<span class="n">channel</span><span class="o">.</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">addListener</span><span class="o">(</span><span class="n">future</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="n">group</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
<span class="o">});</span>

<span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="nc">Scanner</span> <span class="n">scanner</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Scanner</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">in</span><span class="o">);</span>
    <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">line</span> <span class="o">=</span> <span class="n">scanner</span><span class="o">.</span><span class="na">nextLine</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="s">"q"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">line</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">channel</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="k">break</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">channel</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">line</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}).</span><span class="na">start</span><span class="o">();</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="-è¯»å’Œå†™çš„è¯¯è§£-1">ğŸ’¡ è¯»å’Œå†™çš„è¯¯è§£</h3>

<p>æˆ‘æœ€åˆåœ¨è®¤è¯†ä¸Šæœ‰è¿™æ ·çš„è¯¯åŒºï¼Œè®¤ä¸ºåªæœ‰åœ¨ nettyï¼Œnio è¿™æ ·çš„å¤šè·¯å¤ç”¨ IO æ¨¡å‹æ—¶ï¼Œè¯»å†™æ‰ä¸ä¼šç›¸äº’é˜»å¡ï¼Œæ‰å¯ä»¥å®ç°é«˜æ•ˆçš„åŒå‘é€šä¿¡ï¼Œä½†å®é™…ä¸Šï¼ŒJava Socket æ˜¯å…¨åŒå·¥çš„ï¼šåœ¨ä»»æ„æ—¶åˆ»ï¼Œçº¿è·¯ä¸Šå­˜åœ¨<code class="language-plaintext highlighter-rouge">A åˆ° B</code> å’Œ <code class="language-plaintext highlighter-rouge">B åˆ° A</code> çš„åŒå‘ä¿¡å·ä¼ è¾“ã€‚å³ä½¿æ˜¯é˜»å¡ IOï¼Œè¯»å’Œå†™æ˜¯å¯ä»¥åŒæ—¶è¿›è¡Œçš„ï¼Œåªè¦åˆ†åˆ«é‡‡ç”¨è¯»çº¿ç¨‹å’Œå†™çº¿ç¨‹å³å¯ï¼Œè¯»ä¸ä¼šé˜»å¡å†™ã€å†™ä¹Ÿä¸ä¼šé˜»å¡è¯»</p>

<p>ä¾‹å¦‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestServer</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">ServerSocket</span> <span class="n">ss</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServerSocket</span><span class="o">(</span><span class="mi">8888</span><span class="o">);</span>
        <span class="nc">Socket</span> <span class="n">s</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>

        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">BufferedReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="nc">InputStreamReader</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">()));</span>
                <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">());</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}).</span><span class="na">start</span><span class="o">();</span>

        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">BufferedWriter</span> <span class="n">writer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedWriter</span><span class="o">(</span><span class="k">new</span> <span class="nc">OutputStreamWriter</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">()));</span>
                <span class="c1">// ä¾‹å¦‚åœ¨è¿™ä¸ªä½ç½®åŠ å…¥ thread çº§åˆ«æ–­ç‚¹ï¼Œå¯ä»¥å‘ç°å³ä½¿ä¸å†™å…¥æ•°æ®ï¼Œä¹Ÿä¸å¦¨ç¢å‰é¢çº¿ç¨‹è¯»å–å®¢æˆ·ç«¯æ•°æ®</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                    <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
                    <span class="n">writer</span><span class="o">.</span><span class="na">newLine</span><span class="o">();</span>
                    <span class="n">writer</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}).</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å®¢æˆ·ç«¯</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestClient</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">Socket</span> <span class="n">s</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Socket</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="mi">8888</span><span class="o">);</span>

        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">BufferedReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="nc">InputStreamReader</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">()));</span>
                <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">());</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}).</span><span class="na">start</span><span class="o">();</span>

        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">BufferedWriter</span> <span class="n">writer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedWriter</span><span class="o">(</span><span class="k">new</span> <span class="nc">OutputStreamWriter</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">()));</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                    <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
                    <span class="n">writer</span><span class="o">.</span><span class="na">newLine</span><span class="o">();</span>
                    <span class="n">writer</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}).</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h1 id="ä¸‰-netty-è¿›é˜¶">ä¸‰. Netty è¿›é˜¶</h1>

<h2 id="1-ç²˜åŒ…ä¸åŠåŒ…">1. ç²˜åŒ…ä¸åŠåŒ…</h2>

<h3 id="11-ç²˜åŒ…ç°è±¡">1.1 ç²˜åŒ…ç°è±¡</h3>

<p>æœåŠ¡ç«¯ä»£ç </p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloWorldServer</span> <span class="o">{</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="n">log</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">HelloWorldServer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="kt">void</span> <span class="nf">start</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">NioEventLoopGroup</span> <span class="n">boss</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="nc">NioEventLoopGroup</span> <span class="n">worker</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">ServerBootstrap</span> <span class="n">serverBootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServerBootstrap</span><span class="o">();</span>
            <span class="n">serverBootstrap</span><span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="n">serverBootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">boss</span><span class="o">,</span> <span class="n">worker</span><span class="o">);</span>
            <span class="n">serverBootstrap</span><span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                    <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">LoggingHandler</span><span class="o">(</span><span class="nc">LogLevel</span><span class="o">.</span><span class="na">DEBUG</span><span class="o">));</span>
                    <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInboundHandlerAdapter</span><span class="o">()</span> <span class="o">{</span>
                        <span class="nd">@Override</span>
                        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelActive</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"connected {}"</span><span class="o">,</span> <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">());</span>
                            <span class="kd">super</span><span class="o">.</span><span class="na">channelActive</span><span class="o">(</span><span class="n">ctx</span><span class="o">);</span>
                        <span class="o">}</span>

                        <span class="nd">@Override</span>
                        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelInactive</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"disconnect {}"</span><span class="o">,</span> <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">());</span>
                            <span class="kd">super</span><span class="o">.</span><span class="na">channelInactive</span><span class="o">(</span><span class="n">ctx</span><span class="o">);</span>
                        <span class="o">}</span>
                    <span class="o">});</span>
                <span class="o">}</span>
            <span class="o">});</span>
            <span class="nc">ChannelFuture</span> <span class="n">channelFuture</span> <span class="o">=</span> <span class="n">serverBootstrap</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="mi">8080</span><span class="o">);</span>
            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"{} binding..."</span><span class="o">,</span> <span class="n">channelFuture</span><span class="o">.</span><span class="na">channel</span><span class="o">());</span>
            <span class="n">channelFuture</span><span class="o">.</span><span class="na">sync</span><span class="o">();</span>
            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"{} bound..."</span><span class="o">,</span> <span class="n">channelFuture</span><span class="o">.</span><span class="na">channel</span><span class="o">());</span>
            <span class="n">channelFuture</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"server error"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">boss</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
            <span class="n">worker</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"stoped"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">new</span> <span class="nf">HelloWorldServer</span><span class="o">().</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å®¢æˆ·ç«¯ä»£ç å¸Œæœ›å‘é€ 10 ä¸ªæ¶ˆæ¯ï¼Œæ¯ä¸ªæ¶ˆæ¯æ˜¯ 16 å­—èŠ‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloWorldClient</span> <span class="o">{</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="n">log</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">HelloWorldClient</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">NioEventLoopGroup</span> <span class="n">worker</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Bootstrap</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Bootstrap</span><span class="o">();</span>
            <span class="n">bootstrap</span><span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="n">bootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">worker</span><span class="o">);</span>
            <span class="n">bootstrap</span><span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"connetted..."</span><span class="o">);</span>
                    <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInboundHandlerAdapter</span><span class="o">()</span> <span class="o">{</span>
                        <span class="nd">@Override</span>
                        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelActive</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"sending..."</span><span class="o">);</span>
                            <span class="nc">Random</span> <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Random</span><span class="o">();</span>
                            <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="sc">'a'</span><span class="o">;</span>
                            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                                <span class="nc">ByteBuf</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">alloc</span><span class="o">().</span><span class="na">buffer</span><span class="o">();</span>
                                <span class="n">buffer</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="k">new</span> <span class="kt">byte</span><span class="o">[]{</span><span class="mi">0</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="mi">6</span><span class="o">,</span> <span class="mi">7</span><span class="o">,</span> <span class="mi">8</span><span class="o">,</span> <span class="mi">9</span><span class="o">,</span> <span class="mi">10</span><span class="o">,</span> <span class="mi">11</span><span class="o">,</span> <span class="mi">12</span><span class="o">,</span> <span class="mi">13</span><span class="o">,</span> <span class="mi">14</span><span class="o">,</span> <span class="mi">15</span><span class="o">});</span>
                                <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
                            <span class="o">}</span>
                        <span class="o">}</span>
                    <span class="o">});</span>
                <span class="o">}</span>
            <span class="o">});</span>
            <span class="nc">ChannelFuture</span> <span class="n">channelFuture</span> <span class="o">=</span> <span class="n">bootstrap</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="s">"127.0.0.1"</span><span class="o">,</span> <span class="mi">8080</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>
            <span class="n">channelFuture</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>

        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"client error"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">worker</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æœåŠ¡å™¨ç«¯çš„æŸæ¬¡è¾“å‡ºï¼Œå¯ä»¥çœ‹åˆ°ä¸€æ¬¡å°±æ¥æ”¶äº† 160 ä¸ªå­—èŠ‚ï¼Œè€Œéåˆ† 10 æ¬¡æ¥æ”¶</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre>08:24:46 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0x81e0fda5] binding...
08:24:46 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0x81e0fda5, L:/0:0:0:0:0:0:0:0:8080] bound...
08:24:55 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x94132411, L:/127.0.0.1:8080 - R:/127.0.0.1:58177] REGISTERED
08:24:55 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x94132411, L:/127.0.0.1:8080 - R:/127.0.0.1:58177] ACTIVE
08:24:55 [DEBUG] [nioEventLoopGroup-3-1] c.i.n.HelloWorldServer - connected [id: 0x94132411, L:/127.0.0.1:8080 - R:/127.0.0.1:58177]
08:24:55 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x94132411, L:/127.0.0.1:8080 - R:/127.0.0.1:58177] READ: 160B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
|00000010| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
|00000020| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
|00000030| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
|00000040| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
|00000050| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
|00000060| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
|00000070| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
|00000080| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
|00000090| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
+--------+-------------------------------------------------+----------------+
08:24:55 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x94132411, L:/127.0.0.1:8080 - R:/127.0.0.1:58177] READ COMPLETE
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="12-åŠåŒ…ç°è±¡">1.2 åŠåŒ…ç°è±¡</h3>

<p>å®¢æˆ·ç«¯ä»£ç å¸Œæœ›å‘é€ 1 ä¸ªæ¶ˆæ¯ï¼Œè¿™ä¸ªæ¶ˆæ¯æ˜¯ 160 å­—èŠ‚ï¼Œä»£ç æ”¹ä¸º</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="nc">ByteBuf</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">alloc</span><span class="o">().</span><span class="na">buffer</span><span class="o">();</span>
<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
    <span class="n">buffer</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="k">new</span> <span class="kt">byte</span><span class="o">[]{</span><span class="mi">0</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="mi">6</span><span class="o">,</span> <span class="mi">7</span><span class="o">,</span> <span class="mi">8</span><span class="o">,</span> <span class="mi">9</span><span class="o">,</span> <span class="mi">10</span><span class="o">,</span> <span class="mi">11</span><span class="o">,</span> <span class="mi">12</span><span class="o">,</span> <span class="mi">13</span><span class="o">,</span> <span class="mi">14</span><span class="o">,</span> <span class="mi">15</span><span class="o">});</span>
<span class="o">}</span>
<span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä¸ºç°è±¡æ˜æ˜¾ï¼ŒæœåŠ¡ç«¯ä¿®æ”¹ä¸€ä¸‹æ¥æ”¶ç¼“å†²åŒºï¼Œå…¶å®ƒä»£ç ä¸å˜</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">serverBootstrap</span><span class="o">.</span><span class="na">option</span><span class="o">(</span><span class="nc">ChannelOption</span><span class="o">.</span><span class="na">SO_RCVBUF</span><span class="o">,</span> <span class="mi">10</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æœåŠ¡å™¨ç«¯çš„æŸæ¬¡è¾“å‡ºï¼Œå¯ä»¥çœ‹åˆ°æ¥æ”¶çš„æ¶ˆæ¯è¢«åˆ†ä¸ºä¸¤èŠ‚ï¼Œç¬¬ä¸€æ¬¡ 20 å­—èŠ‚ï¼Œç¬¬äºŒæ¬¡ 140 å­—èŠ‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="rouge-code"><pre>08:43:49 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0x4d6c6a84] binding...
08:43:49 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0x4d6c6a84, L:/0:0:0:0:0:0:0:0:8080] bound...
08:44:23 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x1719abf7, L:/127.0.0.1:8080 - R:/127.0.0.1:59221] REGISTERED
08:44:23 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x1719abf7, L:/127.0.0.1:8080 - R:/127.0.0.1:59221] ACTIVE
08:44:23 [DEBUG] [nioEventLoopGroup-3-1] c.i.n.HelloWorldServer - connected [id: 0x1719abf7, L:/127.0.0.1:8080 - R:/127.0.0.1:59221]
08:44:24 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x1719abf7, L:/127.0.0.1:8080 - R:/127.0.0.1:59221] READ: 20B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
|00000010| 00 01 02 03                                     |....            |
+--------+-------------------------------------------------+----------------+
08:44:24 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x1719abf7, L:/127.0.0.1:8080 - R:/127.0.0.1:59221] READ COMPLETE
08:44:24 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x1719abf7, L:/127.0.0.1:8080 - R:/127.0.0.1:59221] READ: 140B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|
|00000010| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|
|00000020| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|
|00000030| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|
|00000040| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|
|00000050| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|
|00000060| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|
|00000070| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|
|00000080| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f             |............    |
+--------+-------------------------------------------------+----------------+
08:44:24 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x1719abf7, L:/127.0.0.1:8080 - R:/127.0.0.1:59221] READ COMPLETE
</pre></td></tr></tbody></table></code></pre></div></div>

<blockquote>
  <p><strong>æ³¨æ„</strong></p>

  <p>serverBootstrap.option(ChannelOption.SO_RCVBUF, 10) å½±å“çš„åº•å±‚æ¥æ”¶ç¼“å†²åŒºï¼ˆå³æ»‘åŠ¨çª—å£ï¼‰å¤§å°ï¼Œä»…å†³å®šäº† netty è¯»å–çš„æœ€å°å•ä½ï¼Œnetty å®é™…æ¯æ¬¡è¯»å–çš„ä¸€èˆ¬æ˜¯å®ƒçš„æ•´æ•°å€</p>
</blockquote>

<h3 id="13-ç°è±¡åˆ†æ">1.3 ç°è±¡åˆ†æ</h3>

<p>ç²˜åŒ…</p>

<ul>
  <li>ç°è±¡ï¼Œå‘é€ abc defï¼Œæ¥æ”¶ abcdef</li>
  <li>åŸå› 
    <ul>
      <li>åº”ç”¨å±‚ï¼šæ¥æ”¶æ–¹ ByteBuf è®¾ç½®å¤ªå¤§ï¼ˆNetty é»˜è®¤ 1024ï¼‰</li>
      <li>æ»‘åŠ¨çª—å£ï¼šå‡è®¾å‘é€æ–¹ 256 bytes è¡¨ç¤ºä¸€ä¸ªå®Œæ•´æŠ¥æ–‡ï¼Œä½†ç”±äºæ¥æ”¶æ–¹å¤„ç†ä¸åŠæ—¶ä¸”çª—å£å¤§å°è¶³å¤Ÿå¤§ï¼Œè¿™ 256 bytes å­—èŠ‚å°±ä¼šç¼“å†²åœ¨æ¥æ”¶æ–¹çš„æ»‘åŠ¨çª—å£ä¸­ï¼Œå½“æ»‘åŠ¨çª—å£ä¸­ç¼“å†²äº†å¤šä¸ªæŠ¥æ–‡å°±ä¼šç²˜åŒ…</li>
      <li>Nagle ç®—æ³•ï¼šä¼šé€ æˆç²˜åŒ…</li>
    </ul>
  </li>
</ul>

<p>åŠåŒ…</p>

<ul>
  <li>ç°è±¡ï¼Œå‘é€ abcdefï¼Œæ¥æ”¶ abc def</li>
  <li>åŸå› 
    <ul>
      <li>åº”ç”¨å±‚ï¼šæ¥æ”¶æ–¹ ByteBuf å°äºå®é™…å‘é€æ•°æ®é‡</li>
      <li>æ»‘åŠ¨çª—å£ï¼šå‡è®¾æ¥æ”¶æ–¹çš„çª—å£åªå‰©äº† 128 bytesï¼Œå‘é€æ–¹çš„æŠ¥æ–‡å¤§å°æ˜¯ 256 bytesï¼Œè¿™æ—¶æ”¾ä¸ä¸‹äº†ï¼Œåªèƒ½å…ˆå‘é€å‰ 128 bytesï¼Œç­‰å¾… ack åæ‰èƒ½å‘é€å‰©ä½™éƒ¨åˆ†ï¼Œè¿™å°±é€ æˆäº†åŠåŒ…</li>
      <li>MSS é™åˆ¶ï¼šå½“å‘é€çš„æ•°æ®è¶…è¿‡ MSS é™åˆ¶åï¼Œä¼šå°†æ•°æ®åˆ‡åˆ†å‘é€ï¼Œå°±ä¼šé€ æˆåŠåŒ…</li>
    </ul>
  </li>
</ul>

<p>æœ¬è´¨æ˜¯å› ä¸º TCP æ˜¯æµå¼åè®®ï¼Œæ¶ˆæ¯æ— è¾¹ç•Œ</p>

<blockquote>
  <p>æ»‘åŠ¨çª—å£</p>

  <ul>
    <li>
      <p>TCP ä»¥ä¸€ä¸ªæ®µï¼ˆsegmentï¼‰ä¸ºå•ä½ï¼Œæ¯å‘é€ä¸€ä¸ªæ®µå°±éœ€è¦è¿›è¡Œä¸€æ¬¡ç¡®è®¤åº”ç­”ï¼ˆackï¼‰å¤„ç†ï¼Œä½†å¦‚æœè¿™ä¹ˆåšï¼Œç¼ºç‚¹æ˜¯åŒ…çš„å¾€è¿”æ—¶é—´è¶Šé•¿æ€§èƒ½å°±è¶Šå·®</p>

      <p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0049.png" alt="" /></p>
    </li>
    <li>
      <p>ä¸ºäº†è§£å†³æ­¤é—®é¢˜ï¼Œå¼•å…¥äº†çª—å£æ¦‚å¿µï¼Œçª—å£å¤§å°å³å†³å®šäº†æ— éœ€ç­‰å¾…åº”ç­”è€Œå¯ä»¥ç»§ç»­å‘é€çš„æ•°æ®æœ€å¤§å€¼</p>

      <p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0051.png" alt="" /></p>
    </li>
    <li>
      <p>çª—å£å®é™…å°±èµ·åˆ°ä¸€ä¸ªç¼“å†²åŒºçš„ä½œç”¨ï¼ŒåŒæ—¶ä¹Ÿèƒ½èµ·åˆ°æµé‡æ§åˆ¶çš„ä½œç”¨</p>

      <ul>
        <li>å›¾ä¸­æ·±è‰²çš„éƒ¨åˆ†å³è¦å‘é€çš„æ•°æ®ï¼Œé«˜äº®çš„éƒ¨åˆ†å³çª—å£</li>
        <li>çª—å£å†…çš„æ•°æ®æ‰å…è®¸è¢«å‘é€ï¼Œå½“åº”ç­”æœªåˆ°è¾¾å‰ï¼Œçª—å£å¿…é¡»åœæ­¢æ»‘åŠ¨</li>
        <li>å¦‚æœ 1001~2000 è¿™ä¸ªæ®µçš„æ•°æ® ack å›æ¥äº†ï¼Œçª—å£å°±å¯ä»¥å‘å‰æ»‘åŠ¨</li>
        <li>æ¥æ”¶æ–¹ä¹Ÿä¼šç»´æŠ¤ä¸€ä¸ªçª—å£ï¼Œåªæœ‰è½åœ¨çª—å£å†…çš„æ•°æ®æ‰èƒ½å…è®¸æ¥æ”¶</li>
      </ul>
    </li>
  </ul>
</blockquote>

<blockquote>
  <p>MSS é™åˆ¶</p>

  <ul>
    <li>
      <p>é“¾è·¯å±‚å¯¹ä¸€æ¬¡èƒ½å¤Ÿå‘é€çš„æœ€å¤§æ•°æ®æœ‰é™åˆ¶ï¼Œè¿™ä¸ªé™åˆ¶ç§°ä¹‹ä¸º MTUï¼ˆmaximum transmission unitï¼‰ï¼Œä¸åŒçš„é“¾è·¯è®¾å¤‡çš„ MTU å€¼ä¹Ÿæœ‰æ‰€ä¸åŒï¼Œä¾‹å¦‚</p>
    </li>
    <li>ä»¥å¤ªç½‘çš„ MTU æ˜¯ 1500</li>
    <li>FDDIï¼ˆå…‰çº¤åˆ†å¸ƒå¼æ•°æ®æ¥å£ï¼‰çš„ MTU æ˜¯ 4352</li>
    <li>
      <p>æœ¬åœ°å›ç¯åœ°å€çš„ MTU æ˜¯ 65535 - æœ¬åœ°æµ‹è¯•ä¸èµ°ç½‘å¡</p>
    </li>
    <li>
      <p>MSS æ˜¯æœ€å¤§æ®µé•¿åº¦ï¼ˆmaximum segment sizeï¼‰ï¼Œå®ƒæ˜¯ MTU åˆ¨å» tcp å¤´å’Œ ip å¤´åå‰©ä½™èƒ½å¤Ÿä½œä¸ºæ•°æ®ä¼ è¾“çš„å­—èŠ‚æ•°</p>
    </li>
    <li>ipv4 tcp å¤´å ç”¨ 20 bytesï¼Œip å¤´å ç”¨ 20 bytesï¼Œå› æ­¤ä»¥å¤ªç½‘ MSS çš„å€¼ä¸º 1500 - 40 = 1460</li>
    <li>TCP åœ¨ä¼ é€’å¤§é‡æ•°æ®æ—¶ï¼Œä¼šæŒ‰ç…§ MSS å¤§å°å°†æ•°æ®è¿›è¡Œåˆ†å‰²å‘é€</li>
    <li>MSS çš„å€¼åœ¨ä¸‰æ¬¡æ¡æ‰‹æ—¶é€šçŸ¥å¯¹æ–¹è‡ªå·± MSS çš„å€¼ï¼Œç„¶ååœ¨ä¸¤è€…ä¹‹é—´é€‰æ‹©ä¸€ä¸ªå°å€¼ä½œä¸º MSS</li>
  </ul>

  <p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0031.jpg" style="zoom:50%;" /></p>
</blockquote>

<blockquote>
  <p>Nagle ç®—æ³•</p>

  <ul>
    <li>å³ä½¿å‘é€ä¸€ä¸ªå­—èŠ‚ï¼Œä¹Ÿéœ€è¦åŠ å…¥ tcp å¤´å’Œ ip å¤´ï¼Œä¹Ÿå°±æ˜¯æ€»å­—èŠ‚æ•°ä¼šä½¿ç”¨ 41 bytesï¼Œéå¸¸ä¸ç»æµã€‚å› æ­¤ä¸ºäº†æé«˜ç½‘ç»œåˆ©ç”¨ç‡ï¼Œtcp å¸Œæœ›å°½å¯èƒ½å‘é€è¶³å¤Ÿå¤§çš„æ•°æ®ï¼Œè¿™å°±æ˜¯ Nagle ç®—æ³•äº§ç”Ÿçš„ç¼˜ç”±</li>
    <li>è¯¥ç®—æ³•æ˜¯æŒ‡å‘é€ç«¯å³ä½¿è¿˜æœ‰åº”è¯¥å‘é€çš„æ•°æ®ï¼Œä½†å¦‚æœè¿™éƒ¨åˆ†æ•°æ®å¾ˆå°‘çš„è¯ï¼Œåˆ™è¿›è¡Œå»¶è¿Ÿå‘é€
      <ul>
        <li>å¦‚æœ SO_SNDBUF çš„æ•°æ®è¾¾åˆ° MSSï¼Œåˆ™éœ€è¦å‘é€</li>
        <li>å¦‚æœ SO_SNDBUF ä¸­å«æœ‰ FINï¼ˆè¡¨ç¤ºéœ€è¦è¿æ¥å…³é—­ï¼‰è¿™æ—¶å°†å‰©ä½™æ•°æ®å‘é€ï¼Œå†å…³é—­</li>
        <li>å¦‚æœ TCP_NODELAY = trueï¼Œåˆ™éœ€è¦å‘é€</li>
        <li>å·²å‘é€çš„æ•°æ®éƒ½æ”¶åˆ° ack æ—¶ï¼Œåˆ™éœ€è¦å‘é€</li>
        <li>ä¸Šè¿°æ¡ä»¶ä¸æ»¡è¶³ï¼Œä½†å‘ç”Ÿè¶…æ—¶ï¼ˆä¸€èˆ¬ä¸º 200msï¼‰åˆ™éœ€è¦å‘é€</li>
        <li>é™¤ä¸Šè¿°æƒ…å†µï¼Œå»¶è¿Ÿå‘é€</li>
      </ul>
    </li>
  </ul>
</blockquote>

<h3 id="14-è§£å†³æ–¹æ¡ˆ">1.4 è§£å†³æ–¹æ¡ˆ</h3>

<ol>
  <li>çŸ­é“¾æ¥ï¼Œå‘ä¸€ä¸ªåŒ…å»ºç«‹ä¸€æ¬¡è¿æ¥ï¼Œè¿™æ ·è¿æ¥å»ºç«‹åˆ°è¿æ¥æ–­å¼€ä¹‹é—´å°±æ˜¯æ¶ˆæ¯çš„è¾¹ç•Œï¼Œç¼ºç‚¹æ•ˆç‡å¤ªä½</li>
  <li>æ¯ä¸€æ¡æ¶ˆæ¯é‡‡ç”¨å›ºå®šé•¿åº¦ï¼Œç¼ºç‚¹æµªè´¹ç©ºé—´</li>
  <li>æ¯ä¸€æ¡æ¶ˆæ¯é‡‡ç”¨åˆ†éš”ç¬¦ï¼Œä¾‹å¦‚ \nï¼Œç¼ºç‚¹éœ€è¦è½¬ä¹‰</li>
  <li>æ¯ä¸€æ¡æ¶ˆæ¯åˆ†ä¸º head å’Œ bodyï¼Œhead ä¸­åŒ…å« body çš„é•¿åº¦</li>
</ol>

<h4 id="æ–¹æ³•1çŸ­é“¾æ¥">æ–¹æ³•1ï¼ŒçŸ­é“¾æ¥</h4>

<p>ä»¥è§£å†³ç²˜åŒ…ä¸ºä¾‹</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloWorldClient</span> <span class="o">{</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="n">log</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">HelloWorldClient</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// åˆ† 10 æ¬¡å‘é€</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">send</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">send</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">NioEventLoopGroup</span> <span class="n">worker</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Bootstrap</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Bootstrap</span><span class="o">();</span>
            <span class="n">bootstrap</span><span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="n">bootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">worker</span><span class="o">);</span>
            <span class="n">bootstrap</span><span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"conneted..."</span><span class="o">);</span>
                    <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">LoggingHandler</span><span class="o">(</span><span class="nc">LogLevel</span><span class="o">.</span><span class="na">DEBUG</span><span class="o">));</span>
                    <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInboundHandlerAdapter</span><span class="o">()</span> <span class="o">{</span>
                        <span class="nd">@Override</span>
                        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelActive</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"sending..."</span><span class="o">);</span>
                            <span class="nc">ByteBuf</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">alloc</span><span class="o">().</span><span class="na">buffer</span><span class="o">();</span>
                            <span class="n">buffer</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="k">new</span> <span class="kt">byte</span><span class="o">[]{</span><span class="mi">0</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="mi">6</span><span class="o">,</span> <span class="mi">7</span><span class="o">,</span> <span class="mi">8</span><span class="o">,</span> <span class="mi">9</span><span class="o">,</span> <span class="mi">10</span><span class="o">,</span> <span class="mi">11</span><span class="o">,</span> <span class="mi">12</span><span class="o">,</span> <span class="mi">13</span><span class="o">,</span> <span class="mi">14</span><span class="o">,</span> <span class="mi">15</span><span class="o">});</span>
                            <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
                            <span class="c1">// å‘å®Œå³å…³</span>
                            <span class="n">ctx</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                        <span class="o">}</span>
                    <span class="o">});</span>
                <span class="o">}</span>
            <span class="o">});</span>
            <span class="nc">ChannelFuture</span> <span class="n">channelFuture</span> <span class="o">=</span> <span class="n">bootstrap</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="mi">8080</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>
            <span class="n">channelFuture</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>

        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"client error"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">worker</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¾“å‡ºï¼Œç•¥</p>

<blockquote>
  <p>åŠåŒ…ç”¨è¿™ç§åŠæ³•è¿˜æ˜¯ä¸å¥½è§£å†³ï¼Œå› ä¸ºæ¥æ”¶æ–¹çš„ç¼“å†²åŒºå¤§å°æ˜¯æœ‰é™çš„</p>
</blockquote>

<h4 id="æ–¹æ³•2å›ºå®šé•¿åº¦">æ–¹æ³•2ï¼Œå›ºå®šé•¿åº¦</h4>

<p>è®©æ‰€æœ‰æ•°æ®åŒ…é•¿åº¦å›ºå®šï¼ˆå‡è®¾é•¿åº¦ä¸º 8 å­—èŠ‚ï¼‰ï¼ŒæœåŠ¡å™¨ç«¯åŠ å…¥</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">FixedLengthFrameDecoder</span><span class="o">(</span><span class="mi">8</span><span class="o">));</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å®¢æˆ·ç«¯æµ‹è¯•ä»£ç ï¼Œæ³¨æ„, é‡‡ç”¨è¿™ç§æ–¹æ³•åï¼Œå®¢æˆ·ç«¯ä»€ä¹ˆæ—¶å€™ flush éƒ½å¯ä»¥</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloWorldClient</span> <span class="o">{</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="n">log</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">HelloWorldClient</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">NioEventLoopGroup</span> <span class="n">worker</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Bootstrap</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Bootstrap</span><span class="o">();</span>
            <span class="n">bootstrap</span><span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="n">bootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">worker</span><span class="o">);</span>
            <span class="n">bootstrap</span><span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"connetted..."</span><span class="o">);</span>
                    <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">LoggingHandler</span><span class="o">(</span><span class="nc">LogLevel</span><span class="o">.</span><span class="na">DEBUG</span><span class="o">));</span>
                    <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInboundHandlerAdapter</span><span class="o">()</span> <span class="o">{</span>
                        <span class="nd">@Override</span>
                        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelActive</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"sending..."</span><span class="o">);</span>
                            <span class="c1">// å‘é€å†…å®¹éšæœºçš„æ•°æ®åŒ…</span>
                            <span class="nc">Random</span> <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Random</span><span class="o">();</span>
                            <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="sc">'a'</span><span class="o">;</span>
                            <span class="nc">ByteBuf</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">alloc</span><span class="o">().</span><span class="na">buffer</span><span class="o">();</span>
                            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                                <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">8</span><span class="o">];</span>
                                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">r</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">8</span><span class="o">);</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
                                    <span class="n">bytes</span><span class="o">[</span><span class="n">j</span><span class="o">]</span> <span class="o">=</span> <span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="n">c</span><span class="o">;</span>
                                <span class="o">}</span>
                                <span class="n">c</span><span class="o">++;</span>
                                <span class="n">buffer</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="n">bytes</span><span class="o">);</span>
                            <span class="o">}</span>
                            <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
                        <span class="o">}</span>
                    <span class="o">});</span>
                <span class="o">}</span>
            <span class="o">});</span>
            <span class="nc">ChannelFuture</span> <span class="n">channelFuture</span> <span class="o">=</span> <span class="n">bootstrap</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="s">"192.168.0.103"</span><span class="o">,</span> <span class="mi">9090</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>
            <span class="n">channelFuture</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>

        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"client error"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">worker</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å®¢æˆ·ç«¯è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre>12:07:00 [DEBUG] [nioEventLoopGroup-2-1] c.i.n.HelloWorldClient - connetted...
12:07:00 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x3c2ef3c2] REGISTERED
12:07:00 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x3c2ef3c2] CONNECT: /192.168.0.103:9090
12:07:00 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x3c2ef3c2, L:/192.168.0.103:53155 - R:/192.168.0.103:9090] ACTIVE
12:07:00 [DEBUG] [nioEventLoopGroup-2-1] c.i.n.HelloWorldClient - sending...
12:07:00 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x3c2ef3c2, L:/192.168.0.103:53155 - R:/192.168.0.103:9090] WRITE: 80B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 61 61 61 61 00 00 00 00 62 00 00 00 00 00 00 00 |aaaa....b.......|
|00000010| 63 63 00 00 00 00 00 00 64 00 00 00 00 00 00 00 |cc......d.......|
|00000020| 00 00 00 00 00 00 00 00 66 66 66 66 00 00 00 00 |........ffff....|
|00000030| 67 67 67 00 00 00 00 00 68 00 00 00 00 00 00 00 |ggg.....h.......|
|00000040| 69 69 69 69 69 00 00 00 6a 6a 6a 6a 00 00 00 00 |iiiii...jjjj....|
+--------+-------------------------------------------------+----------------+
12:07:00 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x3c2ef3c2, L:/192.168.0.103:53155 - R:/192.168.0.103:9090] FLUSH
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æœåŠ¡ç«¯è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
</pre></td><td class="rouge-code"><pre>12:06:51 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0xe3d9713f] binding...
12:06:51 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0xe3d9713f, L:/192.168.0.103:9090] bound...
12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] REGISTERED
12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] ACTIVE
12:07:00 [DEBUG] [nioEventLoopGroup-3-1] c.i.n.HelloWorldServer - connected [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155]
12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 61 61 61 61 00 00 00 00                         |aaaa....        |
+--------+-------------------------------------------------+----------------+
12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 62 00 00 00 00 00 00 00                         |b.......        |
+--------+-------------------------------------------------+----------------+
12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 63 63 00 00 00 00 00 00                         |cc......        |
+--------+-------------------------------------------------+----------------+
12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 64 00 00 00 00 00 00 00                         |d.......        |
+--------+-------------------------------------------------+----------------+
12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 00 00 00 00 00 00 00 00                         |........        |
+--------+-------------------------------------------------+----------------+
12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 66 66 66 66 00 00 00 00                         |ffff....        |
+--------+-------------------------------------------------+----------------+
12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 67 67 67 00 00 00 00 00                         |ggg.....        |
+--------+-------------------------------------------------+----------------+
12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 68 00 00 00 00 00 00 00                         |h.......        |
+--------+-------------------------------------------------+----------------+
12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 69 69 69 69 69 00 00 00                         |iiiii...        |
+--------+-------------------------------------------------+----------------+
12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 6a 6a 6a 6a 00 00 00 00                         |jjjj....        |
+--------+-------------------------------------------------+----------------+
12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ COMPLETE
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç¼ºç‚¹æ˜¯ï¼Œæ•°æ®åŒ…çš„å¤§å°ä¸å¥½æŠŠæ¡</p>

<ul>
  <li>é•¿åº¦å®šçš„å¤ªå¤§ï¼Œæµªè´¹</li>
  <li>é•¿åº¦å®šçš„å¤ªå°ï¼Œå¯¹æŸäº›æ•°æ®åŒ…åˆæ˜¾å¾—ä¸å¤Ÿ</li>
</ul>

<h4 id="æ–¹æ³•3å›ºå®šåˆ†éš”ç¬¦">æ–¹æ³•3ï¼Œå›ºå®šåˆ†éš”ç¬¦</h4>

<p>æœåŠ¡ç«¯åŠ å…¥ï¼Œé»˜è®¤ä»¥ \n æˆ– \r\n ä½œä¸ºåˆ†éš”ç¬¦ï¼Œå¦‚æœè¶…å‡ºæŒ‡å®šé•¿åº¦ä»æœªå‡ºç°åˆ†éš”ç¬¦ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">LineBasedFrameDecoder</span><span class="o">(</span><span class="mi">1024</span><span class="o">));</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å®¢æˆ·ç«¯åœ¨æ¯æ¡æ¶ˆæ¯ä¹‹åï¼ŒåŠ å…¥ \n åˆ†éš”ç¬¦</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloWorldClient</span> <span class="o">{</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="n">log</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">HelloWorldClient</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">NioEventLoopGroup</span> <span class="n">worker</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Bootstrap</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Bootstrap</span><span class="o">();</span>
            <span class="n">bootstrap</span><span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="n">bootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">worker</span><span class="o">);</span>
            <span class="n">bootstrap</span><span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"connetted..."</span><span class="o">);</span>
                    <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">LoggingHandler</span><span class="o">(</span><span class="nc">LogLevel</span><span class="o">.</span><span class="na">DEBUG</span><span class="o">));</span>
                    <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInboundHandlerAdapter</span><span class="o">()</span> <span class="o">{</span>
                        <span class="nd">@Override</span>
                        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelActive</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"sending..."</span><span class="o">);</span>
                            <span class="nc">Random</span> <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Random</span><span class="o">();</span>
                            <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="sc">'a'</span><span class="o">;</span>
                            <span class="nc">ByteBuf</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">alloc</span><span class="o">().</span><span class="na">buffer</span><span class="o">();</span>
                            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">r</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">16</span><span class="o">)+</span><span class="mi">1</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
                                    <span class="n">buffer</span><span class="o">.</span><span class="na">writeByte</span><span class="o">((</span><span class="kt">byte</span><span class="o">)</span> <span class="n">c</span><span class="o">);</span>
                                <span class="o">}</span>
                                <span class="n">buffer</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
                                <span class="n">c</span><span class="o">++;</span>
                            <span class="o">}</span>
                            <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
                        <span class="o">}</span>
                    <span class="o">});</span>
                <span class="o">}</span>
            <span class="o">});</span>
            <span class="nc">ChannelFuture</span> <span class="n">channelFuture</span> <span class="o">=</span> <span class="n">bootstrap</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="s">"192.168.0.103"</span><span class="o">,</span> <span class="mi">9090</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>
            <span class="n">channelFuture</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>

        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"client error"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">worker</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å®¢æˆ·ç«¯è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre>14:08:18 [DEBUG] [nioEventLoopGroup-2-1] c.i.n.HelloWorldClient - connetted...
14:08:18 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x1282d755] REGISTERED
14:08:18 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x1282d755] CONNECT: /192.168.0.103:9090
14:08:18 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x1282d755, L:/192.168.0.103:63641 - R:/192.168.0.103:9090] ACTIVE
14:08:18 [DEBUG] [nioEventLoopGroup-2-1] c.i.n.HelloWorldClient - sending...
14:08:18 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x1282d755, L:/192.168.0.103:63641 - R:/192.168.0.103:9090] WRITE: 60B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 61 0a 62 62 62 0a 63 63 63 0a 64 64 0a 65 65 65 |a.bbb.ccc.dd.eee|
|00000010| 65 65 65 65 65 65 65 0a 66 66 0a 67 67 67 67 67 |eeeeeee.ff.ggggg|
|00000020| 67 67 0a 68 68 68 68 0a 69 69 69 69 69 69 69 0a |gg.hhhh.iiiiiii.|
|00000030| 6a 6a 6a 6a 6a 6a 6a 6a 6a 6a 6a 0a             |jjjjjjjjjjj.    |
+--------+-------------------------------------------------+----------------+
14:08:18 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x1282d755, L:/192.168.0.103:63641 - R:/192.168.0.103:9090] FLUSH
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æœåŠ¡ç«¯è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
</pre></td><td class="rouge-code"><pre>14:08:18 [DEBUG] [nioEventLoopGroup-3-5] c.i.n.HelloWorldServer - connected [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641]
14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 1B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 61                                              |a               |
+--------+-------------------------------------------------+----------------+
14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 3B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 62 62 62                                        |bbb             |
+--------+-------------------------------------------------+----------------+
14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 3B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 63 63 63                                        |ccc             |
+--------+-------------------------------------------------+----------------+
14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 2B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 64 64                                           |dd              |
+--------+-------------------------------------------------+----------------+
14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 10B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 65 65 65 65 65 65 65 65 65 65                   |eeeeeeeeee      |
+--------+-------------------------------------------------+----------------+
14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 2B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 66 66                                           |ff              |
+--------+-------------------------------------------------+----------------+
14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 7B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 67 67 67 67 67 67 67                            |ggggggg         |
+--------+-------------------------------------------------+----------------+
14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 4B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 68 68 68 68                                     |hhhh            |
+--------+-------------------------------------------------+----------------+
14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 7B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 69 69 69 69 69 69 69                            |iiiiiii         |
+--------+-------------------------------------------------+----------------+
14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 11B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 6a 6a 6a 6a 6a 6a 6a 6a 6a 6a 6a                |jjjjjjjjjjj     |
+--------+-------------------------------------------------+----------------+
14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ COMPLETE
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç¼ºç‚¹ï¼Œå¤„ç†å­—ç¬¦æ•°æ®æ¯”è¾ƒåˆé€‚ï¼Œä½†å¦‚æœå†…å®¹æœ¬èº«åŒ…å«äº†åˆ†éš”ç¬¦ï¼ˆå­—èŠ‚æ•°æ®å¸¸å¸¸ä¼šæœ‰æ­¤æƒ…å†µï¼‰ï¼Œé‚£ä¹ˆå°±ä¼šè§£æé”™è¯¯</p>

<h4 id="æ–¹æ³•4é¢„è®¾é•¿åº¦">æ–¹æ³•4ï¼Œé¢„è®¾é•¿åº¦</h4>

<p>åœ¨å‘é€æ¶ˆæ¯å‰ï¼Œå…ˆçº¦å®šç”¨å®šé•¿å­—èŠ‚è¡¨ç¤ºæ¥ä¸‹æ¥æ•°æ®çš„é•¿åº¦</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="c1">// æœ€å¤§é•¿åº¦ï¼Œé•¿åº¦åç§»ï¼Œé•¿åº¦å ç”¨å­—èŠ‚ï¼Œé•¿åº¦è°ƒæ•´ï¼Œå‰¥ç¦»å­—èŠ‚æ•°</span>
<span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">LengthFieldBasedFrameDecoder</span><span class="o">(</span><span class="mi">1024</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">1</span><span class="o">));</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å®¢æˆ·ç«¯ä»£ç </p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloWorldClient</span> <span class="o">{</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="n">log</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">HelloWorldClient</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">NioEventLoopGroup</span> <span class="n">worker</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Bootstrap</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Bootstrap</span><span class="o">();</span>
            <span class="n">bootstrap</span><span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="n">bootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">worker</span><span class="o">);</span>
            <span class="n">bootstrap</span><span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"connetted..."</span><span class="o">);</span>
                    <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">LoggingHandler</span><span class="o">(</span><span class="nc">LogLevel</span><span class="o">.</span><span class="na">DEBUG</span><span class="o">));</span>
                    <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInboundHandlerAdapter</span><span class="o">()</span> <span class="o">{</span>
                        <span class="nd">@Override</span>
                        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelActive</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"sending..."</span><span class="o">);</span>
                            <span class="nc">Random</span> <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Random</span><span class="o">();</span>
                            <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="sc">'a'</span><span class="o">;</span>
                            <span class="nc">ByteBuf</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">alloc</span><span class="o">().</span><span class="na">buffer</span><span class="o">();</span>
                            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                                <span class="kt">byte</span> <span class="n">length</span> <span class="o">=</span> <span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">16</span><span class="o">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
                                <span class="c1">// å…ˆå†™å…¥é•¿åº¦</span>
                                <span class="n">buffer</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">length</span><span class="o">);</span>
                                <span class="c1">// å†</span>
                                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">length</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
                                    <span class="n">buffer</span><span class="o">.</span><span class="na">writeByte</span><span class="o">((</span><span class="kt">byte</span><span class="o">)</span> <span class="n">c</span><span class="o">);</span>
                                <span class="o">}</span>
                                <span class="n">c</span><span class="o">++;</span>
                            <span class="o">}</span>
                            <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
                        <span class="o">}</span>
                    <span class="o">});</span>
                <span class="o">}</span>
            <span class="o">});</span>
            <span class="nc">ChannelFuture</span> <span class="n">channelFuture</span> <span class="o">=</span> <span class="n">bootstrap</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="s">"192.168.0.103"</span><span class="o">,</span> <span class="mi">9090</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>
            <span class="n">channelFuture</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>

        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"client error"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">worker</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å®¢æˆ·ç«¯è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre>14:37:10 [DEBUG] [nioEventLoopGroup-2-1] c.i.n.HelloWorldClient - connetted...
14:37:10 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0xf0f347b8] REGISTERED
14:37:10 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0xf0f347b8] CONNECT: /192.168.0.103:9090
14:37:10 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0xf0f347b8, L:/192.168.0.103:49979 - R:/192.168.0.103:9090] ACTIVE
14:37:10 [DEBUG] [nioEventLoopGroup-2-1] c.i.n.HelloWorldClient - sending...
14:37:10 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0xf0f347b8, L:/192.168.0.103:49979 - R:/192.168.0.103:9090] WRITE: 97B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 09 61 61 61 61 61 61 61 61 61 09 62 62 62 62 62 |.aaaaaaaaa.bbbbb|
|00000010| 62 62 62 62 06 63 63 63 63 63 63 08 64 64 64 64 |bbbb.cccccc.dddd|
|00000020| 64 64 64 64 0f 65 65 65 65 65 65 65 65 65 65 65 |dddd.eeeeeeeeeee|
|00000030| 65 65 65 65 0d 66 66 66 66 66 66 66 66 66 66 66 |eeee.fffffffffff|
|00000040| 66 66 02 67 67 02 68 68 0e 69 69 69 69 69 69 69 |ff.gg.hh.iiiiiii|
|00000050| 69 69 69 69 69 69 69 09 6a 6a 6a 6a 6a 6a 6a 6a |iiiiiii.jjjjjjjj|
|00000060| 6a                                              |j               |
+--------+-------------------------------------------------+----------------+
14:37:10 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0xf0f347b8, L:/192.168.0.103:49979 - R:/192.168.0.103:9090] FLUSH
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æœåŠ¡ç«¯è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
</pre></td><td class="rouge-code"><pre>14:36:50 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0xdff439d3] binding...
14:36:51 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0xdff439d3, L:/192.168.0.103:9090] bound...
14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] REGISTERED
14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] ACTIVE
14:37:10 [DEBUG] [nioEventLoopGroup-3-1] c.i.n.HelloWorldServer - connected [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979]
14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 9B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 61 61 61 61 61 61 61 61 61                      |aaaaaaaaa       |
+--------+-------------------------------------------------+----------------+
14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 9B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 62 62 62 62 62 62 62 62 62                      |bbbbbbbbb       |
+--------+-------------------------------------------------+----------------+
14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 6B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 63 63 63 63 63 63                               |cccccc          |
+--------+-------------------------------------------------+----------------+
14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 8B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 64 64 64 64 64 64 64 64                         |dddddddd        |
+--------+-------------------------------------------------+----------------+
14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 15B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 65 65 65 65 65 65 65 65 65 65 65 65 65 65 65    |eeeeeeeeeeeeeee |
+--------+-------------------------------------------------+----------------+
14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 13B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 66 66 66 66 66 66 66 66 66 66 66 66 66          |fffffffffffff   |
+--------+-------------------------------------------------+----------------+
14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 2B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 67 67                                           |gg              |
+--------+-------------------------------------------------+----------------+
14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 2B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 68 68                                           |hh              |
+--------+-------------------------------------------------+----------------+
14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 14B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 69 69 69 69 69 69 69 69 69 69 69 69 69 69       |iiiiiiiiiiiiii  |
+--------+-------------------------------------------------+----------------+
14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 9B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 6a 6a 6a 6a 6a 6a 6a 6a 6a                      |jjjjjjjjj       |
+--------+-------------------------------------------------+----------------+
14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ COMPLETE

</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="2-åè®®è®¾è®¡ä¸è§£æ">2. åè®®è®¾è®¡ä¸è§£æ</h2>

<h3 id="21-ä¸ºä»€ä¹ˆéœ€è¦åè®®">2.1 ä¸ºä»€ä¹ˆéœ€è¦åè®®ï¼Ÿ</h3>

<p>TCP/IP ä¸­æ¶ˆæ¯ä¼ è¾“åŸºäºæµçš„æ–¹å¼ï¼Œæ²¡æœ‰è¾¹ç•Œã€‚</p>

<p>åè®®çš„ç›®çš„å°±æ˜¯åˆ’å®šæ¶ˆæ¯çš„è¾¹ç•Œï¼Œåˆ¶å®šé€šä¿¡åŒæ–¹è¦å…±åŒéµå®ˆçš„é€šä¿¡è§„åˆ™</p>

<p>ä¾‹å¦‚ï¼šåœ¨ç½‘ç»œä¸Šä¼ è¾“</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ä¸‹é›¨å¤©ç•™å®¢å¤©ç•™æˆ‘ä¸ç•™
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ˜¯ä¸­æ–‡ä¸€å¥è‘—åçš„æ— æ ‡ç‚¹ç¬¦å·å¥å­ï¼Œåœ¨æ²¡æœ‰æ ‡ç‚¹ç¬¦å·æƒ…å†µä¸‹ï¼Œè¿™å¥è¯æœ‰æ•°ç§æ‹†è§£æ–¹å¼ï¼Œè€Œæ„æ€å´æ˜¯å®Œå…¨ä¸åŒï¼Œæ‰€ä»¥å¸¸è¢«ç”¨ä½œè®²è¿°æ ‡ç‚¹ç¬¦å·çš„é‡è¦æ€§</p>

<p>ä¸€ç§è§£è¯»</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ä¸‹é›¨å¤©ç•™å®¢ï¼Œå¤©ç•™ï¼Œæˆ‘ä¸ç•™
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¦ä¸€ç§è§£è¯»</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ä¸‹é›¨å¤©ï¼Œç•™å®¢å¤©ï¼Œç•™æˆ‘ä¸ï¼Ÿç•™
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¦‚ä½•è®¾è®¡åè®®å‘¢ï¼Ÿå…¶å®å°±æ˜¯ç»™ç½‘ç»œä¼ è¾“çš„ä¿¡æ¯åŠ ä¸Šâ€œæ ‡ç‚¹ç¬¦å·â€ã€‚ä½†é€šè¿‡åˆ†éš”ç¬¦æ¥æ–­å¥ä¸æ˜¯å¾ˆå¥½ï¼Œå› ä¸ºåˆ†éš”ç¬¦æœ¬èº«å¦‚æœç”¨äºä¼ è¾“ï¼Œé‚£ä¹ˆå¿…é¡»åŠ ä»¥åŒºåˆ†ã€‚å› æ­¤ï¼Œä¸‹é¢ä¸€ç§åè®®è¾ƒä¸ºå¸¸ç”¨</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>å®šé•¿å­—èŠ‚è¡¨ç¤ºå†…å®¹é•¿åº¦ + å®é™…å†…å®¹
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä¾‹å¦‚ï¼Œå‡è®¾ä¸€ä¸ªä¸­æ–‡å­—ç¬¦é•¿åº¦ä¸º 3ï¼ŒæŒ‰ç…§ä¸Šè¿°åè®®çš„è§„åˆ™ï¼Œå‘é€ä¿¡æ¯æ–¹å¼å¦‚ä¸‹ï¼Œå°±ä¸ä¼šè¢«æ¥æ”¶æ–¹å¼„é”™æ„æ€äº†</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>0fä¸‹é›¨å¤©ç•™å®¢06å¤©ç•™09æˆ‘ä¸ç•™
</pre></td></tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>å°æ•…äº‹</p>

  <p>å¾ˆä¹…å¾ˆä¹…ä»¥å‰ï¼Œä¸€ä½ç§å¡¾å…ˆç”Ÿåˆ°ä¸€å®¶ä»»æ•™ã€‚åŒæ–¹ç­¾è®¢äº†ä¸€çº¸åè®®ï¼šâ€œæ— é¸¡é¸­äº¦å¯æ— é±¼è‚‰äº¦å¯ç™½èœè±†è…ä¸å¯å°‘ä¸å¾—æŸä¿®é‡‘â€ã€‚æ­¤åï¼Œç§å¡¾å…ˆç”Ÿè™½ç„¶è®¤çœŸæ•™è¯¾ï¼Œä½†ä¸»äººå®¶åˆ™æ€»æ˜¯ç»™ç§å¡¾å…ˆç”Ÿä»¥ç™½èœè±†è…ä¸ºèœï¼Œä¸æ¯«æœªè§é¸¡é¸­é±¼è‚‰çš„æ¬¾å¾…ã€‚ç§å¡¾å…ˆç”Ÿå…ˆæ˜¯å¾ˆä¸è§£ï¼Œå¯æ˜¯åæ¥ä¹Ÿå°±æƒ³é€šäº†ï¼šä¸»äººæŠŠé¸¡é¸­é±¼è‚‰çš„é’±éƒ½ä¼šæ¢ä¸ºæŸä¿®é‡‘çš„ï¼Œä¹Ÿç½¢ã€‚è‡³æ­¤åŒæ–¹ç›¸å®‰æ— äº‹ã€‚</p>

  <p>å¹´å…³å°†è‡³ï¼Œä¸€ä¸ªå­¦å¹´æ®µäº¦å‘Šç»“æŸã€‚ç§å¡¾å…ˆç”Ÿä¸´è¡Œæ—¶ï¼Œä¹Ÿä¸è§ä¸»äººå®¶ä¸ºä»–äº¤ä»˜æŸä¿®é‡‘ï¼Œé‚ä¸ä¸»å®¶ç†è®ºã€‚ç„¶ä¸»å®¶äº¦æŒ¯æŒ¯æœ‰è¯ï¼šâ€œæœ‰åè®®ä¸ºè¯â€”â€”æ— é¸¡é¸­äº¦å¯ï¼Œæ— é±¼è‚‰äº¦å¯ï¼Œç™½èœè±†è…ä¸å¯å°‘ï¼Œä¸å¾—æŸä¿®é‡‘ã€‚è¿™ç™½çº¸é»‘å­—æ˜æ‘†ç€çš„ï¼Œä½ æœ‰ä»€ä¹ˆè¦è¯´çš„å‘¢ï¼Ÿâ€</p>

  <p>ç§å¡¾å…ˆç”Ÿæ®ç†åŠ›äº‰ï¼šâ€œåè®®æ˜¯è¿™æ ·çš„â€”â€”æ— é¸¡ï¼Œé¸­äº¦å¯ï¼›æ— é±¼ï¼Œè‚‰äº¦å¯ï¼›ç™½èœè±†è…ä¸å¯ï¼Œå°‘ä¸å¾—æŸä¿®é‡‘ã€‚â€</p>

  <p>åŒæ–¹å”‡æªèˆŒæˆ˜ï¼Œä½ æ¥æˆ‘å¾€ï¼ŒçœŸä¸ªæ˜¯ä¸äº¦ä¹ä¹ï¼</p>

  <p>è¿™é‡Œçš„æŸä¿®é‡‘ï¼Œä¹Ÿä½œâ€œæŸè„©â€ï¼Œåº”å½“æ˜¯æ³›æŒ‡æ•™å¸ˆåº”å½“å¾—åˆ°çš„æŠ¥é…¬</p>
</blockquote>

<h3 id="22-redis-åè®®ä¸¾ä¾‹">2.2 redis åè®®ä¸¾ä¾‹</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
</pre></td><td class="rouge-code"><pre><span class="nc">NioEventLoopGroup</span> <span class="n">worker</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">();</span>
<span class="kt">byte</span><span class="o">[]</span> <span class="no">LINE</span> <span class="o">=</span> <span class="o">{</span><span class="mi">13</span><span class="o">,</span> <span class="mi">10</span><span class="o">};</span>
<span class="k">try</span> <span class="o">{</span>
    <span class="nc">Bootstrap</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Bootstrap</span><span class="o">();</span>
    <span class="n">bootstrap</span><span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">bootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">worker</span><span class="o">);</span>
    <span class="n">bootstrap</span><span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">LoggingHandler</span><span class="o">());</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInboundHandlerAdapter</span><span class="o">()</span> <span class="o">{</span>
                <span class="c1">// ä¼šåœ¨è¿æ¥ channel å»ºç«‹æˆåŠŸåï¼Œä¼šè§¦å‘ active äº‹ä»¶</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelActive</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">set</span><span class="o">(</span><span class="n">ctx</span><span class="o">);</span>
                    <span class="n">get</span><span class="o">(</span><span class="n">ctx</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="kd">private</span> <span class="kt">void</span> <span class="nf">get</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">alloc</span><span class="o">().</span><span class="na">buffer</span><span class="o">();</span>
                    <span class="n">buf</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="s">"*2"</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
                    <span class="n">buf</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="no">LINE</span><span class="o">);</span>
                    <span class="n">buf</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="s">"$3"</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
                    <span class="n">buf</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="no">LINE</span><span class="o">);</span>
                    <span class="n">buf</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="s">"get"</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
                    <span class="n">buf</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="no">LINE</span><span class="o">);</span>
                    <span class="n">buf</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="s">"$3"</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
                    <span class="n">buf</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="no">LINE</span><span class="o">);</span>
                    <span class="n">buf</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="s">"aaa"</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
                    <span class="n">buf</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="no">LINE</span><span class="o">);</span>
                    <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">buf</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="kd">private</span> <span class="kt">void</span> <span class="nf">set</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">alloc</span><span class="o">().</span><span class="na">buffer</span><span class="o">();</span>
                    <span class="n">buf</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="s">"*3"</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
                    <span class="n">buf</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="no">LINE</span><span class="o">);</span>
                    <span class="n">buf</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="s">"$3"</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
                    <span class="n">buf</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="no">LINE</span><span class="o">);</span>
                    <span class="n">buf</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="s">"set"</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
                    <span class="n">buf</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="no">LINE</span><span class="o">);</span>
                    <span class="n">buf</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="s">"$3"</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
                    <span class="n">buf</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="no">LINE</span><span class="o">);</span>
                    <span class="n">buf</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="s">"aaa"</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
                    <span class="n">buf</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="no">LINE</span><span class="o">);</span>
                    <span class="n">buf</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="s">"$3"</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
                    <span class="n">buf</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="no">LINE</span><span class="o">);</span>
                    <span class="n">buf</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="s">"bbb"</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
                    <span class="n">buf</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="no">LINE</span><span class="o">);</span>
                    <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">buf</span><span class="o">);</span>
                <span class="o">}</span>

                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                    <span class="nc">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ByteBuf</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="nc">Charset</span><span class="o">.</span><span class="na">defaultCharset</span><span class="o">()));</span>
                <span class="o">}</span>
            <span class="o">});</span>
        <span class="o">}</span>
    <span class="o">});</span>
    <span class="nc">ChannelFuture</span> <span class="n">channelFuture</span> <span class="o">=</span> <span class="n">bootstrap</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="mi">6379</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>
    <span class="n">channelFuture</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"client error"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
    <span class="n">worker</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="23-http-åè®®ä¸¾ä¾‹">2.3 http åè®®ä¸¾ä¾‹</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre></td><td class="rouge-code"><pre><span class="nc">NioEventLoopGroup</span> <span class="n">boss</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">();</span>
<span class="nc">NioEventLoopGroup</span> <span class="n">worker</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">();</span>
<span class="k">try</span> <span class="o">{</span>
    <span class="nc">ServerBootstrap</span> <span class="n">serverBootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServerBootstrap</span><span class="o">();</span>
    <span class="n">serverBootstrap</span><span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">serverBootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">boss</span><span class="o">,</span> <span class="n">worker</span><span class="o">);</span>
    <span class="n">serverBootstrap</span><span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">LoggingHandler</span><span class="o">(</span><span class="nc">LogLevel</span><span class="o">.</span><span class="na">DEBUG</span><span class="o">));</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">HttpServerCodec</span><span class="o">());</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">SimpleChannelInboundHandler</span><span class="o">&lt;</span><span class="nc">HttpRequest</span><span class="o">&gt;()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">channelRead0</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">HttpRequest</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                    <span class="c1">// è·å–è¯·æ±‚</span>
                    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">uri</span><span class="o">());</span>

                    <span class="c1">// è¿”å›å“åº”</span>
                    <span class="nc">DefaultFullHttpResponse</span> <span class="n">response</span> <span class="o">=</span>
                            <span class="k">new</span> <span class="nf">DefaultFullHttpResponse</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">protocolVersion</span><span class="o">(),</span> <span class="nc">HttpResponseStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">);</span>

                    <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="s">"&lt;h1&gt;Hello, world!&lt;/h1&gt;"</span><span class="o">.</span><span class="na">getBytes</span><span class="o">();</span>

                    <span class="n">response</span><span class="o">.</span><span class="na">headers</span><span class="o">().</span><span class="na">setInt</span><span class="o">(</span><span class="no">CONTENT_LENGTH</span><span class="o">,</span> <span class="n">bytes</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
                    <span class="n">response</span><span class="o">.</span><span class="na">content</span><span class="o">().</span><span class="na">writeBytes</span><span class="o">(</span><span class="n">bytes</span><span class="o">);</span>

                    <span class="c1">// å†™å›å“åº”</span>
                    <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">response</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">});</span>
            <span class="cm">/*ch.pipeline().addLast(new ChannelInboundHandlerAdapter() {
                @Override
                public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {
                    log.debug("{}", msg.getClass());

                    if (msg instanceof HttpRequest) { // è¯·æ±‚è¡Œï¼Œè¯·æ±‚å¤´

                    } else if (msg instanceof HttpContent) { //è¯·æ±‚ä½“

                    }
                }
            });*/</span>
        <span class="o">}</span>
    <span class="o">});</span>
    <span class="nc">ChannelFuture</span> <span class="n">channelFuture</span> <span class="o">=</span> <span class="n">serverBootstrap</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="mi">8080</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>
    <span class="n">channelFuture</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"server error"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
    <span class="n">boss</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
    <span class="n">worker</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="24-è‡ªå®šä¹‰åè®®è¦ç´ ">2.4 è‡ªå®šä¹‰åè®®è¦ç´ </h3>

<ul>
  <li>é­”æ•°ï¼Œç”¨æ¥åœ¨ç¬¬ä¸€æ—¶é—´åˆ¤å®šæ˜¯å¦æ˜¯æ— æ•ˆæ•°æ®åŒ…</li>
  <li>ç‰ˆæœ¬å·ï¼Œå¯ä»¥æ”¯æŒåè®®çš„å‡çº§</li>
  <li>åºåˆ—åŒ–ç®—æ³•ï¼Œæ¶ˆæ¯æ­£æ–‡åˆ°åº•é‡‡ç”¨å“ªç§åºåˆ—åŒ–ååºåˆ—åŒ–æ–¹å¼ï¼Œå¯ä»¥ç”±æ­¤æ‰©å±•ï¼Œä¾‹å¦‚ï¼šjsonã€protobufã€hessianã€jdk</li>
  <li>æŒ‡ä»¤ç±»å‹ï¼Œæ˜¯ç™»å½•ã€æ³¨å†Œã€å•èŠã€ç¾¤èŠâ€¦ è·Ÿä¸šåŠ¡ç›¸å…³</li>
  <li>è¯·æ±‚åºå·ï¼Œä¸ºäº†åŒå·¥é€šä¿¡ï¼Œæä¾›å¼‚æ­¥èƒ½åŠ›</li>
  <li>æ­£æ–‡é•¿åº¦</li>
  <li>æ¶ˆæ¯æ­£æ–‡</li>
</ul>

<h4 id="ç¼–è§£ç å™¨">ç¼–è§£ç å™¨</h4>

<p>æ ¹æ®ä¸Šé¢çš„è¦ç´ ï¼Œè®¾è®¡ä¸€ä¸ªç™»å½•è¯·æ±‚æ¶ˆæ¯å’Œç™»å½•å“åº”æ¶ˆæ¯ï¼Œå¹¶ä½¿ç”¨ Netty å®Œæˆæ”¶å‘</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
</pre></td><td class="rouge-code"><pre><span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MessageCodec</span> <span class="kd">extends</span> <span class="nc">ByteToMessageCodec</span><span class="o">&lt;</span><span class="nc">Message</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">encode</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Message</span> <span class="n">msg</span><span class="o">,</span> <span class="nc">ByteBuf</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="c1">// 1. 4 å­—èŠ‚çš„é­”æ•°</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="k">new</span> <span class="kt">byte</span><span class="o">[]{</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">});</span>
        <span class="c1">// 2. 1 å­—èŠ‚çš„ç‰ˆæœ¬,</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="c1">// 3. 1 å­—èŠ‚çš„åºåˆ—åŒ–æ–¹å¼ jdk 0 , json 1</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
        <span class="c1">// 4. 1 å­—èŠ‚çš„æŒ‡ä»¤ç±»å‹</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">getMessageType</span><span class="o">());</span>
        <span class="c1">// 5. 4 ä¸ªå­—èŠ‚</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">getSequenceId</span><span class="o">());</span>
        <span class="c1">// æ— æ„ä¹‰ï¼Œå¯¹é½å¡«å……</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="mh">0xff</span><span class="o">);</span>
        <span class="c1">// 6. è·å–å†…å®¹çš„å­—èŠ‚æ•°ç»„</span>
        <span class="nc">ByteArrayOutputStream</span> <span class="n">bos</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ByteArrayOutputStream</span><span class="o">();</span>
        <span class="nc">ObjectOutputStream</span> <span class="n">oos</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObjectOutputStream</span><span class="o">(</span><span class="n">bos</span><span class="o">);</span>
        <span class="n">oos</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">bos</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">();</span>
        <span class="c1">// 7. é•¿åº¦</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">bytes</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
        <span class="c1">// 8. å†™å…¥å†…å®¹</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="n">bytes</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">decode</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">ByteBuf</span> <span class="n">in</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">magicNum</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">readInt</span><span class="o">();</span>
        <span class="kt">byte</span> <span class="n">version</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">readByte</span><span class="o">();</span>
        <span class="kt">byte</span> <span class="n">serializerType</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">readByte</span><span class="o">();</span>
        <span class="kt">byte</span> <span class="n">messageType</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">readByte</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">sequenceId</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">readInt</span><span class="o">();</span>
        <span class="n">in</span><span class="o">.</span><span class="na">readByte</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">readInt</span><span class="o">();</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">length</span><span class="o">];</span>
        <span class="n">in</span><span class="o">.</span><span class="na">readBytes</span><span class="o">(</span><span class="n">bytes</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">length</span><span class="o">);</span>
        <span class="nc">ObjectInputStream</span> <span class="n">ois</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObjectInputStream</span><span class="o">(</span><span class="k">new</span> <span class="nc">ByteArrayInputStream</span><span class="o">(</span><span class="n">bytes</span><span class="o">));</span>
        <span class="nc">Message</span> <span class="n">message</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Message</span><span class="o">)</span> <span class="n">ois</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"{}, {}, {}, {}, {}, {}"</span><span class="o">,</span> <span class="n">magicNum</span><span class="o">,</span> <span class="n">version</span><span class="o">,</span> <span class="n">serializerType</span><span class="o">,</span> <span class="n">messageType</span><span class="o">,</span> <span class="n">sequenceId</span><span class="o">,</span> <span class="n">length</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"{}"</span><span class="o">,</span> <span class="n">message</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æµ‹è¯•</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="nc">EmbeddedChannel</span> <span class="n">channel</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">EmbeddedChannel</span><span class="o">(</span>
    <span class="k">new</span> <span class="nf">LoggingHandler</span><span class="o">(),</span>
    <span class="k">new</span> <span class="nf">LengthFieldBasedFrameDecoder</span><span class="o">(</span>
        <span class="mi">1024</span><span class="o">,</span> <span class="mi">12</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">),</span>
    <span class="k">new</span> <span class="nf">MessageCodec</span><span class="o">()</span>
<span class="o">);</span>
<span class="c1">// encode</span>
<span class="nc">LoginRequestMessage</span> <span class="n">message</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LoginRequestMessage</span><span class="o">(</span><span class="s">"zhangsan"</span><span class="o">,</span> <span class="s">"123"</span><span class="o">,</span> <span class="s">"å¼ ä¸‰"</span><span class="o">);</span>
<span class="c1">//        channel.writeOutbound(message);</span>
<span class="c1">// decode</span>
<span class="nc">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="nc">ByteBufAllocator</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">.</span><span class="na">buffer</span><span class="o">();</span>
<span class="k">new</span> <span class="nf">MessageCodec</span><span class="o">().</span><span class="na">encode</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">message</span><span class="o">,</span> <span class="n">buf</span><span class="o">);</span>

<span class="nc">ByteBuf</span> <span class="n">s1</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="na">slice</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">100</span><span class="o">);</span>
<span class="nc">ByteBuf</span> <span class="n">s2</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="na">slice</span><span class="o">(</span><span class="mi">100</span><span class="o">,</span> <span class="n">buf</span><span class="o">.</span><span class="na">readableBytes</span><span class="o">()</span> <span class="o">-</span> <span class="mi">100</span><span class="o">);</span>
<span class="n">s1</span><span class="o">.</span><span class="na">retain</span><span class="o">();</span> <span class="c1">// å¼•ç”¨è®¡æ•° 2</span>
<span class="n">channel</span><span class="o">.</span><span class="na">writeInbound</span><span class="o">(</span><span class="n">s1</span><span class="o">);</span> <span class="c1">// release 1</span>
<span class="n">channel</span><span class="o">.</span><span class="na">writeInbound</span><span class="o">(</span><span class="n">s2</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è§£è¯»</p>

<p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0013.png" alt="" /></p>

<h4 id="-ä»€ä¹ˆæ—¶å€™å¯ä»¥åŠ -sharable">ğŸ’¡ ä»€ä¹ˆæ—¶å€™å¯ä»¥åŠ  @Sharable</h4>

<ul>
  <li>å½“ handler ä¸ä¿å­˜çŠ¶æ€æ—¶ï¼Œå°±å¯ä»¥å®‰å…¨åœ°åœ¨å¤šçº¿ç¨‹ä¸‹è¢«å…±äº«</li>
  <li>ä½†è¦æ³¨æ„å¯¹äºç¼–è§£ç å™¨ç±»ï¼Œä¸èƒ½ç»§æ‰¿ ByteToMessageCodec æˆ– CombinedChannelDuplexHandler çˆ¶ç±»ï¼Œä»–ä»¬çš„æ„é€ æ–¹æ³•å¯¹ @Sharable æœ‰é™åˆ¶</li>
  <li>å¦‚æœèƒ½ç¡®ä¿ç¼–è§£ç å™¨ä¸ä¼šä¿å­˜çŠ¶æ€ï¼Œå¯ä»¥ç»§æ‰¿ MessageToMessageCodec çˆ¶ç±»</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
</pre></td><td class="rouge-code"><pre><span class="nd">@Slf4j</span>
<span class="nd">@ChannelHandler</span><span class="o">.</span><span class="na">Sharable</span>
<span class="cm">/**
 * å¿…é¡»å’Œ LengthFieldBasedFrameDecoder ä¸€èµ·ä½¿ç”¨ï¼Œç¡®ä¿æ¥åˆ°çš„ ByteBuf æ¶ˆæ¯æ˜¯å®Œæ•´çš„
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MessageCodecSharable</span> <span class="kd">extends</span> <span class="nc">MessageToMessageCodec</span><span class="o">&lt;</span><span class="nc">ByteBuf</span><span class="o">,</span> <span class="nc">Message</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">encode</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Message</span> <span class="n">msg</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">outList</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">ByteBuf</span> <span class="n">out</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">alloc</span><span class="o">().</span><span class="na">buffer</span><span class="o">();</span>
        <span class="c1">// 1. 4 å­—èŠ‚çš„é­”æ•°</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="k">new</span> <span class="kt">byte</span><span class="o">[]{</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">});</span>
        <span class="c1">// 2. 1 å­—èŠ‚çš„ç‰ˆæœ¬,</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="c1">// 3. 1 å­—èŠ‚çš„åºåˆ—åŒ–æ–¹å¼ jdk 0 , json 1</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
        <span class="c1">// 4. 1 å­—èŠ‚çš„æŒ‡ä»¤ç±»å‹</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">getMessageType</span><span class="o">());</span>
        <span class="c1">// 5. 4 ä¸ªå­—èŠ‚</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">getSequenceId</span><span class="o">());</span>
        <span class="c1">// æ— æ„ä¹‰ï¼Œå¯¹é½å¡«å……</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="mh">0xff</span><span class="o">);</span>
        <span class="c1">// 6. è·å–å†…å®¹çš„å­—èŠ‚æ•°ç»„</span>
        <span class="nc">ByteArrayOutputStream</span> <span class="n">bos</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ByteArrayOutputStream</span><span class="o">();</span>
        <span class="nc">ObjectOutputStream</span> <span class="n">oos</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObjectOutputStream</span><span class="o">(</span><span class="n">bos</span><span class="o">);</span>
        <span class="n">oos</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">bos</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">();</span>
        <span class="c1">// 7. é•¿åº¦</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">bytes</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
        <span class="c1">// 8. å†™å…¥å†…å®¹</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="n">bytes</span><span class="o">);</span>
        <span class="n">outList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">out</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">decode</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">ByteBuf</span> <span class="n">in</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">magicNum</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">readInt</span><span class="o">();</span>
        <span class="kt">byte</span> <span class="n">version</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">readByte</span><span class="o">();</span>
        <span class="kt">byte</span> <span class="n">serializerType</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">readByte</span><span class="o">();</span>
        <span class="kt">byte</span> <span class="n">messageType</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">readByte</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">sequenceId</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">readInt</span><span class="o">();</span>
        <span class="n">in</span><span class="o">.</span><span class="na">readByte</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">readInt</span><span class="o">();</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">length</span><span class="o">];</span>
        <span class="n">in</span><span class="o">.</span><span class="na">readBytes</span><span class="o">(</span><span class="n">bytes</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">length</span><span class="o">);</span>
        <span class="nc">ObjectInputStream</span> <span class="n">ois</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObjectInputStream</span><span class="o">(</span><span class="k">new</span> <span class="nc">ByteArrayInputStream</span><span class="o">(</span><span class="n">bytes</span><span class="o">));</span>
        <span class="nc">Message</span> <span class="n">message</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Message</span><span class="o">)</span> <span class="n">ois</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"{}, {}, {}, {}, {}, {}"</span><span class="o">,</span> <span class="n">magicNum</span><span class="o">,</span> <span class="n">version</span><span class="o">,</span> <span class="n">serializerType</span><span class="o">,</span> <span class="n">messageType</span><span class="o">,</span> <span class="n">sequenceId</span><span class="o">,</span> <span class="n">length</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"{}"</span><span class="o">,</span> <span class="n">message</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="3-èŠå¤©å®¤æ¡ˆä¾‹">3. èŠå¤©å®¤æ¡ˆä¾‹</h2>

<h3 id="31-èŠå¤©å®¤ä¸šåŠ¡ä»‹ç»">3.1 èŠå¤©å®¤ä¸šåŠ¡ä»‹ç»</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="cm">/**
 * ç”¨æˆ·ç®¡ç†æ¥å£
 */</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserService</span> <span class="o">{</span>

    <span class="cm">/**
     * ç™»å½•
     * @param username ç”¨æˆ·å
     * @param password å¯†ç 
     * @return ç™»å½•æˆåŠŸè¿”å› true, å¦åˆ™è¿”å› false
     */</span>
    <span class="kt">boolean</span> <span class="nf">login</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">,</span> <span class="nc">String</span> <span class="n">password</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre></td><td class="rouge-code"><pre><span class="cm">/**
 * ä¼šè¯ç®¡ç†æ¥å£
 */</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Session</span> <span class="o">{</span>

    <span class="cm">/**
     * ç»‘å®šä¼šè¯
     * @param channel å“ªä¸ª channel è¦ç»‘å®šä¼šè¯
     * @param username ä¼šè¯ç»‘å®šç”¨æˆ·
     */</span>
    <span class="kt">void</span> <span class="nf">bind</span><span class="o">(</span><span class="nc">Channel</span> <span class="n">channel</span><span class="o">,</span> <span class="nc">String</span> <span class="n">username</span><span class="o">);</span>

    <span class="cm">/**
     * è§£ç»‘ä¼šè¯
     * @param channel å“ªä¸ª channel è¦è§£ç»‘ä¼šè¯
     */</span>
    <span class="kt">void</span> <span class="nf">unbind</span><span class="o">(</span><span class="nc">Channel</span> <span class="n">channel</span><span class="o">);</span>

    <span class="cm">/**
     * è·å–å±æ€§
     * @param channel å“ªä¸ª channel
     * @param name å±æ€§å
     * @return å±æ€§å€¼
     */</span>
    <span class="nc">Object</span> <span class="nf">getAttribute</span><span class="o">(</span><span class="nc">Channel</span> <span class="n">channel</span><span class="o">,</span> <span class="nc">String</span> <span class="n">name</span><span class="o">);</span>

    <span class="cm">/**
     * è®¾ç½®å±æ€§
     * @param channel å“ªä¸ª channel
     * @param name å±æ€§å
     * @param value å±æ€§å€¼
     */</span>
    <span class="kt">void</span> <span class="nf">setAttribute</span><span class="o">(</span><span class="nc">Channel</span> <span class="n">channel</span><span class="o">,</span> <span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">value</span><span class="o">);</span>

    <span class="cm">/**
     * æ ¹æ®ç”¨æˆ·åè·å– channel
     * @param username ç”¨æˆ·å
     * @return channel
     */</span>
    <span class="nc">Channel</span> <span class="nf">getChannel</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
</pre></td><td class="rouge-code"><pre><span class="cm">/**
 * èŠå¤©ç»„ä¼šè¯ç®¡ç†æ¥å£
 */</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">GroupSession</span> <span class="o">{</span>

    <span class="cm">/**
     * åˆ›å»ºä¸€ä¸ªèŠå¤©ç»„, å¦‚æœä¸å­˜åœ¨æ‰èƒ½åˆ›å»ºæˆåŠŸ, å¦åˆ™è¿”å› null
     * @param name ç»„å
     * @param members æˆå‘˜
     * @return æˆåŠŸæ—¶è¿”å›ç»„å¯¹è±¡, å¤±è´¥è¿”å› null
     */</span>
    <span class="nc">Group</span> <span class="nf">createGroup</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">members</span><span class="o">);</span>

    <span class="cm">/**
     * åŠ å…¥èŠå¤©ç»„
     * @param name ç»„å
     * @param member æˆå‘˜å
     * @return å¦‚æœç»„ä¸å­˜åœ¨è¿”å› null, å¦åˆ™è¿”å›ç»„å¯¹è±¡
     */</span>
    <span class="nc">Group</span> <span class="nf">joinMember</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">String</span> <span class="n">member</span><span class="o">);</span>

    <span class="cm">/**
     * ç§»é™¤ç»„æˆå‘˜
     * @param name ç»„å
     * @param member æˆå‘˜å
     * @return å¦‚æœç»„ä¸å­˜åœ¨è¿”å› null, å¦åˆ™è¿”å›ç»„å¯¹è±¡
     */</span>
    <span class="nc">Group</span> <span class="nf">removeMember</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">String</span> <span class="n">member</span><span class="o">);</span>

    <span class="cm">/**
     * ç§»é™¤èŠå¤©ç»„
     * @param name ç»„å
     * @return å¦‚æœç»„ä¸å­˜åœ¨è¿”å› null, å¦åˆ™è¿”å›ç»„å¯¹è±¡
     */</span>
    <span class="nc">Group</span> <span class="nf">removeGroup</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">);</span>

    <span class="cm">/**
     * è·å–ç»„æˆå‘˜
     * @param name ç»„å
     * @return æˆå‘˜é›†åˆ, æ²¡æœ‰æˆå‘˜ä¼šè¿”å› empty set
     */</span>
    <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">getMembers</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">);</span>

    <span class="cm">/**
     * è·å–ç»„æˆå‘˜çš„ channel é›†åˆ, åªæœ‰åœ¨çº¿çš„ channel æ‰ä¼šè¿”å›
     * @param name ç»„å
     * @return æˆå‘˜ channel é›†åˆ
     */</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Channel</span><span class="o">&gt;</span> <span class="nf">getMembersChannel</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="32-èŠå¤©å®¤ä¸šåŠ¡-ç™»å½•">3.2 èŠå¤©å®¤ä¸šåŠ¡-ç™»å½•</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre></td><td class="rouge-code"><pre><span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ChatServer</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">NioEventLoopGroup</span> <span class="n">boss</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">();</span>
        <span class="nc">NioEventLoopGroup</span> <span class="n">worker</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">();</span>
        <span class="nc">LoggingHandler</span> <span class="no">LOGGING_HANDLER</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LoggingHandler</span><span class="o">(</span><span class="nc">LogLevel</span><span class="o">.</span><span class="na">DEBUG</span><span class="o">);</span>
        <span class="nc">MessageCodecSharable</span> <span class="no">MESSAGE_CODEC</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MessageCodecSharable</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">ServerBootstrap</span> <span class="n">serverBootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServerBootstrap</span><span class="o">();</span>
            <span class="n">serverBootstrap</span><span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="n">serverBootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">boss</span><span class="o">,</span> <span class="n">worker</span><span class="o">);</span>
            <span class="n">serverBootstrap</span><span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                    <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">ProcotolFrameDecoder</span><span class="o">());</span>
                    <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="no">LOGGING_HANDLER</span><span class="o">);</span>
                    <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="no">MESSAGE_CODEC</span><span class="o">);</span>
                    <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">SimpleChannelInboundHandler</span><span class="o">&lt;</span><span class="nc">LoginRequestMessage</span><span class="o">&gt;()</span> <span class="o">{</span>
                        <span class="nd">@Override</span>
                        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">channelRead0</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">LoginRequestMessage</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                            <span class="nc">String</span> <span class="n">username</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">getUsername</span><span class="o">();</span>
                            <span class="nc">String</span> <span class="n">password</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">getPassword</span><span class="o">();</span>
                            <span class="kt">boolean</span> <span class="n">login</span> <span class="o">=</span> <span class="nc">UserServiceFactory</span><span class="o">.</span><span class="na">getUserService</span><span class="o">().</span><span class="na">login</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">password</span><span class="o">);</span>
                            <span class="nc">LoginResponseMessage</span> <span class="n">message</span><span class="o">;</span>
                            <span class="k">if</span><span class="o">(</span><span class="n">login</span><span class="o">)</span> <span class="o">{</span>
                                <span class="n">message</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LoginResponseMessage</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span> <span class="s">"ç™»å½•æˆåŠŸ"</span><span class="o">);</span>
                            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                                <span class="n">message</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LoginResponseMessage</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="s">"ç”¨æˆ·åæˆ–å¯†ç ä¸æ­£ç¡®"</span><span class="o">);</span>
                            <span class="o">}</span>
                            <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
                        <span class="o">}</span>
                    <span class="o">});</span>
                <span class="o">}</span>
            <span class="o">});</span>
            <span class="nc">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">serverBootstrap</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="mi">8080</span><span class="o">).</span><span class="na">sync</span><span class="o">().</span><span class="na">channel</span><span class="o">();</span>
            <span class="n">channel</span><span class="o">.</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"server error"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">boss</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
            <span class="n">worker</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
</pre></td><td class="rouge-code"><pre><span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ChatClient</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">NioEventLoopGroup</span> <span class="n">group</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">();</span>
        <span class="nc">LoggingHandler</span> <span class="no">LOGGING_HANDLER</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LoggingHandler</span><span class="o">(</span><span class="nc">LogLevel</span><span class="o">.</span><span class="na">DEBUG</span><span class="o">);</span>
        <span class="nc">MessageCodecSharable</span> <span class="no">MESSAGE_CODEC</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MessageCodecSharable</span><span class="o">();</span>
        <span class="nc">CountDownLatch</span> <span class="no">WAIT_FOR_LOGIN</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CountDownLatch</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="nc">AtomicBoolean</span> <span class="no">LOGIN</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicBoolean</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Bootstrap</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Bootstrap</span><span class="o">();</span>
            <span class="n">bootstrap</span><span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="n">bootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">group</span><span class="o">);</span>
            <span class="n">bootstrap</span><span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                    <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">ProcotolFrameDecoder</span><span class="o">());</span>
<span class="c1">//                    ch.pipeline().addLast(LOGGING_HANDLER);</span>
                    <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="no">MESSAGE_CODEC</span><span class="o">);</span>
                    <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="s">"client handler"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">ChannelInboundHandlerAdapter</span><span class="o">()</span> <span class="o">{</span>
                        <span class="c1">// æ¥æ”¶å“åº”æ¶ˆæ¯</span>
                        <span class="nd">@Override</span>
                        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"msg: {}"</span><span class="o">,</span> <span class="n">msg</span><span class="o">);</span>
                            <span class="k">if</span> <span class="o">((</span><span class="n">msg</span> <span class="k">instanceof</span> <span class="nc">LoginResponseMessage</span><span class="o">))</span> <span class="o">{</span>
                                <span class="nc">LoginResponseMessage</span> <span class="n">response</span> <span class="o">=</span> <span class="o">(</span><span class="nc">LoginResponseMessage</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
                                <span class="k">if</span> <span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">isSuccess</span><span class="o">())</span> <span class="o">{</span>
                                    <span class="c1">// å¦‚æœç™»å½•æˆåŠŸ</span>
                                    <span class="no">LOGIN</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
                                <span class="o">}</span>
                                <span class="c1">// å”¤é†’ system in çº¿ç¨‹</span>
                                <span class="no">WAIT_FOR_LOGIN</span><span class="o">.</span><span class="na">countDown</span><span class="o">();</span>
                            <span class="o">}</span>
                        <span class="o">}</span>

                        <span class="c1">// åœ¨è¿æ¥å»ºç«‹åè§¦å‘ active äº‹ä»¶</span>
                        <span class="nd">@Override</span>
                        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelActive</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                            <span class="c1">// è´Ÿè´£æ¥æ”¶ç”¨æˆ·åœ¨æ§åˆ¶å°çš„è¾“å…¥ï¼Œè´Ÿè´£å‘æœåŠ¡å™¨å‘é€å„ç§æ¶ˆæ¯</span>
                            <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
                                <span class="nc">Scanner</span> <span class="n">scanner</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Scanner</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">in</span><span class="o">);</span>
                                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"è¯·è¾“å…¥ç”¨æˆ·å:"</span><span class="o">);</span>
                                <span class="nc">String</span> <span class="n">username</span> <span class="o">=</span> <span class="n">scanner</span><span class="o">.</span><span class="na">nextLine</span><span class="o">();</span>
                                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"è¯·è¾“å…¥å¯†ç :"</span><span class="o">);</span>
                                <span class="nc">String</span> <span class="n">password</span> <span class="o">=</span> <span class="n">scanner</span><span class="o">.</span><span class="na">nextLine</span><span class="o">();</span>
                                <span class="c1">// æ„é€ æ¶ˆæ¯å¯¹è±¡</span>
                                <span class="nc">LoginRequestMessage</span> <span class="n">message</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LoginRequestMessage</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">password</span><span class="o">);</span>
                                <span class="c1">// å‘é€æ¶ˆæ¯</span>
                                <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
                                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ç­‰å¾…åç»­æ“ä½œ..."</span><span class="o">);</span>
                                <span class="k">try</span> <span class="o">{</span>
                                    <span class="no">WAIT_FOR_LOGIN</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
                                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                                <span class="o">}</span>
                                <span class="c1">// å¦‚æœç™»å½•å¤±è´¥</span>
                                <span class="k">if</span> <span class="o">(!</span><span class="no">LOGIN</span><span class="o">.</span><span class="na">get</span><span class="o">())</span> <span class="o">{</span>
                                    <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">close</span><span class="o">();</span>
                                    <span class="k">return</span><span class="o">;</span>
                                <span class="o">}</span>
                                <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"=================================="</span><span class="o">);</span>
                                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"send [username] [content]"</span><span class="o">);</span>
                                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"gsend [group name] [content]"</span><span class="o">);</span>
                                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"gcreate [group name] [m1,m2,m3...]"</span><span class="o">);</span>
                                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"gmembers [group name]"</span><span class="o">);</span>
                                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"gjoin [group name]"</span><span class="o">);</span>
                                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"gquit [group name]"</span><span class="o">);</span>
                                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"quit"</span><span class="o">);</span>
                                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"=================================="</span><span class="o">);</span>
                                    <span class="nc">String</span> <span class="n">command</span> <span class="o">=</span> <span class="n">scanner</span><span class="o">.</span><span class="na">nextLine</span><span class="o">();</span>
                                    <span class="nc">String</span><span class="o">[]</span> <span class="n">s</span> <span class="o">=</span> <span class="n">command</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">" "</span><span class="o">);</span>
                                    <span class="k">switch</span> <span class="o">(</span><span class="n">s</span><span class="o">[</span><span class="mi">0</span><span class="o">]){</span>
                                        <span class="k">case</span> <span class="s">"send"</span><span class="o">:</span>
                                            <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChatRequestMessage</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">s</span><span class="o">[</span><span class="mi">1</span><span class="o">],</span> <span class="n">s</span><span class="o">[</span><span class="mi">2</span><span class="o">]));</span>
                                            <span class="k">break</span><span class="o">;</span>
                                        <span class="k">case</span> <span class="s">"gsend"</span><span class="o">:</span>
                                            <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="k">new</span> <span class="nc">GroupChatRequestMessage</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">s</span><span class="o">[</span><span class="mi">1</span><span class="o">],</span> <span class="n">s</span><span class="o">[</span><span class="mi">2</span><span class="o">]));</span>
                                            <span class="k">break</span><span class="o">;</span>
                                        <span class="k">case</span> <span class="s">"gcreate"</span><span class="o">:</span>
                                            <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">set</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">s</span><span class="o">[</span><span class="mi">2</span><span class="o">].</span><span class="na">split</span><span class="o">(</span><span class="s">","</span><span class="o">)));</span>
                                            <span class="n">set</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">username</span><span class="o">);</span> <span class="c1">// åŠ å…¥è‡ªå·±</span>
                                            <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="k">new</span> <span class="nc">GroupCreateRequestMessage</span><span class="o">(</span><span class="n">s</span><span class="o">[</span><span class="mi">1</span><span class="o">],</span> <span class="n">set</span><span class="o">));</span>
                                            <span class="k">break</span><span class="o">;</span>
                                        <span class="k">case</span> <span class="s">"gmembers"</span><span class="o">:</span>
                                            <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="k">new</span> <span class="nc">GroupMembersRequestMessage</span><span class="o">(</span><span class="n">s</span><span class="o">[</span><span class="mi">1</span><span class="o">]));</span>
                                            <span class="k">break</span><span class="o">;</span>
                                        <span class="k">case</span> <span class="s">"gjoin"</span><span class="o">:</span>
                                            <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="k">new</span> <span class="nc">GroupJoinRequestMessage</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">s</span><span class="o">[</span><span class="mi">1</span><span class="o">]));</span>
                                            <span class="k">break</span><span class="o">;</span>
                                        <span class="k">case</span> <span class="s">"gquit"</span><span class="o">:</span>
                                            <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="k">new</span> <span class="nc">GroupQuitRequestMessage</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">s</span><span class="o">[</span><span class="mi">1</span><span class="o">]));</span>
                                            <span class="k">break</span><span class="o">;</span>
                                        <span class="k">case</span> <span class="s">"quit"</span><span class="o">:</span>
                                            <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">close</span><span class="o">();</span>
                                            <span class="k">return</span><span class="o">;</span>
                                    <span class="o">}</span>
                                <span class="o">}</span>
                            <span class="o">},</span> <span class="s">"system in"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
                        <span class="o">}</span>
                    <span class="o">});</span>
                <span class="o">}</span>
            <span class="o">});</span>
            <span class="nc">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">bootstrap</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="mi">8080</span><span class="o">).</span><span class="na">sync</span><span class="o">().</span><span class="na">channel</span><span class="o">();</span>
            <span class="n">channel</span><span class="o">.</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"client error"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">group</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="33-èŠå¤©å®¤ä¸šåŠ¡-å•èŠ">3.3 èŠå¤©å®¤ä¸šåŠ¡-å•èŠ</h3>

<p>æœåŠ¡å™¨ç«¯å°† handler ç‹¬ç«‹å‡ºæ¥</p>

<p>ç™»å½• handler</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="nd">@ChannelHandler</span><span class="o">.</span><span class="na">Sharable</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LoginRequestMessageHandler</span> <span class="kd">extends</span> <span class="nc">SimpleChannelInboundHandler</span><span class="o">&lt;</span><span class="nc">LoginRequestMessage</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">channelRead0</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">LoginRequestMessage</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">username</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">getUsername</span><span class="o">();</span>
        <span class="nc">String</span> <span class="n">password</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">getPassword</span><span class="o">();</span>
        <span class="kt">boolean</span> <span class="n">login</span> <span class="o">=</span> <span class="nc">UserServiceFactory</span><span class="o">.</span><span class="na">getUserService</span><span class="o">().</span><span class="na">login</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">password</span><span class="o">);</span>
        <span class="nc">LoginResponseMessage</span> <span class="n">message</span><span class="o">;</span>
        <span class="k">if</span><span class="o">(</span><span class="n">login</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">SessionFactory</span><span class="o">.</span><span class="na">getSession</span><span class="o">().</span><span class="na">bind</span><span class="o">(</span><span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">(),</span> <span class="n">username</span><span class="o">);</span>
            <span class="n">message</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LoginResponseMessage</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span> <span class="s">"ç™»å½•æˆåŠŸ"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">message</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LoginResponseMessage</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="s">"ç”¨æˆ·åæˆ–å¯†ç ä¸æ­£ç¡®"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å•èŠ handler</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="nd">@ChannelHandler</span><span class="o">.</span><span class="na">Sharable</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ChatRequestMessageHandler</span> <span class="kd">extends</span> <span class="nc">SimpleChannelInboundHandler</span><span class="o">&lt;</span><span class="nc">ChatRequestMessage</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">channelRead0</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">ChatRequestMessage</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">to</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">getTo</span><span class="o">();</span>
        <span class="nc">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="nc">SessionFactory</span><span class="o">.</span><span class="na">getSession</span><span class="o">().</span><span class="na">getChannel</span><span class="o">(</span><span class="n">to</span><span class="o">);</span>
        <span class="c1">// åœ¨çº¿</span>
        <span class="k">if</span><span class="o">(</span><span class="n">channel</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">channel</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChatResponseMessage</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">getFrom</span><span class="o">(),</span> <span class="n">msg</span><span class="o">.</span><span class="na">getContent</span><span class="o">()));</span>
        <span class="o">}</span>
        <span class="c1">// ä¸åœ¨çº¿</span>
        <span class="k">else</span> <span class="o">{</span>
            <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChatResponseMessage</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="s">"å¯¹æ–¹ç”¨æˆ·ä¸å­˜åœ¨æˆ–è€…ä¸åœ¨çº¿"</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="34-èŠå¤©å®¤ä¸šåŠ¡-ç¾¤èŠ">3.4 èŠå¤©å®¤ä¸šåŠ¡-ç¾¤èŠ</h3>

<p>åˆ›å»ºç¾¤èŠ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="nd">@ChannelHandler</span><span class="o">.</span><span class="na">Sharable</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GroupCreateRequestMessageHandler</span> <span class="kd">extends</span> <span class="nc">SimpleChannelInboundHandler</span><span class="o">&lt;</span><span class="nc">GroupCreateRequestMessage</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">channelRead0</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">GroupCreateRequestMessage</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">groupName</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">getGroupName</span><span class="o">();</span>
        <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">members</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">getMembers</span><span class="o">();</span>
        <span class="c1">// ç¾¤ç®¡ç†å™¨</span>
        <span class="nc">GroupSession</span> <span class="n">groupSession</span> <span class="o">=</span> <span class="nc">GroupSessionFactory</span><span class="o">.</span><span class="na">getGroupSession</span><span class="o">();</span>
        <span class="nc">Group</span> <span class="n">group</span> <span class="o">=</span> <span class="n">groupSession</span><span class="o">.</span><span class="na">createGroup</span><span class="o">(</span><span class="n">groupName</span><span class="o">,</span> <span class="n">members</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">group</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// å‘ç”ŸæˆåŠŸæ¶ˆæ¯</span>
            <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="k">new</span> <span class="nc">GroupCreateResponseMessage</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span> <span class="n">groupName</span> <span class="o">+</span> <span class="s">"åˆ›å»ºæˆåŠŸ"</span><span class="o">));</span>
            <span class="c1">// å‘é€æ‹‰ç¾¤æ¶ˆæ¯</span>
            <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Channel</span><span class="o">&gt;</span> <span class="n">channels</span> <span class="o">=</span> <span class="n">groupSession</span><span class="o">.</span><span class="na">getMembersChannel</span><span class="o">(</span><span class="n">groupName</span><span class="o">);</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Channel</span> <span class="n">channel</span> <span class="o">:</span> <span class="n">channels</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">channel</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="k">new</span> <span class="nc">GroupCreateResponseMessage</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span> <span class="s">"æ‚¨å·²è¢«æ‹‰å…¥"</span> <span class="o">+</span> <span class="n">groupName</span><span class="o">));</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="k">new</span> <span class="nc">GroupCreateResponseMessage</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="n">groupName</span> <span class="o">+</span> <span class="s">"å·²ç»å­˜åœ¨"</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç¾¤èŠ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="nd">@ChannelHandler</span><span class="o">.</span><span class="na">Sharable</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GroupChatRequestMessageHandler</span> <span class="kd">extends</span> <span class="nc">SimpleChannelInboundHandler</span><span class="o">&lt;</span><span class="nc">GroupChatRequestMessage</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">channelRead0</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">GroupChatRequestMessage</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Channel</span><span class="o">&gt;</span> <span class="n">channels</span> <span class="o">=</span> <span class="nc">GroupSessionFactory</span><span class="o">.</span><span class="na">getGroupSession</span><span class="o">()</span>
                <span class="o">.</span><span class="na">getMembersChannel</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">getGroupName</span><span class="o">());</span>

        <span class="k">for</span> <span class="o">(</span><span class="nc">Channel</span> <span class="n">channel</span> <span class="o">:</span> <span class="n">channels</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">channel</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="k">new</span> <span class="nc">GroupChatResponseMessage</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">getFrom</span><span class="o">(),</span> <span class="n">msg</span><span class="o">.</span><span class="na">getContent</span><span class="o">()));</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åŠ å…¥ç¾¤èŠ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="nd">@ChannelHandler</span><span class="o">.</span><span class="na">Sharable</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GroupJoinRequestMessageHandler</span> <span class="kd">extends</span> <span class="nc">SimpleChannelInboundHandler</span><span class="o">&lt;</span><span class="nc">GroupJoinRequestMessage</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">channelRead0</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">GroupJoinRequestMessage</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">Group</span> <span class="n">group</span> <span class="o">=</span> <span class="nc">GroupSessionFactory</span><span class="o">.</span><span class="na">getGroupSession</span><span class="o">().</span><span class="na">joinMember</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">getGroupName</span><span class="o">(),</span> <span class="n">msg</span><span class="o">.</span><span class="na">getUsername</span><span class="o">());</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">group</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="k">new</span> <span class="nc">GroupJoinResponseMessage</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span> <span class="n">msg</span><span class="o">.</span><span class="na">getGroupName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"ç¾¤åŠ å…¥æˆåŠŸ"</span><span class="o">));</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="k">new</span> <span class="nc">GroupJoinResponseMessage</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span> <span class="n">msg</span><span class="o">.</span><span class="na">getGroupName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"ç¾¤ä¸å­˜åœ¨"</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>é€€å‡ºç¾¤èŠ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="nd">@ChannelHandler</span><span class="o">.</span><span class="na">Sharable</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GroupQuitRequestMessageHandler</span> <span class="kd">extends</span> <span class="nc">SimpleChannelInboundHandler</span><span class="o">&lt;</span><span class="nc">GroupQuitRequestMessage</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">channelRead0</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">GroupQuitRequestMessage</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">Group</span> <span class="n">group</span> <span class="o">=</span> <span class="nc">GroupSessionFactory</span><span class="o">.</span><span class="na">getGroupSession</span><span class="o">().</span><span class="na">removeMember</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">getGroupName</span><span class="o">(),</span> <span class="n">msg</span><span class="o">.</span><span class="na">getUsername</span><span class="o">());</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">group</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="k">new</span> <span class="nc">GroupJoinResponseMessage</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span> <span class="s">"å·²é€€å‡ºç¾¤"</span> <span class="o">+</span> <span class="n">msg</span><span class="o">.</span><span class="na">getGroupName</span><span class="o">()));</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="k">new</span> <span class="nc">GroupJoinResponseMessage</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span> <span class="n">msg</span><span class="o">.</span><span class="na">getGroupName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"ç¾¤ä¸å­˜åœ¨"</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æŸ¥çœ‹æˆå‘˜</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="nd">@ChannelHandler</span><span class="o">.</span><span class="na">Sharable</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GroupMembersRequestMessageHandler</span> <span class="kd">extends</span> <span class="nc">SimpleChannelInboundHandler</span><span class="o">&lt;</span><span class="nc">GroupMembersRequestMessage</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">channelRead0</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">GroupMembersRequestMessage</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">members</span> <span class="o">=</span> <span class="nc">GroupSessionFactory</span><span class="o">.</span><span class="na">getGroupSession</span><span class="o">()</span>
                <span class="o">.</span><span class="na">getMembers</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">getGroupName</span><span class="o">());</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="k">new</span> <span class="nc">GroupMembersResponseMessage</span><span class="o">(</span><span class="n">members</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="35-èŠå¤©å®¤ä¸šåŠ¡-é€€å‡º">3.5 èŠå¤©å®¤ä¸šåŠ¡-é€€å‡º</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre>@Slf4j
@ChannelHandler.Sharable
public class QuitHandler extends ChannelInboundHandlerAdapter {

    // å½“è¿æ¥æ–­å¼€æ—¶è§¦å‘ inactive äº‹ä»¶
    @Override
    public void channelInactive(ChannelHandlerContext ctx) throws Exception {
        SessionFactory.getSession().unbind(ctx.channel());
        log.debug("{} å·²ç»æ–­å¼€", ctx.channel());
    }

	// å½“å‡ºç°å¼‚å¸¸æ—¶è§¦å‘
    @Override
    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception {
        SessionFactory.getSession().unbind(ctx.channel());
        log.debug("{} å·²ç»å¼‚å¸¸æ–­å¼€ å¼‚å¸¸æ˜¯{}", ctx.channel(), cause.getMessage());
    }
}
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="36-èŠå¤©å®¤ä¸šåŠ¡-ç©ºé—²æ£€æµ‹">3.6 èŠå¤©å®¤ä¸šåŠ¡-ç©ºé—²æ£€æµ‹</h3>

<h4 id="è¿æ¥å‡æ­»">è¿æ¥å‡æ­»</h4>

<p>åŸå› </p>

<ul>
  <li>ç½‘ç»œè®¾å¤‡å‡ºç°æ•…éšœï¼Œä¾‹å¦‚ç½‘å¡ï¼Œæœºæˆ¿ç­‰ï¼Œåº•å±‚çš„ TCP è¿æ¥å·²ç»æ–­å¼€äº†ï¼Œä½†åº”ç”¨ç¨‹åºæ²¡æœ‰æ„ŸçŸ¥åˆ°ï¼Œä»ç„¶å ç”¨ç€èµ„æºã€‚</li>
  <li>å…¬ç½‘ç½‘ç»œä¸ç¨³å®šï¼Œå‡ºç°ä¸¢åŒ…ã€‚å¦‚æœè¿ç»­å‡ºç°ä¸¢åŒ…ï¼Œè¿™æ—¶ç°è±¡å°±æ˜¯å®¢æˆ·ç«¯æ•°æ®å‘ä¸å‡ºå»ï¼ŒæœåŠ¡ç«¯ä¹Ÿä¸€ç›´æ”¶ä¸åˆ°æ•°æ®ï¼Œå°±è¿™ä¹ˆä¸€ç›´è€—ç€</li>
  <li>åº”ç”¨ç¨‹åºçº¿ç¨‹é˜»å¡ï¼Œæ— æ³•è¿›è¡Œæ•°æ®è¯»å†™</li>
</ul>

<p>é—®é¢˜</p>

<ul>
  <li>å‡æ­»çš„è¿æ¥å ç”¨çš„èµ„æºä¸èƒ½è‡ªåŠ¨é‡Šæ”¾</li>
  <li>å‘å‡æ­»çš„è¿æ¥å‘é€æ•°æ®ï¼Œå¾—åˆ°çš„åé¦ˆæ˜¯å‘é€è¶…æ—¶</li>
</ul>

<p>æœåŠ¡å™¨ç«¯è§£å†³</p>

<ul>
  <li>æ€ä¹ˆåˆ¤æ–­å®¢æˆ·ç«¯è¿æ¥æ˜¯å¦å‡æ­»å‘¢ï¼Ÿå¦‚æœèƒ½æ”¶åˆ°å®¢æˆ·ç«¯æ•°æ®ï¼Œè¯´æ˜æ²¡æœ‰å‡æ­»ã€‚å› æ­¤ç­–ç•¥å°±å¯ä»¥å®šä¸ºï¼Œæ¯éš”ä¸€æ®µæ—¶é—´å°±æ£€æŸ¥è¿™æ®µæ—¶é—´å†…æ˜¯å¦æ¥æ”¶åˆ°å®¢æˆ·ç«¯æ•°æ®ï¼Œæ²¡æœ‰å°±å¯ä»¥åˆ¤å®šä¸ºè¿æ¥å‡æ­»</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="c1">// ç”¨æ¥åˆ¤æ–­æ˜¯ä¸æ˜¯ è¯»ç©ºé—²æ—¶é—´è¿‡é•¿ï¼Œæˆ– å†™ç©ºé—²æ—¶é—´è¿‡é•¿</span>
<span class="c1">// 5s å†…å¦‚æœæ²¡æœ‰æ”¶åˆ° channel çš„æ•°æ®ï¼Œä¼šè§¦å‘ä¸€ä¸ª IdleState#READER_IDLE äº‹ä»¶</span>
<span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">IdleStateHandler</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">));</span>
<span class="c1">// ChannelDuplexHandler å¯ä»¥åŒæ—¶ä½œä¸ºå…¥ç«™å’Œå‡ºç«™å¤„ç†å™¨</span>
<span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelDuplexHandler</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// ç”¨æ¥è§¦å‘ç‰¹æ®Šäº‹ä»¶</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">userEventTriggered</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">evt</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">{</span>
        <span class="nc">IdleStateEvent</span> <span class="n">event</span> <span class="o">=</span> <span class="o">(</span><span class="nc">IdleStateEvent</span><span class="o">)</span> <span class="n">evt</span><span class="o">;</span>
        <span class="c1">// è§¦å‘äº†è¯»ç©ºé—²äº‹ä»¶</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">state</span><span class="o">()</span> <span class="o">==</span> <span class="nc">IdleState</span><span class="o">.</span><span class="na">READER_IDLE</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"å·²ç» 5s æ²¡æœ‰è¯»åˆ°æ•°æ®äº†"</span><span class="o">);</span>
            <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">});</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å®¢æˆ·ç«¯å®šæ—¶å¿ƒè·³</p>

<ul>
  <li>å®¢æˆ·ç«¯å¯ä»¥å®šæ—¶å‘æœåŠ¡å™¨ç«¯å‘é€æ•°æ®ï¼Œåªè¦è¿™ä¸ªæ—¶é—´é—´éš”å°äºæœåŠ¡å™¨å®šä¹‰çš„ç©ºé—²æ£€æµ‹çš„æ—¶é—´é—´éš”ï¼Œé‚£ä¹ˆå°±èƒ½é˜²æ­¢å‰é¢æåˆ°çš„è¯¯åˆ¤ï¼Œå®¢æˆ·ç«¯å¯ä»¥å®šä¹‰å¦‚ä¸‹å¿ƒè·³å¤„ç†å™¨</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="c1">// ç”¨æ¥åˆ¤æ–­æ˜¯ä¸æ˜¯ è¯»ç©ºé—²æ—¶é—´è¿‡é•¿ï¼Œæˆ– å†™ç©ºé—²æ—¶é—´è¿‡é•¿</span>
<span class="c1">// 3s å†…å¦‚æœæ²¡æœ‰å‘æœåŠ¡å™¨å†™æ•°æ®ï¼Œä¼šè§¦å‘ä¸€ä¸ª IdleState#WRITER_IDLE äº‹ä»¶</span>
<span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">IdleStateHandler</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">0</span><span class="o">));</span>
<span class="c1">// ChannelDuplexHandler å¯ä»¥åŒæ—¶ä½œä¸ºå…¥ç«™å’Œå‡ºç«™å¤„ç†å™¨</span>
<span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelDuplexHandler</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// ç”¨æ¥è§¦å‘ç‰¹æ®Šäº‹ä»¶</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">userEventTriggered</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">evt</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">{</span>
        <span class="nc">IdleStateEvent</span> <span class="n">event</span> <span class="o">=</span> <span class="o">(</span><span class="nc">IdleStateEvent</span><span class="o">)</span> <span class="n">evt</span><span class="o">;</span>
        <span class="c1">// è§¦å‘äº†å†™ç©ºé—²äº‹ä»¶</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">state</span><span class="o">()</span> <span class="o">==</span> <span class="nc">IdleState</span><span class="o">.</span><span class="na">WRITER_IDLE</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">//                                log.debug("3s æ²¡æœ‰å†™æ•°æ®äº†ï¼Œå‘é€ä¸€ä¸ªå¿ƒè·³åŒ…");</span>
            <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="k">new</span> <span class="nc">PingMessage</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">});</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h1 id="å››-ä¼˜åŒ–ä¸æºç ">å››. ä¼˜åŒ–ä¸æºç </h1>

<h2 id="1-ä¼˜åŒ–">1. ä¼˜åŒ–</h2>

<h3 id="11-æ‰©å±•åºåˆ—åŒ–ç®—æ³•">1.1 æ‰©å±•åºåˆ—åŒ–ç®—æ³•</h3>

<p>åºåˆ—åŒ–ï¼Œååºåˆ—åŒ–ä¸»è¦ç”¨åœ¨æ¶ˆæ¯æ­£æ–‡çš„è½¬æ¢ä¸Š</p>

<ul>
  <li>åºåˆ—åŒ–æ—¶ï¼Œéœ€è¦å°† Java å¯¹è±¡å˜ä¸ºè¦ä¼ è¾“çš„æ•°æ®ï¼ˆå¯ä»¥æ˜¯ byte[]ï¼Œæˆ– json ç­‰ï¼Œæœ€ç»ˆéƒ½éœ€è¦å˜æˆ byte[]ï¼‰</li>
  <li>ååºåˆ—åŒ–æ—¶ï¼Œéœ€è¦å°†ä¼ å…¥çš„æ­£æ–‡æ•°æ®è¿˜åŸæˆ Java å¯¹è±¡ï¼Œä¾¿äºå¤„ç†</li>
</ul>

<p>ç›®å‰çš„ä»£ç ä»…æ”¯æŒ Java è‡ªå¸¦çš„åºåˆ—åŒ–ï¼Œååºåˆ—åŒ–æœºåˆ¶ï¼Œæ ¸å¿ƒä»£ç å¦‚ä¸‹</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="c1">// ååºåˆ—åŒ–</span>
<span class="kt">byte</span><span class="o">[]</span> <span class="n">body</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">bodyLength</span><span class="o">];</span>
<span class="n">byteByf</span><span class="o">.</span><span class="na">readBytes</span><span class="o">(</span><span class="n">body</span><span class="o">);</span>
<span class="nc">ObjectInputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObjectInputStream</span><span class="o">(</span><span class="k">new</span> <span class="nc">ByteArrayInputStream</span><span class="o">(</span><span class="n">body</span><span class="o">));</span>
<span class="nc">Message</span> <span class="n">message</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Message</span><span class="o">)</span> <span class="n">in</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
<span class="n">message</span><span class="o">.</span><span class="na">setSequenceId</span><span class="o">(</span><span class="n">sequenceId</span><span class="o">);</span>

<span class="c1">// åºåˆ—åŒ–</span>
<span class="nc">ByteArrayOutputStream</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ByteArrayOutputStream</span><span class="o">();</span>
<span class="k">new</span> <span class="nf">ObjectOutputStream</span><span class="o">(</span><span class="n">out</span><span class="o">).</span><span class="na">writeObject</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
<span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">();</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä¸ºäº†æ”¯æŒæ›´å¤šåºåˆ—åŒ–ç®—æ³•ï¼ŒæŠ½è±¡ä¸€ä¸ª Serializer æ¥å£</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Serializer</span> <span class="o">{</span>

    <span class="c1">// ååºåˆ—åŒ–æ–¹æ³•</span>
    <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span> <span class="nf">deserialize</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">clazz</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span><span class="o">);</span>

    <span class="c1">// åºåˆ—åŒ–æ–¹æ³•</span>
    <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">serialize</span><span class="o">(</span><span class="no">T</span> <span class="n">object</span><span class="o">);</span>

<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æä¾›ä¸¤ä¸ªå®ç°ï¼Œæˆ‘è¿™é‡Œç›´æ¥å°†å®ç°åŠ å…¥äº†æšä¸¾ç±» Serializer.Algorithm ä¸­</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre></td><td class="rouge-code"><pre><span class="kd">enum</span> <span class="nc">SerializerAlgorithm</span> <span class="kd">implements</span> <span class="nc">Serializer</span> <span class="o">{</span>
	<span class="c1">// Java å®ç°</span>
    <span class="nc">Java</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span> <span class="nf">deserialize</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">clazz</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">ObjectInputStream</span> <span class="n">in</span> <span class="o">=</span> 
                    <span class="k">new</span> <span class="nf">ObjectInputStream</span><span class="o">(</span><span class="k">new</span> <span class="nc">ByteArrayInputStream</span><span class="o">(</span><span class="n">bytes</span><span class="o">));</span>
                <span class="nc">Object</span> <span class="n">object</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
                <span class="k">return</span> <span class="o">(</span><span class="no">T</span><span class="o">)</span> <span class="n">object</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="o">|</span> <span class="nc">ClassNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"SerializerAlgorithm.Java ååºåˆ—åŒ–é”™è¯¯"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">serialize</span><span class="o">(</span><span class="no">T</span> <span class="n">object</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">ByteArrayOutputStream</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ByteArrayOutputStream</span><span class="o">();</span>
                <span class="k">new</span> <span class="nf">ObjectOutputStream</span><span class="o">(</span><span class="n">out</span><span class="o">).</span><span class="na">writeObject</span><span class="o">(</span><span class="n">object</span><span class="o">);</span>
                <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"SerializerAlgorithm.Java åºåˆ—åŒ–é”™è¯¯"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">},</span> 
    <span class="c1">// Json å®ç°(å¼•å…¥äº† Gson ä¾èµ–)</span>
    <span class="nc">Json</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span> <span class="nf">deserialize</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">clazz</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">Gson</span><span class="o">().</span><span class="na">fromJson</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">bytes</span><span class="o">,</span> <span class="nc">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">),</span> <span class="n">clazz</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">serialize</span><span class="o">(</span><span class="no">T</span> <span class="n">object</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">Gson</span><span class="o">().</span><span class="na">toJson</span><span class="o">(</span><span class="n">object</span><span class="o">).</span><span class="na">getBytes</span><span class="o">(</span><span class="nc">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">};</span>

    <span class="c1">// éœ€è¦ä»åè®®çš„å­—èŠ‚ä¸­å¾—åˆ°æ˜¯å“ªç§åºåˆ—åŒ–ç®—æ³•</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">SerializerAlgorithm</span> <span class="nf">getByInt</span><span class="o">(</span><span class="kt">int</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">SerializerAlgorithm</span><span class="o">[]</span> <span class="n">array</span> <span class="o">=</span> <span class="nc">SerializerAlgorithm</span><span class="o">.</span><span class="na">values</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">type</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">type</span> <span class="o">&gt;</span> <span class="n">array</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"è¶…è¿‡ SerializerAlgorithm èŒƒå›´"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">array</span><span class="o">[</span><span class="n">type</span><span class="o">];</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¢åŠ é…ç½®ç±»å’Œé…ç½®æ–‡ä»¶</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Config</span> <span class="o">{</span>
    <span class="kd">static</span> <span class="nc">Properties</span> <span class="n">properties</span><span class="o">;</span>
    <span class="kd">static</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">(</span><span class="nc">InputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="nc">Config</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getResourceAsStream</span><span class="o">(</span><span class="s">"/application.properties"</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">properties</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Properties</span><span class="o">();</span>
            <span class="n">properties</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="n">in</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ExceptionInInitializerError</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">getServerPort</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">value</span> <span class="o">=</span> <span class="n">properties</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">"server.port"</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(</span><span class="n">value</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="mi">8080</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Serializer</span><span class="o">.</span><span class="na">Algorithm</span> <span class="nf">getSerializerAlgorithm</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">value</span> <span class="o">=</span> <span class="n">properties</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">"serializer.algorithm"</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(</span><span class="n">value</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nc">Serializer</span><span class="o">.</span><span class="na">Algorithm</span><span class="o">.</span><span class="na">Java</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nc">Serializer</span><span class="o">.</span><span class="na">Algorithm</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>é…ç½®æ–‡ä»¶</p>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="py">serializer.algorithm</span><span class="p">=</span><span class="s">Json</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä¿®æ”¹ç¼–è§£ç å™¨</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
</pre></td><td class="rouge-code"><pre><span class="cm">/**
 * å¿…é¡»å’Œ LengthFieldBasedFrameDecoder ä¸€èµ·ä½¿ç”¨ï¼Œç¡®ä¿æ¥åˆ°çš„ ByteBuf æ¶ˆæ¯æ˜¯å®Œæ•´çš„
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MessageCodecSharable</span> <span class="kd">extends</span> <span class="nc">MessageToMessageCodec</span><span class="o">&lt;</span><span class="nc">ByteBuf</span><span class="o">,</span> <span class="nc">Message</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">encode</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Message</span> <span class="n">msg</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">outList</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">ByteBuf</span> <span class="n">out</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">alloc</span><span class="o">().</span><span class="na">buffer</span><span class="o">();</span>
        <span class="c1">// 1. 4 å­—èŠ‚çš„é­”æ•°</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="k">new</span> <span class="kt">byte</span><span class="o">[]{</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">});</span>
        <span class="c1">// 2. 1 å­—èŠ‚çš„ç‰ˆæœ¬,</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="c1">// 3. 1 å­—èŠ‚çš„åºåˆ—åŒ–æ–¹å¼ jdk 0 , json 1</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="nc">Config</span><span class="o">.</span><span class="na">getSerializerAlgorithm</span><span class="o">().</span><span class="na">ordinal</span><span class="o">());</span>
        <span class="c1">// 4. 1 å­—èŠ‚çš„æŒ‡ä»¤ç±»å‹</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">getMessageType</span><span class="o">());</span>
        <span class="c1">// 5. 4 ä¸ªå­—èŠ‚</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">getSequenceId</span><span class="o">());</span>
        <span class="c1">// æ— æ„ä¹‰ï¼Œå¯¹é½å¡«å……</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="mh">0xff</span><span class="o">);</span>
        <span class="c1">// 6. è·å–å†…å®¹çš„å­—èŠ‚æ•°ç»„</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="nc">Config</span><span class="o">.</span><span class="na">getSerializerAlgorithm</span><span class="o">().</span><span class="na">serialize</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
        <span class="c1">// 7. é•¿åº¦</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">bytes</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
        <span class="c1">// 8. å†™å…¥å†…å®¹</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="n">bytes</span><span class="o">);</span>
        <span class="n">outList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">out</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">decode</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">ByteBuf</span> <span class="n">in</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">magicNum</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">readInt</span><span class="o">();</span>
        <span class="kt">byte</span> <span class="n">version</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">readByte</span><span class="o">();</span>
        <span class="kt">byte</span> <span class="n">serializerAlgorithm</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">readByte</span><span class="o">();</span> <span class="c1">// 0 æˆ– 1</span>
        <span class="kt">byte</span> <span class="n">messageType</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">readByte</span><span class="o">();</span> <span class="c1">// 0,1,2...</span>
        <span class="kt">int</span> <span class="n">sequenceId</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">readInt</span><span class="o">();</span>
        <span class="n">in</span><span class="o">.</span><span class="na">readByte</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">readInt</span><span class="o">();</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">length</span><span class="o">];</span>
        <span class="n">in</span><span class="o">.</span><span class="na">readBytes</span><span class="o">(</span><span class="n">bytes</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">length</span><span class="o">);</span>

        <span class="c1">// æ‰¾åˆ°ååºåˆ—åŒ–ç®—æ³•</span>
        <span class="nc">Serializer</span><span class="o">.</span><span class="na">Algorithm</span> <span class="n">algorithm</span> <span class="o">=</span> <span class="nc">Serializer</span><span class="o">.</span><span class="na">Algorithm</span><span class="o">.</span><span class="na">values</span><span class="o">()[</span><span class="n">serializerAlgorithm</span><span class="o">];</span>
        <span class="c1">// ç¡®å®šå…·ä½“æ¶ˆæ¯ç±»å‹</span>
        <span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Message</span><span class="o">&gt;</span> <span class="n">messageClass</span> <span class="o">=</span> <span class="nc">Message</span><span class="o">.</span><span class="na">getMessageClass</span><span class="o">(</span><span class="n">messageType</span><span class="o">);</span>
        <span class="nc">Message</span> <span class="n">message</span> <span class="o">=</span> <span class="n">algorithm</span><span class="o">.</span><span class="na">deserialize</span><span class="o">(</span><span class="n">messageClass</span><span class="o">,</span> <span class="n">bytes</span><span class="o">);</span>
<span class="c1">//        log.debug("{}, {}, {}, {}, {}, {}", magicNum, version, serializerType, messageType, sequenceId, length);</span>
<span class="c1">//        log.debug("{}", message);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å…¶ä¸­ç¡®å®šå…·ä½“æ¶ˆæ¯ç±»å‹ï¼Œå¯ä»¥æ ¹æ® <code class="language-plaintext highlighter-rouge">æ¶ˆæ¯ç±»å‹å­—èŠ‚</code> è·å–åˆ°å¯¹åº”çš„ <code class="language-plaintext highlighter-rouge">æ¶ˆæ¯ class</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
</pre></td><td class="rouge-code"><pre><span class="nd">@Data</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Message</span> <span class="kd">implements</span> <span class="nc">Serializable</span> <span class="o">{</span>

    <span class="cm">/**
     * æ ¹æ®æ¶ˆæ¯ç±»å‹å­—èŠ‚ï¼Œè·å¾—å¯¹åº”çš„æ¶ˆæ¯ class
     * @param messageType æ¶ˆæ¯ç±»å‹å­—èŠ‚
     * @return æ¶ˆæ¯ class
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Message</span><span class="o">&gt;</span> <span class="nf">getMessageClass</span><span class="o">(</span><span class="kt">int</span> <span class="n">messageType</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">messageClasses</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">messageType</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">sequenceId</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">messageType</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">int</span> <span class="nf">getMessageType</span><span class="o">();</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nc">LoginRequestMessage</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nc">LoginResponseMessage</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nc">ChatRequestMessage</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nc">ChatResponseMessage</span> <span class="o">=</span> <span class="mi">3</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nc">GroupCreateRequestMessage</span> <span class="o">=</span> <span class="mi">4</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nc">GroupCreateResponseMessage</span> <span class="o">=</span> <span class="mi">5</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nc">GroupJoinRequestMessage</span> <span class="o">=</span> <span class="mi">6</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nc">GroupJoinResponseMessage</span> <span class="o">=</span> <span class="mi">7</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nc">GroupQuitRequestMessage</span> <span class="o">=</span> <span class="mi">8</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nc">GroupQuitResponseMessage</span> <span class="o">=</span> <span class="mi">9</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nc">GroupChatRequestMessage</span> <span class="o">=</span> <span class="mi">10</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nc">GroupChatResponseMessage</span> <span class="o">=</span> <span class="mi">11</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nc">GroupMembersRequestMessage</span> <span class="o">=</span> <span class="mi">12</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nc">GroupMembersResponseMessage</span> <span class="o">=</span> <span class="mi">13</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nc">PingMessage</span> <span class="o">=</span> <span class="mi">14</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nc">PongMessage</span> <span class="o">=</span> <span class="mi">15</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Message</span><span class="o">&gt;&gt;</span> <span class="n">messageClasses</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>

    <span class="kd">static</span> <span class="o">{</span>
        <span class="n">messageClasses</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">LoginRequestMessage</span><span class="o">,</span> <span class="nc">LoginRequestMessage</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">messageClasses</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">LoginResponseMessage</span><span class="o">,</span> <span class="nc">LoginResponseMessage</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">messageClasses</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">ChatRequestMessage</span><span class="o">,</span> <span class="nc">ChatRequestMessage</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">messageClasses</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">ChatResponseMessage</span><span class="o">,</span> <span class="nc">ChatResponseMessage</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">messageClasses</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">GroupCreateRequestMessage</span><span class="o">,</span> <span class="nc">GroupCreateRequestMessage</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">messageClasses</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">GroupCreateResponseMessage</span><span class="o">,</span> <span class="nc">GroupCreateResponseMessage</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">messageClasses</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">GroupJoinRequestMessage</span><span class="o">,</span> <span class="nc">GroupJoinRequestMessage</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">messageClasses</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">GroupJoinResponseMessage</span><span class="o">,</span> <span class="nc">GroupJoinResponseMessage</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">messageClasses</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">GroupQuitRequestMessage</span><span class="o">,</span> <span class="nc">GroupQuitRequestMessage</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">messageClasses</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">GroupQuitResponseMessage</span><span class="o">,</span> <span class="nc">GroupQuitResponseMessage</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">messageClasses</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">GroupChatRequestMessage</span><span class="o">,</span> <span class="nc">GroupChatRequestMessage</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">messageClasses</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">GroupChatResponseMessage</span><span class="o">,</span> <span class="nc">GroupChatResponseMessage</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">messageClasses</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">GroupMembersRequestMessage</span><span class="o">,</span> <span class="nc">GroupMembersRequestMessage</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">messageClasses</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">GroupMembersResponseMessage</span><span class="o">,</span> <span class="nc">GroupMembersResponseMessage</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="12-å‚æ•°è°ƒä¼˜">1.2 å‚æ•°è°ƒä¼˜</h3>

<h4 id="1connect_timeout_millis">1ï¼‰CONNECT_TIMEOUT_MILLIS</h4>

<ul>
  <li>å±äº SocketChannal å‚æ•°</li>
  <li>
    <p>ç”¨åœ¨å®¢æˆ·ç«¯å»ºç«‹è¿æ¥æ—¶ï¼Œå¦‚æœåœ¨æŒ‡å®šæ¯«ç§’å†…æ— æ³•è¿æ¥ï¼Œä¼šæŠ›å‡º timeout å¼‚å¸¸</p>
  </li>
  <li>SO_TIMEOUT ä¸»è¦ç”¨åœ¨é˜»å¡ IOï¼Œé˜»å¡ IO ä¸­ acceptï¼Œread ç­‰éƒ½æ˜¯æ— é™ç­‰å¾…çš„ï¼Œå¦‚æœä¸å¸Œæœ›æ°¸è¿œé˜»å¡ï¼Œä½¿ç”¨å®ƒè°ƒæ•´è¶…æ—¶æ—¶é—´</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestConnectionTimeout</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">NioEventLoopGroup</span> <span class="n">group</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Bootstrap</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Bootstrap</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">group</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">option</span><span class="o">(</span><span class="nc">ChannelOption</span><span class="o">.</span><span class="na">CONNECT_TIMEOUT_MILLIS</span><span class="o">,</span> <span class="mi">300</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">LoggingHandler</span><span class="o">());</span>
            <span class="nc">ChannelFuture</span> <span class="n">future</span> <span class="o">=</span> <span class="n">bootstrap</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="s">"127.0.0.1"</span><span class="o">,</span> <span class="mi">8080</span><span class="o">);</span>
            <span class="n">future</span><span class="o">.</span><span class="na">sync</span><span class="o">().</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span> <span class="c1">// æ–­ç‚¹1</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"timeout"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">group</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¦å¤–æºç éƒ¨åˆ† <code class="language-plaintext highlighter-rouge">io.netty.channel.nio.AbstractNioChannel.AbstractNioUnsafe#connect</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">connect</span><span class="o">(</span>
        <span class="kd">final</span> <span class="nc">SocketAddress</span> <span class="n">remoteAddress</span><span class="o">,</span> <span class="kd">final</span> <span class="nc">SocketAddress</span> <span class="n">localAddress</span><span class="o">,</span> <span class="kd">final</span> <span class="nc">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// ...</span>
    <span class="c1">// Schedule connect timeout.</span>
    <span class="kt">int</span> <span class="n">connectTimeoutMillis</span> <span class="o">=</span> <span class="n">config</span><span class="o">().</span><span class="na">getConnectTimeoutMillis</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">connectTimeoutMillis</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">connectTimeoutFuture</span> <span class="o">=</span> <span class="n">eventLoop</span><span class="o">().</span><span class="na">schedule</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>                
                <span class="nc">ChannelPromise</span> <span class="n">connectPromise</span> <span class="o">=</span> <span class="nc">AbstractNioChannel</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">connectPromise</span><span class="o">;</span>
                <span class="nc">ConnectTimeoutException</span> <span class="n">cause</span> <span class="o">=</span>
                    <span class="k">new</span> <span class="nf">ConnectTimeoutException</span><span class="o">(</span><span class="s">"connection timed out: "</span> <span class="o">+</span> <span class="n">remoteAddress</span><span class="o">);</span> <span class="c1">// æ–­ç‚¹2</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">connectPromise</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">connectPromise</span><span class="o">.</span><span class="na">tryFailure</span><span class="o">(</span><span class="n">cause</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">close</span><span class="o">(</span><span class="n">voidPromise</span><span class="o">());</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">},</span> <span class="n">connectTimeoutMillis</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">);</span>
    <span class="o">}</span>
	<span class="c1">// ...</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="2so_backlog">2ï¼‰SO_BACKLOG</h4>

<ul>
  <li>å±äº ServerSocketChannal å‚æ•°</li>
</ul>

<pre><code class="language-mermaid">sequenceDiagram

participant c as client
participant s as server
participant sq as syns queue
participant aq as accept queue

s -&gt;&gt; s : bind()
s -&gt;&gt; s : listen()
c -&gt;&gt; c : connect()
c -&gt;&gt; s : 1. SYN
Note left of c : SYN_SEND
s -&gt;&gt; sq : put
Note right of s : SYN_RCVD
s -&gt;&gt; c : 2. SYN + ACK
Note left of c : ESTABLISHED
c -&gt;&gt; s : 3. ACK
sq -&gt;&gt; aq : put
Note right of s : ESTABLISHED
aq --&gt;&gt; s : 
s -&gt;&gt; s : accept()
</code></pre>

<ol>
  <li>ç¬¬ä¸€æ¬¡æ¡æ‰‹ï¼Œclient å‘é€ SYN åˆ° serverï¼ŒçŠ¶æ€ä¿®æ”¹ä¸º SYN_SENDï¼Œserver æ”¶åˆ°ï¼ŒçŠ¶æ€æ”¹å˜ä¸º SYN_REVDï¼Œå¹¶å°†è¯¥è¯·æ±‚æ”¾å…¥ sync queue é˜Ÿåˆ—</li>
  <li>ç¬¬äºŒæ¬¡æ¡æ‰‹ï¼Œserver å›å¤ SYN + ACK ç»™ clientï¼Œclient æ”¶åˆ°ï¼ŒçŠ¶æ€æ”¹å˜ä¸º ESTABLISHEDï¼Œå¹¶å‘é€ ACK ç»™ server</li>
  <li>ç¬¬ä¸‰æ¬¡æ¡æ‰‹ï¼Œserver æ”¶åˆ° ACKï¼ŒçŠ¶æ€æ”¹å˜ä¸º ESTABLISHEDï¼Œå°†è¯¥è¯·æ±‚ä» sync queue æ”¾å…¥ accept queue</li>
</ol>

<p>å…¶ä¸­</p>

<ul>
  <li>
    <p>åœ¨ linux 2.2 ä¹‹å‰ï¼Œbacklog å¤§å°åŒ…æ‹¬äº†ä¸¤ä¸ªé˜Ÿåˆ—çš„å¤§å°ï¼Œåœ¨ 2.2 ä¹‹åï¼Œåˆ†åˆ«ç”¨ä¸‹é¢ä¸¤ä¸ªå‚æ•°æ¥æ§åˆ¶</p>
  </li>
  <li>sync queue - åŠè¿æ¥é˜Ÿåˆ—
    <ul>
      <li>å¤§å°é€šè¿‡ /proc/sys/net/ipv4/tcp_max_syn_backlog æŒ‡å®šï¼Œåœ¨ <code class="language-plaintext highlighter-rouge">syncookies</code> å¯ç”¨çš„æƒ…å†µä¸‹ï¼Œé€»è¾‘ä¸Šæ²¡æœ‰æœ€å¤§å€¼é™åˆ¶ï¼Œè¿™ä¸ªè®¾ç½®ä¾¿è¢«å¿½ç•¥</li>
    </ul>
  </li>
  <li>accept queue - å…¨è¿æ¥é˜Ÿåˆ—
    <ul>
      <li>å…¶å¤§å°é€šè¿‡ /proc/sys/net/core/somaxconn æŒ‡å®šï¼Œåœ¨ä½¿ç”¨ listen å‡½æ•°æ—¶ï¼Œå†…æ ¸ä¼šæ ¹æ®ä¼ å…¥çš„ backlog å‚æ•°ä¸ç³»ç»Ÿå‚æ•°ï¼Œå–äºŒè€…çš„è¾ƒå°å€¼</li>
      <li>å¦‚æœ accpet queue é˜Ÿåˆ—æ»¡äº†ï¼Œserver å°†å‘é€ä¸€ä¸ªæ‹’ç»è¿æ¥çš„é”™è¯¯ä¿¡æ¯åˆ° client</li>
    </ul>
  </li>
</ul>

<p>netty ä¸­</p>

<p>å¯ä»¥é€šè¿‡  option(ChannelOption.SO_BACKLOG, å€¼) æ¥è®¾ç½®å¤§å°</p>

<p>å¯ä»¥é€šè¿‡ä¸‹é¢æºç æŸ¥çœ‹é»˜è®¤å¤§å°</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DefaultServerSocketChannelConfig</span> <span class="kd">extends</span> <span class="nc">DefaultChannelConfig</span>
                                              <span class="kd">implements</span> <span class="nc">ServerSocketChannelConfig</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">backlog</span> <span class="o">=</span> <span class="nc">NetUtil</span><span class="o">.</span><span class="na">SOMAXCONN</span><span class="o">;</span>
    <span class="c1">// ...</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¯¾å ‚è°ƒè¯•å…³é”®æ–­ç‚¹ä¸ºï¼š<code class="language-plaintext highlighter-rouge">io.netty.channel.nio.NioEventLoop#processSelectedKey</code></p>

<p>oio ä¸­æ›´å®¹æ˜“è¯´æ˜ï¼Œä¸ç”¨ debug æ¨¡å¼</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Server</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">ServerSocket</span> <span class="n">ss</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServerSocket</span><span class="o">(</span><span class="mi">8888</span><span class="o">,</span> <span class="mi">2</span><span class="o">);</span>
        <span class="nc">Socket</span> <span class="n">accept</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">accept</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">in</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å®¢æˆ·ç«¯å¯åŠ¨ 4 ä¸ª</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Client</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Socket</span> <span class="n">s</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Socket</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">()+</span><span class="s">" connecting..."</span><span class="o">);</span>
            <span class="n">s</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="mi">8888</span><span class="o">),</span><span class="mi">1000</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">()+</span><span class="s">" connected..."</span><span class="o">);</span>
            <span class="n">s</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">in</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">()+</span><span class="s">" connecting timeout..."</span><span class="o">);</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç¬¬ 1ï¼Œ2ï¼Œ3 ä¸ªå®¢æˆ·ç«¯éƒ½æ‰“å°ï¼Œä½†é™¤äº†ç¬¬ä¸€ä¸ªå¤„äº accpet å¤–ï¼Œå…¶å®ƒä¸¤ä¸ªéƒ½å¤„äº accept queue ä¸­</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nc">Tue</span> <span class="nc">Apr</span> <span class="mi">21</span> <span class="mi">20</span><span class="o">:</span><span class="mi">30</span><span class="o">:</span><span class="mi">28</span> <span class="no">CST</span> <span class="mi">2020</span> <span class="n">connecting</span><span class="o">...</span>
<span class="nc">Tue</span> <span class="nc">Apr</span> <span class="mi">21</span> <span class="mi">20</span><span class="o">:</span><span class="mi">30</span><span class="o">:</span><span class="mi">28</span> <span class="no">CST</span> <span class="mi">2020</span> <span class="n">connected</span><span class="o">...</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç¬¬ 4 ä¸ªå®¢æˆ·ç«¯è¿æ¥æ—¶</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>Tue Apr 21 20:53:58 CST 2020 connecting...
Tue Apr 21 20:53:59 CST 2020 connecting timeout...
java.net.SocketTimeoutException: connect timed out
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="3ulimit--n">3ï¼‰ulimit -n</h4>

<ul>
  <li>å±äºæ“ä½œç³»ç»Ÿå‚æ•°</li>
</ul>

<h4 id="4tcp_nodelay">4ï¼‰TCP_NODELAY</h4>

<ul>
  <li>å±äº SocketChannal å‚æ•°</li>
</ul>

<h4 id="5so_sndbuf--so_rcvbuf">5ï¼‰SO_SNDBUF &amp; SO_RCVBUF</h4>

<ul>
  <li>SO_SNDBUF å±äº SocketChannal å‚æ•°</li>
  <li>SO_RCVBUF æ—¢å¯ç”¨äº SocketChannal å‚æ•°ï¼Œä¹Ÿå¯ä»¥ç”¨äº ServerSocketChannal å‚æ•°ï¼ˆå»ºè®®è®¾ç½®åˆ° ServerSocketChannal ä¸Šï¼‰</li>
</ul>

<h4 id="6allocator">6ï¼‰ALLOCATOR</h4>

<ul>
  <li>å±äº SocketChannal å‚æ•°</li>
  <li>ç”¨æ¥åˆ†é… ByteBufï¼Œ ctx.alloc()</li>
</ul>

<h4 id="7rcvbuf_allocator">7ï¼‰RCVBUF_ALLOCATOR</h4>

<ul>
  <li>å±äº SocketChannal å‚æ•°</li>
  <li>æ§åˆ¶ netty æ¥æ”¶ç¼“å†²åŒºå¤§å°</li>
  <li>è´Ÿè´£å…¥ç«™æ•°æ®çš„åˆ†é…ï¼Œå†³å®šå…¥ç«™ç¼“å†²åŒºçš„å¤§å°ï¼ˆå¹¶å¯åŠ¨æ€è°ƒæ•´ï¼‰ï¼Œç»Ÿä¸€é‡‡ç”¨ direct ç›´æ¥å†…å­˜ï¼Œå…·ä½“æ± åŒ–è¿˜æ˜¯éæ± åŒ–ç”± allocator å†³å®š</li>
</ul>

<h3 id="13-rpc-æ¡†æ¶">1.3 RPC æ¡†æ¶</h3>

<h4 id="1å‡†å¤‡å·¥ä½œ">1ï¼‰å‡†å¤‡å·¥ä½œ</h4>

<p>è¿™äº›ä»£ç å¯ä»¥è®¤ä¸ºæ˜¯ç°æˆçš„ï¼Œæ— éœ€ä»å¤´ç¼–å†™ç»ƒä¹ </p>

<p>ä¸ºäº†ç®€åŒ–èµ·è§ï¼Œåœ¨åŸæ¥èŠå¤©é¡¹ç›®çš„åŸºç¡€ä¸Šæ–°å¢ Rpc è¯·æ±‚å’Œå“åº”æ¶ˆæ¯</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="nd">@Data</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Message</span> <span class="kd">implements</span> <span class="nc">Serializable</span> <span class="o">{</span>

    <span class="c1">// çœç•¥æ—§çš„ä»£ç </span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">RPC_MESSAGE_TYPE_REQUEST</span> <span class="o">=</span> <span class="mi">101</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span>  <span class="no">RPC_MESSAGE_TYPE_RESPONSE</span> <span class="o">=</span> <span class="mi">102</span><span class="o">;</span>

    <span class="kd">static</span> <span class="o">{</span>
        <span class="c1">// ...</span>
        <span class="n">messageClasses</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="no">RPC_MESSAGE_TYPE_REQUEST</span><span class="o">,</span> <span class="nc">RpcRequestMessage</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">messageClasses</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="no">RPC_MESSAGE_TYPE_RESPONSE</span><span class="o">,</span> <span class="nc">RpcResponseMessage</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¯·æ±‚æ¶ˆæ¯</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td><td class="rouge-code"><pre><span class="nd">@Getter</span>
<span class="nd">@ToString</span><span class="o">(</span><span class="n">callSuper</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RpcRequestMessage</span> <span class="kd">extends</span> <span class="nc">Message</span> <span class="o">{</span>

    <span class="cm">/**
     * è°ƒç”¨çš„æ¥å£å…¨é™å®šåï¼ŒæœåŠ¡ç«¯æ ¹æ®å®ƒæ‰¾åˆ°å®ç°
     */</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">interfaceName</span><span class="o">;</span>
    <span class="cm">/**
     * è°ƒç”¨æ¥å£ä¸­çš„æ–¹æ³•å
     */</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">methodName</span><span class="o">;</span>
    <span class="cm">/**
     * æ–¹æ³•è¿”å›ç±»å‹
     */</span>
    <span class="kd">private</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">returnType</span><span class="o">;</span>
    <span class="cm">/**
     * æ–¹æ³•å‚æ•°ç±»å‹æ•°ç»„
     */</span>
    <span class="kd">private</span> <span class="nc">Class</span><span class="o">[]</span> <span class="n">parameterTypes</span><span class="o">;</span>
    <span class="cm">/**
     * æ–¹æ³•å‚æ•°å€¼æ•°ç»„
     */</span>
    <span class="kd">private</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">parameterValue</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">RpcRequestMessage</span><span class="o">(</span><span class="kt">int</span> <span class="n">sequenceId</span><span class="o">,</span> <span class="nc">String</span> <span class="n">interfaceName</span><span class="o">,</span> <span class="nc">String</span> <span class="n">methodName</span><span class="o">,</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">returnType</span><span class="o">,</span> <span class="nc">Class</span><span class="o">[]</span> <span class="n">parameterTypes</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">parameterValue</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">setSequenceId</span><span class="o">(</span><span class="n">sequenceId</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">interfaceName</span> <span class="o">=</span> <span class="n">interfaceName</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">methodName</span> <span class="o">=</span> <span class="n">methodName</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">returnType</span> <span class="o">=</span> <span class="n">returnType</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">parameterTypes</span> <span class="o">=</span> <span class="n">parameterTypes</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">parameterValue</span> <span class="o">=</span> <span class="n">parameterValue</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getMessageType</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="no">RPC_MESSAGE_TYPE_REQUEST</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å“åº”æ¶ˆæ¯</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="nd">@Data</span>
<span class="nd">@ToString</span><span class="o">(</span><span class="n">callSuper</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RpcResponseMessage</span> <span class="kd">extends</span> <span class="nc">Message</span> <span class="o">{</span>
    <span class="cm">/**
     * è¿”å›å€¼
     */</span>
    <span class="kd">private</span> <span class="nc">Object</span> <span class="n">returnValue</span><span class="o">;</span>
    <span class="cm">/**
     * å¼‚å¸¸å€¼
     */</span>
    <span class="kd">private</span> <span class="nc">Exception</span> <span class="n">exceptionValue</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getMessageType</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="no">RPC_MESSAGE_TYPE_RESPONSE</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æœåŠ¡å™¨æ¶å­</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="rouge-code"><pre><span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RpcServer</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">NioEventLoopGroup</span> <span class="n">boss</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">();</span>
        <span class="nc">NioEventLoopGroup</span> <span class="n">worker</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">();</span>
        <span class="nc">LoggingHandler</span> <span class="no">LOGGING_HANDLER</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LoggingHandler</span><span class="o">(</span><span class="nc">LogLevel</span><span class="o">.</span><span class="na">DEBUG</span><span class="o">);</span>
        <span class="nc">MessageCodecSharable</span> <span class="no">MESSAGE_CODEC</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MessageCodecSharable</span><span class="o">();</span>
        
        <span class="c1">// rpc è¯·æ±‚æ¶ˆæ¯å¤„ç†å™¨ï¼Œå¾…å®ç°</span>
        <span class="nc">RpcRequestMessageHandler</span> <span class="no">RPC_HANDLER</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RpcRequestMessageHandler</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">ServerBootstrap</span> <span class="n">serverBootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServerBootstrap</span><span class="o">();</span>
            <span class="n">serverBootstrap</span><span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="n">serverBootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">boss</span><span class="o">,</span> <span class="n">worker</span><span class="o">);</span>
            <span class="n">serverBootstrap</span><span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                    <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">ProcotolFrameDecoder</span><span class="o">());</span>
                    <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="no">LOGGING_HANDLER</span><span class="o">);</span>
                    <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="no">MESSAGE_CODEC</span><span class="o">);</span>
                    <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="no">RPC_HANDLER</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">});</span>
            <span class="nc">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">serverBootstrap</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="mi">8080</span><span class="o">).</span><span class="na">sync</span><span class="o">().</span><span class="na">channel</span><span class="o">();</span>
            <span class="n">channel</span><span class="o">.</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"server error"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">boss</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
            <span class="n">worker</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å®¢æˆ·ç«¯æ¶å­</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RpcClient</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">NioEventLoopGroup</span> <span class="n">group</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">();</span>
        <span class="nc">LoggingHandler</span> <span class="no">LOGGING_HANDLER</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LoggingHandler</span><span class="o">(</span><span class="nc">LogLevel</span><span class="o">.</span><span class="na">DEBUG</span><span class="o">);</span>
        <span class="nc">MessageCodecSharable</span> <span class="no">MESSAGE_CODEC</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MessageCodecSharable</span><span class="o">();</span>
        
        <span class="c1">// rpc å“åº”æ¶ˆæ¯å¤„ç†å™¨ï¼Œå¾…å®ç°</span>
        <span class="nc">RpcResponseMessageHandler</span> <span class="no">RPC_HANDLER</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RpcResponseMessageHandler</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Bootstrap</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Bootstrap</span><span class="o">();</span>
            <span class="n">bootstrap</span><span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="n">bootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">group</span><span class="o">);</span>
            <span class="n">bootstrap</span><span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                    <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">ProcotolFrameDecoder</span><span class="o">());</span>
                    <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="no">LOGGING_HANDLER</span><span class="o">);</span>
                    <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="no">MESSAGE_CODEC</span><span class="o">);</span>
                    <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="no">RPC_HANDLER</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">});</span>
            <span class="nc">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">bootstrap</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="mi">8080</span><span class="o">).</span><span class="na">sync</span><span class="o">().</span><span class="na">channel</span><span class="o">();</span>
            <span class="n">channel</span><span class="o">.</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"client error"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">group</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æœåŠ¡å™¨ç«¯çš„ service è·å–</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ServicesFactory</span> <span class="o">{</span>

    <span class="kd">static</span> <span class="nc">Properties</span> <span class="n">properties</span><span class="o">;</span>
    <span class="kd">static</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?&gt;,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;&gt;();</span>

    <span class="kd">static</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">(</span><span class="nc">InputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="nc">Config</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getResourceAsStream</span><span class="o">(</span><span class="s">"/application.properties"</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">properties</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Properties</span><span class="o">();</span>
            <span class="n">properties</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="n">in</span><span class="o">);</span>
            <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">names</span> <span class="o">=</span> <span class="n">properties</span><span class="o">.</span><span class="na">stringPropertyNames</span><span class="o">();</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">name</span> <span class="o">:</span> <span class="n">names</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">name</span><span class="o">.</span><span class="na">endsWith</span><span class="o">(</span><span class="s">"Service"</span><span class="o">))</span> <span class="o">{</span>
                    <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">interfaceClass</span> <span class="o">=</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
                    <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">instanceClass</span> <span class="o">=</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">properties</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="n">name</span><span class="o">));</span>
                    <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">interfaceClass</span><span class="o">,</span> <span class="n">instanceClass</span><span class="o">.</span><span class="na">newInstance</span><span class="o">());</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="o">|</span> <span class="nc">ClassNotFoundException</span> <span class="o">|</span> <span class="nc">InstantiationException</span> <span class="o">|</span> <span class="nc">IllegalAccessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ExceptionInInitializerError</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span> <span class="nf">getService</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">interfaceClass</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="no">T</span><span class="o">)</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">interfaceClass</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç›¸å…³é…ç½® application.properties</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>serializer.algorithm=Json
cn.itcast.server.service.HelloService=cn.itcast.server.service.HelloServiceImpl
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="2æœåŠ¡å™¨-handler">2ï¼‰æœåŠ¡å™¨ handler</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre><span class="nd">@Slf4j</span>
<span class="nd">@ChannelHandler</span><span class="o">.</span><span class="na">Sharable</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RpcRequestMessageHandler</span> <span class="kd">extends</span> <span class="nc">SimpleChannelInboundHandler</span><span class="o">&lt;</span><span class="nc">RpcRequestMessage</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">channelRead0</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">RpcRequestMessage</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">RpcResponseMessage</span> <span class="n">response</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RpcResponseMessage</span><span class="o">();</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setSequenceId</span><span class="o">(</span><span class="n">message</span><span class="o">.</span><span class="na">getSequenceId</span><span class="o">());</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// è·å–çœŸæ­£çš„å®ç°å¯¹è±¡</span>
            <span class="nc">HelloService</span> <span class="n">service</span> <span class="o">=</span> <span class="o">(</span><span class="nc">HelloService</span><span class="o">)</span>
                    <span class="nc">ServicesFactory</span><span class="o">.</span><span class="na">getService</span><span class="o">(</span><span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">message</span><span class="o">.</span><span class="na">getInterfaceName</span><span class="o">()));</span>
            
            <span class="c1">// è·å–è¦è°ƒç”¨çš„æ–¹æ³•</span>
            <span class="nc">Method</span> <span class="n">method</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getMethod</span><span class="o">(</span><span class="n">message</span><span class="o">.</span><span class="na">getMethodName</span><span class="o">(),</span> <span class="n">message</span><span class="o">.</span><span class="na">getParameterTypes</span><span class="o">());</span>
            
            <span class="c1">// è°ƒç”¨æ–¹æ³•</span>
            <span class="nc">Object</span> <span class="n">invoke</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">service</span><span class="o">,</span> <span class="n">message</span><span class="o">.</span><span class="na">getParameterValue</span><span class="o">());</span>
            <span class="c1">// è°ƒç”¨æˆåŠŸ</span>
            <span class="n">response</span><span class="o">.</span><span class="na">setReturnValue</span><span class="o">(</span><span class="n">invoke</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="c1">// è°ƒç”¨å¼‚å¸¸</span>
            <span class="n">response</span><span class="o">.</span><span class="na">setExceptionValue</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">// è¿”å›ç»“æœ</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">response</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="3å®¢æˆ·ç«¯ä»£ç ç¬¬ä¸€ç‰ˆ">3ï¼‰å®¢æˆ·ç«¯ä»£ç ç¬¬ä¸€ç‰ˆ</h4>

<p>åªå‘æ¶ˆæ¯</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre></td><td class="rouge-code"><pre><span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RpcClient</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">NioEventLoopGroup</span> <span class="n">group</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">();</span>
        <span class="nc">LoggingHandler</span> <span class="no">LOGGING_HANDLER</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LoggingHandler</span><span class="o">(</span><span class="nc">LogLevel</span><span class="o">.</span><span class="na">DEBUG</span><span class="o">);</span>
        <span class="nc">MessageCodecSharable</span> <span class="no">MESSAGE_CODEC</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MessageCodecSharable</span><span class="o">();</span>
        <span class="nc">RpcResponseMessageHandler</span> <span class="no">RPC_HANDLER</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RpcResponseMessageHandler</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Bootstrap</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Bootstrap</span><span class="o">();</span>
            <span class="n">bootstrap</span><span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="n">bootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">group</span><span class="o">);</span>
            <span class="n">bootstrap</span><span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                    <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">ProcotolFrameDecoder</span><span class="o">());</span>
                    <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="no">LOGGING_HANDLER</span><span class="o">);</span>
                    <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="no">MESSAGE_CODEC</span><span class="o">);</span>
                    <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="no">RPC_HANDLER</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">});</span>
            <span class="nc">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">bootstrap</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="mi">8080</span><span class="o">).</span><span class="na">sync</span><span class="o">().</span><span class="na">channel</span><span class="o">();</span>

            <span class="nc">ChannelFuture</span> <span class="n">future</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="k">new</span> <span class="nc">RpcRequestMessage</span><span class="o">(</span>
                    <span class="mi">1</span><span class="o">,</span>
                    <span class="s">"cn.itcast.server.service.HelloService"</span><span class="o">,</span>
                    <span class="s">"sayHello"</span><span class="o">,</span>
                    <span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
                    <span class="k">new</span> <span class="nc">Class</span><span class="o">[]{</span><span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">},</span>
                    <span class="k">new</span> <span class="nc">Object</span><span class="o">[]{</span><span class="s">"å¼ ä¸‰"</span><span class="o">}</span>
            <span class="o">)).</span><span class="na">addListener</span><span class="o">(</span><span class="n">promise</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">promise</span><span class="o">.</span><span class="na">isSuccess</span><span class="o">())</span> <span class="o">{</span>
                    <span class="nc">Throwable</span> <span class="n">cause</span> <span class="o">=</span> <span class="n">promise</span><span class="o">.</span><span class="na">cause</span><span class="o">();</span>
                    <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"error"</span><span class="o">,</span> <span class="n">cause</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">});</span>

            <span class="n">channel</span><span class="o">.</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"client error"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">group</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="4å®¢æˆ·ç«¯-handler-ç¬¬ä¸€ç‰ˆ">4ï¼‰å®¢æˆ·ç«¯ handler ç¬¬ä¸€ç‰ˆ</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="nd">@Slf4j</span>
<span class="nd">@ChannelHandler</span><span class="o">.</span><span class="na">Sharable</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RpcResponseMessageHandler</span> <span class="kd">extends</span> <span class="nc">SimpleChannelInboundHandler</span><span class="o">&lt;</span><span class="nc">RpcResponseMessage</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">channelRead0</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">RpcResponseMessage</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"{}"</span><span class="o">,</span> <span class="n">msg</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="5å®¢æˆ·ç«¯ä»£ç -ç¬¬äºŒç‰ˆ">5ï¼‰å®¢æˆ·ç«¯ä»£ç  ç¬¬äºŒç‰ˆ</h4>

<p>åŒ…æ‹¬ channel ç®¡ç†ï¼Œä»£ç†ï¼Œæ¥æ”¶ç»“æœ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
</pre></td><td class="rouge-code"><pre><span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RpcClientManager</span> <span class="o">{</span>


    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">HelloService</span> <span class="n">service</span> <span class="o">=</span> <span class="n">getProxyService</span><span class="o">(</span><span class="nc">HelloService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">service</span><span class="o">.</span><span class="na">sayHello</span><span class="o">(</span><span class="s">"zhangsan"</span><span class="o">));</span>
<span class="c1">//        System.out.println(service.sayHello("lisi"));</span>
<span class="c1">//        System.out.println(service.sayHello("wangwu"));</span>
    <span class="o">}</span>

    <span class="c1">// åˆ›å»ºä»£ç†ç±»</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span> <span class="nf">getProxyService</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">serviceClass</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ClassLoader</span> <span class="n">loader</span> <span class="o">=</span> <span class="n">serviceClass</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">();</span>
        <span class="nc">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">interfaces</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Class</span><span class="o">[]{</span><span class="n">serviceClass</span><span class="o">};</span>
        <span class="c1">//                                                            sayHello  "å¼ ä¸‰"</span>
        <span class="nc">Object</span> <span class="n">o</span> <span class="o">=</span> <span class="nc">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span><span class="n">loader</span><span class="o">,</span> <span class="n">interfaces</span><span class="o">,</span> <span class="o">(</span><span class="n">proxy</span><span class="o">,</span> <span class="n">method</span><span class="o">,</span> <span class="n">args</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="c1">// 1. å°†æ–¹æ³•è°ƒç”¨è½¬æ¢ä¸º æ¶ˆæ¯å¯¹è±¡</span>
            <span class="kt">int</span> <span class="n">sequenceId</span> <span class="o">=</span> <span class="nc">SequenceIdGenerator</span><span class="o">.</span><span class="na">nextId</span><span class="o">();</span>
            <span class="nc">RpcRequestMessage</span> <span class="n">msg</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RpcRequestMessage</span><span class="o">(</span>
                    <span class="n">sequenceId</span><span class="o">,</span>
                    <span class="n">serviceClass</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span>
                    <span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span>
                    <span class="n">method</span><span class="o">.</span><span class="na">getReturnType</span><span class="o">(),</span>
                    <span class="n">method</span><span class="o">.</span><span class="na">getParameterTypes</span><span class="o">(),</span>
                    <span class="n">args</span>
            <span class="o">);</span>
            <span class="c1">// 2. å°†æ¶ˆæ¯å¯¹è±¡å‘é€å‡ºå»</span>
            <span class="n">getChannel</span><span class="o">().</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>

            <span class="c1">// 3. å‡†å¤‡ä¸€ä¸ªç©º Promise å¯¹è±¡ï¼Œæ¥æ¥æ”¶ç»“æœ             æŒ‡å®š promise å¯¹è±¡å¼‚æ­¥æ¥æ”¶ç»“æœçº¿ç¨‹</span>
            <span class="nc">DefaultPromise</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">promise</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultPromise</span><span class="o">&lt;&gt;(</span><span class="n">getChannel</span><span class="o">().</span><span class="na">eventLoop</span><span class="o">());</span>
            <span class="nc">RpcResponseMessageHandler</span><span class="o">.</span><span class="na">PROMISES</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">sequenceId</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>

<span class="c1">//            promise.addListener(future -&gt; {</span>
<span class="c1">//                // çº¿ç¨‹</span>
<span class="c1">//            });</span>

            <span class="c1">// 4. ç­‰å¾… promise ç»“æœ</span>
            <span class="n">promise</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
            <span class="k">if</span><span class="o">(</span><span class="n">promise</span><span class="o">.</span><span class="na">isSuccess</span><span class="o">())</span> <span class="o">{</span>
                <span class="c1">// è°ƒç”¨æ­£å¸¸</span>
                <span class="k">return</span> <span class="n">promise</span><span class="o">.</span><span class="na">getNow</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="c1">// è°ƒç”¨å¤±è´¥</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">promise</span><span class="o">.</span><span class="na">cause</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="k">return</span> <span class="o">(</span><span class="no">T</span><span class="o">)</span> <span class="n">o</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Object</span> <span class="no">LOCK</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">();</span>

    <span class="c1">// è·å–å”¯ä¸€çš„ channel å¯¹è±¡</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Channel</span> <span class="nf">getChannel</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">channel</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">channel</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="no">LOCK</span><span class="o">)</span> <span class="o">{</span> <span class="c1">//  t2</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">channel</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// t1</span>
                <span class="k">return</span> <span class="n">channel</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">initChannel</span><span class="o">();</span>
            <span class="k">return</span> <span class="n">channel</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// åˆå§‹åŒ– channel æ–¹æ³•</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">NioEventLoopGroup</span> <span class="n">group</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">();</span>
        <span class="nc">LoggingHandler</span> <span class="no">LOGGING_HANDLER</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LoggingHandler</span><span class="o">(</span><span class="nc">LogLevel</span><span class="o">.</span><span class="na">DEBUG</span><span class="o">);</span>
        <span class="nc">MessageCodecSharable</span> <span class="no">MESSAGE_CODEC</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MessageCodecSharable</span><span class="o">();</span>
        <span class="nc">RpcResponseMessageHandler</span> <span class="no">RPC_HANDLER</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RpcResponseMessageHandler</span><span class="o">();</span>
        <span class="nc">Bootstrap</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Bootstrap</span><span class="o">();</span>
        <span class="n">bootstrap</span><span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">bootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">group</span><span class="o">);</span>
        <span class="n">bootstrap</span><span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">ProcotolFrameDecoder</span><span class="o">());</span>
                <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="no">LOGGING_HANDLER</span><span class="o">);</span>
                <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="no">MESSAGE_CODEC</span><span class="o">);</span>
                <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="no">RPC_HANDLER</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">channel</span> <span class="o">=</span> <span class="n">bootstrap</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="mi">8080</span><span class="o">).</span><span class="na">sync</span><span class="o">().</span><span class="na">channel</span><span class="o">();</span>
            <span class="n">channel</span><span class="o">.</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">addListener</span><span class="o">(</span><span class="n">future</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="n">group</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
            <span class="o">});</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"client error"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="6å®¢æˆ·ç«¯-handler-ç¬¬äºŒç‰ˆ">6ï¼‰å®¢æˆ·ç«¯ handler ç¬¬äºŒç‰ˆ</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="nd">@Slf4j</span>
<span class="nd">@ChannelHandler</span><span class="o">.</span><span class="na">Sharable</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RpcResponseMessageHandler</span> <span class="kd">extends</span> <span class="nc">SimpleChannelInboundHandler</span><span class="o">&lt;</span><span class="nc">RpcResponseMessage</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="c1">//                       åºå·      ç”¨æ¥æ¥æ”¶ç»“æœçš„ promise å¯¹è±¡</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">Promise</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;&gt;</span> <span class="no">PROMISES</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;&gt;();</span>

    <span class="nd">@Override</span>

    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">channelRead0</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">RpcResponseMessage</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"{}"</span><span class="o">,</span> <span class="n">msg</span><span class="o">);</span>
        <span class="c1">// æ‹¿åˆ°ç©ºçš„ promise</span>
        <span class="nc">Promise</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">promise</span> <span class="o">=</span> <span class="no">PROMISES</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">getSequenceId</span><span class="o">());</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">promise</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Object</span> <span class="n">returnValue</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">getReturnValue</span><span class="o">();</span>
            <span class="nc">Exception</span> <span class="n">exceptionValue</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">getExceptionValue</span><span class="o">();</span>
            <span class="k">if</span><span class="o">(</span><span class="n">exceptionValue</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">promise</span><span class="o">.</span><span class="na">setFailure</span><span class="o">(</span><span class="n">exceptionValue</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">promise</span><span class="o">.</span><span class="na">setSuccess</span><span class="o">(</span><span class="n">returnValue</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="2-æºç åˆ†æ">2. æºç åˆ†æ</h2>

<h3 id="21-å¯åŠ¨å‰–æ">2.1 å¯åŠ¨å‰–æ</h3>

<p>æˆ‘ä»¬å°±æ¥çœ‹çœ‹ netty ä¸­å¯¹ä¸‹é¢çš„ä»£ç æ˜¯æ€æ ·è¿›è¡Œå¤„ç†çš„</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="c1">//1 netty ä¸­ä½¿ç”¨ NioEventLoopGroup ï¼ˆç®€ç§° nio boss çº¿ç¨‹ï¼‰æ¥å°è£…çº¿ç¨‹å’Œ selector</span>
<span class="nc">Selector</span> <span class="n">selector</span> <span class="o">=</span> <span class="nc">Selector</span><span class="o">.</span><span class="na">open</span><span class="o">();</span> 

<span class="c1">//2 åˆ›å»º NioServerSocketChannelï¼ŒåŒæ—¶ä¼šåˆå§‹åŒ–å®ƒå…³è”çš„ handlerï¼Œä»¥åŠä¸ºåŸç”Ÿ ssc å­˜å‚¨ config</span>
<span class="nc">NioServerSocketChannel</span> <span class="n">attachment</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioServerSocketChannel</span><span class="o">();</span>

<span class="c1">//3 åˆ›å»º NioServerSocketChannel æ—¶ï¼Œåˆ›å»ºäº† java åŸç”Ÿçš„ ServerSocketChannel</span>
<span class="nc">ServerSocketChannel</span> <span class="n">serverSocketChannel</span> <span class="o">=</span> <span class="nc">ServerSocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">();</span> 
<span class="n">serverSocketChannel</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>

<span class="c1">//4 å¯åŠ¨ nio boss çº¿ç¨‹æ‰§è¡Œæ¥ä¸‹æ¥çš„æ“ä½œ</span>

<span class="c1">//5 æ³¨å†Œï¼ˆä»…å…³è” selector å’Œ NioServerSocketChannelï¼‰ï¼Œæœªå…³æ³¨äº‹ä»¶</span>
<span class="nc">SelectionKey</span> <span class="n">selectionKey</span> <span class="o">=</span> <span class="n">serverSocketChannel</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">selector</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">attachment</span><span class="o">);</span>

<span class="c1">//6 head -&gt; åˆå§‹åŒ–å™¨ -&gt; ServerBootstrapAcceptor -&gt; tailï¼Œåˆå§‹åŒ–å™¨æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œåªä¸ºæ·»åŠ  acceptor</span>

<span class="c1">//7 ç»‘å®šç«¯å£</span>
<span class="n">serverSocketChannel</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="mi">8080</span><span class="o">));</span>

<span class="c1">//8 è§¦å‘ channel active äº‹ä»¶ï¼Œåœ¨ head ä¸­å…³æ³¨ op_accept äº‹ä»¶</span>
<span class="n">selectionKey</span><span class="o">.</span><span class="na">interestOps</span><span class="o">(</span><span class="nc">SelectionKey</span><span class="o">.</span><span class="na">OP_ACCEPT</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å…¥å£ <code class="language-plaintext highlighter-rouge">io.netty.bootstrap.ServerBootstrap#bind</code></p>

<p>å…³é”®ä»£ç  <code class="language-plaintext highlighter-rouge">io.netty.bootstrap.AbstractBootstrap#doBind</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="nc">ChannelFuture</span> <span class="nf">doBind</span><span class="o">(</span><span class="kd">final</span> <span class="nc">SocketAddress</span> <span class="n">localAddress</span><span class="o">)</span> <span class="o">{</span>
	<span class="c1">// 1. æ‰§è¡Œåˆå§‹åŒ–å’Œæ³¨å†Œ regFuture ä¼šç”± initAndRegister è®¾ç½®å…¶æ˜¯å¦å®Œæˆï¼Œä»è€Œå›è°ƒ 3.2 å¤„ä»£ç </span>
    <span class="kd">final</span> <span class="nc">ChannelFuture</span> <span class="n">regFuture</span> <span class="o">=</span> <span class="n">initAndRegister</span><span class="o">();</span>
    <span class="kd">final</span> <span class="nc">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">regFuture</span><span class="o">.</span><span class="na">channel</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">regFuture</span><span class="o">.</span><span class="na">cause</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">regFuture</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// 2. å› ä¸ºæ˜¯ initAndRegister å¼‚æ­¥æ‰§è¡Œï¼Œéœ€è¦åˆ†ä¸¤ç§æƒ…å†µæ¥çœ‹ï¼Œè°ƒè¯•æ—¶ä¹Ÿéœ€è¦é€šè¿‡ suspend æ–­ç‚¹ç±»å‹åŠ ä»¥åŒºåˆ†</span>
    <span class="c1">// 2.1 å¦‚æœå·²ç»å®Œæˆ</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">regFuture</span><span class="o">.</span><span class="na">isDone</span><span class="o">())</span> <span class="o">{</span>
        <span class="nc">ChannelPromise</span> <span class="n">promise</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="na">newPromise</span><span class="o">();</span>
        <span class="c1">// 3.1 ç«‹åˆ»è°ƒç”¨ doBind0</span>
        <span class="n">doBind0</span><span class="o">(</span><span class="n">regFuture</span><span class="o">,</span> <span class="n">channel</span><span class="o">,</span> <span class="n">localAddress</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">promise</span><span class="o">;</span>
    <span class="o">}</span> 
    <span class="c1">// 2.2 è¿˜æ²¡æœ‰å®Œæˆ</span>
    <span class="k">else</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">PendingRegistrationPromise</span> <span class="n">promise</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PendingRegistrationPromise</span><span class="o">(</span><span class="n">channel</span><span class="o">);</span>
        <span class="c1">// 3.2 å›è°ƒ doBind0</span>
        <span class="n">regFuture</span><span class="o">.</span><span class="na">addListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelFutureListener</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">operationComplete</span><span class="o">(</span><span class="nc">ChannelFuture</span> <span class="n">future</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                <span class="nc">Throwable</span> <span class="n">cause</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="na">cause</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">cause</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// å¤„ç†å¼‚å¸¸...</span>
                    <span class="n">promise</span><span class="o">.</span><span class="na">setFailure</span><span class="o">(</span><span class="n">cause</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="n">promise</span><span class="o">.</span><span class="na">registered</span><span class="o">();</span>
					<span class="c1">// 3. ç”±æ³¨å†Œçº¿ç¨‹å»æ‰§è¡Œ doBind0</span>
                    <span class="n">doBind0</span><span class="o">(</span><span class="n">regFuture</span><span class="o">,</span> <span class="n">channel</span><span class="o">,</span> <span class="n">localAddress</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="k">return</span> <span class="n">promise</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å…³é”®ä»£ç  <code class="language-plaintext highlighter-rouge">io.netty.bootstrap.AbstractBootstrap#initAndRegister</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="kd">final</span> <span class="nc">ChannelFuture</span> <span class="nf">initAndRegister</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">channel</span> <span class="o">=</span> <span class="n">channelFactory</span><span class="o">.</span><span class="na">newChannel</span><span class="o">();</span>
        <span class="c1">// 1.1 åˆå§‹åŒ– - åšçš„äº‹å°±æ˜¯æ·»åŠ ä¸€ä¸ªåˆå§‹åŒ–å™¨ ChannelInitializer</span>
        <span class="n">init</span><span class="o">(</span><span class="n">channel</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// å¤„ç†å¼‚å¸¸...</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">DefaultChannelPromise</span><span class="o">(</span><span class="k">new</span> <span class="nc">FailedChannel</span><span class="o">(),</span> <span class="nc">GlobalEventExecutor</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">).</span><span class="na">setFailure</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// 1.2 æ³¨å†Œ - åšçš„äº‹å°±æ˜¯å°†åŸç”Ÿ channel æ³¨å†Œåˆ° selector ä¸Š</span>
    <span class="nc">ChannelFuture</span> <span class="n">regFuture</span> <span class="o">=</span> <span class="n">config</span><span class="o">().</span><span class="na">group</span><span class="o">().</span><span class="na">register</span><span class="o">(</span><span class="n">channel</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">regFuture</span><span class="o">.</span><span class="na">cause</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// å¤„ç†å¼‚å¸¸...</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">regFuture</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å…³é”®ä»£ç  <code class="language-plaintext highlighter-rouge">io.netty.bootstrap.ServerBootstrap#init</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
</pre></td><td class="rouge-code"><pre><span class="c1">// è¿™é‡Œ channel å®é™…ä¸Šæ˜¯ NioServerSocketChannel</span>
<span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="nc">Channel</span> <span class="n">channel</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">ChannelOption</span><span class="o">&lt;?&gt;,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">options</span> <span class="o">=</span> <span class="n">options0</span><span class="o">();</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">options</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">setChannelOptions</span><span class="o">(</span><span class="n">channel</span><span class="o">,</span> <span class="n">options</span><span class="o">,</span> <span class="n">logger</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">final</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">AttributeKey</span><span class="o">&lt;?&gt;,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">attrs</span> <span class="o">=</span> <span class="n">attrs0</span><span class="o">();</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">attrs</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Entry</span><span class="o">&lt;</span><span class="nc">AttributeKey</span><span class="o">&lt;?&gt;,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="nl">e:</span> <span class="n">attrs</span><span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
            <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
            <span class="nc">AttributeKey</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">key</span> <span class="o">=</span> <span class="o">(</span><span class="nc">AttributeKey</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;)</span> <span class="n">e</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>
            <span class="n">channel</span><span class="o">.</span><span class="na">attr</span><span class="o">(</span><span class="n">key</span><span class="o">).</span><span class="na">set</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nc">ChannelPipeline</span> <span class="n">p</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>

    <span class="kd">final</span> <span class="nc">EventLoopGroup</span> <span class="n">currentChildGroup</span> <span class="o">=</span> <span class="n">childGroup</span><span class="o">;</span>
    <span class="kd">final</span> <span class="nc">ChannelHandler</span> <span class="n">currentChildHandler</span> <span class="o">=</span> <span class="n">childHandler</span><span class="o">;</span>
    <span class="kd">final</span> <span class="nc">Entry</span><span class="o">&lt;</span><span class="nc">ChannelOption</span><span class="o">&lt;?&gt;,</span> <span class="nc">Object</span><span class="o">&gt;[]</span> <span class="n">currentChildOptions</span><span class="o">;</span>
    <span class="kd">final</span> <span class="nc">Entry</span><span class="o">&lt;</span><span class="nc">AttributeKey</span><span class="o">&lt;?&gt;,</span> <span class="nc">Object</span><span class="o">&gt;[]</span> <span class="n">currentChildAttrs</span><span class="o">;</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">childOptions</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">currentChildOptions</span> <span class="o">=</span> <span class="n">childOptions</span><span class="o">.</span><span class="na">entrySet</span><span class="o">().</span><span class="na">toArray</span><span class="o">(</span><span class="n">newOptionArray</span><span class="o">(</span><span class="mi">0</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">childAttrs</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">currentChildAttrs</span> <span class="o">=</span> <span class="n">childAttrs</span><span class="o">.</span><span class="na">entrySet</span><span class="o">().</span><span class="na">toArray</span><span class="o">(</span><span class="n">newAttrArray</span><span class="o">(</span><span class="mi">0</span><span class="o">));</span>
    <span class="o">}</span>
	
    <span class="c1">// ä¸º NioServerSocketChannel æ·»åŠ åˆå§‹åŒ–å™¨</span>
    <span class="n">p</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">Channel</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="kd">final</span> <span class="nc">Channel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="nc">ChannelPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>
            <span class="nc">ChannelHandler</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="na">handler</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">handler</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="n">handler</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="c1">// åˆå§‹åŒ–å™¨çš„èŒè´£æ˜¯å°† ServerBootstrapAcceptor åŠ å…¥è‡³ NioServerSocketChannel</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">eventLoop</span><span class="o">().</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                    <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">ServerBootstrapAcceptor</span><span class="o">(</span>
                            <span class="n">ch</span><span class="o">,</span> <span class="n">currentChildGroup</span><span class="o">,</span> <span class="n">currentChildHandler</span><span class="o">,</span> <span class="n">currentChildOptions</span><span class="o">,</span> <span class="n">currentChildAttrs</span><span class="o">));</span>
                <span class="o">}</span>
            <span class="o">});</span>
        <span class="o">}</span>
    <span class="o">});</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å…³é”®ä»£ç  <code class="language-plaintext highlighter-rouge">io.netty.channel.AbstractChannel.AbstractUnsafe#register</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">register</span><span class="o">(</span><span class="nc">EventLoop</span> <span class="n">eventLoop</span><span class="o">,</span> <span class="kd">final</span> <span class="nc">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// ä¸€äº›æ£€æŸ¥ï¼Œç•¥...</span>

    <span class="nc">AbstractChannel</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">eventLoop</span> <span class="o">=</span> <span class="n">eventLoop</span><span class="o">;</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">eventLoop</span><span class="o">.</span><span class="na">inEventLoop</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">register0</span><span class="o">(</span><span class="n">promise</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// é¦–æ¬¡æ‰§è¡Œ execute æ–¹æ³•æ—¶ï¼Œä¼šå¯åŠ¨ nio çº¿ç¨‹ï¼Œä¹‹åæ³¨å†Œç­‰æ“ä½œåœ¨ nio çº¿ç¨‹ä¸Šæ‰§è¡Œ</span>
            <span class="c1">// å› ä¸ºåªæœ‰ä¸€ä¸ª NioServerSocketChannel å› æ­¤ï¼Œä¹Ÿåªä¼šæœ‰ä¸€ä¸ª boss nio çº¿ç¨‹</span>
            <span class="c1">// è¿™è¡Œä»£ç å®Œæˆçš„äº‹å®æ˜¯ main -&gt; nio boss çº¿ç¨‹çš„åˆ‡æ¢</span>
            <span class="n">eventLoop</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                    <span class="n">register0</span><span class="o">(</span><span class="n">promise</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">});</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// æ—¥å¿—è®°å½•...</span>
            <span class="n">closeForcibly</span><span class="o">();</span>
            <span class="n">closeFuture</span><span class="o">.</span><span class="na">setClosed</span><span class="o">();</span>
            <span class="n">safeSetFailure</span><span class="o">(</span><span class="n">promise</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">io.netty.channel.AbstractChannel.AbstractUnsafe#register0</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">void</span> <span class="nf">register0</span><span class="o">(</span><span class="nc">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">promise</span><span class="o">.</span><span class="na">setUncancellable</span><span class="o">()</span> <span class="o">||</span> <span class="o">!</span><span class="n">ensureOpen</span><span class="o">(</span><span class="n">promise</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kt">boolean</span> <span class="n">firstRegistration</span> <span class="o">=</span> <span class="n">neverRegistered</span><span class="o">;</span>
        <span class="c1">// 1.2.1 åŸç”Ÿçš„ nio channel ç»‘å®šåˆ° selector ä¸Šï¼Œæ³¨æ„æ­¤æ—¶æ²¡æœ‰æ³¨å†Œ selector å…³æ³¨äº‹ä»¶ï¼Œé™„ä»¶ä¸º NioServerSocketChannel</span>
        <span class="n">doRegister</span><span class="o">();</span>
        <span class="n">neverRegistered</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="n">registered</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>

        <span class="c1">// 1.2.2 æ‰§è¡Œ NioServerSocketChannel åˆå§‹åŒ–å™¨çš„ initChannel</span>
        <span class="n">pipeline</span><span class="o">.</span><span class="na">invokeHandlerAddedIfNeeded</span><span class="o">();</span>

        <span class="c1">// å›è°ƒ 3.2 io.netty.bootstrap.AbstractBootstrap#doBind0</span>
        <span class="n">safeSetSuccess</span><span class="o">(</span><span class="n">promise</span><span class="o">);</span>
        <span class="n">pipeline</span><span class="o">.</span><span class="na">fireChannelRegistered</span><span class="o">();</span>
        
        <span class="c1">// å¯¹åº” server socket channel è¿˜æœªç»‘å®šï¼ŒisActive ä¸º false</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">isActive</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">firstRegistration</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">pipeline</span><span class="o">.</span><span class="na">fireChannelActive</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">config</span><span class="o">().</span><span class="na">isAutoRead</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">beginRead</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Close the channel directly to avoid FD leak.</span>
        <span class="n">closeForcibly</span><span class="o">();</span>
        <span class="n">closeFuture</span><span class="o">.</span><span class="na">setClosed</span><span class="o">();</span>
        <span class="n">safeSetFailure</span><span class="o">(</span><span class="n">promise</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å…³é”®ä»£ç  <code class="language-plaintext highlighter-rouge">io.netty.channel.ChannelInitializer#initChannel</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">initMap</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">ctx</span><span class="o">))</span> <span class="o">{</span> <span class="c1">// Guard against re-entrance.</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// 1.2.2.1 æ‰§è¡Œåˆå§‹åŒ–</span>
            <span class="n">initChannel</span><span class="o">((</span><span class="no">C</span><span class="o">)</span> <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">exceptionCaught</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="n">cause</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="c1">// 1.2.2.2 ç§»é™¤åˆå§‹åŒ–å™¨</span>
            <span class="nc">ChannelPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">pipeline</span><span class="o">.</span><span class="na">context</span><span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">pipeline</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å…³é”®ä»£ç  <code class="language-plaintext highlighter-rouge">io.netty.bootstrap.AbstractBootstrap#doBind0</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="c1">// 3.1 æˆ– 3.2 æ‰§è¡Œ doBind0</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">doBind0</span><span class="o">(</span>
        <span class="kd">final</span> <span class="nc">ChannelFuture</span> <span class="n">regFuture</span><span class="o">,</span> <span class="kd">final</span> <span class="nc">Channel</span> <span class="n">channel</span><span class="o">,</span>
        <span class="kd">final</span> <span class="nc">SocketAddress</span> <span class="n">localAddress</span><span class="o">,</span> <span class="kd">final</span> <span class="nc">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="o">{</span>

    <span class="n">channel</span><span class="o">.</span><span class="na">eventLoop</span><span class="o">().</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">regFuture</span><span class="o">.</span><span class="na">isSuccess</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">channel</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">localAddress</span><span class="o">,</span> <span class="n">promise</span><span class="o">).</span><span class="na">addListener</span><span class="o">(</span><span class="nc">ChannelFutureListener</span><span class="o">.</span><span class="na">CLOSE_ON_FAILURE</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">promise</span><span class="o">.</span><span class="na">setFailure</span><span class="o">(</span><span class="n">regFuture</span><span class="o">.</span><span class="na">cause</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">});</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å…³é”®ä»£ç  <code class="language-plaintext highlighter-rouge">io.netty.channel.AbstractChannel.AbstractUnsafe#bind</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">bind</span><span class="o">(</span><span class="kd">final</span> <span class="nc">SocketAddress</span> <span class="n">localAddress</span><span class="o">,</span> <span class="kd">final</span> <span class="nc">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">assertEventLoop</span><span class="o">();</span>

    <span class="k">if</span> <span class="o">(!</span><span class="n">promise</span><span class="o">.</span><span class="na">setUncancellable</span><span class="o">()</span> <span class="o">||</span> <span class="o">!</span><span class="n">ensureOpen</span><span class="o">(</span><span class="n">promise</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="nc">Boolean</span><span class="o">.</span><span class="na">TRUE</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">config</span><span class="o">().</span><span class="na">getOption</span><span class="o">(</span><span class="nc">ChannelOption</span><span class="o">.</span><span class="na">SO_BROADCAST</span><span class="o">))</span> <span class="o">&amp;&amp;</span>
        <span class="n">localAddress</span> <span class="k">instanceof</span> <span class="nc">InetSocketAddress</span> <span class="o">&amp;&amp;</span>
        <span class="o">!((</span><span class="nc">InetSocketAddress</span><span class="o">)</span> <span class="n">localAddress</span><span class="o">).</span><span class="na">getAddress</span><span class="o">().</span><span class="na">isAnyLocalAddress</span><span class="o">()</span> <span class="o">&amp;&amp;</span>
        <span class="o">!</span><span class="nc">PlatformDependent</span><span class="o">.</span><span class="na">isWindows</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nc">PlatformDependent</span><span class="o">.</span><span class="na">maybeSuperUser</span><span class="o">())</span> <span class="o">{</span>
        <span class="c1">// è®°å½•æ—¥å¿—...</span>
    <span class="o">}</span>

    <span class="kt">boolean</span> <span class="n">wasActive</span> <span class="o">=</span> <span class="n">isActive</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// 3.3 æ‰§è¡Œç«¯å£ç»‘å®š</span>
        <span class="n">doBind</span><span class="o">(</span><span class="n">localAddress</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">safeSetFailure</span><span class="o">(</span><span class="n">promise</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
        <span class="n">closeIfClosed</span><span class="o">();</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(!</span><span class="n">wasActive</span> <span class="o">&amp;&amp;</span> <span class="n">isActive</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">invokeLater</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="c1">// 3.4 è§¦å‘ active äº‹ä»¶</span>
                <span class="n">pipeline</span><span class="o">.</span><span class="na">fireChannelActive</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span>

    <span class="n">safeSetSuccess</span><span class="o">(</span><span class="n">promise</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>3.3 å…³é”®ä»£ç  <code class="language-plaintext highlighter-rouge">io.netty.channel.socket.nio.NioServerSocketChannel#doBind</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doBind</span><span class="o">(</span><span class="nc">SocketAddress</span> <span class="n">localAddress</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="nc">PlatformDependent</span><span class="o">.</span><span class="na">javaVersion</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">javaChannel</span><span class="o">().</span><span class="na">bind</span><span class="o">(</span><span class="n">localAddress</span><span class="o">,</span> <span class="n">config</span><span class="o">.</span><span class="na">getBacklog</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">javaChannel</span><span class="o">().</span><span class="na">socket</span><span class="o">().</span><span class="na">bind</span><span class="o">(</span><span class="n">localAddress</span><span class="o">,</span> <span class="n">config</span><span class="o">.</span><span class="na">getBacklog</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>3.4 å…³é”®ä»£ç  <code class="language-plaintext highlighter-rouge">io.netty.channel.DefaultChannelPipeline.HeadContext#channelActive</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelActive</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">ctx</span><span class="o">.</span><span class="na">fireChannelActive</span><span class="o">();</span>
	<span class="c1">// è§¦å‘ read (NioServerSocketChannel ä¸Šçš„ read ä¸æ˜¯è¯»å–æ•°æ®ï¼Œåªæ˜¯ä¸ºäº†è§¦å‘ channel çš„äº‹ä»¶æ³¨å†Œ)</span>
    <span class="n">readIfIsAutoRead</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å…³é”®ä»£ç  <code class="language-plaintext highlighter-rouge">io.netty.channel.nio.AbstractNioChannel#doBeginRead</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doBeginRead</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="c1">// Channel.read() or ChannelHandlerContext.read() was called</span>
    <span class="kd">final</span> <span class="nc">SelectionKey</span> <span class="n">selectionKey</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">selectionKey</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">selectionKey</span><span class="o">.</span><span class="na">isValid</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="n">readPending</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>

    <span class="kd">final</span> <span class="kt">int</span> <span class="n">interestOps</span> <span class="o">=</span> <span class="n">selectionKey</span><span class="o">.</span><span class="na">interestOps</span><span class="o">();</span>
    <span class="c1">// readInterestOp å–å€¼æ˜¯ 16ï¼Œåœ¨ NioServerSocketChannel åˆ›å»ºæ—¶åˆå§‹åŒ–å¥½ï¼Œä»£è¡¨å…³æ³¨ accept äº‹ä»¶</span>
    <span class="k">if</span> <span class="o">((</span><span class="n">interestOps</span> <span class="o">&amp;</span> <span class="n">readInterestOp</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">selectionKey</span><span class="o">.</span><span class="na">interestOps</span><span class="o">(</span><span class="n">interestOps</span> <span class="o">|</span> <span class="n">readInterestOp</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="22-nioeventloop-å‰–æ">2.2 NioEventLoop å‰–æ</h3>

<p>NioEventLoop çº¿ç¨‹ä¸ä»…è¦å¤„ç† IO äº‹ä»¶ï¼Œè¿˜è¦å¤„ç† Taskï¼ˆåŒ…æ‹¬æ™®é€šä»»åŠ¡å’Œå®šæ—¶ä»»åŠ¡ï¼‰ï¼Œ</p>

<p>æäº¤ä»»åŠ¡ä»£ç  <code class="language-plaintext highlighter-rouge">io.netty.util.concurrent.SingleThreadEventExecutor#execute</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="nc">Runnable</span> <span class="n">task</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">task</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">(</span><span class="s">"task"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kt">boolean</span> <span class="n">inEventLoop</span> <span class="o">=</span> <span class="n">inEventLoop</span><span class="o">();</span>
    <span class="c1">// æ·»åŠ ä»»åŠ¡ï¼Œå…¶ä¸­é˜Ÿåˆ—ä½¿ç”¨äº† jctools æä¾›çš„ mpsc æ— é”é˜Ÿåˆ—</span>
    <span class="n">addTask</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">inEventLoop</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// inEventLoop å¦‚æœä¸º false è¡¨ç¤ºç”±å…¶å®ƒçº¿ç¨‹æ¥è°ƒç”¨ executeï¼Œå³é¦–æ¬¡è°ƒç”¨ï¼Œè¿™æ—¶éœ€è¦å‘ eventLoop æäº¤é¦–ä¸ªä»»åŠ¡ï¼Œå¯åŠ¨æ­»å¾ªç¯ï¼Œä¼šæ‰§è¡Œåˆ°ä¸‹é¢çš„ doStartThread</span>
        <span class="n">startThread</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">isShutdown</span><span class="o">())</span> <span class="o">{</span>
            <span class="c1">// å¦‚æœå·²ç» shutdownï¼Œåšæ‹’ç»é€»è¾‘ï¼Œä»£ç ç•¥...</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(!</span><span class="n">addTaskWakesUp</span> <span class="o">&amp;&amp;</span> <span class="n">wakesUpForTask</span><span class="o">(</span><span class="n">task</span><span class="o">))</span> <span class="o">{</span>
        <span class="c1">// å¦‚æœçº¿ç¨‹ç”±äº IO select é˜»å¡äº†ï¼Œæ·»åŠ çš„ä»»åŠ¡çš„çº¿ç¨‹éœ€è¦è´Ÿè´£å”¤é†’ NioEventLoop çº¿ç¨‹</span>
        <span class="n">wakeup</span><span class="o">(</span><span class="n">inEventLoop</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å”¤é†’ select é˜»å¡çº¿ç¨‹<code class="language-plaintext highlighter-rouge">io.netty.channel.nio.NioEventLoop#wakeup</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">wakeup</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">inEventLoop</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">inEventLoop</span> <span class="o">&amp;&amp;</span> <span class="n">wakenUp</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="kc">true</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">selector</span><span class="o">.</span><span class="na">wakeup</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¯åŠ¨ EventLoop ä¸»å¾ªç¯ <code class="language-plaintext highlighter-rouge">io.netty.util.concurrent.SingleThreadEventExecutor#doStartThread</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">void</span> <span class="nf">doStartThread</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">assert</span> <span class="n">thread</span> <span class="o">==</span> <span class="kc">null</span><span class="o">;</span>
    <span class="n">executor</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="c1">// å°†çº¿ç¨‹æ± çš„å½“å‰çº¿ç¨‹ä¿å­˜åœ¨æˆå‘˜å˜é‡ä¸­ï¼Œä»¥ä¾¿åç»­ä½¿ç”¨</span>
            <span class="n">thread</span> <span class="o">=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">interrupted</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">thread</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
            <span class="o">}</span>

            <span class="kt">boolean</span> <span class="n">success</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="n">updateLastExecutionTime</span><span class="o">();</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="c1">// è°ƒç”¨å¤–éƒ¨ç±» SingleThreadEventExecutor çš„ run æ–¹æ³•ï¼Œè¿›å…¥æ­»å¾ªç¯ï¼Œrun æ–¹æ³•è§ä¸‹</span>
                <span class="nc">SingleThreadEventExecutor</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
                <span class="n">success</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"Unexpected exception from an event executor: "</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
				<span class="c1">// æ¸…ç†å·¥ä½œï¼Œä»£ç ç•¥...</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">});</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">io.netty.channel.nio.NioEventLoop#run</code> ä¸»è¦ä»»åŠ¡æ˜¯æ‰§è¡Œæ­»å¾ªç¯ï¼Œä¸æ–­çœ‹æœ‰æ²¡æœ‰æ–°ä»»åŠ¡ï¼Œæœ‰æ²¡æœ‰ IO äº‹ä»¶</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
</pre></td><td class="rouge-code"><pre><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="c1">// calculateStrategy çš„é€»è¾‘å¦‚ä¸‹ï¼š</span>
                <span class="c1">// æœ‰ä»»åŠ¡ï¼Œä¼šæ‰§è¡Œä¸€æ¬¡ selectNowï¼Œæ¸…é™¤ä¸Šä¸€æ¬¡çš„ wakeup ç»“æœï¼Œæ— è®ºæœ‰æ²¡æœ‰ IO äº‹ä»¶ï¼Œéƒ½ä¼šè·³è¿‡ switch</span>
                <span class="c1">// æ²¡æœ‰ä»»åŠ¡ï¼Œä¼šåŒ¹é… SelectStrategy.SELECTï¼Œçœ‹æ˜¯å¦åº”å½“é˜»å¡</span>
                <span class="k">switch</span> <span class="o">(</span><span class="n">selectStrategy</span><span class="o">.</span><span class="na">calculateStrategy</span><span class="o">(</span><span class="n">selectNowSupplier</span><span class="o">,</span> <span class="n">hasTasks</span><span class="o">()))</span> <span class="o">{</span>
                    <span class="k">case</span> <span class="nc">SelectStrategy</span><span class="o">.</span><span class="na">CONTINUE</span><span class="o">:</span>
                        <span class="k">continue</span><span class="o">;</span>

                    <span class="k">case</span> <span class="nc">SelectStrategy</span><span class="o">.</span><span class="na">BUSY_WAIT</span><span class="o">:</span>

                    <span class="k">case</span> <span class="nc">SelectStrategy</span><span class="o">.</span><span class="na">SELECT</span><span class="o">:</span>
                        <span class="c1">// å› ä¸º IO çº¿ç¨‹å’Œæäº¤ä»»åŠ¡çº¿ç¨‹éƒ½æœ‰å¯èƒ½æ‰§è¡Œ wakeupï¼Œè€Œ wakeup å±äºæ¯”è¾ƒæ˜‚è´µçš„æ“ä½œï¼Œå› æ­¤ä½¿ç”¨äº†ä¸€ä¸ªåŸå­å¸ƒå°”å¯¹è±¡ wakenUpï¼Œå®ƒå–å€¼ä¸º true æ—¶ï¼Œè¡¨ç¤ºè¯¥ç”±å½“å‰çº¿ç¨‹å”¤é†’</span>
                        <span class="c1">// è¿›è¡Œ select é˜»å¡ï¼Œå¹¶è®¾ç½®å”¤é†’çŠ¶æ€ä¸º false</span>
                        <span class="kt">boolean</span> <span class="n">oldWakenUp</span> <span class="o">=</span> <span class="n">wakenUp</span><span class="o">.</span><span class="na">getAndSet</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
                        
                        <span class="c1">// å¦‚æœåœ¨è¿™ä¸ªä½ç½®ï¼Œé EventLoop çº¿ç¨‹æŠ¢å…ˆå°† wakenUp ç½®ä¸º trueï¼Œå¹¶ wakeup</span>
                        <span class="c1">// ä¸‹é¢çš„ select æ–¹æ³•ä¸ä¼šé˜»å¡</span>
                        <span class="c1">// ç­‰ runAllTasks å¤„ç†å®Œæˆåï¼Œåˆ°å†å¾ªç¯è¿›æ¥è¿™ä¸ªé˜¶æ®µæ–°å¢çš„ä»»åŠ¡ä¼šä¸ä¼šåŠæ—¶æ‰§è¡Œå‘¢?</span>
                        <span class="c1">// å› ä¸º oldWakenUp ä¸º trueï¼Œå› æ­¤ä¸‹é¢çš„ select æ–¹æ³•å°±ä¼šé˜»å¡ï¼Œç›´åˆ°è¶…æ—¶</span>
                        <span class="c1">// æ‰èƒ½æ‰§è¡Œï¼Œè®© select æ–¹æ³•æ— è°“é˜»å¡</span>
                        <span class="n">select</span><span class="o">(</span><span class="n">oldWakenUp</span><span class="o">);</span>

                        <span class="k">if</span> <span class="o">(</span><span class="n">wakenUp</span><span class="o">.</span><span class="na">get</span><span class="o">())</span> <span class="o">{</span>
                            <span class="n">selector</span><span class="o">.</span><span class="na">wakeup</span><span class="o">();</span>
                        <span class="o">}</span>
                    <span class="k">default</span><span class="o">:</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">rebuildSelector0</span><span class="o">();</span>
                <span class="n">handleLoopException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                <span class="k">continue</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="n">cancelledKeys</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="n">needsToSelectAgain</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="c1">// ioRatio é»˜è®¤æ˜¯ 50</span>
            <span class="kd">final</span> <span class="kt">int</span> <span class="n">ioRatio</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">ioRatio</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">ioRatio</span> <span class="o">==</span> <span class="mi">100</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">processSelectedKeys</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                    <span class="c1">// ioRatio ä¸º 100 æ—¶ï¼Œæ€»æ˜¯è¿è¡Œå®Œæ‰€æœ‰é IO ä»»åŠ¡</span>
                    <span class="n">runAllTasks</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>                
                <span class="kd">final</span> <span class="kt">long</span> <span class="n">ioStartTime</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">processSelectedKeys</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                    <span class="c1">// è®°å½• io äº‹ä»¶å¤„ç†è€—æ—¶</span>
                    <span class="kd">final</span> <span class="kt">long</span> <span class="n">ioTime</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">()</span> <span class="o">-</span> <span class="n">ioStartTime</span><span class="o">;</span>
                    <span class="c1">// è¿è¡Œé IO ä»»åŠ¡ï¼Œä¸€æ—¦è¶…æ—¶ä¼šé€€å‡º runAllTasks</span>
                    <span class="n">runAllTasks</span><span class="o">(</span><span class="n">ioTime</span> <span class="o">*</span> <span class="o">(</span><span class="mi">100</span> <span class="o">-</span> <span class="n">ioRatio</span><span class="o">)</span> <span class="o">/</span> <span class="n">ioRatio</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">handleLoopException</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">isShuttingDown</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">closeAll</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">confirmShutdown</span><span class="o">())</span> <span class="o">{</span>
                    <span class="k">return</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">handleLoopException</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="ï¸-æ³¨æ„">âš ï¸ æ³¨æ„</h4>

<blockquote>
  <p>è¿™é‡Œæœ‰ä¸ªè´¹è§£çš„åœ°æ–¹å°±æ˜¯ wakeupï¼Œå®ƒæ—¢å¯ä»¥ç”±æäº¤ä»»åŠ¡çš„çº¿ç¨‹æ¥è°ƒç”¨ï¼ˆæ¯”è¾ƒå¥½ç†è§£ï¼‰ï¼Œä¹Ÿå¯ä»¥ç”± EventLoop çº¿ç¨‹æ¥è°ƒç”¨ï¼ˆæ¯”è¾ƒè´¹è§£ï¼‰ï¼Œè¿™é‡Œè¦çŸ¥é“ wakeup æ–¹æ³•çš„æ•ˆæœï¼š</p>

  <ul>
    <li>ç”±é EventLoop çº¿ç¨‹è°ƒç”¨ï¼Œä¼šå”¤é†’å½“å‰åœ¨æ‰§è¡Œ select é˜»å¡çš„ EventLoop çº¿ç¨‹</li>
    <li>ç”± EventLoop è‡ªå·±è°ƒç”¨ï¼Œä¼šæœ¬æ¬¡çš„ wakeup ä¼šå–æ¶ˆä¸‹ä¸€æ¬¡çš„ select æ“ä½œ</li>
  </ul>
</blockquote>

<p>å‚è€ƒä¸‹å›¾</p>

<p><img src="https://procon-note.oss-cn-guangzhou.aliyuncs.com/typora0032.png" /></p>

<p><code class="language-plaintext highlighter-rouge">io.netty.channel.nio.NioEventLoop#select</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">void</span> <span class="nf">select</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">oldWakenUp</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="nc">Selector</span> <span class="n">selector</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">selector</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">selectCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="kt">long</span> <span class="n">currentTimeNanos</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
        <span class="c1">// è®¡ç®—ç­‰å¾…æ—¶é—´</span>
        <span class="c1">// * æ²¡æœ‰ scheduledTaskï¼Œè¶…æ—¶æ—¶é—´ä¸º 1s</span>
        <span class="c1">// * æœ‰ scheduledTaskï¼Œè¶…æ—¶æ—¶é—´ä¸º `ä¸‹ä¸€ä¸ªå®šæ—¶ä»»åŠ¡æ‰§è¡Œæ—¶é—´ - å½“å‰æ—¶é—´`</span>
        <span class="kt">long</span> <span class="n">selectDeadLineNanos</span> <span class="o">=</span> <span class="n">currentTimeNanos</span> <span class="o">+</span> <span class="n">delayNanos</span><span class="o">(</span><span class="n">currentTimeNanos</span><span class="o">);</span>

        <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
            <span class="kt">long</span> <span class="n">timeoutMillis</span> <span class="o">=</span> <span class="o">(</span><span class="n">selectDeadLineNanos</span> <span class="o">-</span> <span class="n">currentTimeNanos</span> <span class="o">+</span> <span class="mi">500000L</span><span class="o">)</span> <span class="o">/</span> <span class="mi">1000000L</span><span class="o">;</span>
            <span class="c1">// å¦‚æœè¶…æ—¶ï¼Œé€€å‡ºå¾ªç¯</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">timeoutMillis</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">selectCnt</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">selector</span><span class="o">.</span><span class="na">selectNow</span><span class="o">();</span>
                    <span class="n">selectCnt</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="c1">// å¦‚æœæœŸé—´åˆæœ‰ task é€€å‡ºå¾ªç¯ï¼Œå¦‚æœæ²¡è¿™ä¸ªåˆ¤æ–­ï¼Œé‚£ä¹ˆä»»åŠ¡å°±ä¼šç­‰åˆ°ä¸‹æ¬¡ select è¶…æ—¶æ—¶æ‰èƒ½è¢«æ‰§è¡Œ</span>
            <span class="c1">// wakenUp.compareAndSet(false, true) æ˜¯è®©é NioEventLoop ä¸å¿…å†æ‰§è¡Œ wakeup</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">hasTasks</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">wakenUp</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="kc">true</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">selector</span><span class="o">.</span><span class="na">selectNow</span><span class="o">();</span>
                <span class="n">selectCnt</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="c1">// select æœ‰é™æ—¶é˜»å¡</span>
            <span class="c1">// æ³¨æ„ nio æœ‰ bugï¼Œå½“ bug å‡ºç°æ—¶ï¼Œselect æ–¹æ³•å³ä½¿æ²¡æœ‰æ—¶é—´å‘ç”Ÿï¼Œä¹Ÿä¸ä¼šé˜»å¡ä½ï¼Œå¯¼è‡´ä¸æ–­ç©ºè½®è¯¢ï¼Œcpu å ç”¨ 100%</span>
            <span class="kt">int</span> <span class="n">selectedKeys</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">timeoutMillis</span><span class="o">);</span>
            <span class="c1">// è®¡æ•°åŠ  1</span>
            <span class="n">selectCnt</span> <span class="o">++;</span>

            <span class="c1">// é†’æ¥åï¼Œå¦‚æœæœ‰ IO äº‹ä»¶ã€æˆ–æ˜¯ç”±é EventLoop çº¿ç¨‹å”¤é†’ï¼Œæˆ–è€…æœ‰ä»»åŠ¡ï¼Œé€€å‡ºå¾ªç¯</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">selectedKeys</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">oldWakenUp</span> <span class="o">||</span> <span class="n">wakenUp</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">||</span> <span class="n">hasTasks</span><span class="o">()</span> <span class="o">||</span> <span class="n">hasScheduledTasks</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">interrupted</span><span class="o">())</span> <span class="o">{</span>
               	<span class="c1">// çº¿ç¨‹è¢«æ‰“æ–­ï¼Œé€€å‡ºå¾ªç¯</span>
                <span class="c1">// è®°å½•æ—¥å¿—</span>
                <span class="n">selectCnt</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="kt">long</span> <span class="n">time</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">time</span> <span class="o">-</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">.</span><span class="na">toNanos</span><span class="o">(</span><span class="n">timeoutMillis</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="n">currentTimeNanos</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// å¦‚æœè¶…æ—¶ï¼Œè®¡æ•°é‡ç½®ä¸º 1ï¼Œä¸‹æ¬¡å¾ªç¯å°±ä¼š break</span>
                <span class="n">selectCnt</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
            <span class="o">}</span> 
            <span class="c1">// è®¡æ•°è¶…è¿‡é˜ˆå€¼ï¼Œç”± io.netty.selectorAutoRebuildThreshold æŒ‡å®šï¼Œé»˜è®¤ 512</span>
            <span class="c1">// è¿™æ˜¯ä¸ºäº†è§£å†³ nio ç©ºè½®è¯¢ bug</span>
            <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="no">SELECTOR_AUTO_REBUILD_THRESHOLD</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
                    <span class="n">selectCnt</span> <span class="o">&gt;=</span> <span class="no">SELECTOR_AUTO_REBUILD_THRESHOLD</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// é‡å»º selector</span>
                <span class="n">selector</span> <span class="o">=</span> <span class="n">selectRebuildSelector</span><span class="o">(</span><span class="n">selectCnt</span><span class="o">);</span>
                <span class="n">selectCnt</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="n">currentTimeNanos</span> <span class="o">=</span> <span class="n">time</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">selectCnt</span> <span class="o">&gt;</span> <span class="no">MIN_PREMATURE_SELECTOR_RETURNS</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// è®°å½•æ—¥å¿—</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">CancelledKeyException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// è®°å½•æ—¥å¿—</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¤„ç† keys <code class="language-plaintext highlighter-rouge">io.netty.channel.nio.NioEventLoop#processSelectedKeys</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">void</span> <span class="nf">processSelectedKeys</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">selectedKeys</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// é€šè¿‡åå°„å°† Selector å®ç°ç±»ä¸­çš„å°±ç»ªäº‹ä»¶é›†åˆæ›¿æ¢ä¸º SelectedSelectionKeySet </span>
        <span class="c1">// SelectedSelectionKeySet åº•å±‚ä¸ºæ•°ç»„å®ç°ï¼Œå¯ä»¥æé«˜éå†æ€§èƒ½ï¼ˆåŸæœ¬ä¸º HashSetï¼‰</span>
        <span class="n">processSelectedKeysOptimized</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">processSelectedKeysPlain</span><span class="o">(</span><span class="n">selector</span><span class="o">.</span><span class="na">selectedKeys</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">io.netty.channel.nio.NioEventLoop#processSelectedKey</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">void</span> <span class="nf">processSelectedKey</span><span class="o">(</span><span class="nc">SelectionKey</span> <span class="n">k</span><span class="o">,</span> <span class="nc">AbstractNioChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="nc">AbstractNioChannel</span><span class="o">.</span><span class="na">NioUnsafe</span> <span class="n">unsafe</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">unsafe</span><span class="o">();</span>
    <span class="c1">// å½“ key å–æ¶ˆæˆ–å…³é—­æ—¶ä¼šå¯¼è‡´è¿™ä¸ª key æ— æ•ˆ</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">k</span><span class="o">.</span><span class="na">isValid</span><span class="o">())</span> <span class="o">{</span>
        <span class="c1">// æ— æ•ˆæ—¶å¤„ç†...</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">try</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">readyOps</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="na">readyOps</span><span class="o">();</span>
        <span class="c1">// è¿æ¥äº‹ä»¶</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">readyOps</span> <span class="o">&amp;</span> <span class="nc">SelectionKey</span><span class="o">.</span><span class="na">OP_CONNECT</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">ops</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="na">interestOps</span><span class="o">();</span>
            <span class="n">ops</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="nc">SelectionKey</span><span class="o">.</span><span class="na">OP_CONNECT</span><span class="o">;</span>
            <span class="n">k</span><span class="o">.</span><span class="na">interestOps</span><span class="o">(</span><span class="n">ops</span><span class="o">);</span>

            <span class="n">unsafe</span><span class="o">.</span><span class="na">finishConnect</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="c1">// å¯å†™äº‹ä»¶</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">readyOps</span> <span class="o">&amp;</span> <span class="nc">SelectionKey</span><span class="o">.</span><span class="na">OP_WRITE</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">unsafe</span><span class="o">().</span><span class="na">forceFlush</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="c1">// å¯è¯»æˆ–å¯æ¥å…¥äº‹ä»¶</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">readyOps</span> <span class="o">&amp;</span> <span class="o">(</span><span class="nc">SelectionKey</span><span class="o">.</span><span class="na">OP_READ</span> <span class="o">|</span> <span class="nc">SelectionKey</span><span class="o">.</span><span class="na">OP_ACCEPT</span><span class="o">))</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">readyOps</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// å¦‚æœæ˜¯å¯æ¥å…¥ io.netty.channel.nio.AbstractNioMessageChannel.NioMessageUnsafe#read</span>
            <span class="c1">// å¦‚æœæ˜¯å¯è¯» io.netty.channel.nio.AbstractNioByteChannel.NioByteUnsafe#read</span>
            <span class="n">unsafe</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">CancelledKeyException</span> <span class="n">ignored</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">unsafe</span><span class="o">.</span><span class="na">close</span><span class="o">(</span><span class="n">unsafe</span><span class="o">.</span><span class="na">voidPromise</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="23-accept-å‰–æ">2.3 accept å‰–æ</h3>

<p>nio ä¸­å¦‚ä¸‹ä»£ç ï¼Œåœ¨ netty ä¸­çš„æµç¨‹</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="c1">//1 é˜»å¡ç›´åˆ°äº‹ä»¶å‘ç”Ÿ</span>
<span class="n">selector</span><span class="o">.</span><span class="na">select</span><span class="o">();</span>

<span class="nc">Iterator</span><span class="o">&lt;</span><span class="nc">SelectionKey</span><span class="o">&gt;</span> <span class="n">iter</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="na">selectedKeys</span><span class="o">().</span><span class="na">iterator</span><span class="o">();</span>
<span class="k">while</span> <span class="o">(</span><span class="n">iter</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>    
    <span class="c1">//2 æ‹¿åˆ°ä¸€ä¸ªäº‹ä»¶</span>
    <span class="nc">SelectionKey</span> <span class="n">key</span> <span class="o">=</span> <span class="n">iter</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
    
    <span class="c1">//3 å¦‚æœæ˜¯ accept äº‹ä»¶</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">isAcceptable</span><span class="o">())</span> <span class="o">{</span>
        
        <span class="c1">//4 æ‰§è¡Œ accept</span>
        <span class="nc">SocketChannel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">serverSocketChannel</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>
        <span class="n">channel</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
        
        <span class="c1">//5 å…³æ³¨ read äº‹ä»¶</span>
        <span class="n">channel</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">selector</span><span class="o">,</span> <span class="nc">SelectionKey</span><span class="o">.</span><span class="na">OP_READ</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">// ...</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å…ˆæ¥çœ‹å¯æ¥å…¥äº‹ä»¶å¤„ç†ï¼ˆacceptï¼‰</p>

<p><code class="language-plaintext highlighter-rouge">io.netty.channel.nio.AbstractNioMessageChannel.NioMessageUnsafe#read</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">read</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">assert</span> <span class="nf">eventLoop</span><span class="o">().</span><span class="na">inEventLoop</span><span class="o">();</span>
    <span class="kd">final</span> <span class="nc">ChannelConfig</span> <span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="o">();</span>
    <span class="kd">final</span> <span class="nc">ChannelPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">();</span>    
    <span class="kd">final</span> <span class="nc">RecvByteBufAllocator</span><span class="o">.</span><span class="na">Handle</span> <span class="n">allocHandle</span> <span class="o">=</span> <span class="n">unsafe</span><span class="o">().</span><span class="na">recvBufAllocHandle</span><span class="o">();</span>
    <span class="n">allocHandle</span><span class="o">.</span><span class="na">reset</span><span class="o">(</span><span class="n">config</span><span class="o">);</span>

    <span class="kt">boolean</span> <span class="n">closed</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="nc">Throwable</span> <span class="n">exception</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">do</span> <span class="o">{</span>
				<span class="c1">// doReadMessages ä¸­æ‰§è¡Œäº† accept å¹¶åˆ›å»º NioSocketChannel ä½œä¸ºæ¶ˆæ¯æ”¾å…¥ readBuf</span>
                <span class="c1">// readBuf æ˜¯ä¸€ä¸ª ArrayList ç”¨æ¥ç¼“å­˜æ¶ˆæ¯</span>
                <span class="kt">int</span> <span class="n">localRead</span> <span class="o">=</span> <span class="n">doReadMessages</span><span class="o">(</span><span class="n">readBuf</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">localRead</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">localRead</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">closed</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>
				<span class="c1">// localRead ä¸º 1ï¼Œå°±ä¸€æ¡æ¶ˆæ¯ï¼Œå³æ¥æ”¶ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥</span>
                <span class="n">allocHandle</span><span class="o">.</span><span class="na">incMessagesRead</span><span class="o">(</span><span class="n">localRead</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">while</span> <span class="o">(</span><span class="n">allocHandle</span><span class="o">.</span><span class="na">continueReading</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">exception</span> <span class="o">=</span> <span class="n">t</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">readBuf</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span> <span class="o">++)</span> <span class="o">{</span>
            <span class="n">readPending</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="c1">// è§¦å‘ read äº‹ä»¶ï¼Œè®© pipeline ä¸Šçš„ handler å¤„ç†ï¼Œè¿™æ—¶æ˜¯å¤„ç†</span>
            <span class="c1">// io.netty.bootstrap.ServerBootstrap.ServerBootstrapAcceptor#channelRead</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="na">fireChannelRead</span><span class="o">(</span><span class="n">readBuf</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="n">readBuf</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
        <span class="n">allocHandle</span><span class="o">.</span><span class="na">readComplete</span><span class="o">();</span>
        <span class="n">pipeline</span><span class="o">.</span><span class="na">fireChannelReadComplete</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">exception</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">closed</span> <span class="o">=</span> <span class="n">closeOnReadError</span><span class="o">(</span><span class="n">exception</span><span class="o">);</span>

            <span class="n">pipeline</span><span class="o">.</span><span class="na">fireExceptionCaught</span><span class="o">(</span><span class="n">exception</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">closed</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">inputShutdown</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">isOpen</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">close</span><span class="o">(</span><span class="n">voidPromise</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">readPending</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">config</span><span class="o">.</span><span class="na">isAutoRead</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">removeReadOp</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å…³é”®ä»£ç  <code class="language-plaintext highlighter-rouge">io.netty.bootstrap.ServerBootstrap.ServerBootstrapAcceptor#channelRead</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// è¿™æ—¶çš„ msg æ˜¯ NioSocketChannel</span>
    <span class="kd">final</span> <span class="nc">Channel</span> <span class="n">child</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Channel</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>

    <span class="c1">// NioSocketChannel æ·»åŠ   childHandler å³åˆå§‹åŒ–å™¨</span>
    <span class="n">child</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="n">childHandler</span><span class="o">);</span>

    <span class="c1">// è®¾ç½®é€‰é¡¹</span>
    <span class="n">setChannelOptions</span><span class="o">(</span><span class="n">child</span><span class="o">,</span> <span class="n">childOptions</span><span class="o">,</span> <span class="n">logger</span><span class="o">);</span>

    <span class="k">for</span> <span class="o">(</span><span class="nc">Entry</span><span class="o">&lt;</span><span class="nc">AttributeKey</span><span class="o">&lt;?&gt;,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="nl">e:</span> <span class="n">childAttrs</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">child</span><span class="o">.</span><span class="na">attr</span><span class="o">((</span><span class="nc">AttributeKey</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;)</span> <span class="n">e</span><span class="o">.</span><span class="na">getKey</span><span class="o">()).</span><span class="na">set</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// æ³¨å†Œ NioSocketChannel åˆ° nio worker çº¿ç¨‹ï¼Œæ¥ä¸‹æ¥çš„å¤„ç†ä¹Ÿç§»äº¤è‡³ nio worker çº¿ç¨‹</span>
        <span class="n">childGroup</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">child</span><span class="o">).</span><span class="na">addListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelFutureListener</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">operationComplete</span><span class="o">(</span><span class="nc">ChannelFuture</span> <span class="n">future</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">future</span><span class="o">.</span><span class="na">isSuccess</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">forceClose</span><span class="o">(</span><span class="n">child</span><span class="o">,</span> <span class="n">future</span><span class="o">.</span><span class="na">cause</span><span class="o">());</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">forceClose</span><span class="o">(</span><span class="n">child</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åˆå›åˆ°äº†ç†Ÿæ‚‰çš„ <code class="language-plaintext highlighter-rouge">io.netty.channel.AbstractChannel.AbstractUnsafe#register</code>  æ–¹æ³•</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">register</span><span class="o">(</span><span class="nc">EventLoop</span> <span class="n">eventLoop</span><span class="o">,</span> <span class="kd">final</span> <span class="nc">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// ä¸€äº›æ£€æŸ¥ï¼Œç•¥...</span>

    <span class="nc">AbstractChannel</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">eventLoop</span> <span class="o">=</span> <span class="n">eventLoop</span><span class="o">;</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">eventLoop</span><span class="o">.</span><span class="na">inEventLoop</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">register0</span><span class="o">(</span><span class="n">promise</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// è¿™è¡Œä»£ç å®Œæˆçš„äº‹å®æ˜¯ nio boss -&gt; nio worker çº¿ç¨‹çš„åˆ‡æ¢</span>
            <span class="n">eventLoop</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                    <span class="n">register0</span><span class="o">(</span><span class="n">promise</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">});</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// æ—¥å¿—è®°å½•...</span>
            <span class="n">closeForcibly</span><span class="o">();</span>
            <span class="n">closeFuture</span><span class="o">.</span><span class="na">setClosed</span><span class="o">();</span>
            <span class="n">safeSetFailure</span><span class="o">(</span><span class="n">promise</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">io.netty.channel.AbstractChannel.AbstractUnsafe#register0</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">void</span> <span class="nf">register0</span><span class="o">(</span><span class="nc">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">promise</span><span class="o">.</span><span class="na">setUncancellable</span><span class="o">()</span> <span class="o">||</span> <span class="o">!</span><span class="n">ensureOpen</span><span class="o">(</span><span class="n">promise</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kt">boolean</span> <span class="n">firstRegistration</span> <span class="o">=</span> <span class="n">neverRegistered</span><span class="o">;</span>
        <span class="n">doRegister</span><span class="o">();</span>
        <span class="n">neverRegistered</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="n">registered</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
		
        <span class="c1">// æ‰§è¡Œåˆå§‹åŒ–å™¨ï¼Œæ‰§è¡Œå‰ pipeline ä¸­åªæœ‰ head -&gt; åˆå§‹åŒ–å™¨ -&gt; tail</span>
        <span class="n">pipeline</span><span class="o">.</span><span class="na">invokeHandlerAddedIfNeeded</span><span class="o">();</span>
        <span class="c1">// æ‰§è¡Œåå°±æ˜¯ head -&gt; logging handler -&gt; my handler -&gt; tail</span>

        <span class="n">safeSetSuccess</span><span class="o">(</span><span class="n">promise</span><span class="o">);</span>
        <span class="n">pipeline</span><span class="o">.</span><span class="na">fireChannelRegistered</span><span class="o">();</span>
        
        <span class="k">if</span> <span class="o">(</span><span class="n">isActive</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">firstRegistration</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// è§¦å‘ pipeline ä¸Š active äº‹ä»¶</span>
                <span class="n">pipeline</span><span class="o">.</span><span class="na">fireChannelActive</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">config</span><span class="o">().</span><span class="na">isAutoRead</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">beginRead</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">closeForcibly</span><span class="o">();</span>
        <span class="n">closeFuture</span><span class="o">.</span><span class="na">setClosed</span><span class="o">();</span>
        <span class="n">safeSetFailure</span><span class="o">(</span><span class="n">promise</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å›åˆ°äº†ç†Ÿæ‚‰çš„ä»£ç  <code class="language-plaintext highlighter-rouge">io.netty.channel.DefaultChannelPipeline.HeadContext#channelActive</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelActive</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">ctx</span><span class="o">.</span><span class="na">fireChannelActive</span><span class="o">();</span>
	<span class="c1">// è§¦å‘ read (NioSocketChannel è¿™é‡Œ readï¼Œåªæ˜¯ä¸ºäº†è§¦å‘ channel çš„äº‹ä»¶æ³¨å†Œï¼Œè¿˜æœªæ¶‰åŠæ•°æ®è¯»å–)</span>
    <span class="n">readIfIsAutoRead</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">io.netty.channel.nio.AbstractNioChannel#doBeginRead</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doBeginRead</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="c1">// Channel.read() or ChannelHandlerContext.read() was called</span>
    <span class="kd">final</span> <span class="nc">SelectionKey</span> <span class="n">selectionKey</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">selectionKey</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">selectionKey</span><span class="o">.</span><span class="na">isValid</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="n">readPending</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
	<span class="c1">// è¿™æ—¶å€™ interestOps æ˜¯ 0</span>
    <span class="kd">final</span> <span class="kt">int</span> <span class="n">interestOps</span> <span class="o">=</span> <span class="n">selectionKey</span><span class="o">.</span><span class="na">interestOps</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">((</span><span class="n">interestOps</span> <span class="o">&amp;</span> <span class="n">readInterestOp</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// å…³æ³¨ read äº‹ä»¶</span>
        <span class="n">selectionKey</span><span class="o">.</span><span class="na">interestOps</span><span class="o">(</span><span class="n">interestOps</span> <span class="o">|</span> <span class="n">readInterestOp</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="24-read-å‰–æ">2.4 read å‰–æ</h3>

<p>å†æ¥çœ‹å¯è¯»äº‹ä»¶ <code class="language-plaintext highlighter-rouge">io.netty.channel.nio.AbstractNioByteChannel.NioByteUnsafe#read</code>ï¼Œæ³¨æ„å‘é€çš„æ•°æ®æœªå¿…èƒ½å¤Ÿä¸€æ¬¡è¯»å®Œï¼Œå› æ­¤ä¼šè§¦å‘å¤šæ¬¡ nio read äº‹ä»¶ï¼Œä¸€æ¬¡äº‹ä»¶å†…ä¼šè§¦å‘å¤šæ¬¡ pipeline readï¼Œä¸€æ¬¡äº‹ä»¶ä¼šè§¦å‘ä¸€æ¬¡ pipeline read complete</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">read</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="nc">ChannelConfig</span> <span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">shouldBreakReadReady</span><span class="o">(</span><span class="n">config</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">clearReadPending</span><span class="o">();</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">final</span> <span class="nc">ChannelPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">();</span>
    <span class="c1">// io.netty.allocator.type å†³å®š allocator çš„å®ç°</span>
    <span class="kd">final</span> <span class="nc">ByteBufAllocator</span> <span class="n">allocator</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="na">getAllocator</span><span class="o">();</span>
    <span class="c1">// ç”¨æ¥åˆ†é… byteBufï¼Œç¡®å®šå•æ¬¡è¯»å–å¤§å°</span>
    <span class="kd">final</span> <span class="nc">RecvByteBufAllocator</span><span class="o">.</span><span class="na">Handle</span> <span class="n">allocHandle</span> <span class="o">=</span> <span class="n">recvBufAllocHandle</span><span class="o">();</span>
    <span class="n">allocHandle</span><span class="o">.</span><span class="na">reset</span><span class="o">(</span><span class="n">config</span><span class="o">);</span>

    <span class="nc">ByteBuf</span> <span class="n">byteBuf</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kt">boolean</span> <span class="n">close</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="k">do</span> <span class="o">{</span>
            <span class="n">byteBuf</span> <span class="o">=</span> <span class="n">allocHandle</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">allocator</span><span class="o">);</span>
            <span class="c1">// è¯»å–</span>
            <span class="n">allocHandle</span><span class="o">.</span><span class="na">lastBytesRead</span><span class="o">(</span><span class="n">doReadBytes</span><span class="o">(</span><span class="n">byteBuf</span><span class="o">));</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">allocHandle</span><span class="o">.</span><span class="na">lastBytesRead</span><span class="o">()</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">byteBuf</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
                <span class="n">byteBuf</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="n">close</span> <span class="o">=</span> <span class="n">allocHandle</span><span class="o">.</span><span class="na">lastBytesRead</span><span class="o">()</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">close</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">readPending</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="n">allocHandle</span><span class="o">.</span><span class="na">incMessagesRead</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
            <span class="n">readPending</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="c1">// è§¦å‘ read äº‹ä»¶ï¼Œè®© pipeline ä¸Šçš„ handler å¤„ç†ï¼Œè¿™æ—¶æ˜¯å¤„ç† NioSocketChannel ä¸Šçš„ handler</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="na">fireChannelRead</span><span class="o">(</span><span class="n">byteBuf</span><span class="o">);</span>
            <span class="n">byteBuf</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span> 
        <span class="c1">// æ˜¯å¦è¦ç»§ç»­å¾ªç¯</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">allocHandle</span><span class="o">.</span><span class="na">continueReading</span><span class="o">());</span>

        <span class="n">allocHandle</span><span class="o">.</span><span class="na">readComplete</span><span class="o">();</span>
        <span class="c1">// è§¦å‘ read complete äº‹ä»¶</span>
        <span class="n">pipeline</span><span class="o">.</span><span class="na">fireChannelReadComplete</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">close</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">closeOnRead</span><span class="o">(</span><span class="n">pipeline</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">handleReadException</span><span class="o">(</span><span class="n">pipeline</span><span class="o">,</span> <span class="n">byteBuf</span><span class="o">,</span> <span class="n">t</span><span class="o">,</span> <span class="n">close</span><span class="o">,</span> <span class="n">allocHandle</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">readPending</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">config</span><span class="o">.</span><span class="na">isAutoRead</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">removeReadOp</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">io.netty.channel.DefaultMaxMessagesRecvByteBufAllocator.MaxMessageHandle#continueReading(io.netty.util.UncheckedBooleanSupplier)</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">continueReading</span><span class="o">(</span><span class="nc">UncheckedBooleanSupplier</span> <span class="n">maybeMoreDataSupplier</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> 
           <span class="c1">// ä¸€èˆ¬ä¸º true</span>
           <span class="n">config</span><span class="o">.</span><span class="na">isAutoRead</span><span class="o">()</span> <span class="o">&amp;&amp;</span>
           <span class="c1">// respectMaybeMoreData é»˜è®¤ä¸º true</span>
           <span class="c1">// maybeMoreDataSupplier çš„é€»è¾‘æ˜¯å¦‚æœé¢„æœŸè¯»å–å­—èŠ‚ä¸å®é™…è¯»å–å­—èŠ‚ç›¸ç­‰ï¼Œè¿”å› true</span>
           <span class="o">(!</span><span class="n">respectMaybeMoreData</span> <span class="o">||</span> <span class="n">maybeMoreDataSupplier</span><span class="o">.</span><span class="na">get</span><span class="o">())</span> <span class="o">&amp;&amp;</span>
           <span class="c1">// å°äºæœ€å¤§æ¬¡æ•°ï¼ŒmaxMessagePerRead é»˜è®¤ 16</span>
           <span class="n">totalMessages</span> <span class="o">&lt;</span> <span class="n">maxMessagePerRead</span> <span class="o">&amp;&amp;</span>
           <span class="c1">// å®é™…è¯»åˆ°äº†æ•°æ®</span>
           <span class="n">totalBytesRead</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>



                <hr style="visibility: hidden;">
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2019/11/28/Java%E4%B9%8B-SpringMVC/" data-toggle="tooltip" data-placement="top" title="SpringMVC">
                        Previous<br>
                        <span>SpringMVC</span>
                        </a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2020/01/18/Java%E4%B9%8BSpring-Boot/" data-toggle="tooltip" data-placement="top" title="Spring Bootå…¥é—¨">
                        Next<br>
                        <span>Spring Bootå…¥é—¨</span>
                        </a>
                    </li>
                    
                </ul>
                <hr style="visibility: hidden;">

                <!-- Gitalk è¯„è®º start  -->
                
                <!-- Link Gitalk çš„æ”¯æŒæ–‡ä»¶  -->
                <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
                <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>

                <div id="gitalk-container"></div>
                <script type="text/javascript">
                    var gitalk = new Gitalk({

                        // gitalkçš„ä¸»è¦å‚æ•°
                        clientID: '2542452a44c3a8034a35',
                        clientSecret: '3119b189eb567a7a89c2440917078889d1689226',
                        repo: 'xprocon.github.io',
                        owner: 'xprocon',
                        admin: ['xprocon'],
                        id: 'post',
                        distractionFreeMode: true,  //æ˜¯å¦å¯ç”¨è¯„è®ºå…¨å±é®ç½©.
                        createIssueManually: true, //å¦‚æœå½“å‰é¡µé¢æ²¡æœ‰ç›¸åº”çš„ isssue ï¼Œä¸”ç™»å½•çš„ç”¨æˆ·å±äº adminï¼Œåˆ™ä¼šè‡ªåŠ¨åˆ›å»º issueã€‚å¦‚æœè®¾ç½®ä¸º trueï¼Œåˆ™æ˜¾ç¤ºä¸€ä¸ªåˆå§‹åŒ–é¡µé¢ï¼Œåˆ›å»º issue éœ€è¦ç‚¹å‡» init æŒ‰é’®ã€‚
                        perPage: 15 //æ¯é¡µå¤šå°‘ä¸ªè¯„è®º
                    });
                    gitalk.render('gitalk-container');
                </script>
                
                <!-- Gitalk end -->

                

                
            </div>  

    <!-- Side Catalog Container -->
        
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
        

    <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                


<section>
    
        <hr class="hidden-sm hidden-xs">
    
    <h5><a href="/archive/">FEATURED TAGS</a></h5>
    <div class="tags">
        
        
        
        
        
        
                <a data-sort="0042" 
                    href="/archive/?tag=Java"
                    title="Java"
                    rel="6">Java</a>
        
                <a data-sort="0032" 
                    href="/archive/?tag=linux"
                    title="linux"
                    rel="16">linux</a>
        
                <a data-sort="0035" 
                    href="/archive/?tag=%E8%BF%90%E7%BB%B4"
                    title="è¿ç»´"
                    rel="13">è¿ç»´</a>
        
                <a data-sort="0036" 
                    href="/archive/?tag=%E5%AD%A6%E4%B9%A0"
                    title="å­¦ä¹ "
                    rel="12">å­¦ä¹ </a>
        
                <a data-sort="0037" 
                    href="/archive/?tag=java"
                    title="java"
                    rel="11">java</a>
        
                <a data-sort="0039" 
                    href="/archive/?tag=centos"
                    title="centos"
                    rel="9">centos</a>
        
                <a data-sort="0043" 
                    href="/archive/?tag=%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83"
                    title="å¼€å‘ç¯å¢ƒ"
                    rel="5">å¼€å‘ç¯å¢ƒ</a>
        
                <a data-sort="0043" 
                    href="/archive/?tag=nginx"
                    title="nginx"
                    rel="5">nginx</a>
        
                <a data-sort="0044" 
                    href="/archive/?tag=%E5%AE%B9%E5%99%A8%E5%8C%96"
                    title="å®¹å™¨åŒ–"
                    rel="4">å®¹å™¨åŒ–</a>
        
                <a data-sort="0044" 
                    href="/archive/?tag=git"
                    title="git"
                    rel="4">git</a>
        
                <a data-sort="0044" 
                    href="/archive/?tag=spring"
                    title="spring"
                    rel="4">spring</a>
        
                <a data-sort="0045" 
                    href="/archive/?tag=%E4%BA%91%E5%8E%9F%E7%94%9F"
                    title="äº‘åŸç”Ÿ"
                    rel="3">äº‘åŸç”Ÿ</a>
        
                <a data-sort="0045" 
                    href="/archive/?tag=%E5%9F%BA%E7%A1%80"
                    title="åŸºç¡€"
                    rel="3">åŸºç¡€</a>
        
                <a data-sort="0045" 
                    href="/archive/?tag=jetbrains"
                    title="jetbrains"
                    rel="3">jetbrains</a>
        
                <a data-sort="0045" 
                    href="/archive/?tag=python"
                    title="python"
                    rel="3">python</a>
    </div>
</section>


                <!-- Friends Blog -->
                
<hr>
<h5>FRIENDS</h5>
<ul class="list-inline">
  
  <li><a href="https://www.baidu.com/">ç™¾åº¦ï¼ˆbaiduï¼‰</a></li>
  
  <li><a href="http://10.175.194.215:8080/">ITå·¥å…·ç®±ï¼ˆittoolsï¼‰</a></li>
  
  <li><a href="https://www.emojiall.com/zh-hans">emojiï¼ˆemojiæœç´¢ï¼‰</a></li>
  
  <li><a href="https://www.v2ex.com/">v2exï¼ˆv2exè®ºå›ï¼‰</a></li>
  
  <li><a href="https://www.reddit.com/r/China_irl/">redditï¼ˆæµæµªé˜²åŒºï¼‰</a></li>
  
</ul>

            </div>
        </div>
    </div>
</article>

<!-- add support for mathjax by voleking-->









<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'hover',
          placement: 'right',
          // icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <!-- SNS Link -->
                


<ul class="list-inline text-center">


  
  
  <li>
    <a href="https://twitter.com/xprocon">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
      </span>
    </a>
  </li>
  
  
  <li>
    <a target="_blank" href="https://www.zhihu.com/people/procon">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa  fa-stack-1x fa-inverse">çŸ¥</i>
      </span>
    </a>
  </li>
  
  
  <li>
    <a target="_blank" href="http://weibo.com/huangpuguang1ni">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
      </span>
    </a>
  </li>
  
  
  
  <li>
    <a target="_blank" href="https://github.com/xprocon">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-github fa-stack-1x fa-inverse"></i>
      </span>
    </a>
  </li>
  
  
</ul>

                <p class="copyright text-muted">
                    Copyright &copy; Procon's Tech Life Blog 2024
                    <br>
                    Powered by <a href="https://blog.procon.cc">Procon Blog</a>
<!--                    <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="100px"-->
<!--                        height="20px"-->
<!--                        src="https://ghbtns.com/github-btn.html?user=huxpro&repo=huxpro.github.io&type=star&count=true">-->
<!--                    </iframe>-->
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<!-- Currently, only navbar scroll-down effect at desktop still depends on this -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js "></script>

<!-- Simple Jekyll Search -->
<script src="/js/simple-jekyll-search.min.js"></script>

<!-- Service Worker -->


<!-- async load function -->
<script>
    function async(u, c) {
        var d = document, t = 'script',
            o = d.createElement(t),
            s = d.getElementsByTagName(t)[0];
        o.src = u;
        if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
        s.parentNode.insertBefore(o, s);
    }
</script>

<!--
     Because of the native support for backtick-style fenced code blocks
     right within the Markdown is landed in Github Pages,
     From V1.6, There is no need for Highlight.js,
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/
     - https://github.com/jneen/rouge/wiki/list-of-supported-languages-and-lexers
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->







<!--fastClick.js -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function () {
        var $nav = document.querySelector("nav");
        if ($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->



<!-- Baidu Tongji -->



<!-- Side Catalog -->

<script type="text/javascript">
    function generateCatalog(selector) {

        // interop with multilangual 
        if ('' == 'true') {
            _containerSelector = 'div.post-container.active'
        } else {
            _containerSelector = 'div.post-container'
        }

        // init
        var P = $(_containerSelector), a, n, t, l, i, c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        // clean
        $(selector).html('')

        // appending
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#" + $(this).prop('id');
            t = $(this).text();
            c = $('<a href="' + i + '" rel="nofollow">' + t + '</a>');
            l = $('<li class="' + n + '_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    // toggle side catalog
    $(".catalog-toggle").click((function (e) {
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    /*
     * Doc: https://github.com/davist11/jQuery-One-Page-Nav
     * Fork by Hux to support padding
     */
    async("/js/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>



<!-- Multi-Lingual -->


<!-- Simple Jekyll Search -->
<script>
    // https://stackoverflow.com/questions/1912501/unescape-html-entities-in-javascript
    function htmlDecode(input) {
        var e = document.createElement('textarea');
        e.innerHTML = input;
        // handle case of empty input
        return e.childNodes.length === 0 ? "" : e.childNodes[0].nodeValue;
    }

    SimpleJekyllSearch({
        searchInput: document.getElementById('search-input'),
        resultsContainer: document.getElementById('search-results'),
        json: '/search.json',
        searchResultTemplate: '<div class="post-preview item"><a href="{url}"><h2 class="post-title">{title}</h2><h3 class="post-subtitle">{subtitle}</h3><hr></a></div>',
        noResultsText: 'No results',
        limit: 50,
        fuzzy: false,
        // a hack to get escaped subtitle unescaped. for some reason, 
        // post.subtitle w/o escape filter nuke entire search.
        templateMiddleware: function (prop, value, template) {
            if (prop === 'subtitle' || prop === 'title') {
                if (value.indexOf("code")) {
                    return htmlDecode(value);
                } else {
                    return value;
                }
            }
        }
    });

    $(document).ready(function () {
        var $searchPage = $('.search-page');
        var $searchOpen = $('.search-icon');
        var $searchClose = $('.search-icon-close');
        var $searchInput = $('#search-input');
        var $body = $('body');

        $searchOpen.on('click', function (e) {
            e.preventDefault();
            $searchPage.toggleClass('search-active');
            var prevClasses = $body.attr('class') || '';
            setTimeout(function () {
                $body.addClass('no-scroll');
            }, 400)

            if ($searchPage.hasClass('search-active')) {
                $searchClose.on('click', function (e) {
                    e.preventDefault();
                    $searchPage.removeClass('search-active');
                    $body.attr('class', prevClasses);  // from closure 
                });
                $searchInput.focus();
            }
        });
    });
</script>


<!-- Image to hack wechat -->
<img src="/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
